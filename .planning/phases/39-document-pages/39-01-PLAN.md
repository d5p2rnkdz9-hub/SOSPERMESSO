---
phase: 39-document-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - _data/documents.js
  - eleventy.config.mjs
  - scripts/templates/dizionario-map.json
autonomous: true

must_haves:
  truths:
    - "Document data is fetched from Notion during 11ty build"
    - "All 6 template filters are registered and available: linkToDizionario, normalizeDocumentName, getDocumentClass, isDisputed, escapeHtml, parseDocNotes"
    - "Build does not fail when Notion API is unavailable (graceful degradation)"
    - "documents.js returns object with separate primo and rinnovo arrays"
  artifacts:
    - path: "_data/documents.js"
      provides: "Async data file fetching document data from Notion"
      exports: ["documents.primo array", "documents.rinnovo array"]
    - path: "eleventy.config.mjs"
      provides: "Liquid filters for template helpers"
      contains: "addFilter"
  key_links:
    - from: "_data/documents.js"
      to: "Notion API"
      via: "@notionhq/client"
      pattern: "notion.search"
    - from: "eleventy.config.mjs"
      to: "scripts/templates/helpers.js"
      via: "require and addFilter"
      pattern: "addFilter.*linkToDizionario"
---

<objective>
Create 11ty data layer for document pages: async data file that fetches from Notion API, plus Liquid filters for template helpers.

Purpose: Move document data fetching from standalone build script into 11ty's native data pipeline. This enables 11ty to generate document pages during normal build.

Output: `_data/documents.js` that exports object with `primo` and `rinnovo` arrays, Liquid filters registered in eleventy.config.mjs
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-document-pages/39-RESEARCH.md

# Existing implementation to adapt
@scripts/notion-client.js
@scripts/templates/helpers.js
@scripts/templates/dizionario-map.json
@scripts/slug-map.json

# 11ty patterns established in v3.0
@eleventy.config.mjs
@_data/site.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create documents.js data file</name>
  <files>_data/documents.js</files>
  <action>
Create `_data/documents.js` that exports an async function returning an object with separate `primo` and `rinnovo` arrays.

Adapt logic from `scripts/notion-client.js`:
- Use `@notionhq/client` with `process.env.NOTION_API_KEY`
- Database ID: `1ad7355e-7f7f-8088-a065-e814c92e2cfd`
- Use `notion.search()` API (workaround for dataSources.query permission)
- Filter pages by parent database ID

For each permit page, extract:
- `tipo`: from "Nome permesso" title property
- `slug`: slugified tipo (use same slugify logic)
- `primoDocuments`: from "Doc primo rilascio" multi_select
- `rinnovoDocuments`: from "Doc rinnovo" multi_select
- `primoMethod`: from "Mod primo rilascio" multi_select (first value)
- `rinnovoMethod`: from "Mod rinnovo" multi_select (first value)
- `docNotes`: from "Info extra su doc rilascio" rich_text

**Return object with separate arrays** (NOT flat array with type field):

```javascript
module.exports = async function() {
  // ... fetch logic ...

  const primo = [];
  const rinnovo = [];

  for (const permit of permits) {
    // Create primo entry
    primo.push({
      tipo: permit.tipo,
      slug: permit.slug,
      documents: permit.primoDocuments,
      method: permit.primoMethod,
      docNotes: permit.docNotes
    });

    // Create rinnovo entry
    rinnovo.push({
      tipo: permit.tipo,
      slug: permit.slug,
      documents: permit.rinnovoDocuments,
      method: permit.rinnovoMethod,
      docNotes: permit.docNotes
    });
  }

  return { primo, rinnovo };
};
```

This structure enables 11ty pagination to use `documents.primo` and `documents.rinnovo` directly.

**Graceful degradation:** If NOTION_API_KEY is not set or API fails, return `{ primo: [], rinnovo: [] }` and log warning (don't fail build).

Use CommonJS format (not ESM) per established pattern.
  </action>
  <verify>
Run `node -e "require('./_data/documents.js')().then(d => console.log('primo:', d.primo.length, 'rinnovo:', d.rinnovo.length))"` - should output counts or "primo: 0 rinnovo: 0" if no API key.
  </verify>
  <done>
_data/documents.js exists, exports async function, returns object with `primo` and `rinnovo` arrays (or empty arrays gracefully).
  </done>
</task>

<task type="auto">
  <name>Task 2: Register Liquid filters for template helpers</name>
  <files>eleventy.config.mjs, scripts/templates/dizionario-map.json</files>
  <action>
Update `eleventy.config.mjs` to register Liquid filters from helpers.js functions.

Required filters (adapt from scripts/templates/helpers.js exports):

1. **linkToDizionario** - Converts document name to HTML with dizionario links
   - Load dizionario-map.json
   - Find matching terms, wrap in `<a href="dizionario.html#anchor">`
   - Return HTML string (use with `| safe` in templates)

2. **normalizeDocumentName** - Normalize document names
   - Fix "4fototessere" -> "4 fototessere"
   - Capitalize first letter
   - Trim and collapse whitespace

3. **getDocumentClass** - Return CSS class for document item
   - Check against DISPUTED_DOCUMENTS array
   - Return "doc-item" or "doc-item doc-disputed"

4. **isDisputed** - Check if document is disputed
   - Return boolean

5. **escapeHtml** - Escape HTML special characters
   - Replace &, <, >, ", '

6. **parseDocNotes** - Parse document notes into Q&A sections
   - Extract questions (Quali?, Come?, Devo?, etc.)
   - Format bullet lists (uses formatNotesContent internally)
   - Return array of {question, content} objects

Note: `formatNotesContent` is a private helper function used internally by `parseDocNotes` - it is NOT exported from helpers.js and should NOT be registered as a separate filter.

**Move dizionario-map.json** to `_data/dizionario-map.json` so it can be loaded by config.
Or keep in scripts/ and use relative path in config - either works.

Register filters like:
```javascript
eleventyConfig.addFilter("linkToDizionario", (docName) => {...});
```

Import helpers.js functions or inline the logic (helpers.js is CommonJS, config is ESM - may need to use createRequire).
  </action>
  <verify>
Run `npx @11ty/eleventy --dryrun` - should complete without errors about unknown filters.
  </verify>
  <done>
eleventy.config.mjs has 6 new filters registered: linkToDizionario, normalizeDocumentName, getDocumentClass, isDisputed, escapeHtml, parseDocNotes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add slug-map data for redirects</name>
  <files>_data/slugMap.js</files>
  <action>
Create `_data/slugMap.js` that exports the redirect mappings from `scripts/slug-map.json`.

Simple data file:
```javascript
module.exports = {
  mappings: {
    "assistenza-minore": "assistenza-minore-art-31",
    "attesa-occupazione": "attesa-occupazione-art-22",
    // ... rest of mappings
  }
};
```

This makes the slug map available to templates as `slugMap.mappings` for generating redirect pages.
  </action>
  <verify>
Run `node -e "console.log(Object.keys(require('./_data/slugMap.js').mappings).length)"` - should output 19 (number of redirect mappings).
  </verify>
  <done>
_data/slugMap.js exists and exports mappings object with 19 redirect entries.
  </done>
</task>

</tasks>

<verification>
1. `node -e "require('./_data/documents.js')().then(d => console.log(d.primo.length, d.rinnovo.length))"` - returns numbers or 0 0
2. `node -e "console.log(require('./_data/slugMap.js').mappings)"` - shows redirect map
3. `npx @11ty/eleventy --dryrun` - completes without filter errors
</verification>

<success_criteria>
1. _data/documents.js fetches from Notion and returns object with primo and rinnovo arrays
2. _data/slugMap.js provides redirect mappings
3. eleventy.config.mjs has all 6 helper filters registered
4. Build does not fail when NOTION_API_KEY is missing
5. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/39-document-pages/39-01-SUMMARY.md`
</output>
