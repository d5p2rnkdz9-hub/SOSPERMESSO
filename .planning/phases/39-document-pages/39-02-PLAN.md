---
phase: 39-document-pages
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - src/pages/documents-primo.liquid
  - src/pages/documents-rinnovo.liquid
  - src/pages/documents-redirects.liquid
autonomous: true

must_haves:
  truths:
    - "Document primo pages render with same structure as current JS templates"
    - "Document rinnovo pages render with same structure as current JS templates"
    - "Redirect pages generate for all slug-map entries"
    - "URLs match current URLs exactly (documenti-{slug}-primo.html)"
  artifacts:
    - path: "src/pages/documents-primo.liquid"
      provides: "Pagination template for primo document pages"
      contains: "pagination"
    - path: "src/pages/documents-rinnovo.liquid"
      provides: "Pagination template for rinnovo document pages"
      contains: "pagination"
    - path: "src/pages/documents-redirects.liquid"
      provides: "Pagination template for redirect pages"
      contains: "meta http-equiv"
  key_links:
    - from: "src/pages/documents-primo.liquid"
      to: "_data/documents.js"
      via: "pagination over documents"
      pattern: "pagination.*documents"
    - from: "templates"
      to: "filters"
      via: "linkToDizionario filter"
      pattern: "linkToDizionario.*safe"
---

<objective>
Create Liquid templates that generate document pages via 11ty pagination.

Purpose: Replace JS template functions (primo.js, rinnovo.js) with Liquid templates. Each page is generated from the documents data array using size:1 pagination.

Output: Three template files that generate all document pages during 11ty build.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-document-pages/39-01-SUMMARY.md

# Templates to convert to Liquid
@scripts/templates/primo.js
@scripts/templates/rinnovo.js

# Existing 11ty patterns
@_includes/layouts/base.liquid
@eleventy.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create primo document template</name>
  <files>src/pages/documents-primo.liquid</files>
  <action>
Create `src/pages/documents-primo.liquid` using 11ty pagination.

**Front matter:**
```yaml
---
pagination:
  data: documents
  size: 1
  alias: doc
  filter:
    - type
  addAllPagesToCollections: true
permalink: "src/pages/documenti-{{ doc.slug }}-primo.html"
layout: false
---
```

Wait - we need to filter for primo pages only. The documents.js returns both primo and rinnovo entries. Add filter logic.

Actually, better approach: In documents.js, return separate arrays or filter in pagination:
```yaml
pagination:
  data: documents
  size: 1
  alias: doc
  before: function(data) { return data.filter(d => d.type === 'primo'); }
```

But Liquid doesn't support JS functions in front matter. Options:
1. Return separate `documentsPrimo` and `documentsRinnovo` arrays from data file
2. Use pagination with filtering

**Best approach:** Modify _data/documents.js to export object with `primo` and `rinnovo` arrays:
```javascript
module.exports = async function() {
  // ... fetch logic ...
  return {
    primo: primoPages,
    rinnovo: rinnovoPages
  };
};
```

Then pagination uses `data: documents.primo`.

**Template structure** (convert from primo.js):

```liquid
---
pagination:
  data: documents.primo
  size: 1
  alias: doc
permalink: "src/pages/documenti-{{ doc.slug }}-primo.html"
layout: false
eleventyExcludeFromCollections: true
---
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Documenti necessari per il primo rilascio del permesso per {{ doc.tipo }}">
  <title>Documenti {{ doc.tipo }} - Primo Rilascio - SOS Permesso</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="../../images/Favicon.svg">
  ...

  <!-- Styles (same as primo.js) -->
  <link rel="stylesheet" href="../styles/main.css">
  ...
</head>
<body class="page-primo">

  <!-- HEADER (inline, not using include - matches current structure) -->
  <header class="header">
    <div class="container">
      <nav class="navbar">
        <a href="../../index.html" class="logo">
          <img src="../../images/logo-full.png" alt="SOS Permesso" class="logo-image">
        </a>
        <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
        <ul class="nav-menu" id="nav-menu">
          <li><a href="../../index.html" class="nav-link">Home</a></li>
          <li><a href="database.html" class="nav-link">Database</a></li>
          <li><a href="chi-siamo.html" class="nav-link">Chi siamo</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- BREADCRUMB -->
  <section class="section" style="padding: 1rem 0;">
    <div class="container" style="position: relative;">
      <div style="font-size: 0.875rem; color: var(--gray-medium);">
        <a href="../../index.html" style="color: var(--taxi-yellow-dark);">Home</a> ‚Üí
        <a href="documenti-questura.html" style="color: var(--taxi-yellow-dark);">Documenti Questura</a> ‚Üí
        <span>{{ doc.tipo }} - Primo Rilascio</span>
      </div>

      <!-- ERROR BUTTON -->
      <a href="https://form.typeform.com/to/FsqvzdXI#page_url=https://sospermesso.it/src/pages/documenti-{{ doc.slug }}-primo.html"
         class="error-report-btn"
         target="_blank"
         rel="noopener noreferrer">
        üö® Segnala errore
      </a>
    </div>
  </section>

  <!-- PAGE HEADER -->
  <section class="section bg-off-white" style="padding: 1.5rem 0;">
    <div class="container">
      <div class="page-header text-center">
        <h1 class="page-title" style="margin-bottom: 0.25rem;">{{ doc.tipo }}</h1>
        <p class="section-subtitle" style="margin-bottom: 0.5rem;">Documenti per il <strong>Primo Rilascio</strong></p>
        <a href="documenti-{{ doc.slug }}-rinnovo.html" class="quick-switch-link">
          Vedi anche: Rinnovo ‚Üí
        </a>
      </div>
    </div>
  </section>

  <!-- SUBMISSION METHOD CALLOUT -->
  {%- assign isKit = doc.method | downcase | contains: 'kit' -%}
  {%- if isKit -%}
    {%- assign calloutClass = 'callout-kit' -%}
    {%- assign calloutIcon = 'üìÆ' -%}
    {%- assign calloutText = 'Invia tramite KIT alle Poste (non devi andare in Questura)' -%}
  {%- else -%}
    {%- assign calloutClass = 'callout-questura' -%}
    {%- assign calloutIcon = 'üèõÔ∏è' -%}
    {%- assign calloutText = 'Porta i documenti in Questura (non puoi usare il KIT postale)' -%}
  {%- endif -%}
  <section class="section" style="padding: 1rem 0;">
    <div class="container" style="max-width: 700px;">
      <div class="submission-callout {{ calloutClass }}">
        <span class="callout-icon">{{ calloutIcon }}</span>
        <div class="callout-text">{{ calloutText }}</div>
      </div>
    </div>
  </section>

  <!-- DOCUMENT CHECKLIST -->
  <section class="section">
    <div class="container" style="max-width: 700px;">
      <div class="card">
        <h2>üìã Documenti necessari</h2>
        <p class="checklist-intro">Spunta i documenti che hai gi√† preparato. I tuoi progressi vengono salvati automaticamente.</p>

        <div class="doc-checklist" data-permit="{{ doc.slug }}-primo">
          {%- for docItem in doc.documents -%}
            {%- assign normalizedDoc = docItem | normalizeDocumentName -%}
            {%- assign docClass = normalizedDoc | getDocumentClass -%}
            {%- assign docLabel = normalizedDoc | linkToDizionario -%}
            {%- assign disputed = normalizedDoc | isDisputed -%}
          <div class="{{ docClass }}">
            <input type="checkbox"
                   class="doc-checkbox"
                   id="doc-{{ doc.slug }}-primo-{{ forloop.index0 }}"
                   data-doc="{{ normalizedDoc | escapeHtml }}">
            <span class="doc-label">{{ docLabel | safe }}{% if disputed %}<span class="disputed-note">(potrebbe dipendere dalla Questura)</span>{% endif %}</span>
          </div>
          {%- endfor -%}
        </div>

        <div class="checklist-progress">
          <span class="progress-text">Completati: <span id="progress-count">0</span>/{{ doc.documents.size }}</span>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="alert alert-warning" style="margin-top: 1rem;">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <div>
          <strong>Nota:</strong> I documenti richiesti possono variare da Questura a Questura. Contatta sempre la tua Questura per confermare la lista esatta.
        </div>
      </div>
    </div>
  </section>

  {%- assign notesSections = doc.docNotes | parseDocNotes -%}
  {%- if notesSections.size > 0 -%}
  <!-- DOCUMENT NOTES -->
  <section class="section bg-off-white">
    <div class="container" style="max-width: 700px;">
      <h2 style="text-align: center; margin-bottom: 1.5rem;">üìù Informazioni aggiuntive sui documenti</h2>
      {%- for section in notesSections -%}
      <div class="card" style="margin-bottom: 1rem;">
        <h3 style="margin-bottom: 0.75rem; font-size: 1rem;">{{ section.question | escapeHtml }}</h3>
        {{ section.content | safe }}
      </div>
      {%- endfor -%}
    </div>
  </section>
  {%- endif -%}

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container">
      <div class="footer-links">
        <a href="chi-siamo.html" class="footer-link">Chi siamo</a>
        <a href="../../index.html" class="footer-link">Home</a>
        <a href="https://form.typeform.com/to/USx16QN3" class="footer-link">Contatti</a>
      </div>
      <p class="footer-copyright">¬© 2025 SOS Permesso. Tutti i diritti riservati.</p>
    </div>
  </footer>

  <script src="../scripts/app.js"></script>
  <script>
    // Checklist persistence with localStorage
    (function() {
      var permitKey = '{{ doc.slug }}-primo';
      var checkboxes = document.querySelectorAll('.doc-checkbox');
      var progressCount = document.getElementById('progress-count');
      var progressFill = document.getElementById('progress-fill');

      function loadState() {
        var saved = localStorage.getItem('checklist-' + permitKey);
        if (saved) {
          try {
            var state = JSON.parse(saved);
            state.forEach(function(item) {
              var checkbox = document.getElementById(item.id);
              if (checkbox) checkbox.checked = item.checked;
            });
          } catch (e) { console.warn('Failed to load checklist state:', e); }
        }
        updateProgress();
      }

      function saveState() {
        var state = Array.from(checkboxes).map(function(cb) {
          return { id: cb.id, checked: cb.checked };
        });
        localStorage.setItem('checklist-' + permitKey, JSON.stringify(state));
        updateProgress();
      }

      function updateProgress() {
        var total = checkboxes.length;
        var checked = Array.from(checkboxes).filter(function(cb) { return cb.checked; }).length;
        progressCount.textContent = checked;
        progressFill.style.width = (total > 0 ? (checked / total) * 100 : 0) + '%';
      }

      checkboxes.forEach(function(cb) { cb.addEventListener('change', saveState); });
      document.addEventListener('DOMContentLoaded', loadState);
    })();
  </script>
</body>
</html>
```

**Note:** Keep inline header/footer (not using includes) to match exact current output. The document pages have simpler nav than main site pages.

**Update documents.js** to return `{primo: [...], rinnovo: [...]}` structure if not already done.
  </action>
  <verify>
Run `npx @11ty/eleventy` with NOTION_API_KEY set. Check that `_site/src/pages/documenti-*-primo.html` files are generated.
  </verify>
  <done>
src/pages/documents-primo.liquid exists, pagination generates primo pages, output matches current primo.js structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create rinnovo document template</name>
  <files>src/pages/documents-rinnovo.liquid</files>
  <action>
Create `src/pages/documents-rinnovo.liquid` using same pattern as primo.

Key differences from primo (from rinnovo.js):
1. Body class: `page-rinnovo`
2. Title: "Documenti per il Rinnovo"
3. Quick switch links to primo instead of rinnovo
4. **Adds common document** at start of list: "Copia permesso precedente (o denuncia smarrimento)"
5. **Extra alert box** for renewal reminder (60 days before expiry)
6. **Disputed warning** for attesa-occupazione renewal (special case)

```yaml
---
pagination:
  data: documents.rinnovo
  size: 1
  alias: doc
permalink: "src/pages/documenti-{{ doc.slug }}-rinnovo.html"
layout: false
eleventyExcludeFromCollections: true
---
```

**Template structure** - same as primo but with these changes:

1. Title and meta description mention "Rinnovo"
2. Quick switch link goes to `-primo.html`
3. Before document loop, add common doc:
```liquid
{%- assign commonDoc = "Copia permesso precedente (o denuncia smarrimento)" -%}
{%- assign allDocs = "" | split: "" -%}
{%- assign allDocs = allDocs | push: commonDoc -%}
{%- for d in doc.documents -%}
  {%- unless d == commonDoc -%}
    {%- assign allDocs = allDocs | push: d -%}
  {%- endunless -%}
{%- endfor -%}
```
Wait, Liquid arrays are tricky. Better approach - handle in data file or just prepend in template.

Actually simpler: use `concat` or just render common doc first:
```liquid
<div class="{{ 'Copia permesso precedente' | getDocumentClass }}">
  <input type="checkbox" class="doc-checkbox" id="doc-{{ doc.slug }}-rinnovo-0" data-doc="Copia permesso precedente (o denuncia smarrimento)">
  <span class="doc-label">{{ 'Copia permesso precedente (o denuncia smarrimento)' | linkToDizionario | safe }}</span>
</div>
{%- for docItem in doc.documents -%}
  {%- unless docItem == 'Copia permesso precedente (o denuncia smarrimento)' -%}
    ... render doc item with forloop.index + 1 for id ...
  {%- endunless -%}
{%- endfor -%}
```

4. Add renewal alert after warning:
```liquid
<div class="alert alert-info" style="margin-top: 0.75rem;">
  <span class="alert-icon">üìÖ</span>
  <div>
    <strong>Ricorda:</strong> Il rinnovo va richiesto almeno 60 giorni prima della scadenza del permesso attuale.
  </div>
</div>
```

5. Add attesa-occupazione warning (before checklist):
```liquid
{%- if doc.slug contains 'attesa-occupazione' -%}
<section class="section" style="padding: 0.5rem 0;">
  <div class="container" style="max-width: 700px;">
    <div class="alert alert-danger" style="background: #FFF0F0; border: 1.5px solid #E53935; border-radius: 8px;">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <div>
        <strong>Attenzione:</strong> Il rinnovo del permesso per attesa occupazione √® controverso...
        <a href="aiuto-legale.html" style="color: #E53935; font-weight: 600;">‚Üí Trova aiuto legale nella tua zona</a>
      </div>
    </div>
  </div>
</section>
{%- endif -%}
```
  </action>
  <verify>
Run `npx @11ty/eleventy` with NOTION_API_KEY set. Check that `_site/src/pages/documenti-*-rinnovo.html` files are generated.
  </verify>
  <done>
src/pages/documents-rinnovo.liquid exists, pagination generates rinnovo pages, includes common doc prepend, renewal reminder, and attesa-occupazione warning.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create redirect pages template</name>
  <files>src/pages/documents-redirects.liquid, _data/documentRedirects.js</files>
  <action>
Create redirect page generation using 11ty pagination.

**Step 1:** Create `_data/documentRedirects.js` that returns array of redirect objects:
```javascript
const slugMap = require('./slugMap.js');

module.exports = function() {
  const redirects = [];

  for (const [displaySlug, canonicalSlug] of Object.entries(slugMap.mappings)) {
    // Generate primo redirect
    redirects.push({
      displaySlug,
      canonicalSlug,
      type: 'primo',
      targetFile: `documenti-${canonicalSlug}-primo.html`
    });

    // Generate rinnovo redirect
    redirects.push({
      displaySlug,
      canonicalSlug,
      type: 'rinnovo',
      targetFile: `documenti-${canonicalSlug}-rinnovo.html`
    });
  }

  return redirects;
};
```

**Step 2:** Create `src/pages/documents-redirects.liquid`:
```liquid
---
pagination:
  data: documentRedirects
  size: 1
  alias: redirect
permalink: "src/pages/documenti-{{ redirect.displaySlug }}-{{ redirect.type }}.html"
layout: false
eleventyExcludeFromCollections: true
---
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="0;url={{ redirect.targetFile }}">
  <link rel="canonical" href="{{ redirect.targetFile }}">
  <title>Redirecting...</title>
</head>
<body>
  <p>Reindirizzamento in corso...</p>
  <script>window.location.replace("{{ redirect.targetFile }}");</script>
</body>
</html>
```

This generates redirect pages like `documenti-studio-primo.html` that redirect to `documenti-studio-art-39-primo.html`.
  </action>
  <verify>
Run `npx @11ty/eleventy`. Check that redirect files exist in `_site/src/pages/` (e.g., `documenti-studio-primo.html` with meta refresh).
  </verify>
  <done>
_data/documentRedirects.js exists, src/pages/documents-redirects.liquid exists, redirect pages are generated for all slug-map entries.
  </done>
</task>

</tasks>

<verification>
1. `npx @11ty/eleventy` completes successfully
2. `ls _site/src/pages/documenti-*-primo.html | wc -l` - matches expected count
3. `ls _site/src/pages/documenti-*-rinnovo.html | wc -l` - matches expected count
4. `grep -l "meta http-equiv" _site/src/pages/documenti-*.html | wc -l` - shows redirect count
5. Visual comparison: open a generated page and current page side by side
</verification>

<success_criteria>
1. All primo document pages generate via 11ty
2. All rinnovo document pages generate via 11ty
3. All redirect pages generate via 11ty
4. URLs match current URLs exactly
5. Generated HTML matches current structure (visual parity)
6. Checklist JavaScript works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/39-document-pages/39-02-SUMMARY.md`
</output>
