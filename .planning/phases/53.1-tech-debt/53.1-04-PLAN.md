---
phase: 53.1-tech-debt
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/sitemap-it.liquid
  - src/pages/sitemap-en.liquid
  - src/pages/sitemap-fr.liquid
  - src/pages/sitemap-index.liquid
  - eleventy.config.mjs
autonomous: true

must_haves:
  truths:
    - "Sitemap is generated by 11ty as part of the build (not a separate script)"
    - "Sitemap URLs use correct paths (no src/pages/ in URLs)"
    - "Homepage URL is / not /index.html"
    - "sitemap-index.xml points to per-language sitemaps (IT, EN, FR)"
    - "Each language sitemap includes hreflang alternates"
  artifacts:
    - path: "src/pages/sitemap-it.liquid"
      provides: "IT sitemap template generated by 11ty"
      contains: "urlset"
    - path: "src/pages/sitemap-en.liquid"
      provides: "EN sitemap template generated by 11ty"
      contains: "urlset"
    - path: "src/pages/sitemap-fr.liquid"
      provides: "FR sitemap template generated by 11ty"
      contains: "urlset"
    - path: "src/pages/sitemap-index.liquid"
      provides: "Sitemap index pointing to all language sitemaps"
      contains: "sitemapindex"
  key_links:
    - from: "src/pages/sitemap-index.liquid"
      to: "sitemap-it.xml, sitemap-en.xml, sitemap-fr.xml"
      via: "sitemap loc elements"
      pattern: "sitemap-(it|en|fr)\\.xml"
    - from: "src/pages/sitemap-it.liquid"
      to: "All IT page URLs"
      via: "url loc elements"
      pattern: "sospermesso\\.it/"
---

<objective>
Replace the standalone `scripts/build-sitemap.js` with 11ty-native sitemap templates that generate correct URLs from the actual build output, including FR support and proper hreflang alternates.

Purpose: The current sitemap script scans `src/pages/` (source files) instead of `_site/` (output), producing URLs with `src/pages/` in the path. Moving to 11ty templates ensures sitemaps are generated from actual page data with correct URLs.
Output: 4 Liquid templates producing sitemap-index.xml, sitemap-it.xml, sitemap-en.xml, sitemap-fr.xml as part of the 11ty build.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53.1-tech-debt/53.1-CONTEXT.md
@scripts/build-sitemap.js
@eleventy.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 11ty sitemap templates for IT, EN, FR + sitemap index</name>
  <files>src/pages/sitemap-it.liquid, src/pages/sitemap-en.liquid, src/pages/sitemap-fr.liquid, src/pages/sitemap-index.liquid</files>
  <action>
**Approach:** Use 11ty's `collections.all` to access all generated pages, then filter by language prefix to create per-language sitemaps. Each sitemap includes hreflang alternates.

**1. Create `src/pages/sitemap-index.liquid`:**

```liquid
---
permalink: sitemap-index.xml
eleventyExcludeFromCollections: true
---
<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <sitemap>
    <loc>{{ site.url }}/sitemap-it.xml</loc>
  </sitemap>
  <sitemap>
    <loc>{{ site.url }}/sitemap-en.xml</loc>
  </sitemap>
  <sitemap>
    <loc>{{ site.url }}/sitemap-fr.xml</loc>
  </sitemap>
</sitemapindex>
```

**2. Create `src/pages/sitemap-it.liquid`:**

The IT sitemap should list all pages whose URL does NOT start with `/en/` or `/fr/`. Exclude: pages with `eleventyExcludeFromCollections: true`, 404 pages, PREVIEW pages, sitemap XML files themselves, and Google verification files.

Since 11ty's Liquid templates have limited filtering capability, use a data-driven approach. Create a helper that collects page URLs, OR use the collections API.

**Better approach -- use 11ty addCollection in eleventy.config.mjs** to create `sitemapIt`, `sitemapEn`, `sitemapFr` collections, then iterate them in simple Liquid templates. This is cleaner than complex Liquid filtering.

In each sitemap template, iterate the appropriate collection:

```liquid
---
permalink: sitemap-it.xml
eleventyExcludeFromCollections: true
---
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xhtml="http://www.w3.org/1999/xhtml">
{%- for page in collections.sitemapIt %}
  <url>
    <loc>{{ site.url }}{{ page.url }}</loc>
    <xhtml:link rel="alternate" hreflang="it" href="{{ site.url }}{{ page.url }}"/>
    <xhtml:link rel="alternate" hreflang="en" href="{{ site.url }}/en{{ page.url }}"/>
    <xhtml:link rel="alternate" hreflang="fr" href="{{ site.url }}/fr{{ page.url }}"/>
    <xhtml:link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ page.url }}"/>
  </url>
{%- endfor %}
</urlset>
```

For EN sitemap:
```liquid
---
permalink: sitemap-en.xml
eleventyExcludeFromCollections: true
---
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xhtml="http://www.w3.org/1999/xhtml">
{%- for page in collections.sitemapEn %}
  {%- assign itUrl = page.url | replace_first: "/en/", "/" %}
  <url>
    <loc>{{ site.url }}{{ page.url }}</loc>
    <xhtml:link rel="alternate" hreflang="it" href="{{ site.url }}{{ itUrl }}"/>
    <xhtml:link rel="alternate" hreflang="en" href="{{ site.url }}{{ page.url }}"/>
    <xhtml:link rel="alternate" hreflang="fr" href="{{ site.url }}/fr{{ itUrl }}"/>
    <xhtml:link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ itUrl }}"/>
  </url>
{%- endfor %}
</urlset>
```

FR sitemap: same pattern with `/fr/` prefix.

**3. Add collections in `eleventy.config.mjs`:**

Add three custom collections that filter pages for sitemaps. These collections:
- Exclude pages with `eleventyExcludeFromCollections: true`
- Exclude sitemap files themselves (check URL ends with `.xml`)
- Exclude 404, PREVIEW, Google verification files
- Filter by URL prefix for language

```js
// Sitemap collections
const sitemapExcludes = ['/404.html', '/PREVIEW.html'];

eleventyConfig.addCollection("sitemapIt", function(collectionApi) {
  return collectionApi.getAll().filter(item => {
    const url = item.url || '';
    if (!url || url.endsWith('.xml')) return false;
    if (sitemapExcludes.some(e => url === e)) return false;
    if (url.startsWith('/en/') || url.startsWith('/fr/')) return false;
    // Exclude Google verification files
    if (url.includes('google') && url.endsWith('.html')) return false;
    return true;
  });
});

eleventyConfig.addCollection("sitemapEn", function(collectionApi) {
  return collectionApi.getAll().filter(item => {
    const url = item.url || '';
    if (!url || url.endsWith('.xml')) return false;
    if (sitemapExcludes.some(e => url === e)) return false;
    if (!url.startsWith('/en/')) return false;
    return true;
  });
});

eleventyConfig.addCollection("sitemapFr", function(collectionApi) {
  return collectionApi.getAll().filter(item => {
    const url = item.url || '';
    if (!url || url.endsWith('.xml')) return false;
    if (sitemapExcludes.some(e => url === e)) return false;
    if (!url.startsWith('/fr/')) return false;
    return true;
  });
});
```

**4. Homepage URL:** 11ty outputs the homepage URL as `/` (not `/index.html`), so the sitemap will naturally have the correct URL.

**Important Liquid note:** Use `{%- -%}` (with dashes) to strip whitespace in XML output, preventing blank lines that make the XML malformed.
  </action>
  <verify>
  npm run build
  Then check the output:
  head -20 _site/sitemap-index.xml
  head -20 _site/sitemap-it.xml
  grep -c "<url>" _site/sitemap-it.xml
  grep -c "<url>" _site/sitemap-en.xml
  grep -c "<url>" _site/sitemap-fr.xml
  grep "src/pages" _site/sitemap-it.xml (should return NO matches)
  grep "index.html" _site/sitemap-it.xml (should NOT appear as a standalone URL -- homepage should be just /)

  Cross-check hreflang alternate URLs actually correspond to generated pages:
  Pick a specific page (e.g., database.html) and verify its hreflang alternates exist:
  grep "database.html" _site/sitemap-it.xml (should show IT loc + EN/FR alternates)
  ls _site/database.html _site/en/database.html _site/fr/database.html (all three should exist)
  Pick a permit page and verify:
  grep "permesso-richiesta-asilo" _site/sitemap-en.xml | head -5 (should show EN loc + IT/FR alternates)
  ls _site/permesso-richiesta-asilo.html _site/en/permesso-richiesta-asilo.html _site/fr/permesso-richiesta-asilo.html (all three should exist)
  </verify>
  <done>Build produces sitemap-index.xml pointing to 3 language sitemaps. Each language sitemap lists all pages with correct URLs (no src/pages/ prefix) and hreflang alternates. Alternate URLs correspond to actually generated pages. Homepage URL is /.</done>
</task>

<task type="auto">
  <name>Task 2: Clean up old sitemap infrastructure</name>
  <files>eleventy.config.mjs</files>
  <action>
**1. Remove old sitemap passthrough copies from eleventy.config.mjs.**

In `eleventy.config.mjs`, remove these lines (around lines 182-184):
```js
eleventyConfig.addPassthroughCopy("sitemap-it.xml");
eleventyConfig.addPassthroughCopy("sitemap-en.xml");
eleventyConfig.addPassthroughCopy("sitemap-index.xml");
```

These are no longer needed because sitemaps are now generated by 11ty templates, not copied as static files.

**2. Remove old static sitemap files from project root (if they exist).**

Delete these files if present:
- `sitemap-it.xml` (root level)
- `sitemap-en.xml` (root level)
- `sitemap-index.xml` (root level)

These were previously generated by `scripts/build-sitemap.js` and copied by passthrough. Now 11ty generates them directly into `_site/`.

**3. Update `package.json` build script (if sitemap script is referenced).**

Check if `package.json`'s `build` script includes `node scripts/build-sitemap.js`. If so, remove that step from the build chain. The sitemap is now part of the 11ty build, not a separate step.

**4. Do NOT delete `scripts/build-sitemap.js` yet** -- keep it as reference. It can be cleaned up in a future phase. Just ensure it's not called during build.

**5. Add `sitemap-fr.xml` passthrough copy is NOT needed** -- 11ty generates it.
  </action>
  <verify>
  grep -n "sitemap" eleventy.config.mjs (should show collection definitions, NOT passthrough copies for sitemap XMLs)
  npm run build (should succeed and produce all 4 sitemap files in _site/)
  ls -la _site/sitemap-*.xml _site/sitemap-index.xml
  </verify>
  <done>Old sitemap passthrough copies removed. Build produces sitemaps via 11ty templates. No old static sitemap files interfere with generation.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `_site/sitemap-index.xml` references sitemap-it.xml, sitemap-en.xml, sitemap-fr.xml
3. `_site/sitemap-it.xml` contains correct URLs (no `src/pages/` prefix)
4. `_site/sitemap-en.xml` contains URLs starting with `/en/`
5. `_site/sitemap-fr.xml` contains URLs starting with `/fr/`
6. Homepage appears as `https://www.sospermesso.it/` not `https://www.sospermesso.it/index.html`
7. Each URL entry has hreflang alternates for IT, EN, FR, and x-default
8. No `404.html`, `PREVIEW.html`, or `.xml` files in sitemap URLs
9. Hreflang alternate URLs in sitemaps correspond to actually generated pages in `_site/`
</verification>

<success_criteria>
- Sitemaps are generated as part of `npm run build` (11ty templates, not separate script)
- URLs are correct (root-level, no src/pages/ prefix)
- Homepage URL is `/` not `/index.html`
- All three language sitemaps exist with hreflang alternates
- sitemap-index.xml references all three language sitemaps
- Alternate hreflang URLs point to real generated pages
</success_criteria>

<output>
After completion, create `.planning/phases/53.1-tech-debt/53.1-04-SUMMARY.md`
</output>
