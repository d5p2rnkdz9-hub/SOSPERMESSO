---
phase: 53.1-tech-debt
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/templates/dizionario-map.json
  - scripts/templates/helpers.js
  - eleventy.config.mjs
  - en/src/pages/documents-primo-en.liquid
  - en/src/pages/documents-rinnovo-en.liquid
  - fr/src/pages/documents-primo-fr.liquid
  - fr/src/pages/documents-rinnovo-fr.liquid
  - src/pages/documents-primo.liquid
  - src/pages/documents-rinnovo.liquid
autonomous: true

must_haves:
  truths:
    - "Dizionario links appear in EN permit/document pages when Italian legal terms are found in the text"
    - "Dizionario links appear in FR permit/document pages when Italian legal terms are found in the text"
    - "All dizionario links point to the IT dizionario page (single source of truth)"
    - "EN/FR translated equivalents of Italian terms also link to the IT dizionario"
  artifacts:
    - path: "scripts/templates/dizionario-map.json"
      provides: "Term-to-anchor mapping including EN and FR translated equivalents"
      contains: "Questura"
    - path: "scripts/templates/helpers.js"
      provides: "linkToDizionario filter that handles language-aware URL prefixing"
      contains: "linkToDizionario"
    - path: "en/src/pages/documents-primo-en.liquid"
      provides: "EN primo template with linkToDizionario filter calls"
      contains: "linkToDizionario"
    - path: "fr/src/pages/documents-primo-fr.liquid"
      provides: "FR primo template with linkToDizionario filter calls"
      contains: "linkToDizionario"
  key_links:
    - from: "scripts/templates/helpers.js"
      to: "dizionario-map.json"
      via: "require import"
      pattern: "dizionario-map\\.json"
    - from: "eleventy.config.mjs"
      to: "scripts/templates/helpers.js"
      via: "filter registration"
      pattern: "linkToDizionario"
---

<objective>
Expand the dizionario linking system to work on EN and FR pages by adding translated term equivalents to the mapping and making the link filter language-aware (always pointing to the IT dizionario page).

Purpose: Currently, dizionario links only work on IT document pages. Many Italian legal terms appear untranslated in EN/FR content (e.g., "Questura", "Prefettura", "Nulla osta"), and some translated equivalents (e.g., "residence permit", "titre de sejour") should also be linkable. This gives EN/FR users access to the same glossary.
Output: Updated dizionario-map.json with EN/FR equivalents, updated filter that generates links pointing to IT dizionario regardless of current page language, and EN/FR templates updated to call the filter.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53.1-tech-debt/53.1-CONTEXT.md
@scripts/templates/dizionario-map.json
@scripts/templates/helpers.js
@eleventy.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand dizionario-map.json with EN and FR term equivalents</name>
  <files>scripts/templates/dizionario-map.json</files>
  <action>
Add English and French translations of key Italian legal terms to dizionario-map.json. Each translated term maps to the SAME anchor ID as its Italian equivalent (since the dizionario page is IT-only).

The current map has ~40 Italian terms. Add EN and FR equivalents for the most common ones. Many Italian terms appear untranslated in EN/FR text (e.g., "Questura", "Nulla osta"), so they are already covered. Focus on adding translated equivalents that users would encounter:

**English translations to add:**
```json
"Residence permit": "permesso-di-soggiorno",
"residence permit": "permesso-di-soggiorno",
"Revenue stamp": "marca-da-bollo",
"revenue stamp": "marca-da-bollo",
"Police headquarters": "questura",
"police headquarters": "questura",
"Family reunification": "ricongiungimento-familiare",
"family reunification": "ricongiungimento-familiare",
"International protection": "protezione-internazionale",
"Refugee status": "status-di-rifugiato",
"refugee status": "status-di-rifugiato",
"Territorial Commission": "commissione-territoriale",
"territorial commission": "commissione-territoriale",
"Housing suitability": "idoneita-alloggiativa",
"housing suitability": "idoneita-alloggiativa",
"Health card": "tessera-sanitaria",
"health card": "tessera-sanitaria",
"Postal kit": "kit-postale",
"postal kit": "kit-postale",
"Juvenile Court": "tribunale-per-i-minorenni",
"Social services": "servizi-sociali",
"social services": "servizi-sociali",
"Tax code": "codice-fiscale",
"tax code": "codice-fiscale",
"Criminal record": "casellario-giudiziale",
"criminal record": "casellario-giudiziale",
"Pending charges": "carichi-pendenti",
"pending charges": "carichi-pendenti",
"Hospitality declaration": "dichiarazione-di-ospitalita",
"Authorization": "nulla-osta",
"authorization": "nulla-osta"
```

**French translations to add:**
```json
"Titre de séjour": "permesso-di-soggiorno",
"titre de séjour": "permesso-di-soggiorno",
"Timbre fiscal": "marca-da-bollo",
"timbre fiscal": "marca-da-bollo",
"Commissariat": "questura",
"commissariat": "questura",
"Regroupement familial": "ricongiungimento-familiare",
"regroupement familial": "ricongiungimento-familiare",
"Protection internationale": "protezione-internazionale",
"protection internationale": "protezione-internazionale",
"Statut de réfugié": "status-di-rifugiato",
"statut de réfugié": "status-di-rifugiato",
"Commission territoriale": "commissione-territoriale",
"commission territoriale": "commissione-territoriale",
"Aptitude du logement": "idoneita-alloggiativa",
"Carte sanitaire": "tessera-sanitaria",
"Kit postal": "kit-postale",
"kit postal": "kit-postale",
"Tribunal pour mineurs": "tribunale-per-i-minorenni",
"Services sociaux": "servizi-sociali",
"services sociaux": "servizi-sociali",
"Code fiscal": "codice-fiscale",
"code fiscal": "codice-fiscale",
"Casier judiciaire": "casellario-giudiziale",
"casier judiciaire": "casellario-giudiziale",
"Charges en cours": "carichi-pendenti",
"Déclaration d'hospitalité": "dichiarazione-di-ospitalita",
"Autorisation": "nulla-osta"
```

Add all of these to the existing JSON file. Keep the file alphabetically organized is not required — just append them cleanly.

**Important:** Do NOT remove existing Italian terms. The map should contain ALL terms (IT + EN + FR equivalents) since the filter does partial matching against document names in all languages.
  </action>
  <verify>
  node -e "const m = require('./scripts/templates/dizionario-map.json'); console.log('Total terms:', Object.keys(m).length); console.log('Has EN:', 'Residence permit' in m); console.log('Has FR:', 'Titre de séjour' in m);"
  </verify>
  <done>dizionario-map.json contains Italian terms PLUS English and French equivalents, all mapping to the correct IT dizionario anchor IDs. Total term count is approximately 90-110 (up from ~40).</done>
</task>

<task type="auto">
  <name>Task 2: Add linkToDizionario calls to EN/FR templates and make filter language-aware</name>
  <files>scripts/templates/helpers.js, eleventy.config.mjs, en/src/pages/documents-primo-en.liquid, en/src/pages/documents-rinnovo-en.liquid, fr/src/pages/documents-primo-fr.liquid, fr/src/pages/documents-rinnovo-fr.liquid, src/pages/documents-primo.liquid, src/pages/documents-rinnovo.liquid</files>
  <action>
**Critical context:** EN/FR document templates do NOT currently call the `linkToDizionario` filter at all. They use `| escapeHtml` instead. The IT templates DO call it. This task must FIRST add the filter call to EN/FR templates, THEN make the filter language-aware.

**Step 1: Make linkToDizionario filter language-aware in helpers.js.**

Update the `linkToDizionario` function signature to accept a second parameter `lang`. Add a null-safe guard at the top so internal callers (like `formatNotesContent` at line ~253 which calls `linkToDizionario(bullet)` without lang) default to IT behavior:

```js
function linkToDizionario(documentName, lang) {
  if (!lang) lang = 'it';  // Null-safe: internal calls without lang default to IT
  if (!documentName) return '';

  // ... existing matching logic unchanged ...

  // Determine dizionario URL prefix based on language
  let dizionarioBase = 'dizionario.html';
  if (lang === 'en' || lang === 'fr') {
    // EN/FR pages link to IT dizionario (absolute path from root)
    dizionarioBase = '/dizionario.html';
  }

  // In the replacement loop, use dizionarioBase instead of hardcoded 'dizionario.html':
  const link = `<a href="${dizionarioBase}#${r.anchorId}" class="doc-link">${escapeHtml(r.original)}</a>`;
  // ... rest unchanged
}
```

The internal call in `formatNotesContent()` (line ~253: `linkToDizionario(bullet)`) requires NO change -- the undefined `lang` parameter will default to `'it'` via the null-safe guard, which is correct since `formatNotesContent` is only called from IT document parsing context.

**Step 2: Add linkToDizionario filter calls to EN/FR document templates.**

The EN/FR templates currently use `| escapeHtml` where IT uses `| linkToDizionario`. Change them to match the IT pattern but with lang parameter.

In `en/src/pages/documents-primo-en.liquid`, find lines like:
```liquid
{%- assign docLabel = normalizedDoc | escapeHtml -%}
```
Change to:
```liquid
{%- assign docLabel = normalizedDoc | linkToDizionario: lang -%}
```

Apply the same change in all 4 EN/FR document templates:
- `en/src/pages/documents-primo-en.liquid` (line ~106: `docLabel`)
- `en/src/pages/documents-rinnovo-en.liquid` (lines ~121 `commonDocLabel` and ~139 `docLabel`)
- `fr/src/pages/documents-primo-fr.liquid` (line ~106: `docLabel`)
- `fr/src/pages/documents-rinnovo-fr.liquid` (lines ~121 `commonDocLabel` and ~139 `docLabel`)

Look at the IT templates for the exact pattern:
- IT `documents-primo.liquid` line ~102: `{%- assign docLabel = normalizedDoc | linkToDizionario -%}`
- IT `documents-rinnovo.liquid` line ~117: `{%- assign commonDocLabel = commonDocNormalized | linkToDizionario -%}`
- IT `documents-rinnovo.liquid` line ~135: `{%- assign docLabel = normalizedDoc | linkToDizionario -%}`

**Step 3: Update IT templates to also pass lang parameter.**

Update the existing IT template calls to pass `lang` for consistency:
- `src/pages/documents-primo.liquid`: `{{ normalizedDoc | linkToDizionario: lang }}`
- `src/pages/documents-rinnovo.liquid`: same pattern for both occurrences

This ensures IT templates explicitly pass `lang: 'it'` (from front matter) and the filter uses relative paths. Without this, IT templates rely on the null-safe default which works but is less explicit.

**No changes needed to eleventy.config.mjs filter registration.** The filter registration `eleventyConfig.addFilter("linkToDizionario", helpers.linkToDizionario)` already works with the additional parameter -- 11ty Liquid passes extra filter arguments as additional function parameters.

**Note on `| safe` filter:** After switching from `| escapeHtml` to `| linkToDizionario`, the output contains HTML anchor tags. Make sure the template renders the output with `| safe` (or without escaping) so the links render as clickable. Check how IT templates handle this -- they likely use `{{ docLabel | safe }}` or output it in a `safe` context. The EN/FR templates must do the same.
  </action>
  <verify>
  npm run build
  Then check EN and FR document pages for dizionario links:
  grep -l "dizionario.html#" _site/en/documenti-*-primo.html | head -3
  grep "dizionario.html#" _site/en/documenti-richiesta-asilo-primo.html | head -5
  grep "dizionario.html#" _site/fr/documenti-richiesta-asilo-primo.html | head -5
  Verify EN/FR links point to /dizionario.html# (absolute, not /en/dizionario.html#)
  Verify IT links still point to dizionario.html# (relative, no leading /)
  grep "dizionario.html#" _site/documenti-richiesta-asilo-primo.html | head -5
  </verify>
  <done>linkToDizionario filter is language-aware with null-safe default. EN/FR document templates now call the filter (they previously used escapeHtml only). EN/FR pages link to the IT dizionario page. IT pages continue to work as before.</done>
</task>

</tasks>

<verification>
1. dizionario-map.json has EN and FR term equivalents (~90+ terms total)
2. `npm run build` succeeds without errors
3. EN document pages contain links to `/dizionario.html#anchor` (IT dizionario, not EN)
4. FR document pages contain links to `/dizionario.html#anchor` (IT dizionario, not FR)
5. IT document pages still use relative `dizionario.html#anchor` (unchanged behavior)
6. Common terms like "Questura", "Nulla osta", "Kit postale" are linked in EN/FR pages
7. EN-specific terms like "Residence permit", "Revenue stamp" are also linked
8. formatNotesContent internal call still works (defaults to IT behavior via null-safe guard)
</verification>

<success_criteria>
- Dizionario links appear on EN and FR document pages for both Italian terms and translated equivalents
- All dizionario links point to the IT dizionario page (single source of truth)
- IT dizionario linking continues to work as before
- Internal calls to linkToDizionario without lang param default safely to IT
- Build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/53.1-tech-debt/53.1-05-SUMMARY.md`
</output>
