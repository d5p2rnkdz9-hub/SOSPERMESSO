---
phase: 53.1-tech-debt
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - _includes/components/header.liquid
  - _includes/components/nav.liquid
  - _includes/components/language-switcher.liquid
  - src/styles/components.css
  - src/styles/mobile.css
  - src/scripts/app.js
autonomous: false

must_haves:
  truths:
    - "Language switcher appears as a dropdown menu item in the main navigation bar"
    - "On mobile, language switcher is the FIRST item when hamburger menu opens"
    - "Clicking a language navigates to the equivalent page in that language"
    - "Current language is visually indicated in the switcher"
  artifacts:
    - path: "_includes/components/nav.liquid"
      provides: "Navigation with integrated language switcher as a dropdown item"
      contains: "language"
    - path: "_includes/components/header.liquid"
      provides: "Header without standalone language switcher"
    - path: "src/styles/components.css"
      provides: "CSS for language switcher as nav dropdown"
      contains: "language"
  key_links:
    - from: "_includes/components/nav.liquid"
      to: "Language switching URLs"
      via: "anchor hrefs with language prefix"
      pattern: "data-lang"
    - from: "src/scripts/app.js"
      to: "Language switcher event handlers"
      via: "JavaScript click handlers"
      pattern: "language"
---

<objective>
Move the language switcher from a standalone dropdown component into the main navigation bar as a proper dropdown menu item, with mobile-first positioning (first item in hamburger menu).

Purpose: The standalone language switcher is visually disconnected from the navigation. Integrating it makes the site feel more professional and makes language switching more discoverable, especially on mobile.
Output: Language switcher rendered as a nav dropdown item, positioned first on mobile, with proper styling for desktop hover and mobile tap.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53.1-tech-debt/53.1-CONTEXT.md
@_includes/components/nav.liquid
@_includes/components/header.liquid
@_includes/components/language-switcher.liquid
@_data/nav.js
@src/styles/components.css
@src/scripts/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate language switcher into nav as dropdown menu item</name>
  <files>_includes/components/nav.liquid, _includes/components/header.liquid, _includes/components/language-switcher.liquid, src/scripts/app.js</files>
  <action>
**1. Update nav.liquid to include language switcher as first dropdown item.**

The current nav.liquid iterates over `navData.dropdowns` to render nav items. Add a language dropdown BEFORE the data-driven dropdowns. This language item should:
- Show current language with flag emoji as the label (e.g., "IT" with flag)
- Dropdown shows all 3 languages: IT/EN/FR with flag emojis and full names
- Each language option links to the equivalent page in that language
- Use CSS class `nav-language` for targeted styling

**Only include IT, EN, and FR.** ES and ZH are intentionally excluded per user decision -- only implemented languages appear in the switcher. The old language-switcher.liquid had 5 languages (IT/EN/FR/ES/ZH) but ES/ZH are not implemented and should not be shown.

Language URL logic (must match existing hreflang logic in base.liquid):
- If current page is `/en/...`, IT version is same URL without `/en/` prefix, FR version replaces `/en/` with `/fr/`
- If current page is `/fr/...`, IT version removes `/fr/`, EN version replaces with `/en/`
- If current page is `/...` (IT), EN version adds `/en/` prefix, FR adds `/fr/`

Since this is a static site, use JavaScript to compute the target URLs at runtime based on `window.location.pathname`, OR use Liquid template variables (the hreflang logic already exists in base.liquid -- extract those variables and pass them).

**Preferred approach:** Use Liquid variables directly. Compute language URLs in nav.liquid using the same Liquid logic as base.liquid:

```liquid
{%- assign urlPrefix = page.url | slice: 0, 4 -%}
{%- if urlPrefix == "/en/" -%}
  {%- assign langItUrl = page.url | replace_first: "/en/", "/" -%}
  {%- assign langEnUrl = page.url -%}
  {%- assign langFrUrl = "/fr" | append: langItUrl -%}
{%- elsif urlPrefix == "/fr/" -%}
  {%- assign langItUrl = page.url | replace_first: "/fr/", "/" -%}
  {%- assign langEnUrl = "/en" | append: langItUrl -%}
  {%- assign langFrUrl = page.url -%}
{%- else -%}
  {%- assign langItUrl = page.url -%}
  {%- assign langEnUrl = "/en" | append: page.url -%}
  {%- assign langFrUrl = "/fr" | append: page.url -%}
{%- endif -%}
```

Then render the language dropdown:
```liquid
<li class="nav-item has-dropdown nav-language">
  <a href="#" class="nav-link" aria-haspopup="true" aria-expanded="false">
    {% if lang == 'fr' %}FR{% elsif lang == 'en' %}EN{% else %}IT{% endif %}
  </a>
  <ul class="nav-dropdown" role="menu">
    <li role="none"><a href="{{ langItUrl }}" class="dropdown-link{% if lang == 'it' %} active-lang{% endif %}" role="menuitem">IT Italiano</a></li>
    <li role="none"><a href="{{ langEnUrl }}" class="dropdown-link{% if lang == 'en' %} active-lang{% endif %}" role="menuitem">EN English</a></li>
    <li role="none"><a href="{{ langFrUrl }}" class="dropdown-link{% if lang == 'fr' %} active-lang{% endif %}" role="menuitem">FR Fran&ccedil;ais</a></li>
  </ul>
</li>
```

**2. Remove standalone language-switcher from header.liquid.**

In `_includes/components/header.liquid`, remove the line:
```liquid
{% include "components/language-switcher.liquid" %}
```

Keep the language-switcher.liquid file for now (don't delete it), but it won't be included anywhere.

**3. Update app.js to remove old language switcher JavaScript.**

In `src/scripts/app.js`, there may be event handlers for the old `#language-toggle` and `#language-dropdown` elements. Remove or comment out these handlers since the new implementation uses standard nav dropdown behavior (CSS hover on desktop, tap on mobile) which is already handled by the existing nav dropdown code.

Search for and remove any code referencing:
- `language-toggle`
- `language-dropdown`
- `language-option`
- `language-switcher`
- `language-button`

The existing nav dropdown CSS (`.has-dropdown` hover behavior) and mobile nav toggle behavior will handle the language dropdown automatically since it uses the same HTML structure.
  </action>
  <verify>
  grep -n "language-switcher" _includes/components/header.liquid (should NOT match)
  grep -n "nav-language" _includes/components/nav.liquid (should match)
  grep -n "langItUrl\|langEnUrl\|langFrUrl" _includes/components/nav.liquid (should match)
  grep -c "Español\|中文" _includes/components/nav.liquid (should return 0 -- ES/ZH not included)
  </verify>
  <done>Language switcher is a dropdown item inside the nav menu, not a standalone component in the header. Only IT/EN/FR are shown (ES/ZH intentionally excluded). All 3 languages are listed with links to equivalent pages.</done>
</task>

<task type="auto">
  <name>Task 2: CSS for language switcher in nav + mobile-first positioning</name>
  <files>src/styles/components.css, src/styles/mobile.css</files>
  <action>
**1. Desktop styling (components.css):**

Add CSS for the `.nav-language` item that makes it visually distinct from other nav dropdowns:
- Slightly different appearance: maybe a globe icon or flag prefix
- Current language text shown as the dropdown trigger
- Active language in dropdown highlighted with a subtle background color
- Dropdown items show flag + language name

```css
/* Language switcher in nav */
.nav-language .nav-link {
  font-weight: 600;
  letter-spacing: 0.05em;
}

.nav-language .active-lang {
  background-color: rgba(255, 215, 0, 0.15);
  font-weight: 600;
}
```

**2. Mobile styling (mobile.css):**

On mobile (hamburger menu), the language switcher should appear as the FIRST item. Since it's rendered first in the HTML (before the data-driven dropdowns), it naturally appears first. Ensure:
- The language dropdown items are easily tappable (44px minimum touch target)
- Language options lay out horizontally as a row of buttons (not a dropdown) on mobile -- more compact and finger-friendly
- OR keep as a standard dropdown but with clear visual separation from the rest of the nav

Recommended mobile layout: render language options as a horizontal row of compact buttons at the TOP of the hamburger menu, above the nav dropdowns. Use CSS `order: -1` on `.nav-language` within the mobile nav to ensure it appears first even if DOM order changes.

```css
@media (max-width: 768px) {
  .nav-language {
    order: -1;
    width: 100%;
    border-bottom: 1px solid #eee;
    padding-bottom: 0.75rem;
    margin-bottom: 0.75rem;
  }

  /* Show language options as horizontal row on mobile */
  .nav-language .nav-dropdown {
    display: flex !important;
    flex-direction: row;
    gap: 0.5rem;
    position: static;
    box-shadow: none;
    background: transparent;
    padding: 0.5rem 0 0;
  }

  .nav-language .dropdown-link {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    background: var(--gray-light);
    font-size: 0.9rem;
    white-space: nowrap;
  }

  .nav-language .dropdown-link.active-lang {
    background: var(--taxi-yellow-light);
    font-weight: 600;
  }
}
```

**3. Remove old language-switcher CSS.**

Find and remove CSS rules for the old standalone language-switcher (`.language-switcher`, `.language-button`, `.language-dropdown`, `.language-option`) from components.css. These selectors are no longer used.
  </action>
  <verify>
  grep -n "nav-language" src/styles/components.css (should match new styles)
  grep -n "nav-language" src/styles/mobile.css (should match mobile styles)
  grep -n "\.language-switcher\b" src/styles/components.css (should NOT match -- old styles removed)
  </verify>
  <done>Language switcher is styled as a nav dropdown on desktop (hover to expand) and shows as a horizontal button row at the top of the hamburger menu on mobile. Old standalone language-switcher CSS is removed.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Language switcher moved from standalone dropdown into the main navigation bar. On desktop it appears as a nav dropdown. On mobile it appears as the first item in the hamburger menu with horizontal language buttons.</what-built>
  <how-to-verify>
    1. Run `npx @11ty/eleventy --serve` and open localhost
    2. Desktop: Verify the language dropdown appears in the nav bar. Hover to see IT/EN/FR options. Click one to navigate to the equivalent page.
    3. Mobile: Resize browser to mobile width (< 768px). Open hamburger menu. Verify language options appear at the TOP of the menu as horizontal buttons. Tap a language to switch.
    4. Check that the old standalone language-switcher dropdown is gone from the header.
    5. Test on a permit page (e.g., permesso-richiesta-asilo.html) to verify language switching works correctly from a detail page.
  </how-to-verify>
  <resume-signal>Type "approved" if the language switcher works correctly in both desktop and mobile views, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. Language switcher is a `<li class="nav-item has-dropdown nav-language">` inside nav.liquid
2. Header.liquid no longer includes language-switcher.liquid
3. On mobile, `.nav-language` appears first (order: -1)
4. Clicking a language navigates to the correct translated page
5. Current language is visually highlighted
6. Only IT/EN/FR shown (no ES/ZH)
</verification>

<success_criteria>
- Language switcher is inside the main nav (not standalone)
- Desktop: hover to see language options
- Mobile: language options visible at top of hamburger menu
- Navigation works correctly between IT/EN/FR on all page types
- Only implemented languages (IT/EN/FR) are shown
</success_criteria>

<output>
After completion, create `.planning/phases/53.1-tech-debt/53.1-03-SUMMARY.md`
</output>
