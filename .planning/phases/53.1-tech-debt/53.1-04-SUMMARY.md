---
phase: 53.1-tech-debt
plan: 04
subsystem: infra
tags: [11ty, sitemap, liquid, seo, multilingual, hreflang]

# Dependency graph
requires:
  - phase: 53-fr-page-generation
    provides: FR page generation pipeline and permitsFr/documentsFr data files
  - phase: 52-notion-database
    provides: EN/FR Notion databases with permits and documents data
provides:
  - 11ty-native sitemap-it.xml generated from permits/documents data (136 URLs)
  - 11ty-native sitemap-en.xml generated from permitsEn/documentsEn data (131 URLs)
  - 11ty-native sitemap-fr.xml generated from permitsFr/documentsFr data (121 URLs)
  - sitemap-index.xml pointing to all 3 language sitemaps
  - All sitemaps include correct hreflang alternates for IT/EN/FR
affects:
  - future language additions (add new sitemap-{lang}.liquid)
  - SEO phase (sitemap correctness)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Data-driven sitemap: iterate Notion data arrays (permits, documents.primo, documents.rinnovo) in Liquid templates instead of scanning filesystem"
    - "pages.11tydata.js non-.html permalink bypass: check if explicit permalink ends in non-.html to avoid overriding .xml permalinks"

key-files:
  created:
    - src/pages/sitemap-it.liquid
    - src/pages/sitemap-en.liquid
    - src/pages/sitemap-fr.liquid
    - src/pages/sitemap-index.liquid
  modified:
    - eleventy.config.mjs
    - src/pages/pages.11tydata.js

key-decisions:
  - "Data-driven over collection-driven: pagination templates use eleventyExcludeFromCollections: true so collectionApi.getAll() misses permit/document pages. Solution: iterate data arrays directly in templates."
  - "Static XML files deleted from root: no longer needed since 11ty generates them from templates"
  - "build:sitemap npm script kept but unused: scripts/build-sitemap.js preserved for reference"

patterns-established:
  - "Sitemap template pattern: use Liquid for-loops over permits/documents data arrays with explicit URL construction"
  - "pages.11tydata.js permalink bypass: if permalink is string and doesn't end in .html, pass through as-is"

# Metrics
duration: 9min
completed: 2026-02-19
---

# Phase 53.1 Plan 04: 11ty-Native Sitemap Templates Summary

**11ty data-driven sitemap templates (IT/EN/FR + index) replacing old build-sitemap.js script that produced src/pages/ URLs**

## Performance

- **Duration:** 9 min
- **Started:** 2026-02-19T10:22:24Z
- **Completed:** 2026-02-19T10:31:04Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Created 4 Liquid sitemap templates (sitemap-it.liquid, sitemap-en.liquid, sitemap-fr.liquid, sitemap-index.liquid) as part of 11ty build
- URLs now correct: no `src/pages/` prefix, homepage is `/`, all permit/document URLs at root or language prefix
- Each language sitemap includes hreflang alternates for IT/EN/FR with x-default pointing to IT
- sitemap-index.xml references all 3 language sitemaps
- Removed old static XML files from project root and passthrough copy config

## Task Commits

Each task was committed atomically:

1. **Task 1: Create 11ty sitemap templates for IT, EN, FR + sitemap index** - `b82a564` (feat)
2. **Task 2: Clean up old sitemap infrastructure** - `e2f204d` (chore)

## Files Created/Modified
- `src/pages/sitemap-it.liquid` - IT sitemap template iterating permits/documents data (136 URLs)
- `src/pages/sitemap-en.liquid` - EN sitemap template iterating permitsEn/documentsEn data (131 URLs)
- `src/pages/sitemap-fr.liquid` - FR sitemap template iterating permitsFr/documentsFr data (121 URLs)
- `src/pages/sitemap-index.liquid` - Sitemap index pointing to 3 language sitemaps
- `eleventy.config.mjs` - Removed sitemap-it/en/index.xml passthrough copies
- `src/pages/pages.11tydata.js` - Added bypass for non-.html explicit permalinks

## Decisions Made
- **Data-driven over collection-driven approach**: Initially tried `collectionApi.getAll()` with language filters, but discovered that pagination templates (`permits.liquid`, etc.) use `eleventyExcludeFromCollections: true` which excludes all their generated pages from collections. Solution: iterate the Notion data arrays directly (`permits`, `documents.primo`, etc.) in sitemap templates for complete coverage.
- **Static XML files deleted**: Root-level `sitemap-it.xml`, `sitemap-en.xml`, `sitemap-index.xml` deleted since they're now generated by 11ty and passthrough copy was removed.
- **scripts/build-sitemap.js preserved**: Kept for reference per plan spec, but `build:sitemap` npm script no longer needed for normal builds.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Collection approach didn't include paginated pages**
- **Found during:** Task 1 (initial build verification)
- **Issue:** `collectionApi.getAll()` only returned 16 IT pages instead of ~136 because pagination templates use `eleventyExcludeFromCollections: true`, excluding all permit/document pages from collections
- **Fix:** Replaced collection-based approach with data-driven approach: iterate `permits`, `documents.primo`, `documents.rinnovo` etc. directly in Liquid templates
- **Files modified:** src/pages/sitemap-it.liquid, sitemap-en.liquid, sitemap-fr.liquid
- **Verification:** IT sitemap has 136 URLs, no src/pages/ contamination
- **Committed in:** b82a564 (Task 1 commit)

**2. [Rule 2 - Missing Critical] pages.11tydata.js overrides sitemap permalink**
- **Found during:** Task 1 (design review before first build)
- **Issue:** pages.11tydata.js computes `${data.page.fileSlug}.html` for all non-pagination pages, which would override `permalink: sitemap-it.xml` to `sitemap-it.html`
- **Fix:** Added bypass: if front matter permalink is a string not ending in `.html`, return it as-is
- **Files modified:** src/pages/pages.11tydata.js
- **Verification:** Build generates sitemap-it.xml, sitemap-en.xml, sitemap-fr.xml, sitemap-index.xml at correct paths
- **Committed in:** b82a564 (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (1 bug, 1 missing critical)
**Impact on plan:** Both required redesigning the approach but the outcome (correct sitemaps) matches plan objectives exactly.

## Issues Encountered
- Collection-based sitemap approach is inherently incompatible with 11ty pagination templates that use `eleventyExcludeFromCollections: true`. Data-driven approach is more reliable and self-consistent with the existing page generation architecture.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Sitemaps are now generated correctly as part of `npm run build`
- Adding a new language requires creating `sitemap-{lang}.liquid` and adding it to `sitemap-index.liquid`
- No blockers

---
*Phase: 53.1-tech-debt*
*Completed: 2026-02-19*
