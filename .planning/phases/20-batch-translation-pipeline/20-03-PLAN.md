---
phase: 20-batch-translation-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["20-01", "20-02"]
files_modified:
  - scripts/translate-batch.js
  - en/index.html
  - en/src/pages/*.html
autonomous: false

must_haves:
  truths:
    - "Running `npm run translate:en` translates all 208 pages"
    - "All translated pages pass verification with no errors"
    - "Internal links point to /en/ versions"
    - "lang='en' attribute set on all pages"
  artifacts:
    - path: "scripts/translate-batch.js"
      provides: "Complete translation script with Batch API"
      contains: "messages.batches.create"
    - path: "en/index.html"
      provides: "Translated homepage"
      contains: "lang=\"en\""
    - path: "scripts/translation-manifest.json"
      provides: "Manifest tracking all translations"
      contains: "totalTranslated"
  key_links:
    - from: "scripts/translate-batch.js"
      to: "Anthropic API"
      via: "@anthropic-ai/sdk"
      pattern: "anthropic.messages.batches"
    - from: "scripts/translate-batch.js"
      to: "scripts/verify-translation.js"
      via: "exec or require"
      pattern: "verify"
---

<objective>
Implement Anthropic Batch API integration and execute full translation of all 208 pages.

Purpose: This is the core translation execution - connecting to Claude's Batch API, processing all pages in chunks, handling results, and producing the complete EN site.

Output: All 208 pages translated to EN in /en/ directory, passing verification, with manifest updated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-batch-translation-pipeline/20-RESEARCH.md
@.planning/phases/20-batch-translation-pipeline/20-01-SUMMARY.md
@.planning/phases/20-batch-translation-pipeline/20-02-SUMMARY.md

# Verification script to run after translation
@scripts/verify-translation.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Anthropic Batch API integration</name>
  <files>scripts/translate-batch.js</files>
  <action>
Add Anthropic Batch API integration following the research patterns:

```javascript
const Anthropic = require('@anthropic-ai/sdk');
const pLimit = require('p-limit');
const cliProgress = require('cli-progress');

// Initialize client (uses ANTHROPIC_API_KEY env var)
const anthropic = new Anthropic();

const BATCH_SIZE = 50;  // Pages per batch
const MODEL = 'claude-sonnet-4-5-20250514';
const MAX_TOKENS = 8192;

/**
 * Create translation batch request
 */
function createBatchRequest(pages, systemPrompt) {
  return pages.map(page => ({
    custom_id: page.filename,
    params: {
      model: MODEL,
      max_tokens: MAX_TOKENS,
      system: systemPrompt,
      messages: [{
        role: 'user',
        content: JSON.stringify({
          filename: page.filename,
          title: page.metadata.title,
          description: page.metadata.description,
          segments: page.segments.map(s => ({
            id: s.id,
            text: s.text
          }))
        })
      }]
    }
  }));
}

/**
 * Submit batch and poll for completion
 */
async function processBatch(requests, batchNumber, totalBatches) {
  console.log(`\nSubmitting batch ${batchNumber}/${totalBatches} (${requests.length} pages)...`);

  const batch = await anthropic.messages.batches.create({ requests });
  console.log(`Batch ID: ${batch.id}`);

  // Poll for completion
  const pollInterval = 30000; // 30 seconds
  const maxWait = 60 * 60 * 1000; // 1 hour max
  const startTime = Date.now();

  while (true) {
    const status = await anthropic.messages.batches.retrieve(batch.id);

    if (status.processing_status === 'ended') {
      console.log(`Batch ${batchNumber} completed!`);
      return batch.id;
    }

    if (Date.now() - startTime > maxWait) {
      throw new Error(`Batch ${batch.id} timed out after 1 hour`);
    }

    const elapsed = Math.round((Date.now() - startTime) / 1000);
    process.stdout.write(`\rWaiting... ${elapsed}s (status: ${status.processing_status})`);
    await new Promise(r => setTimeout(r, pollInterval));
  }
}

/**
 * Retrieve and process batch results
 */
async function retrieveResults(batchId) {
  const results = [];

  for await (const result of await anthropic.messages.batches.results(batchId)) {
    if (result.result.type === 'succeeded') {
      try {
        const content = result.result.message.content[0].text;
        const parsed = JSON.parse(content);
        results.push({
          filename: result.custom_id,
          segments: parsed.segments || parsed,
          title: parsed.title,
          description: parsed.description,
          success: true
        });
      } catch (e) {
        results.push({
          filename: result.custom_id,
          error: `Parse error: ${e.message}`,
          success: false
        });
      }
    } else {
      results.push({
        filename: result.custom_id,
        error: result.result.error?.message || 'Unknown error',
        success: false
      });
    }
  }

  return results;
}
```

Key implementation notes:
- Use claude-sonnet-4-5 (latest, best quality/cost)
- 50 pages per batch (safe under limits)
- 30-second polling interval
- 1-hour timeout per batch
- Parse JSON response carefully with error handling
  </action>
  <verify>
Test with single file first:
```bash
# Set API key
export ANTHROPIC_API_KEY="your-key-here"

# Test single file translation
node scripts/translate-batch.js --file src/pages/chi-siamo.html --output-dir /tmp/test-en

# Check output
cat /tmp/test-en/chi-siamo.html | grep 'lang="en"'
```
  </verify>
  <done>Single file translation works, produces valid EN HTML with lang="en"</done>
</task>

<task type="auto">
  <name>Task 2: Implement full batch translation with progress</name>
  <files>scripts/translate-batch.js</files>
  <action>
Add the main translation orchestration:

```javascript
/**
 * Main translation function
 */
async function translateAll(options = {}) {
  const { force = false, batchSize = BATCH_SIZE, dryRun = false } = options;

  // 1. Build system prompt
  console.log('Loading glossary and building prompt...');
  const systemPrompt = await buildSystemPrompt();

  // 2. Discover pages
  console.log('Discovering pages...');
  const allPages = await discoverPages();
  console.log(`Found ${allPages.length} pages`);

  // 3. Load manifest and filter
  const manifest = await loadManifest();
  const pagesToTranslate = force
    ? allPages
    : allPages.filter(p => needsTranslation(p, manifest));

  console.log(`${pagesToTranslate.length} pages need translation`);

  if (dryRun) {
    console.log('\nDry run - pages that would be translated:');
    pagesToTranslate.slice(0, 20).forEach(p => console.log(`  - ${p.filename}`));
    if (pagesToTranslate.length > 20) {
      console.log(`  ... and ${pagesToTranslate.length - 20} more`);
    }
    return;
  }

  if (pagesToTranslate.length === 0) {
    console.log('All pages up to date!');
    return;
  }

  // 4. Extract segments from all pages
  console.log('\nExtracting segments...');
  const progressBar = new cliProgress.SingleBar({
    format: 'Extracting |{bar}| {percentage}% | {value}/{total} pages'
  }, cliProgress.Presets.shades_classic);

  progressBar.start(pagesToTranslate.length, 0);

  const preparedPages = [];
  for (const page of pagesToTranslate) {
    const html = await fs.readFile(page.filepath, 'utf-8');
    const { $, segments, metadata } = extractSegments(html);
    preparedPages.push({
      ...page,
      $,
      segments,
      metadata,
      html
    });
    progressBar.increment();
  }
  progressBar.stop();

  // 5. Process in batches
  const batches = [];
  for (let i = 0; i < preparedPages.length; i += batchSize) {
    batches.push(preparedPages.slice(i, i + batchSize));
  }

  console.log(`\nProcessing ${batches.length} batches...`);

  let successCount = 0;
  let errorCount = 0;

  for (let i = 0; i < batches.length; i++) {
    const batch = batches[i];
    const requests = createBatchRequest(batch, systemPrompt);

    try {
      const batchId = await processBatch(requests, i + 1, batches.length);
      const results = await retrieveResults(batchId);

      // Write translated files
      for (const result of results) {
        const page = batch.find(p => p.filename === result.filename);
        if (!page) continue;

        if (result.success) {
          await writeTranslatedPage(page, result, manifest);
          successCount++;
        } else {
          console.error(`\nError translating ${result.filename}: ${result.error}`);
          errorCount++;
        }
      }

      // Save manifest after each batch
      await saveManifest(manifest);

    } catch (e) {
      console.error(`\nBatch ${i + 1} failed: ${e.message}`);
      errorCount += batch.length;
    }
  }

  // 6. Summary
  console.log('\n========================================');
  console.log('  TRANSLATION COMPLETE');
  console.log('========================================');
  console.log(`Successful: ${successCount}`);
  console.log(`Errors: ${errorCount}`);
  console.log(`Manifest updated: scripts/translation-manifest.json`);

  // 7. Run verification
  console.log('\nRunning verification...');
  const { execSync } = require('child_process');
  try {
    execSync('node scripts/verify-translation.js', { stdio: 'inherit' });
  } catch (e) {
    console.log('Verification found issues - review output above');
  }
}

/**
 * Write translated page to EN directory
 */
async function writeTranslatedPage(page, result, manifest) {
  // Reload cheerio from original HTML
  const $ = cheerio.load(page.html, { decodeEntities: false });

  // Re-extract to get markers
  extractSegments(page.html); // This adds data-translate-id markers

  // Reassemble with translations
  const translatedHtml = reassembleHtml(
    cheerio.load(page.html, { decodeEntities: false }),
    result.segments,
    { title: result.title, description: result.description }
  );

  // Transform links
  const $translated = cheerio.load(translatedHtml, { decodeEntities: false });
  transformLinks($translated);

  // Apply glossary post-processing
  let finalHtml = $translated.html();
  finalHtml = applyGlossaryPostProcess(finalHtml);

  // Write to EN directory
  const outputPath = path.join(__dirname, '../en/src/pages', page.filename);
  await fs.mkdir(path.dirname(outputPath), { recursive: true });
  await fs.writeFile(outputPath, finalHtml, 'utf-8');

  // Update manifest
  manifest.pages[page.filename] = {
    translated: new Date().toISOString(),
    sourceMtime: page.mtime
  };
  manifest.meta.totalTranslated = Object.keys(manifest.pages).length;
  manifest.meta.lastRun = new Date().toISOString();
}
```
  </action>
  <verify>
```bash
# Translate small batch first (5 pages)
node scripts/translate-batch.js --batch-size 5 --max-pages 5

# Check results
ls -la en/src/pages/ | head -10
node scripts/verify-translation.js 2>&1 | tail -20
```
  </verify>
  <done>Batch translation works for small batch, produces valid EN pages that pass verification</done>
</task>

<task type="auto">
  <name>Task 3: Execute full translation and verify</name>
  <files>en/index.html, en/src/pages/*.html, scripts/translation-manifest.json</files>
  <action>
Execute complete translation:

```bash
# Run full translation (will take 1-2 hours due to batch processing)
npm run translate:en

# Or with explicit batch size
npm run translate:en -- --batch-size 50
```

Also translate the root index.html:
- Read `index.html` from root
- Apply same translation process
- Write to `en/index.html`

After completion:
1. Run verification script
2. Fix any issues reported
3. Commit translated pages

Expected output structure:
```
en/
├── index.html                    # Translated homepage
└── src/
    └── pages/
        ├── database.html         # 1 of 208
        ├── chi-siamo.html
        ├── documenti-questura.html
        ├── permesso-*.html       # ~67 permit pages
        ├── documenti-*.html      # ~100 document pages
        └── ...                   # All 208 pages
```
  </action>
  <verify>
```bash
# Count translated pages
find en/src/pages -name "*.html" | wc -l
# Should be 208

# Run verification
node scripts/verify-translation.js
# Should pass with no errors (warnings OK)

# Check manifest
cat scripts/translation-manifest.json | grep totalTranslated
# Should show 208

# Spot check a few pages
grep 'lang="en"' en/src/pages/database.html
grep 'residence permit' en/src/pages/permesso-studio.html
```
  </verify>
  <done>All 208 pages translated, verification passes, manifest shows 208 pages</done>
</task>

</tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete EN translation of all 208 pages using AI batch translation</what-built>
  <how-to-verify>
1. Open `en/src/pages/database.html` in browser
   - Verify page displays correctly
   - Check all permit names are in English
   - Click a few links - should go to EN pages

2. Open `en/src/pages/permesso-studio.html` in browser
   - Verify content is in English
   - Check that "permesso di soggiorno" appears as "residence permit"
   - Verify navigation links work

3. Run verification script:
```bash
node scripts/verify-translation.js
```
   - Should show mostly green checks
   - Warnings are OK, errors need fixing

4. Check a random document page:
   - `en/src/pages/documenti-studio-primo.html`
   - Checklist should be in English
   - "Documenti necessari" should be "Required documents"

5. Verify homepage:
   - Open `en/index.html`
   - All sections should be in English
  </how-to-verify>
  <resume-signal>Type "approved" if translations look good, or describe specific issues to fix</resume-signal>
</task>

<verification>
Run these commands to verify plan completion:

```bash
# 1. All pages translated
find en/src/pages -name "*.html" | wc -l
# Expected: 208

# 2. Verification passes
node scripts/verify-translation.js 2>&1 | grep -E "^(Total|Passed|Failed)"

# 3. Manifest updated
cat scripts/translation-manifest.json | grep -E "(totalTranslated|lastRun)"

# 4. Lang attribute correct
grep -l 'lang="it"' en/src/pages/*.html | wc -l
# Expected: 0 (no Italian lang)

grep -l 'lang="en"' en/src/pages/*.html | wc -l
# Expected: 208

# 5. Key terms translated
grep -c "residence permit" en/src/pages/database.html
# Expected: > 0
```
</verification>

<success_criteria>
- [ ] Anthropic Batch API integration working
- [ ] Single file translation test passes
- [ ] All 208 pages translated to EN
- [ ] All pages have lang="en" attribute
- [ ] Verification script passes with no errors
- [ ] Internal links point to EN pages
- [ ] Manifest tracks all 208 translations
- [ ] Homepage (en/index.html) translated
- [ ] User approves quality spot-check
</success_criteria>

<output>
After completion, create `.planning/phases/20-batch-translation-pipeline/20-03-SUMMARY.md`
</output>
