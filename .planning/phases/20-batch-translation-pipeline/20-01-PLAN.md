---
phase: 20-batch-translation-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/translate-batch.js
  - scripts/translation-manifest.json
  - scripts/templates/translation-prompt.txt
  - package.json
autonomous: true

user_setup:
  - service: anthropic
    why: "Claude API for translation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys"

must_haves:
  truths:
    - "Running `node scripts/translate-batch.js --help` shows usage"
    - "Manifest file can be loaded and saved"
    - "Translation prompt includes all glossary terms"
  artifacts:
    - path: "scripts/translate-batch.js"
      provides: "Main translation script skeleton"
      min_lines: 100
    - path: "scripts/translation-manifest.json"
      provides: "Empty manifest structure"
      contains: "translated"
    - path: "scripts/templates/translation-prompt.txt"
      provides: "System prompt for Claude"
      contains: "residence permit"
    - path: "package.json"
      provides: "New dependencies and npm script"
      contains: "translate:en"
  key_links:
    - from: "scripts/translate-batch.js"
      to: "scripts/translation-glossary.json"
      via: "require/import"
      pattern: "translation-glossary"
    - from: "scripts/translate-batch.js"
      to: "scripts/translation-manifest.json"
      via: "loadManifest/saveManifest functions"
      pattern: "manifest"
---

<objective>
Create the translation script infrastructure with manifest tracking, glossary integration, and CLI interface.

Purpose: Establish the foundation that Plans 02 and 03 will build upon. Without this infrastructure, we cannot track progress or maintain consistency.

Output: Working script skeleton with manifest system, installed dependencies, npm script, and translation prompt.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-batch-translation-pipeline/20-RESEARCH.md

# Existing assets to integrate with
@scripts/translation-glossary.json
@scripts/build-permits.js (manifest pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create npm script</name>
  <files>package.json</files>
  <action>
Install required dependencies:
```bash
npm install @anthropic-ai/sdk cheerio p-limit cli-progress
```

Add npm script to package.json:
```json
"scripts": {
  "translate:en": "node scripts/translate-batch.js"
}
```

Use the exact versions from research: @anthropic-ai/sdk (latest), cheerio ^1.0.0, p-limit ^5.0.0, cli-progress ^3.12.0
  </action>
  <verify>
```bash
npm ls @anthropic-ai/sdk cheerio p-limit cli-progress
npm run translate:en -- --help 2>&1 | head -5
```
  </verify>
  <done>All 4 dependencies installed, `npm run translate:en -- --help` runs without "module not found" errors</done>
</task>

<task type="auto">
  <name>Task 2: Create translation script skeleton with CLI and manifest</name>
  <files>scripts/translate-batch.js, scripts/translation-manifest.json</files>
  <action>
Create `scripts/translate-batch.js` following the pattern from `build-permits.js`:

1. **CLI interface** with these flags:
   - `--help`: Show usage
   - `--dry-run`: List pages without translating
   - `--force`: Ignore manifest, retranslate all
   - `--batch-size N`: Pages per batch (default 50)
   - `--file path`: Translate single file for testing
   - `--show-prompt`: Display the populated translation prompt
   - `--test-extract path`: Reserved for Plan 02 (segment extraction test)
   - `--test-links path`: Reserved for Plan 02 (link transformation test)
   - `--test-reassemble path`: Reserved for Plan 02 (HTML reassembly test)

2. **Manifest functions** (copy pattern from build-permits.js):
   - `loadManifest()`: Load from scripts/translation-manifest.json
   - `saveManifest(manifest)`: Save updated manifest
   - `needsTranslation(page, manifest)`: Check source mtime vs manifest

3. **Page discovery**:
   - Scan `src/pages/*.html` for all IT pages
   - Filter out redirect pages (check for meta refresh)
   - Return array of { filename, filepath, mtime }

4. **Main entry point**:
   - Parse CLI args
   - Load manifest
   - Discover pages
   - Log summary: "Found X pages, Y need translation"
   - Exit with placeholder for actual translation

5. **Test mode flags** (flags recognized but NOT implemented yet):
   - `--test-extract`: Log "Test extract mode - will be implemented in Plan 02"
   - `--test-links`: Log "Test links mode - will be implemented in Plan 02"
   - `--test-reassemble`: Log "Test reassemble mode - will be implemented in Plan 02"

   NOTE: These flags are defined in the CLI parser and documented in --help, but Plan 02 will implement the actual handlers. This plan only ensures the flags are recognized.

Create `scripts/translation-manifest.json` with initial structure:
```json
{
  "meta": {
    "created": "2026-02-01",
    "lastRun": null,
    "totalTranslated": 0
  },
  "pages": {}
}
```

Header comment in translate-batch.js:
```javascript
/**
 * Batch Translation Script - Phase 20
 *
 * Translates all IT pages to EN using Anthropic Claude API.
 * Uses Message Batches API for 50% cost savings.
 *
 * Usage: npm run translate:en [options]
 * Options:
 *   --help            Show this help
 *   --dry-run         List pages without translating
 *   --force           Retranslate all pages
 *   --batch-size N    Pages per API batch (default: 50)
 *   --file path       Translate single file
 *   --show-prompt     Display populated translation prompt
 *   --test-extract    Test segment extraction (Plan 02)
 *   --test-links      Test link transformation (Plan 02)
 *   --test-reassemble Test HTML reassembly (Plan 02)
 */
```
  </action>
  <verify>
```bash
node scripts/translate-batch.js --help
node scripts/translate-batch.js --dry-run 2>&1 | head -20
cat scripts/translation-manifest.json
```
  </verify>
  <done>Script shows help with all flags documented, dry-run lists 208 pages, manifest file exists with meta structure</done>
</task>

<task type="auto">
  <name>Task 3: Create translation prompt template with glossary</name>
  <files>scripts/templates/translation-prompt.txt, scripts/translate-batch.js</files>
  <action>
Create `scripts/templates/translation-prompt.txt` with the system prompt for Claude:

```
You are a professional translator for SOS Permesso, a website helping immigrants understand Italian residence permits (permessi di soggiorno).

TASK: Translate the provided Italian text segments to English.

MANDATORY TERMINOLOGY - Use these exact translations:
{GLOSSARY_TERMS}

DO NOT TRANSLATE these terms (keep exactly as-is):
{DO_NOT_TRANSLATE}

RULES:
1. Translate ONLY the text content in the "text" field
2. Return JSON with the same structure, translated values
3. Preserve any HTML tags within text (e.g., <strong>, <em>, <a>)
4. For legal/bureaucratic terms, prioritize clarity over literal translation
5. Maintain a friendly, informative, accessible tone
6. Keep placeholders unchanged: {variable}, {{name}}, %s
7. Keep numbers, dates, and codes unchanged
8. URLs and email addresses remain unchanged

OUTPUT FORMAT:
Return a JSON array with translated segments:
[
  { "id": 0, "text": "translated text here" },
  { "id": 1, "text": "translated text here" }
]
```

In `translate-batch.js`, add function to load and populate the prompt:
```javascript
async function buildSystemPrompt() {
  const template = await fs.readFile(
    path.join(__dirname, 'templates/translation-prompt.txt'),
    'utf-8'
  );
  const glossary = require('./translation-glossary.json');

  const termsStr = Object.entries(glossary.terms)
    .map(([it, en]) => `- "${it}" -> "${en}"`)
    .join('\n');

  const doNotTranslateStr = glossary.doNotTranslate
    .map(t => `- ${t}`)
    .join('\n');

  return template
    .replace('{GLOSSARY_TERMS}', termsStr)
    .replace('{DO_NOT_TRANSLATE}', doNotTranslateStr);
}
```

Add a test command: `--show-prompt` to display the populated prompt.
  </action>
  <verify>
```bash
mkdir -p scripts/templates
node scripts/translate-batch.js --show-prompt 2>&1 | head -30
```
Verify output shows "residence permit" and "Questura" terms
  </verify>
  <done>Prompt template exists, --show-prompt displays glossary terms correctly substituted</done>
</task>

</tasks>

<verification>
Run these commands to verify plan completion:

```bash
# 1. Dependencies installed
npm ls @anthropic-ai/sdk cheerio p-limit cli-progress

# 2. npm script works
npm run translate:en -- --help

# 3. Script discovers pages
npm run translate:en -- --dry-run 2>&1 | grep "pages"

# 4. Manifest exists
cat scripts/translation-manifest.json | head -10

# 5. Prompt template works
npm run translate:en -- --show-prompt | grep -c "residence permit"

# 6. Test mode flags are recognized (but not implemented)
npm run translate:en -- --test-extract src/pages/chi-siamo.html 2>&1 | grep -i "plan 02"
```
</verification>

<success_criteria>
- [ ] 4 npm dependencies installed (@anthropic-ai/sdk, cheerio, p-limit, cli-progress)
- [ ] `npm run translate:en` script exists and runs
- [ ] Script accepts --help, --dry-run, --force, --batch-size, --file flags
- [ ] Script recognizes --test-extract, --test-links, --test-reassemble flags (documented for Plan 02)
- [ ] Manifest file created with meta structure
- [ ] Translation prompt template includes all 35+ glossary terms
- [ ] --show-prompt displays populated system prompt
</success_criteria>

<output>
After completion, create `.planning/phases/20-batch-translation-pipeline/20-01-SUMMARY.md`
</output>
