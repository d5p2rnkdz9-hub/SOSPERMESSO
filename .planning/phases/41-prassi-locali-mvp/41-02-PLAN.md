---
phase: 41-prassi-locali-mvp
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - netlify/functions/submit-prassi.js
  - netlify/functions/vote-prassi.js
  - netlify.toml
autonomous: true
user_setup:
  - service: notion
    why: "Same NOTION_API_KEY already in use. PRASSI_DB_ID needed for submission target."
    env_vars:
      - name: PRASSI_DB_ID
        source: "Same as Plan 01 setup — the Prassi Locali Notion database ID"

must_haves:
  truths:
    - "POST to /.netlify/functions/submit-prassi creates a Notion page with Status=Pending"
    - "POST to /.netlify/functions/vote-prassi increments vote count on Notion page"
    - "Both endpoints return proper CORS headers"
    - "Invalid input returns 400 with error message"
  artifacts:
    - path: "netlify/functions/submit-prassi.js"
      provides: "Form submission endpoint creating Notion pages"
      min_lines: 40
    - path: "netlify/functions/vote-prassi.js"
      provides: "Voting endpoint updating Notion page counts"
      min_lines: 30
  key_links:
    - from: "netlify/functions/submit-prassi.js"
      to: "Notion API"
      via: "@notionhq/client pages.create"
      pattern: "notion\\.pages\\.create"
    - from: "netlify/functions/vote-prassi.js"
      to: "Notion API"
      via: "@notionhq/client pages.update"
      pattern: "notion\\.pages\\.update"
---

<objective>
Create the two Netlify Functions that power the dynamic layer of the Prassi Locali feature: form submission (creating Notion pages) and voting (updating vote counts in Notion).

Purpose: These serverless endpoints handle user interactions that require server-side processing -- creating new submissions in Notion for moderation, and updating vote counts. Client-side localStorage prevents casual duplicate voting; server-side rate limiting can be added later if abuse occurs.

Output: Two Netlify Functions (`submit-prassi.js`, `vote-prassi.js`), Netlify config updated. No new npm dependencies (uses existing @notionhq/client).
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/41-prassi-locali-mvp/41-CONTEXT.md
@.planning/phases/41-prassi-locali-mvp/41-RESEARCH.md
@netlify.toml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Netlify Functions for submission and voting</name>
  <files>netlify/functions/submit-prassi.js, netlify/functions/vote-prassi.js</files>
  <action>
**Step 1: Create `netlify/functions/` directory**

**Step 2: Create `netlify/functions/submit-prassi.js`**
Netlify Functions v2.0 (Web Platform API — `export default async (req, context)`).

The function must:
- Only accept POST method (return 405 for others)
- Handle OPTIONS for CORS preflight (return 204 with CORS headers)
- Parse JSON body: `{ city, description, date, category, pageUrl, pageSlug }`
- Validate required fields: `city` (non-empty string), `description` (string, min 20 chars)
- Validate `city` against the 105 questura cities list (hardcoded array). If not in list, return 400.
- Create Notion page in PRASSI_DB_ID database with properties:
  - "Citta": title type, value = city
  - "Descrizione": rich_text type, value = description
  - "Data esperienza": date type, value = date (optional, null if not provided)
  - "Categoria": rich_text type, value = category (optional, empty if not provided)
  - "Pagina": url type, value = pageUrl
  - "Slug pagina": rich_text type, value = pageSlug
  - "Status": select type, value = "Pending"
  - "Voti Confermo": number type, value = 0
  - "Voti Non Confermo": number type, value = 0
- Return 200 with `{ success: true, id: response.id }` on success
- Return 400 with `{ error: "message" }` for validation failures
- Return 500 with `{ error: "Failed to submit" }` for Notion API errors
- ALL responses must include CORS headers:
  ```
  'Content-Type': 'application/json',
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type'
  ```
- Use `import { Client } from "@notionhq/client"` (ESM — Netlify Functions v2.0 uses ESM)
- Include the full QUESTURA_CITIES array (105 cities from research)

**Step 3: Create `netlify/functions/vote-prassi.js`**
Netlify Functions v2.0, simple Notion update (no external rate limiting).

The function must:
- Only accept POST method (return 405 for others)
- Handle OPTIONS for CORS preflight
- Parse JSON body: `{ id, voteType }` where voteType is "confermo" or "non_confermo"
- Validate: `id` must be non-empty string, `voteType` must be one of the two values
- Fetch current page from Notion to get current count
- Increment the appropriate property ("Voti Confermo" or "Voti Non Confermo")
- Update Notion page with new count
- Return 200 with `{ success: true, newCount, voteType }`
- Return 400 for invalid input, 500 for Notion errors
- ALL responses include CORS headers (same as submit function)
- Import: `import { Client } from "@notionhq/client"`

Note: Duplicate vote prevention is handled client-side via localStorage (Plan 41-03). Server-side rate limiting (e.g., Upstash Redis) can be added in a future phase if abuse occurs.
  </action>
  <verify>
Check files exist and have correct structure:
- `ls netlify/functions/submit-prassi.js netlify/functions/vote-prassi.js`
- `grep -c "export default" netlify/functions/submit-prassi.js` should be 1
- `grep -c "pages.update" netlify/functions/vote-prassi.js` should be >= 1
- `grep -c "Access-Control-Allow-Origin" netlify/functions/submit-prassi.js` should be >= 2
  </verify>
  <done>Both Netlify Functions exist with proper validation, CORS headers, and Notion integration.</done>
</task>

<task type="auto">
  <name>Task 2: Update Netlify config for Functions</name>
  <files>netlify.toml</files>
  <action>
**Step 1: Update `netlify.toml`**
Add the Netlify Functions directory configuration. Add after the `[build]` section:

```toml
# Netlify Functions configuration
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
```

The `node_bundler = "esbuild"` ensures ESM imports work correctly in Netlify Functions v2.0.

Do NOT add environment variables to netlify.toml (they contain secrets — user sets them in Netlify dashboard).

No new npm dependencies needed — @notionhq/client is already installed.
  </action>
  <verify>
- `grep "directory" netlify.toml` should show `netlify/functions`
- `grep "node_bundler" netlify.toml` should show `esbuild`
  </verify>
  <done>netlify.toml has functions directory configured.</done>
</task>

</tasks>

<verification>
1. `netlify/functions/submit-prassi.js` exists with Notion page creation
2. `netlify/functions/vote-prassi.js` exists with Notion vote updates
3. Both functions handle CORS preflight (OPTIONS method)
4. Both functions validate input and return appropriate error codes
5. netlify.toml has functions directory configuration
6. No new npm dependencies required (@notionhq/client already installed)
</verification>

<success_criteria>
- Two Netlify Functions ready for deployment
- City validation against 105 questura cities
- CORS headers on all responses
- Netlify config updated for functions directory
- Client-side localStorage handles duplicate vote prevention (Plan 41-03)
</success_criteria>

<output>
After completion, create `.planning/phases/41-prassi-locali-mvp/41-02-SUMMARY.md`
</output>
