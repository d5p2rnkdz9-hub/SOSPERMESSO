---
phase: 41-prassi-locali-mvp
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - netlify/functions/submit-prassi.js
  - netlify/functions/vote-prassi.js
  - package.json
  - netlify.toml
autonomous: true
user_setup:
  - service: upstash
    why: "Serverless Redis for rate limiting votes (stateless functions need external storage)"
    env_vars:
      - name: UPSTASH_REDIS_REST_URL
        source: "Create free Upstash Redis database at console.upstash.com. Copy REST URL from database details page."
      - name: UPSTASH_REDIS_REST_TOKEN
        source: "Same Upstash database details page. Copy REST Token."
    dashboard_config:
      - task: "Create Redis database"
        location: "console.upstash.com > Create Database > Choose region (eu-west-1 for Italy)"
  - service: notion
    why: "Same NOTION_API_KEY already in use. PRASSI_DB_ID needed for submission target."
    env_vars:
      - name: PRASSI_DB_ID
        source: "Same as Plan 01 setup — the Prassi Locali Notion database ID"

must_haves:
  truths:
    - "POST to /.netlify/functions/submit-prassi creates a Notion page with Status=Pending"
    - "POST to /.netlify/functions/vote-prassi increments vote count on Notion page"
    - "Vote endpoint rate limits by IP (max 5 per 60 seconds)"
    - "Both endpoints return proper CORS headers"
    - "Invalid input returns 400 with error message"
  artifacts:
    - path: "netlify/functions/submit-prassi.js"
      provides: "Form submission endpoint creating Notion pages"
      min_lines: 40
    - path: "netlify/functions/vote-prassi.js"
      provides: "Rate-limited voting endpoint updating Notion page counts"
      min_lines: 50
  key_links:
    - from: "netlify/functions/submit-prassi.js"
      to: "Notion API"
      via: "@notionhq/client pages.create"
      pattern: "notion\\.pages\\.create"
    - from: "netlify/functions/vote-prassi.js"
      to: "Upstash Redis"
      via: "@upstash/ratelimit"
      pattern: "ratelimit\\.limit"
    - from: "netlify/functions/vote-prassi.js"
      to: "Notion API"
      via: "@notionhq/client pages.update"
      pattern: "notion\\.pages\\.update"
---

<objective>
Create the two Netlify Functions that power the dynamic layer of the Prassi Locali feature: form submission (creating Notion pages) and voting (rate-limited vote counting).

Purpose: These serverless endpoints handle user interactions that require server-side processing -- creating new submissions in Notion for moderation, and updating vote counts with abuse prevention. Without these, users can view but not contribute or vote.

Output: Two Netlify Functions (`submit-prassi.js`, `vote-prassi.js`), npm dependencies installed, Netlify config updated.
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/41-prassi-locali-mvp/41-CONTEXT.md
@.planning/phases/41-prassi-locali-mvp/41-RESEARCH.md
@netlify.toml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Netlify Functions for submission and voting</name>
  <files>netlify/functions/submit-prassi.js, netlify/functions/vote-prassi.js</files>
  <action>
**Step 1: Create `netlify/functions/` directory**

**Step 2: Create `netlify/functions/submit-prassi.js`**
Netlify Functions v2.0 (Web Platform API — `export default async (req, context)`).

The function must:
- Only accept POST method (return 405 for others)
- Handle OPTIONS for CORS preflight (return 204 with CORS headers)
- Parse JSON body: `{ city, description, date, category, pageUrl, pageSlug }`
- Validate required fields: `city` (non-empty string), `description` (string, min 20 chars)
- Validate `city` against the 105 questura cities list (hardcoded array). If not in list, return 400.
- Create Notion page in PRASSI_DB_ID database with properties:
  - "Citta": title type, value = city
  - "Descrizione": rich_text type, value = description
  - "Data esperienza": date type, value = date (optional, null if not provided)
  - "Categoria": rich_text type, value = category (optional, empty if not provided)
  - "Pagina": url type, value = pageUrl
  - "Slug pagina": rich_text type, value = pageSlug
  - "Status": select type, value = "Pending"
  - "Voti Confermo": number type, value = 0
  - "Voti Non Confermo": number type, value = 0
- Return 200 with `{ success: true, id: response.id }` on success
- Return 400 with `{ error: "message" }` for validation failures
- Return 500 with `{ error: "Failed to submit" }` for Notion API errors
- ALL responses must include CORS headers:
  ```
  'Content-Type': 'application/json',
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type'
  ```
- Use `import { Client } from "@notionhq/client"` (ESM — Netlify Functions v2.0 uses ESM)
- Include the full QUESTURA_CITIES array (105 cities from research)

**Step 3: Create `netlify/functions/vote-prassi.js`**
Netlify Functions v2.0 with Upstash rate limiting.

The function must:
- Only accept POST method (return 405 for others)
- Handle OPTIONS for CORS preflight
- Parse JSON body: `{ id, voteType }` where voteType is "confermo" or "non_confermo"
- Validate: `id` must be non-empty string, `voteType` must be one of the two values
- Rate limit by IP using `@upstash/ratelimit`:
  - Get IP from `req.headers.get('x-forwarded-for')` or `context.ip` or 'unknown'
  - Sliding window: 5 votes per 60 seconds per IP
  - Combine with per-prassi-id key: `${ip}:${id}` to prevent voting on same item repeatedly
  - If rate limited, return 429 with `{ error: "Troppi voti. Riprova tra poco.", remaining: 0 }`
- Also check localStorage bypass prevention:
  - Add a second rate limit key per-item per-IP: `vote:${ip}:${id}` with limit 1 per 24 hours (one vote per item per day per IP)
  - If already voted on this item today, return 429 with `{ error: "Hai gia votato per questa segnalazione oggi.", alreadyVoted: true }`
- Fetch current page from Notion to get current count
- Increment the appropriate property ("Voti Confermo" or "Voti Non Confermo")
- Update Notion page with new count
- Return 200 with `{ success: true, remaining, newCount, voteType }`
- ALL responses include CORS headers (same as submit function)
- Import: `import { Client } from "@notionhq/client"`, `import { Ratelimit } from "@upstash/ratelimit"`, `import { Redis } from "@upstash/redis"`
  </action>
  <verify>
Check files exist and have correct structure:
- `ls netlify/functions/submit-prassi.js netlify/functions/vote-prassi.js`
- `grep -c "export default" netlify/functions/submit-prassi.js` should be 1
- `grep -c "Ratelimit" netlify/functions/vote-prassi.js` should be >= 1
- `grep -c "Access-Control-Allow-Origin" netlify/functions/submit-prassi.js` should be >= 2
  </verify>
  <done>Both Netlify Functions exist with proper validation, CORS headers, Notion integration, and rate limiting.</done>
</task>

<task type="auto">
  <name>Task 2: Install dependencies and update Netlify config</name>
  <files>package.json, netlify.toml</files>
  <action>
**Step 1: Install Upstash dependencies**
Run: `npm install @upstash/redis @upstash/ratelimit`

These are the only new dependencies. @notionhq/client is already installed.

**Step 2: Update `netlify.toml`**
Add the Netlify Functions directory configuration. Add after the `[build]` section:

```toml
# Netlify Functions configuration
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
```

The `node_bundler = "esbuild"` ensures ESM imports work correctly in Netlify Functions v2.0.

Do NOT add environment variables to netlify.toml (they contain secrets — user sets them in Netlify dashboard).
  </action>
  <verify>
- `grep "@upstash/redis" package.json` should match
- `grep "@upstash/ratelimit" package.json` should match
- `grep "directory" netlify.toml` should show `netlify/functions`
- `npm ls @upstash/redis @upstash/ratelimit` should show installed versions
  </verify>
  <done>Dependencies installed, netlify.toml has functions directory configured.</done>
</task>

</tasks>

<verification>
1. `netlify/functions/submit-prassi.js` exists with Notion page creation
2. `netlify/functions/vote-prassi.js` exists with Upstash rate limiting
3. Both functions handle CORS preflight (OPTIONS method)
4. Both functions validate input and return appropriate error codes
5. @upstash/redis and @upstash/ratelimit in package.json dependencies
6. netlify.toml has functions directory configuration
7. `npm install` succeeds without errors
</verification>

<success_criteria>
- Two Netlify Functions ready for deployment
- Rate limiting configured (5 votes/min + 1 vote/item/day per IP)
- City validation against 105 questura cities
- CORS headers on all responses
- Dependencies installed and config updated
</success_criteria>

<output>
After completion, create `.planning/phases/41-prassi-locali-mvp/41-02-SUMMARY.md`
</output>
