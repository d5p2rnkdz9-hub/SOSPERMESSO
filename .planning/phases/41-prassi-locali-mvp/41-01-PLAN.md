---
phase: 41-prassi-locali-mvp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - _data/prassiLocali.js
  - src/pages/documents-primo.liquid
  - src/pages/documents-rinnovo.liquid
  - src/styles/prassi.css
autonomous: true
user_setup:
  - service: notion
    why: "Prassi Locali database for storing/fetching community submissions"
    env_vars:
      - name: PRASSI_DB_ID
        source: "Create a new Notion database called 'Prassi Locali' in the SOS Permesso workspace. Properties: Citta (title), Descrizione (rich_text), Data esperienza (date), Categoria (rich_text), Pagina (url), Slug pagina (rich_text), Status (select: Pending/Approved/Rejected), Voti Confermo (number), Voti Non Confermo (number). Copy the database ID from the URL."

must_haves:
  truths:
    - "Document pages display a 'Prassi locali' section after main content"
    - "Approved practices appear grouped by city at build time"
    - "Empty state shows encouraging message with call-to-action button"
    - "Section has anchor link accessible from page header"
    - "Build succeeds with empty prassi data (graceful degradation)"
  artifacts:
    - path: "_data/prassiLocali.js"
      provides: "Fetch approved practices from Notion, grouped by page slug"
      exports: ["module.exports (async function)"]
    - path: "src/styles/prassi.css"
      provides: "Styles for prassi section, city groups, practice cards"
      min_lines: 50
  key_links:
    - from: "_data/prassiLocali.js"
      to: "Notion API (PRASSI_DB_ID)"
      via: "@notionhq/client search + JS filter"
      pattern: "notion\\.search"
    - from: "src/pages/documents-primo.liquid"
      to: "prassiLocali data"
      via: "11ty data access in template"
      pattern: "prassiLocali"
---

<objective>
Create the static core of the Prassi Locali feature: an 11ty data file that fetches approved practices from Notion at build time, and display sections in the document page templates showing practices grouped by city.

Purpose: This is the foundation for the entire prassi locali MVP. Approved content is baked into pages at build time (static-first architecture). Without this, there's nothing to display, nothing to vote on, and nowhere to add new submissions.

Output: `_data/prassiLocali.js` data file + "Prassi locali" section in both document templates + CSS styles.
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-prassi-locali-mvp/41-CONTEXT.md
@.planning/phases/41-prassi-locali-mvp/41-RESEARCH.md
@_data/documents.js
@src/pages/documents-primo.liquid
@src/pages/documents-rinnovo.liquid
@eleventy.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prassiLocali.js data file</name>
  <files>_data/prassiLocali.js</files>
  <action>
Create `_data/prassiLocali.js` following the exact same pattern as `_data/documents.js`:
- CommonJS format (`module.exports = async function()`)
- Graceful degradation: if `NOTION_API_KEY` or `PRASSI_DB_ID` not set, return empty object `{}`
- Use `@notionhq/client` to fetch all pages from the prassi database
- Use `notion.search()` with JS-side filtering (same pattern as documents.js — Notion Search API doesn't support property filtering)
- Filter pages where `parent.database_id === PRASSI_DB_ID` or `parent.data_source_id === PRASSI_DB_ID`
- Filter for `Status` select property === "Approved" only (never expose Pending or Rejected)
- Extract properties: id, city (Citta title), description (Descrizione rich_text), date (Data esperienza date), category (Categoria rich_text), pageSlug (Slug pagina rich_text), votiConfermo (Voti Confermo number), votiNonConfermo (Voti Non Confermo number)
- Group results by `pageSlug` into an object: `{ "attesa-occupazione": [practice1, practice2], "lavoro-subordinato": [...] }`
- Within each slug group, sub-group by city: `{ "attesa-occupazione": { "Torino": [p1, p2], "Milano": [p3] } }`
- Sort cities alphabetically within each group
- Log counts: `[prassiLocali.js] Fetched N approved practices for M document pages`
- Return the nested object (empty object `{}` if no results)
  </action>
  <verify>
Run `node -e "require('./_data/prassiLocali.js')().then(d => console.log('Keys:', Object.keys(d).length, 'Type:', typeof d))"` — should output "Keys: 0 Type: object" when no PRASSI_DB_ID is set (graceful degradation).
  </verify>
  <done>Data file exists, returns grouped object structure, handles missing env vars gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Add prassi locali section to document page templates</name>
  <files>src/pages/documents-primo.liquid, src/pages/documents-rinnovo.liquid, src/styles/prassi.css, eleventy.config.mjs</files>
  <action>
**Step 1: Add prassi.css passthrough in eleventy.config.mjs**
No change needed — `src/styles` is already a passthrough directory.

**Step 2: Create `src/styles/prassi.css`**
Styles for the prassi locali section. Must match the existing design system (CSS variables from main.css). Include:
- `.prassi-section` — container with off-white background, max-width 700px (matches document content)
- `.prassi-anchor-link` — styled anchor link for the page header jump link. Use the existing `.quick-switch-link` pattern for consistency.
- `.prassi-city-group` — city grouping with city name as heading
- `.prassi-card` — individual practice card. Use `.card` base pattern from components.css (white bg, border-radius, subtle shadow). Add a left border accent in `var(--accent-teal)`.
- `.prassi-card-description` — practice text, line-height 1.6
- `.prassi-card-meta` — date and category in small gray text
- `.prassi-card-votes` — vote counts display area (will be enhanced in Plan 03)
- `.prassi-empty-state` — centered text with encouraging message, uses muted colors
- `.prassi-submit-btn` — "Aggiungi la tua esperienza" button. Use `.btn-primary` pattern (yellow gradient). This button will trigger the modal (added in Plan 03).
- Mobile responsive styles for all of the above at 768px and 480px breakpoints

**Step 3: Update `src/pages/documents-primo.liquid`**
After the document notes section (or after the checklist section if no notes), add:

1. An anchor link in the page header section (below the "Vedi anche: Rinnovo" link):
```liquid
<a href="#prassi-locali" class="prassi-anchor-link">Prassi locali della tua Questura</a>
```

2. The prassi locali section before the footer:
```liquid
<!-- PRASSI LOCALI -->
<section class="section prassi-section" id="prassi-locali">
  <div class="container" style="max-width: 700px;">
    <h2 style="text-align: center; margin-bottom: 0.5rem;">Prassi locali</h2>
    <p style="text-align: center; color: var(--gray-medium); margin-bottom: 1.5rem;">Esperienze condivise dalla community sulle pratiche delle Questure</p>

    {% assign pagePrassi = prassiLocali[doc.slug] %}
    {% if pagePrassi %}
      {% for cityGroup in pagePrassi %}
        <div class="prassi-city-group">
          <h3 class="prassi-city-name">{{ cityGroup[0] }}</h3>
          {% for practice in cityGroup[1] %}
            <div class="prassi-card" data-prassi-id="{{ practice.id }}">
              <p class="prassi-card-description">{{ practice.description }}</p>
              <div class="prassi-card-meta">
                {% if practice.date %}<span>{{ practice.date }}</span>{% endif %}
                {% if practice.category %}<span class="prassi-category-tag">{{ practice.category }}</span>{% endif %}
              </div>
              <div class="prassi-card-votes">
                <span class="vote-confermo">Confermo: {{ practice.votiConfermo }}</span>
                <span class="vote-non-confermo">Non confermo: {{ practice.votiNonConfermo }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    {% else %}
      <div class="prassi-empty-state">
        <p>Nessuna segnalazione ancora. Sei il primo a condividere la tua esperienza!</p>
        <button class="btn btn-primary prassi-submit-btn" onclick="openPrassiModal()">
          Aggiungi la tua esperienza
        </button>
      </div>
    {% endif %}

    {% if pagePrassi %}
      <div style="text-align: center; margin-top: 1.5rem;">
        <button class="btn btn-primary prassi-submit-btn" onclick="openPrassiModal()">
          Aggiungi la tua esperienza
        </button>
      </div>
    {% endif %}
  </div>
</section>
```

3. Add the prassi.css stylesheet link in the `<head>`:
```html
<link rel="stylesheet" href="../styles/prassi.css">
```

**Step 4: Update `src/pages/documents-rinnovo.liquid`**
Apply the exact same changes as documents-primo.liquid (anchor link, prassi section, CSS link). The rinnovo template has the same structure — place the section in the same position relative to footer.

**Important:** The `openPrassiModal()` function won't exist yet (Plan 03). That's fine — the button will be present but non-functional until Plan 03 adds the JS. The static display of existing practices will work immediately.
  </action>
  <verify>
Run `npm run build:11ty 2>&1 | tail -20` — build should complete without errors. Check that `_site/src/pages/documenti-*-primo.html` files contain "prassi-locali" section. Verify with: `grep -l "prassi-locali" _site/src/pages/documenti-*-primo.html | head -3`
  </verify>
  <done>Document pages have "Prassi locali" section with city-grouped display, empty state, anchor link in header, and styled with prassi.css. Build succeeds.</done>
</task>

</tasks>

<verification>
1. `_data/prassiLocali.js` exists and exports async function
2. Running without PRASSI_DB_ID returns empty object (no crash)
3. `npm run build:11ty` succeeds
4. Generated document pages contain prassi-locali section
5. Empty state message appears when no prassi data
6. prassi.css is included in document pages
7. Anchor link to prassi section exists in page header
</verification>

<success_criteria>
- Data file follows established documents.js pattern exactly
- Both primo and rinnovo templates have prassi section
- Build produces working pages with or without Notion data
- Styles match existing design system
</success_criteria>

<output>
After completion, create `.planning/phases/41-prassi-locali-mvp/41-01-SUMMARY.md`
</output>
