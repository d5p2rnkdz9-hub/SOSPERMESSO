---
phase: 40-permit-pages
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - src/pages/permits.liquid
  - eleventy.config.mjs
autonomous: false

must_haves:
  truths:
    - "Standard permit pages render with breadcrumb, header, Q&A sections with colored borders, document CTAs, related links, and footer"
    - "Placeholder permit pages show 'Contenuto in arrivo' card instead of Q&A sections"
    - "Variant parent pages show variant selection grid linking to child pages"
    - "Variant child pages show Q&A sections with back-link to parent page"
    - "Generated pages have same URLs as current static pages (permesso-*.html flat in src/pages/)"
    - "No permalink conflicts between template-generated and existing static permit pages"
  artifacts:
    - path: "src/pages/permits.liquid"
      provides: "Pagination template generating all permit pages"
      contains: "pagination"
    - path: "eleventy.config.mjs"
      provides: "Ignore patterns for old static permit HTML files"
      contains: "permesso-"
  key_links:
    - from: "src/pages/permits.liquid"
      to: "_data/permits.js"
      via: "pagination over permits data"
      pattern: "data: permits"
    - from: "src/pages/permits.liquid"
      to: "eleventy.config.mjs"
      via: "getSectionBorderColor filter usage"
      pattern: "getSectionBorderColor"
    - from: "eleventy.config.mjs"
      to: "src/pages/permesso-*.html"
      via: "ignores.add for old static files"
      pattern: "ignores.*permesso-"
---

<objective>
Create the Liquid pagination template that generates all permit pages from the permits data file, and handle permalink conflicts with existing static permit HTML files.

Purpose: This completes the Phase 40 migration. After this plan, permit pages are generated from Notion data via 11ty's data+template pipeline, matching Phase 39's pattern for document pages.

Output: `src/pages/permits.liquid` template + old file conflict resolution in eleventy.config.mjs
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-permit-pages/40-01-SUMMARY.md
@.planning/phases/39-document-pages/39-02-SUMMARY.md

Key source files for template structure:
@scripts/templates/permesso.js — HTML structure to replicate in Liquid (generatePermessoPage, generatePlaceholderPage, generateVariantParentPage, generateVariantChildPage)
@src/pages/permesso-studio.html — Example of current permit page with front matter (uses layout: layouts/base.liquid)
@src/pages/permesso-lavoro-subordinato.html — Example of current variant parent page
@src/pages/documents-primo.liquid — Phase 39 pagination template pattern (reference for pagination syntax)
@eleventy.config.mjs — Current config (needs ignore patterns added)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create permits.liquid template with conditional rendering</name>
  <files>src/pages/permits.liquid</files>
  <action>
Create `src/pages/permits.liquid` as a single pagination template that handles all permit page types.

CRITICAL DETAIL: Unlike document pages (which use `layout: false` with inline header/footer), permit pages use `layout: layouts/base.liquid`. This means the template should NOT include full HTML/head/body — just the page content that goes inside the base layout.

Front matter:
```yaml
---
pagination:
  data: permits
  size: 1
  alias: permit
permalink: "src/pages/permesso-{{ permit.slug }}.html"
layout: layouts/base.liquid
title: "Permesso per {{ permit.tipo }}"
lang: it
description: "Permesso di soggiorno per {{ permit.tipo }} - informazioni, requisiti, documenti e procedure"
eleventyExcludeFromCollections: true
---
```

The template body renders INSIDE base.liquid (which provides html, head, header, footer, scripts). The template should contain:

**1. BREADCRUMB section** (all page types):
```liquid
<!-- BREADCRUMB -->
<div class="breadcrumb-bar">
  <div class="container">
    <div class="breadcrumb-content">
      <div class="breadcrumb-nav">
        <a href="../../index.html">Home</a> &rarr;
        <a href="database.html">Database</a> &rarr;
        {% if permit.isVariantChild %}
          <a href="permesso-{{ permit.baseName | slugify }}.html">Permesso per {{ permit.baseName | escapeHtml }}</a> &rarr;
          <span>{{ permit.variantName | escapeHtml }}</span>
        {% else %}
          <span>Permesso per {{ permit.tipo | escapeHtml }}</span>
        {% endif %}
      </div>
      <a href="https://form.typeform.com/to/FsqvzdXI#page_url=https%3A%2F%2Fsospermesso.it%2Fsrc%2Fpages%2Fpermesso-{{ permit.slug }}.html"
         class="error-report-btn" target="_blank" rel="noopener noreferrer">
        Segnala errore
      </a>
    </div>
  </div>
</div>
```

NOTE: Use `&rarr;` entity (not `→` literal) for HTML arrows in breadcrumbs. Check the existing pages — the current ones use `→` directly in their HTML. Match whatever the existing pages use. Read permesso-studio.html to confirm.

**2. PAGE HEADER** (all page types):
```liquid
<section class="section bg-off-white">
  <div class="container">
    <div class="page-header text-center">
      <span class="page-icon" style="font-size: 4rem;">{{ permit.emoji }}</span>
      <h1 class="page-title">Permesso per {{ permit.tipo | escapeHtml }}</h1>
    </div>
  </div>
</section>
```

**3. CONDITIONAL BODY** — Use `{% if %}` / `{% elsif %}` / `{% else %}`:

**A) Variant Parent (permit.isVariantParent == true):**
- Info alert box explaining "informazioni comuni a tutte le tipologie"
- Default generic cards (Cos'e, Durata, Diritti) matching the content in generateVariantParentPage
- "Quale situazione ti interessa?" heading with grid of variant link cards
- Each variant card: `<a href="permesso-{{ variant.slug }}.html" class="card card-link">` with variant emoji and name

**B) Placeholder page (permit.isPlaceholder == true AND NOT isVariantParent):**
- "Contenuto in arrivo" card with emoji, message, and "Dai una mano" CTA button
- Matching the structure in generatePlaceholderPage

**C) Variant Child (permit.isVariantChild == true AND NOT isPlaceholder):**
- Back-to-parent link: `<a href="permesso-{{ permit.baseName | slugify }}.html">` with left arrow
- Info alert explaining "solo le informazioni specifiche per [variantName]"
- Q&A sections loop (same as standard)
- "Hai altre domande?" CTA

**D) Standard permit (default — has sections, not variant parent):**
- Document CTA buttons (primo rilascio + rinnovo)
- Q&A sections loop:
  ```liquid
  {% for section in permit.sections %}
    <div class="card" style="margin-bottom: 2rem; border-left: 4px solid {{ section.index | getSectionBorderColor: section.question }};">
      <h2>{{ section.question | escapeHtml }}</h2>
      {{ section.content }}
    </div>
  {% endfor %}
  ```
- "Hai altre domande?" CTA

**4. RELATED section** (all page types):
- Three cards: Tutti i permessi, Documenti Questura, Dizionario (matching current pages)

**5. Contact form container** (all page types):
```liquid
<div id="contact-form-container"></div>
<script>
  fetch('../components/contact-form.html')
    .then(response => response.text())
    .then(html => {
      document.getElementById('contact-form-container').innerHTML = html;
    });
</script>
```

IMPORTANT: The `slugify` filter used in breadcrumbs for variant child pages needs to work. Check if Liquid has a built-in slugify filter. If not, the baseName slug should be pre-computed in the data file and available as a field. Actually, looking at the data: variant children already have the parent slug available — the parent's slug IS `slugify(baseName)`. So in the data file, we should ensure variant children have a `parentSlug` field (or compute it in the data file from baseName). If the data file from Plan 01 already puts baseName through slugify, use that. Otherwise, pre-compute `parentSlug` in permits.js for variant children and use `permit.parentSlug` in the template instead of `permit.baseName | slugify`.

MATCH THE EXACT HTML: Read the existing pages (permesso-studio.html for standard, permesso-lavoro-subordinato.html for variant parent) and ensure the template produces equivalent HTML structure. The content will be different (dynamic from Notion vs static), but the structural elements (class names, nesting, section order) must match.
  </action>
  <verify>
Run: `npx @11ty/eleventy --dryrun` — should complete without errors.
If NOTION_API_KEY is set and there are permits, verify a sample page generates:
`ls _site/src/pages/permesso-studio.html 2>/dev/null` (or whichever permit exists)
  </verify>
  <done>
permits.liquid template exists with pagination, conditional rendering for all 4 page types (standard, placeholder, variant parent, variant child), uses base layout
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle permalink conflicts with existing static permit files</name>
  <files>eleventy.config.mjs</files>
  <action>
The 66 existing static permit HTML files in src/pages/permesso-*.html have 11ty front matter (`layout: layouts/base.liquid`) and will conflict with the template-generated pages when NOTION_API_KEY is set (both try to write to the same permalink).

Add ignore patterns in eleventy.config.mjs to ignore ALL existing static permit HTML files, similar to how Phase 39 handled redirect page conflicts.

After the existing redirect ignore patterns (the `for` loop over `redirectSlugs`), add:

```javascript
// Ignore existing static permit HTML files (replaced by permits.liquid template)
// These files are old build-permits.js output that will be regenerated via pagination
const fs = require('fs');
const path = require('path');
try {
  const pagesDir = path.join(process.cwd(), 'src', 'pages');
  const files = fs.readdirSync(pagesDir);
  const permitFiles = files.filter(f => f.startsWith('permesso-') && f.endsWith('.html'));
  for (const file of permitFiles) {
    eleventyConfig.ignores.add(`src/pages/${file}`);
  }
  if (permitFiles.length > 0) {
    console.log(`[eleventy] Ignoring ${permitFiles.length} old static permit files (replaced by permits.liquid)`);
  }
} catch (e) {
  // Directory might not exist in some environments
}
```

This dynamically reads src/pages/ and ignores all permesso-*.html files, so only the template-generated pages are produced.

IMPORTANT: Use synchronous `fs.readdirSync` since the eleventy.config.mjs export function is synchronous. The `fs` and `path` requires need to use the createRequire pattern already established at the top of the file.

Actually, since eleventy.config.mjs is ESM, you need to either:
- Use `import fs from 'fs'` and `import path from 'path'` at the top (Node.js built-ins work with ESM import), OR
- Use the existing `createRequire` to require them

Choose whichever is cleaner. The createRequire is already set up, so `const fs = require('fs')` inside the function body will work (since `require` is already created via createRequire at the top of the file).

Alternative simpler approach: If you know the exact filenames, you could glob them. But the dynamic approach is more robust and matches the Phase 39 pattern.
  </action>
  <verify>
Run: `npx @11ty/eleventy --dryrun`
- Should complete without DuplicatePermalinkOutputError
- Should log the count of ignored permit files
If NOTION_API_KEY is set: `npx @11ty/eleventy` should build without conflicts
  </verify>
  <done>
All 66 existing static permit HTML files are ignored by 11ty, no permalink conflicts, build succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete permit page generation pipeline via 11ty: data file fetches from Notion, parses Q&A, detects variants; Liquid template renders 4 page types (standard, placeholder, variant parent, variant child); old static files ignored to prevent conflicts.
  </what-built>
  <how-to-verify>
1. Run `NOTION_API_KEY=your_key npx @11ty/eleventy` and confirm build completes
2. Open `_site/src/pages/permesso-studio.html` in browser — verify Q&A sections render with colored left borders, breadcrumb works, document CTA buttons present
3. Open a placeholder permit page (e.g., one listed in .planning/TODO-permits.md) — verify "Contenuto in arrivo" card shows
4. Open `_site/src/pages/permesso-lavoro-subordinato.html` — verify variant parent page shows variant selection grid
5. Open a variant child page — verify Q&A sections render with back-to-parent link
6. Compare any page side-by-side with current live version at sospermesso.it — structure should be equivalent
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `src/pages/permits.liquid` exists with pagination over `permits` data
2. `npx @11ty/eleventy` builds without errors or permalink conflicts
3. Generated permit pages have correct URLs: `src/pages/permesso-*.html`
4. Standard pages have Q&A sections with colored borders
5. Placeholder pages show "Contenuto in arrivo"
6. Variant parent pages show variant selection grid
7. Variant child pages have back-to-parent link and Q&A sections
</verification>

<success_criteria>
- permits.liquid generates all permit page types via 11ty pagination
- Generated pages match current page structure (classes, sections, layout)
- No permalink conflicts with old static files
- Build produces `permesso-*.html` files matching current URLs (PERM-04)
- User verifies visual parity with current pages
</success_criteria>

<output>
After completion, create `.planning/phases/40-permit-pages/40-02-SUMMARY.md`
</output>
