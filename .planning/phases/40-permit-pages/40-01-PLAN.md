---
phase: 40-permit-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - _data/permits.js
  - eleventy.config.mjs
autonomous: true

must_haves:
  truths:
    - "permits.js returns an array of permit objects with pre-parsed Q&A HTML when NOTION_API_KEY is set"
    - "permits.js returns empty array when NOTION_API_KEY is not set (graceful degradation)"
    - "Variant permits are detected and grouped — parent objects have isVariantParent:true and variants array"
    - "Variant child objects include parentSlug field for breadcrumb navigation links"
    - "Each Q&A section card renders with a keyword-matched or index-based colored left border"
  artifacts:
    - path: "_data/permits.js"
      provides: "Async data file returning array of parsed permit objects"
      exports: ["module.exports (async function)"]
    - path: "eleventy.config.mjs"
      provides: "getSectionBorderColor filter registration"
      contains: "getSectionBorderColor"
  key_links:
    - from: "_data/permits.js"
      to: "scripts/notion-client.js"
      via: "require for fetchPermitData and fetchPageBlocks"
      pattern: "require.*notion-client"
    - from: "_data/permits.js"
      to: "scripts/templates/helpers.js"
      via: "require for escapeHtml and linkToDizionario (called by the copied parsing functions)"
      pattern: "require.*helpers"
    - from: "eleventy.config.mjs"
      to: "Liquid templates"
      via: "addFilter registration"
      pattern: "addFilter.*getSectionBorderColor"
---

<objective>
Create the 11ty data file that fetches permit data from Notion, parses Q&A content into HTML, detects variant groups, and returns a structured array. Also register the getSectionBorderColor filter needed by the permit template.

Purpose: This is the data backbone for Phase 40. The data file replaces the fetch+parse logic from scripts/build-permits.js. Once this exists, the Liquid template (Plan 02) can render permit pages.

Output: `_data/permits.js` data file + `getSectionBorderColor` filter in eleventy.config.mjs
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-document-pages/39-01-SUMMARY.md

Key source files to read and adapt from:
@scripts/build-permits.js — Contains 9 parsing functions (lines 83-457) to copy into permits.js. See detailed function list below.
@scripts/notion-client.js — fetchPermitData() and fetchPageBlocks() to reuse via require
@scripts/templates/helpers.js — escapeHtml and linkToDizionario, required by the copied parsing functions (richTextToHtml calls these)
@scripts/templates/permesso.js — getSectionBorderColor function (lines 14-47) to register as 11ty filter
@_data/documents.js — Phase 39 pattern to follow for data file structure
@eleventy.config.mjs — Current config to add filter to
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create _data/permits.js data file</name>
  <files>_data/permits.js</files>
  <action>
Create `_data/permits.js` as a CommonJS async data file (matching _data/documents.js pattern).

The data file must:

1. **Import Notion API functions via require:**
   - From `scripts/notion-client.js`: `fetchPermitData`, `fetchPageBlocks`

2. **Import helper functions via require:**
   - From `scripts/templates/helpers.js`: `escapeHtml`, `linkToDizionario`

   These two helpers are used internally by the parsing functions below (specifically, `richTextToHtml` calls `escapeHtml` and `linkToDizionario`). They are NOT in build-permits.js — they live in helpers.js.

3. **Copy 9 parsing functions from scripts/build-permits.js into permits.js:**

   These functions live in build-permits.js but CANNOT be imported from it because build-permits.js has a side-effect `build().catch(...)` at the bottom that runs on require. Copy them directly:

   - `extractPlainText` (build-permits.js lines 83-88) — strips checkmarks, joins rich_text
   - `richTextToHtml` (build-permits.js lines 96-132) — converts Notion rich_text to HTML. Internally calls `escapeHtml` and `linkToDizionario` from helpers.js
   - `isQuestionBlock` (build-permits.js lines 143-168) — detects Q&A question blocks
   - `blockToHtml` (build-permits.js lines 176-249) — converts single Notion block to HTML
   - `groupAndRenderBlocks` (build-permits.js lines 256-302) — groups list items, renders blocks
   - `parseQASections` (build-permits.js lines 309-370) — parses blocks into Q&A sections
   - `slugify` (build-permits.js lines 377-384) — simple text-to-slug
   - `detectVariants` (build-permits.js lines 392-435) — groups "a seguito di" permits
   - `getEmojiForPermit` (build-permits.js lines 442-457) — keyword-based emoji

   Total: ~290 lines of function code. Copy them verbatim. The functions `richTextToHtml` and `blockToHtml` reference `escapeHtml` and `linkToDizionario` as free variables — these are satisfied by the require in step 2.

4. **Graceful degradation:** If NOTION_API_KEY is not set, log a warning and return empty array `[]`.

5. **Fetch permit pages from Notion:**
   - Use `fetchPermitData()` from notion-client.js to get all permit pages
   - This returns array of objects with: id, tipo, slug, primoDocuments, rinnovoDocuments, primoMethod, rinnovoMethod, docNotes, last_edited_time

6. **For each permit with a tipo:**
   - Fetch page blocks using `fetchPageBlocks(permit.id)` from notion-client.js
   - Parse Q&A sections using `parseQASections(blocks)`
   - Build permit object with: id, slug, tipo, emoji (from getEmojiForPermit), sections (array of {question, content, index}), isPlaceholder (true if no sections)
   - Add 350ms delay between permits for rate limiting
   - Log progress every 10 permits

7. **Detect variants:**
   - After processing all permits, call `detectVariants(permits)`
   - This returns `{ variantGroups, standalone }`
   - For each variantGroup with 2+ variants: create a synthetic parent object with `isVariantParent: true`, `baseName`, `slug` (from baseSlug), `tipo` (baseName), `emoji` (from getEmojiForPermit), and `variants` array
   - Mark each variant child with `isVariantChild: true`, `baseName`, `variantName`, and **`parentSlug`** (set to the group's `baseSlug` value from detectVariants)
   - Single-variant items go back to standalone

8. **Return flat array** combining: standalone permits + variant parents + variant children. This flat array is what the template will paginate over.

9. **Error handling:** Wrap entire function in try/catch. On error, log and return empty array.

The returned objects should have this shape:
```javascript
// Standard permit:
{ id, slug, tipo, emoji, sections: [{question, content, index}], isPlaceholder: bool }

// Variant parent (synthetic):
{ slug, tipo, emoji, isVariantParent: true, baseName, variants: [{slug, tipo, emoji, variantName}] }

// Variant child:
{ id, slug, tipo, emoji, sections: [...], isVariantChild: true, baseName, variantName, parentSlug, isPlaceholder: bool }
```

NOTE on parentSlug: This is critical for the Liquid template breadcrumbs. Liquid does not have a built-in `slugify` filter, so `permit.baseName | slugify` will NOT work in the template. Pre-computing `parentSlug` in the data file avoids this issue. Set it to the group's `baseSlug` (which is already computed by `detectVariants` using the `slugify` function).

NOTE on placeholder handling: Permits without Q&A content (empty page or no sections) should still be included in the array with `isPlaceholder: true`. This allows the template to render a "Contenuto in arrivo" page for them, matching existing behavior from build-permits.js.
  </action>
  <verify>
Run: `node -e "require('./_data/permits.js')().then(d => console.log('Count:', d.length, 'Parents:', d.filter(p=>p.isVariantParent).length, 'Children with parentSlug:', d.filter(p=>p.parentSlug).length))"`
- Without NOTION_API_KEY: should print "Count: 0 Parents: 0 Children with parentSlug: 0" and a warning
- With NOTION_API_KEY set: should print count of permits, variant parents, and children with parentSlug
Also verify: `npx @11ty/eleventy --dryrun` completes without errors
  </verify>
  <done>
_data/permits.js exists, exports async function, returns array of permit objects with pre-parsed Q&A HTML, handles graceful degradation, detects variants, variant children have parentSlug field
  </done>
</task>

<task type="auto">
  <name>Task 2: Register getSectionBorderColor filter in eleventy.config.mjs</name>
  <files>eleventy.config.mjs</files>
  <action>
Add the `getSectionBorderColor` filter to eleventy.config.mjs.

Read the current eleventy.config.mjs first. Then add the filter after the existing filter registrations (after the parseDocNotes filter block).

The filter implementation should be copied from scripts/templates/permesso.js lines 14-47 (the getSectionBorderColor function). Register it as:

```javascript
/**
 * getSectionBorderColor - Return border color for permit Q&A section cards
 * Based on question keywords, with index-based fallback for variety
 * Usage: {{ section.index | getSectionBorderColor: section.question }}
 */
eleventyConfig.addFilter("getSectionBorderColor", function(index, question) {
  const q = (question || '').toLowerCase();

  // Match by keywords first
  if (q.includes("cos'è") || q.includes("che cos'è") || q.includes("che cosa")) return 'var(--accent-blue)';
  if (q.includes('requisiti') || q.includes('chi può') || q.includes('chi puo')) return 'var(--taxi-yellow)';
  if (q.includes('lavorare') || q.includes('lavoro') || q.includes('diritti')) return 'var(--lighthouse-red)';
  if (q.includes('conversione') || q.includes('convertire')) return 'var(--accent-teal)';
  if (q.includes('durata') || q.includes('quanto dura')) return 'var(--accent-blue)';
  if (q.includes('costi') || q.includes('quanto costa')) return 'var(--accent-orange)';

  // Fallback by index for variety
  const colors = [
    'var(--accent-blue)',
    'var(--taxi-yellow)',
    'var(--lighthouse-red)',
    'var(--accent-teal)',
    'var(--accent-purple)',
    'var(--accent-orange)'
  ];
  return colors[index % colors.length];
});
```

Place this after the `parseDocNotes` filter registration and before the passthrough copy section.
  </action>
  <verify>
Run: `npx @11ty/eleventy --dryrun` — should complete without errors.
Verify the filter exists: `grep -n "getSectionBorderColor" eleventy.config.mjs` should show the registration.
  </verify>
  <done>
getSectionBorderColor filter registered in eleventy.config.mjs, build runs without errors
  </done>
</task>

</tasks>

<verification>
1. `_data/permits.js` exists and is a valid CommonJS module
2. Without NOTION_API_KEY: `node -e "require('./_data/permits.js')().then(d => console.log(d.length))"` prints 0
3. Variant child objects have `parentSlug` field set (not undefined)
4. `npx @11ty/eleventy --dryrun` completes without errors
5. `grep "getSectionBorderColor" eleventy.config.mjs` finds the filter
</verification>

<success_criteria>
- _data/permits.js fetches permit data + page blocks from Notion, parses Q&A to HTML, detects variants
- Variant children have parentSlug field pre-computed from detectVariants baseSlug
- getSectionBorderColor filter registered and usable in Liquid templates
- Build pipeline runs without errors (dryrun passes)
- Graceful degradation works (empty array when no API key)
</success_criteria>

<output>
After completion, create `.planning/phases/40-permit-pages/40-01-SUMMARY.md`
</output>
