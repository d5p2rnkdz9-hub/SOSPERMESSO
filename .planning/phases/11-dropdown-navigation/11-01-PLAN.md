---
phase: 11-dropdown-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/styles/components.css
  - src/styles/mobile.css
  - src/scripts/app.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "Desktop: hovering over Database/Guide/Test nav items shows dropdown menu"
    - "Desktop: dropdown shows correct sub-items for each menu category"
    - "Desktop: keyboard navigation (Tab/focus) also opens dropdowns"
    - "Mobile: hamburger menu shows all items as flat list (no nested dropdowns)"
    - "Dropdown styling matches existing header design (white background, teal text, shadows)"
  artifacts:
    - path: "src/styles/components.css"
      provides: "Desktop dropdown styles (.nav-dropdown, .has-dropdown, .dropdown-link)"
      contains: ".has-dropdown:hover .nav-dropdown"
    - path: "src/styles/mobile.css"
      provides: "Mobile flat list override for dropdowns"
      contains: "@media (max-width: 768px)"
    - path: "src/scripts/app.js"
      provides: "ARIA state management for dropdowns"
      contains: "aria-expanded"
    - path: "index.html"
      provides: "Template header with dropdown HTML structure"
      contains: "has-dropdown"
  key_links:
    - from: "index.html"
      to: "src/styles/components.css"
      via: ".has-dropdown and .nav-dropdown classes"
      pattern: "has-dropdown.*nav-dropdown"
    - from: "components.css"
      to: "mobile.css"
      via: "mobile override for .nav-dropdown position: static"
      pattern: "nav-dropdown.*position.*static"
---

<objective>
Implement core dropdown navigation functionality for Database, Guide, and Test menu items.

Purpose: Enable users to discover and access sub-pages directly from the navigation menu, improving information architecture and reducing clicks to reach content.

Output:
- Desktop hover dropdowns with smooth animations
- Mobile flat list navigation (no nested menus)
- ARIA accessibility attributes
- Template header in index.html ready for propagation
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-dropdown-navigation/11-RESEARCH.md

# Key reference files
@src/styles/components.css (language switcher pattern at lines 498-562)
@src/styles/mobile.css (existing mobile menu styles)
@src/scripts/app.js (mobile menu toggle logic at lines 9-34)
@index.html (current header structure at lines 28-83)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dropdown CSS styles</name>
  <files>
    src/styles/components.css
    src/styles/mobile.css
  </files>
  <action>
Add dropdown navigation styles to components.css after the language switcher section (around line 562):

**Desktop dropdown styles (in components.css):**
```css
/* ===============================================
   NAVIGATION DROPDOWNS
   =============================================== */

/* Parent item needs relative positioning */
.nav-item {
  position: relative;
}

.has-dropdown .nav-link {
  position: relative;
  padding-right: 1.75rem; /* Space for arrow */
}

/* Arrow indicator */
.has-dropdown .nav-link::after {
  content: '\25BE'; /* Down arrow */
  position: absolute;
  right: 0.25rem;
  font-size: 0.75rem;
  transition: transform var(--transition-base);
}

.has-dropdown:hover .nav-link::after,
.has-dropdown:focus-within .nav-link::after {
  transform: rotate(180deg);
}

/* Dropdown menu container */
.nav-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  background-color: var(--white);
  border: 1px solid var(--gray-light);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  min-width: 240px;
  padding: 0.5rem 0;
  margin-top: 0.25rem;
  list-style: none;

  /* Hidden by default */
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all var(--transition-base);
  z-index: var(--z-dropdown);
}

/* Show on hover AND focus-within (accessibility) */
.has-dropdown:hover .nav-dropdown,
.has-dropdown:focus-within .nav-dropdown {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

/* Dropdown links */
.dropdown-link {
  display: block;
  padding: 0.75rem 1.25rem;
  color: #1A6B5F;
  font-weight: 500;
  font-size: 1.125rem;
  text-decoration: none;
  transition: background-color var(--transition-fast), color var(--transition-fast);
}

.dropdown-link:hover,
.dropdown-link:focus {
  background-color: rgba(255, 215, 0, 0.15);
  color: var(--taxi-yellow-dark);
}
```

**Mobile overrides (add to mobile.css after existing nav-menu mobile styles):**
```css
/* Mobile dropdown - flat list instead of hover dropdown */
@media (max-width: 768px) {
  .nav-item {
    position: static; /* Remove relative positioning */
  }

  .has-dropdown .nav-link::after {
    display: none; /* Hide arrow on mobile */
  }

  .nav-dropdown {
    position: static;
    opacity: 1;
    visibility: visible;
    transform: none;
    box-shadow: none;
    border: none;
    background: transparent;
    padding: 0;
    margin: 0;
    min-width: unset;
  }

  .dropdown-link {
    padding: 0.75rem 1rem 0.75rem 2rem; /* Indent sub-items */
    font-size: 1rem;
    color: #1A6B5F;
  }

  .dropdown-link::before {
    content: '\2192 '; /* Arrow prefix */
    color: var(--taxi-yellow);
    font-weight: 600;
  }
}
```

IMPORTANT: Match existing design system values:
- Use var(--z-dropdown) for z-index (1000)
- Use var(--transition-base) for animations (250ms)
- Use #1A6B5F for teal text color
- Use var(--taxi-yellow) family for hover states
  </action>
  <verify>
Check CSS syntax:
1. Open components.css and mobile.css - no syntax errors
2. Verify .nav-dropdown and .has-dropdown classes exist
3. Verify mobile override uses @media (max-width: 768px)
  </verify>
  <done>
- Desktop dropdown styles added to components.css with hover + focus-within triggers
- Mobile flat list override added to mobile.css
- Arrow indicator rotates on hover
- Colors match existing header design (teal text, yellow hover)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update header HTML with dropdown structure</name>
  <files>
    index.html
  </files>
  <action>
Modify the nav-menu section in index.html (lines 44-49) to add dropdown structure.

**Current structure:**
```html
<ul class="nav-menu" id="nav-menu">
  <li><a href="#database" class="nav-link">Database</a></li>
  <li><a href="#guide" class="nav-link">Guide</a></li>
  <li><a href="#test" class="nav-link">Test</a></li>
  <li><a href="src/pages/chi-siamo.html" class="nav-link">Il progetto</a></li>
</ul>
```

**New structure with dropdowns:**
```html
<ul class="nav-menu" id="nav-menu">
  <!-- Database with dropdown -->
  <li class="nav-item has-dropdown">
    <a href="#database" class="nav-link" aria-haspopup="true" aria-expanded="false">Database</a>
    <ul class="nav-dropdown" role="menu">
      <li role="none"><a href="src/pages/database.html" class="dropdown-link" role="menuitem">Database di permessi</a></li>
      <li role="none"><a href="src/pages/documenti-questura.html" class="dropdown-link" role="menuitem">Che documenti porto in Questura</a></li>
    </ul>
  </li>

  <!-- Guide with dropdown -->
  <li class="nav-item has-dropdown">
    <a href="#guide" class="nav-link" aria-haspopup="true" aria-expanded="false">Guide</a>
    <ul class="nav-dropdown" role="menu">
      <li role="none"><a href="src/pages/protezione-internazionale.html" class="dropdown-link" role="menuitem">Protezione internazionale</a></li>
      <li role="none"><a href="src/pages/ricongiungimento-familiare.html" class="dropdown-link" role="menuitem">Ricongiungimento familiare</a></li>
      <li role="none"><a href="src/pages/dizionario.html" class="dropdown-link" role="menuitem">Dizionario</a></li>
    </ul>
  </li>

  <!-- Test with dropdown -->
  <li class="nav-item has-dropdown">
    <a href="#test" class="nav-link" aria-haspopup="true" aria-expanded="false">Test</a>
    <ul class="nav-dropdown" role="menu">
      <li role="none"><a href="https://form.typeform.com/to/kt7P9Ejk" class="dropdown-link" role="menuitem" target="_blank">Posso AVERE un permesso?</a></li>
      <li role="none"><a href="https://form.typeform.com/to/R7HY8nBp" class="dropdown-link" role="menuitem" target="_blank">Posso RINNOVARE il permesso?</a></li>
    </ul>
  </li>

  <!-- Il progetto - no dropdown -->
  <li class="nav-item"><a href="src/pages/chi-siamo.html" class="nav-link">Il progetto</a></li>
</ul>
```

**Key requirements:**
- NAV-01: Database has 2 items: "Database di permessi", "Che documenti porto in Questura"
- NAV-02: Guide has 3 items: "Protezione internazionale", "Ricongiungimento familiare", "Dizionario"
- NAV-03: Test has 2 items: "Posso AVERE un permesso?", "Posso RINNOVARE il permesso?"
- ARIA attributes: aria-haspopup="true", aria-expanded="false", role="menu", role="menuitem"
- External links (Typeform) get target="_blank"

**Path verification (FLAT structure - no subdirectories):**
All guide pages exist flat in src/pages/:
- src/pages/database.html (exists)
- src/pages/documenti-questura.html (exists)
- src/pages/protezione-internazionale.html (exists)
- src/pages/ricongiungimento-familiare.html (exists - may be named permesso-ricongiungimento-familiare.html)
- src/pages/dizionario.html (exists)

IMPORTANT: All pages are flat in src/pages/ - there are NO guide/ or documenti-questura/ subdirectories.
  </action>
  <verify>
1. Open index.html in browser
2. Desktop (>768px): Hover over Database - dropdown should appear with 2 items
3. Desktop: Hover over Guide - dropdown should appear with 3 items
4. Desktop: Hover over Test - dropdown should appear with 2 items
5. Verify all dropdown links are clickable and lead to correct pages (no 404s)
  </verify>
  <done>
- index.html has dropdown structure for Database, Guide, Test menu items
- Each dropdown has correct sub-items per requirements (NAV-01, NAV-02, NAV-03)
- ARIA attributes added for accessibility
- Parent links maintain anchor navigation (#database, #guide, #test)
- All paths use flat structure (src/pages/*.html, no subdirectories)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update mobile JS for flat list and ARIA states</name>
  <files>
    src/scripts/app.js
  </files>
  <action>
Add ARIA state management to app.js after the existing mobile menu toggle code (around line 34).

**Add this code:**
```javascript
// ===============================================
// DROPDOWN ARIA STATE MANAGEMENT
// ===============================================

// Update aria-expanded on hover (desktop only)
function initDropdownAria() {
  if (window.innerWidth > 768) {
    const dropdownParents = document.querySelectorAll('.has-dropdown');

    dropdownParents.forEach(parent => {
      const link = parent.querySelector('.nav-link');
      if (!link) return;

      // Mouse events
      parent.addEventListener('mouseenter', () => {
        link.setAttribute('aria-expanded', 'true');
      });

      parent.addEventListener('mouseleave', () => {
        link.setAttribute('aria-expanded', 'false');
      });

      // Keyboard support - focus within dropdown
      parent.addEventListener('focusin', () => {
        link.setAttribute('aria-expanded', 'true');
      });

      parent.addEventListener('focusout', (e) => {
        // Only close if focus leaves the entire dropdown parent
        if (!parent.contains(e.relatedTarget)) {
          link.setAttribute('aria-expanded', 'false');
        }
      });
    });
  }
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', initDropdownAria);

// Re-initialize on resize (in case viewport crosses 768px threshold)
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(initDropdownAria, 250);
});
```

**Also update the existing mobile menu code** to handle dropdown links:
In the nav link click handler section (around line 28), ensure dropdown links also close the mobile menu:

```javascript
// Close menu when clicking any link (nav-link OR dropdown-link)
navWrapper.querySelectorAll('.nav-link, .dropdown-link').forEach(link => {
  link.addEventListener('click', () => {
    navWrapper.classList.remove('active');
    menuToggle.textContent = '\u2630'; // Hamburger icon
  });
});
```

**Important notes:**
- This JS is enhancement only - dropdowns work with pure CSS, JS adds ARIA states
- Mobile flat list works without JS (CSS handles position: static)
- Debounce resize handler to avoid excessive re-initialization
  </action>
  <verify>
1. Open browser dev tools console - no JavaScript errors
2. Desktop: Hover over dropdown, inspect element - aria-expanded changes to "true"
3. Desktop: Move mouse away - aria-expanded changes back to "false"
4. Mobile: Open hamburger menu, click a dropdown link - menu closes
5. Tab through navigation with keyboard - dropdowns open on focus

**Combined CSS + JS verification:**
6. Desktop: Tab to "Database" nav item, verify:
   - CSS shows dropdown (opacity: 1, visibility: visible from :focus-within)
   - JS updates aria-expanded="true" (inspect in dev tools)
   - Both work together for accessible keyboard navigation
  </verify>
  <done>
- ARIA state management added for screen reader accessibility
- aria-expanded updates dynamically on hover/focus
- Mobile menu closes when clicking any link (including dropdown links)
- Keyboard navigation supported via :focus-within (CSS) + aria-expanded updates (JS)
- CSS and JS work together: CSS provides visual feedback, JS provides ARIA state
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Desktop dropdown test (NAV-04):**
   - Open index.html in browser at >768px viewport
   - Hover over "Database" - dropdown appears with 2 items
   - Hover over "Guide" - dropdown appears with 3 items
   - Hover over "Test" - dropdown appears with 2 items
   - Dropdowns have smooth fade-in animation
   - Arrow indicator rotates on hover

2. **Mobile flat list test (NAV-05):**
   - Resize browser to <768px or use mobile device
   - Click hamburger menu
   - All items visible as flat list (no hover dropdowns)
   - Sub-items indented with arrow prefix
   - Clicking any link closes the menu

3. **Styling consistency test (NAV-06):**
   - Dropdown background is white
   - Dropdown text is teal (#1A6B5F)
   - Hover state shows yellow background tint
   - Shadow matches existing language switcher dropdown

4. **Accessibility test:**
   - Tab through navigation - dropdowns open on focus
   - Inspect elements - aria-expanded changes appropriately

5. **Link integrity test:**
   - All dropdown links use flat paths (src/pages/*.html)
   - Click each link in dropdown - no 404 errors
</verification>

<success_criteria>
- [ ] NAV-01: Database dropdown has 2 items (Database di permessi, Che documenti porto in Questura)
- [ ] NAV-02: Guide dropdown has 3 items (Protezione internazionale, Ricongiungimento familiare, Dizionario)
- [ ] NAV-03: Test dropdown has 2 items (Posso AVERE un permesso?, Posso RINNOVARE il permesso?)
- [ ] NAV-04: Desktop dropdowns open on hover
- [ ] NAV-05: Mobile shows flat list in hamburger menu
- [ ] NAV-06: Dropdown styling consistent with header design
- [ ] Template header in index.html ready for propagation to all pages
- [ ] All paths are flat (no guide/ or documenti-questura/ subdirectories assumed)
</success_criteria>

<output>
After completion, create `.planning/phases/11-dropdown-navigation/11-01-SUMMARY.md`
</output>
