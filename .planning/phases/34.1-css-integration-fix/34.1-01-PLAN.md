---
phase: 34.1-css-integration-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/add-css-links.js
  - index.html
  - en/index.html
  - src/pages/*.html
  - en/src/pages/*.html
autonomous: true

must_haves:
  truths:
    - "Adding lang='ar' dir='rtl' to any HTML page causes RTL layout to apply"
    - "Adding lang='zh' to any HTML page causes CJK typography to apply"
    - "All 410 HTML pages include rtl.css and cjk.css link tags"
  artifacts:
    - path: "scripts/add-css-links.js"
      provides: "Batch HTML link injection script"
      min_lines: 50
    - path: "index.html"
      provides: "Root homepage with CSS links"
      contains: "rtl.css"
    - path: "en/index.html"
      provides: "EN homepage with CSS links"
      contains: "cjk.css"
  key_links:
    - from: "index.html"
      to: "src/styles/rtl.css"
      via: "link tag with correct relative path"
      pattern: 'href="src/styles/rtl.css"'
    - from: "en/src/pages/*.html"
      to: "src/styles/cjk.css"
      via: "link tag with correct relative path"
      pattern: 'href="../../../src/styles/cjk.css"'
---

<objective>
Link rtl.css and cjk.css to all HTML pages to activate RTL and CJK infrastructure.

Purpose: Phase 34 created the CSS files but they are dormant (not linked in any HTML). This plan makes the infrastructure functional by adding link tags to all 410 HTML pages.

Output: All pages load rtl.css and cjk.css, enabling RTL layout when `lang="ar" dir="rtl"` is set and CJK typography when `lang="zh"` is set.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34.1-css-integration-fix/34.1-RESEARCH.md

# Key existing patterns
@scripts/fix-en-paths.js
@scripts/translate-batch.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create script and add CSS links to all 410 HTML pages</name>
  <files>
    scripts/add-css-links.js
    index.html
    en/index.html
    src/pages/*.html (~204 files)
    en/src/pages/*.html (~204 files)
  </files>
  <action>
Create `scripts/add-css-links.js` following the established project patterns from fix-en-paths.js and translate-batch.js.

Script requirements:
1. Use Cheerio (already installed) for DOM-aware link insertion
2. Process 4 locations with correct relative paths:
   - `index.html` (root): use `src/styles/rtl.css` and `src/styles/cjk.css`
   - `src/pages/*.html` (IT pages): use `../styles/rtl.css` and `../styles/cjk.css`
   - `en/index.html`: use `../src/styles/rtl.css` and `../src/styles/cjk.css`
   - `en/src/pages/*.html` (EN pages): use `../../../src/styles/rtl.css` and `../../../src/styles/cjk.css`
3. Include idempotency check - skip files that already have rtl.css or cjk.css links
4. Insert links AFTER the last existing stylesheet link (before mobile-fix.css is fine, or after)
5. Use `cheerio.load(html, { decodeEntities: false })` to preserve HTML formatting
6. Log progress with file count summary

The research provides complete code at line 267-374 of 34.1-RESEARCH.md, but note the en/index.html path needs to be `../src/styles/` (verified from en/index.html line 20-24).

After creating the script, run it:
```bash
node scripts/add-css-links.js
```

Expected output: ~410 files processed (0 skipped on first run).
  </action>
  <verify>
1. Script creates successfully: `ls scripts/add-css-links.js`
2. Script runs without errors: `node scripts/add-css-links.js`
3. Check links added to root index.html:
   ```bash
   grep -E "(rtl|cjk)\.css" index.html
   ```
4. Check links added to IT page:
   ```bash
   grep -E "(rtl|cjk)\.css" src/pages/chi-siamo.html
   ```
5. Check links added to EN page:
   ```bash
   grep -E "(rtl|cjk)\.css" en/src/pages/chi-siamo.html
   ```
6. Check links added to en/index.html:
   ```bash
   grep -E "(rtl|cjk)\.css" en/index.html
   ```
7. Verify idempotency - running script again shows files skipped:
   ```bash
   node scripts/add-css-links.js  # Should show ~410 skipped
   ```
  </verify>
  <done>
- Script exists at `scripts/add-css-links.js`
- All 410 HTML files contain both rtl.css and cjk.css link tags
- Paths are correct for each file location (verified by grep showing expected path patterns)
- Script is idempotent (running twice shows all files skipped)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify RTL and CJK infrastructure end-to-end</name>
  <files>
    src/pages/chi-siamo.html (test file - temporary modification)
  </files>
  <action>
Test that the CSS infrastructure actually works end-to-end:

**Test 1: RTL Layout Application**
1. Create a temporary test by copying chi-siamo.html:
   ```bash
   cp src/pages/chi-siamo.html src/pages/test-rtl-temp.html
   ```
2. Modify test-rtl-temp.html to add `lang="ar" dir="rtl"` to the html tag
3. Open in browser (or use grep to verify the CSS would apply):
   - Text should flow right-to-left
   - Navigation should align to right
   - Breadcrumb arrows should flip direction
4. Verify rtl.css selectors match:
   ```bash
   grep -E '\[dir="rtl"\]|\[lang="ar"\]' src/styles/rtl.css | head -5
   ```

**Test 2: CJK Typography Application**
1. Create a temporary test:
   ```bash
   cp src/pages/chi-siamo.html src/pages/test-cjk-temp.html
   ```
2. Modify test-cjk-temp.html to add `lang="zh"` to the html tag
3. Verify cjk.css selectors match:
   ```bash
   grep -E '\[lang="zh"\]' src/styles/cjk.css | head -5
   ```

**Test 3: Verify CSS files load correctly**
1. Start a local server (if available) or verify paths work:
   ```bash
   ls -la src/styles/rtl.css src/styles/cjk.css
   ```
2. Verify relative paths resolve correctly from different locations

**Cleanup:**
Remove temporary test files:
```bash
rm -f src/pages/test-rtl-temp.html src/pages/test-cjk-temp.html
```

**Note:** Full visual browser testing should be done by user. This task verifies the wiring is correct at the file/CSS level.
  </action>
  <verify>
1. rtl.css contains `[dir="rtl"]` selectors:
   ```bash
   grep -c '\[dir="rtl"\]' src/styles/rtl.css
   ```
   Expected: > 0 matches

2. cjk.css contains `[lang="zh"]` selectors:
   ```bash
   grep -c '\[lang="zh"\]' src/styles/cjk.css
   ```
   Expected: > 0 matches

3. CSS files are linked in pages:
   ```bash
   grep -l "rtl.css" index.html src/pages/chi-siamo.html en/src/pages/chi-siamo.html | wc -l
   ```
   Expected: 3 files

4. No temporary test files remain:
   ```bash
   ls src/pages/test-*-temp.html 2>/dev/null || echo "No temp files - clean"
   ```
  </verify>
  <done>
- RTL selectors in rtl.css would apply when dir="rtl" is set
- CJK selectors in cjk.css would apply when lang="zh" is set
- CSS files are linked in all target HTML files
- No temporary test files remain
- Infrastructure is wired correctly (visual verification left to user)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Link count verification:**
   ```bash
   grep -l "rtl.css" index.html src/pages/*.html en/index.html en/src/pages/*.html 2>/dev/null | wc -l
   ```
   Expected: ~410 files

2. **Path pattern verification:**
   ```bash
   # Root index uses src/styles/
   grep 'href="src/styles/rtl.css"' index.html

   # IT pages use ../styles/
   grep 'href="../styles/rtl.css"' src/pages/chi-siamo.html

   # EN pages use ../../../src/styles/
   grep 'href="../../../src/styles/rtl.css"' en/src/pages/chi-siamo.html

   # EN index uses ../src/styles/
   grep 'href="../src/styles/rtl.css"' en/index.html
   ```

3. **Idempotency verification:**
   ```bash
   node scripts/add-css-links.js
   # Output should show 0 processed, ~410 skipped
   ```

4. **CSS selector existence:**
   ```bash
   grep -q '\[dir="rtl"\]' src/styles/rtl.css && echo "RTL selectors: OK"
   grep -q '\[lang="zh"\]' src/styles/cjk.css && echo "CJK selectors: OK"
   ```
</verification>

<success_criteria>
1. All 410 HTML pages include `<link rel="stylesheet" href="...rtl.css">` tag
2. All 410 HTML pages include `<link rel="stylesheet" href="...cjk.css">` tag
3. Paths are correct for each file location (4 different path patterns)
4. Script is idempotent (safe to run multiple times)
5. RTL and CJK CSS selectors exist and would apply when language attributes set
6. No broken paths or 404s when loading pages
</success_criteria>

<output>
After completion, create `.planning/phases/34.1-css-integration-fix/34.1-01-SUMMARY.md`
</output>
