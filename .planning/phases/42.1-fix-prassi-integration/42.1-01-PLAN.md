---
phase: 42.1-fix-prassi-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - _data/documents.js
  - eleventy.config.mjs
  - .env.example
  - src/pages/documenti-*-primo.html (107 content files deleted)
  - src/pages/documenti-*-rinnovo.html (content files deleted)
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Built document pages include prassi.css link in <head>"
    - "Built document pages include prassi section HTML after document content"
    - "Built document pages include prassi.js script tag before </body>"
    - "All document page URLs remain unchanged (no broken links)"
    - ".env.example documents PRASSI_DB_ID"
  artifacts:
    - path: "_data/documents.js"
      provides: "Document data without static file existence check"
      contains: "primo.push"
    - path: "eleventy.config.mjs"
      provides: "Ignore rules for old static files updated"
    - path: ".env.example"
      provides: "All required env vars documented"
      contains: "PRASSI_DB_ID"
  key_links:
    - from: "_data/documents.js"
      to: "src/pages/documents-primo.liquid"
      via: "documents.primo array feeds pagination"
      pattern: "primo\\.push"
    - from: "_data/documents.js"
      to: "src/pages/documents-rinnovo.liquid"
      via: "documents.rinnovo array feeds pagination"
      pattern: "rinnovo\\.push"
    - from: "src/pages/documents-primo.liquid"
      to: "_site/src/pages/documenti-*-primo.html"
      via: "11ty pagination generates output pages"
      pattern: "prassi\\.css"
---

<objective>
Fix prassi locali integration by removing old static document HTML files that prevent Liquid templates from generating pages with the prassi section.

Purpose: Phase 41 delivered all prassi code (data file, CSS, JS, Netlify Functions, Liquid template sections) but the prassi section never renders because old static HTML files in `src/pages/` cause `documents.js` to skip those slugs from its data arrays. The Liquid pagination templates (`documents-primo.liquid`, `documents-rinnovo.liquid`) never generate pages for those slugs. Instead, 11ty serves the old static files which lack prassi CSS, prassi section, and prassi.js.

Output: All document pages generated via Liquid templates with full prassi integration.
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/v3.1-MILESTONE-AUDIT.md

Key files:
@_data/documents.js — lines 112-133 have the static file check to remove
@eleventy.config.mjs — lines 46-48 have the comment to update
@src/pages/documents-primo.liquid — correct template with prassi (282 lines)
@src/pages/documents-rinnovo.liquid — correct template with prassi (325 lines)
@.env.example — missing PRASSI_DB_ID
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete old static document files and remove filesystem guard from documents.js</name>
  <files>
    src/pages/documenti-*-primo.html (107 non-redirect content files)
    src/pages/documenti-*-rinnovo.html (non-redirect content files)
    _data/documents.js
  </files>
  <action>
**Step 1: Delete old static content document files.**

Delete ALL `documenti-*-primo.html` and `documenti-*-rinnovo.html` files from `src/pages/` EXCEPT:
- Do NOT delete the Liquid templates: `documents-primo.liquid`, `documents-rinnovo.liquid`, `documents-redirects.liquid`
- The 38 redirect files (12-line files matching slugMap display slugs) CAN be deleted too — they are already regenerated by `documents-redirects.liquid` and ignored by eleventy.config.mjs. Deleting them is cleaner.

So effectively: delete ALL `src/pages/documenti-*-primo.html` and `src/pages/documenti-*-rinnovo.html` files (145 tracked/modified + 21 untracked = up to 166 files).

Use this command pattern:
```bash
cd src/pages && rm -f documenti-*-primo.html documenti-*-rinnovo.html
```

Verify no Liquid templates were deleted:
```bash
ls src/pages/documents-primo.liquid src/pages/documents-rinnovo.liquid src/pages/documents-redirects.liquid
```

**Step 2: Remove the static file existence check from `_data/documents.js`.**

In `_data/documents.js`, remove lines 112-133 (the `hasPrimoStatic`/`hasRinnovoStatic` check). Replace the entire block from `// Only add entries when no static HTML file exists` through the closing braces of both `if` statements with unconditional pushes:

Replace this block:
```javascript
      // Only add entries when no static HTML file exists (avoids duplicate permalink errors)
      const pagesDir = path.join(process.cwd(), 'src', 'pages');
      const hasPrimoStatic = fs.existsSync(path.join(pagesDir, `documenti-${slug}-primo.html`));
      const hasRinnovoStatic = fs.existsSync(path.join(pagesDir, `documenti-${slug}-rinnovo.html`));

      if (!hasPrimoStatic) {
        primo.push({
          tipo, slug,
          documents: primoDocuments,
          method: primoMethod,
          docNotes: docNotes || null
        });
      }

      if (!hasRinnovoStatic) {
        rinnovo.push({
          tipo, slug,
          documents: rinnovoDocuments,
          method: rinnovoMethod,
          docNotes: docNotes || null
        });
      }
```

With:
```javascript
      primo.push({
        tipo, slug,
        documents: primoDocuments,
        method: primoMethod,
        docNotes: docNotes || null
      });

      rinnovo.push({
        tipo, slug,
        documents: rinnovoDocuments,
        method: rinnovoMethod,
        docNotes: docNotes || null
      });
```

Also remove the now-unused `fs` and `path` imports at the top of the file (lines 3-4: `const fs = require('fs')` and `const path = require('path')`). These were ONLY used for the static file check.
  </action>
  <verify>
1. `ls src/pages/documenti-*-primo.html src/pages/documenti-*-rinnovo.html 2>/dev/null | wc -l` returns 0
2. `ls src/pages/documents-primo.liquid src/pages/documents-rinnovo.liquid src/pages/documents-redirects.liquid` returns 3 files
3. `grep -c "existsSync" _data/documents.js` returns 0
4. `grep -c "require('fs')" _data/documents.js` returns 0
  </verify>
  <done>All 145+ old static document HTML files deleted. documents.js no longer checks for static files and unconditionally pushes all entries to primo/rinnovo arrays. fs and path imports removed.</done>
</task>

<task type="auto">
  <name>Task 2: Update config comment, .env.example, ignore rules, and verify build</name>
  <files>
    eleventy.config.mjs
    .env.example
  </files>
  <action>
**Step 1: Update the comment in `eleventy.config.mjs` (lines 46-48).**

Replace:
```javascript
  // Static documenti-*.html files are NOT ignored.
  // documents.js filters out slugs that have existing static files to avoid duplicates.
  // This way static files serve as fallback when no Liquid replacement exists.
```

With:
```javascript
  // All document pages are generated via Liquid pagination templates
  // (documents-primo.liquid, documents-rinnovo.liquid, documents-redirects.liquid).
  // Old static documenti-*.html files were removed in Phase 42.1.
```

**Step 2: Also add ignores for any stray static document files (safety net).**

After the updated comment (the block that was just changed), add a dynamic ignore block similar to the permit file ignore pattern (lines 29-44). This ensures if any old static document files are ever re-created, they won't conflict:

```javascript
  // Ignore any remaining static document HTML files (safety net)
  // All document pages should be generated by Liquid pagination templates
  try {
    const docFiles = fs.readdirSync(pagesDir).filter(f =>
      f.startsWith('documenti-') && f.endsWith('.html')
    );
    for (const file of docFiles) {
      eleventyConfig.ignores.add(`src/pages/${file}`);
    }
    if (docFiles.length > 0) {
      console.log(`[eleventy] Ignoring ${docFiles.length} static document files (replaced by Liquid templates)`);
    }
  } catch (e) {
    // Directory might not exist in some environments
  }
```

Note: The `fs`, `path`, and `pagesDir` variables are already defined higher in the file (lines 30-33) for the permit files ignore block. Reuse them. If the `pagesDir` variable is scoped inside the try block for permits, move its declaration up or redeclare it.

Also remove the now-redundant redirect file ignore block (lines 21-27 of the original config):
```javascript
  // Ignore existing redirect HTML files (replaced by documents-redirects.liquid template)
  // These files are old static redirects that will be regenerated via pagination
  const redirectSlugs = require('./_data/slugMap.js').mappings;
  for (const displaySlug of Object.keys(redirectSlugs)) {
    eleventyConfig.ignores.add(`src/pages/documenti-${displaySlug}-primo.html`);
    eleventyConfig.ignores.add(`src/pages/documenti-${displaySlug}-rinnovo.html`);
  }
```

This block is now redundant because: (a) the old redirect static files have been deleted, and (b) the new dynamic ignore block above catches ALL `documenti-*.html` files including redirects. Remove it and replace with a brief comment noting the files were deleted.

**Step 3: Add PRASSI_DB_ID to `.env.example`.**

Add this line after the NOTION_API_KEY line:
```
# Required for prassi locali feature (crowdsourced questura notes)
PRASSI_DB_ID=your_prassi_notion_database_id_here
```

**Step 4: Run build and verify prassi section appears.**

Run: `npm run build`

After build completes, verify:
1. Pick a known document page from _site output, e.g.: `_site/src/pages/documenti-richiesta-asilo-primo.html`
2. Check it contains `prassi.css` link: `grep "prassi.css" _site/src/pages/documenti-richiesta-asilo-primo.html`
3. Check it contains prassi section: `grep "prassi-section" _site/src/pages/documenti-richiesta-asilo-primo.html`
4. Check it contains prassi.js script: `grep "prassi.js" _site/src/pages/documenti-richiesta-asilo-primo.html`
5. Count total built document pages: `ls _site/src/pages/documenti-*-primo.html 2>/dev/null | wc -l` — should be >= 50 (all Notion entries)
6. Verify redirect pages still work: `grep "meta http-equiv" _site/src/pages/documenti-cure-mediche-primo.html` — should show redirect
  </action>
  <verify>
1. `grep "prassi.css" _site/src/pages/documenti-richiesta-asilo-primo.html` returns a match
2. `grep "prassi-section" _site/src/pages/documenti-richiesta-asilo-primo.html` returns a match
3. `grep "prassi.js" _site/src/pages/documenti-richiesta-asilo-primo.html` returns a match
4. `grep "PRASSI_DB_ID" .env.example` returns a match
5. `ls _site/src/pages/documenti-*-primo.html 2>/dev/null | wc -l` returns >= 50
6. Build completes without errors
  </verify>
  <done>eleventy.config.mjs comment updated and safety-net ignore added. .env.example includes PRASSI_DB_ID. Build produces document pages with prassi.css, prassi section, and prassi.js. All document URLs preserved. Redirect pages still functional.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full PRASSI integration chain:

1. **PRASSI-02 (display section):** Built document pages contain prassi-locali-section div
   ```bash
   grep -l "prassi-section" _site/src/pages/documenti-*-primo.html | head -5
   ```

2. **PRASSI-01 (submission form):** Built pages contain the submission modal trigger
   ```bash
   grep -l "openPrassiModal" _site/src/pages/documenti-*-primo.html | head -5
   ```

3. **PRASSI-03 (voting):** Built pages contain voting UI elements
   ```bash
   grep -l "vote" _site/src/pages/documenti-*-primo.html | head -5
   ```

4. **URL preservation:** Spot-check 5 known document URLs exist in _site
   ```bash
   ls _site/src/pages/documenti-richiesta-asilo-primo.html
   ls _site/src/pages/documenti-protezione-sussidiaria-primo.html
   ls _site/src/pages/documenti-lavoro-subordinato-a-seguito-di-ingresso-per-flussi-primo.html
   ls _site/src/pages/documenti-minore-eta-primo.html
   ls _site/src/pages/documenti-motivi-religiosi-primo.html
   ```

5. **Redirect preservation:** Redirect pages still have meta refresh
   ```bash
   grep "http-equiv" _site/src/pages/documenti-cure-mediche-primo.html
   grep "http-equiv" _site/src/pages/documenti-asilo-politico-primo.html
   ```

6. **No regressions:** Build log shows no errors or warnings about duplicate permalinks
</verification>

<success_criteria>
1. Zero old static `documenti-*-primo.html` / `documenti-*-rinnovo.html` files in `src/pages/`
2. `documents.js` has no filesystem existence check
3. Build produces all document pages via Liquid templates
4. Every built document page includes prassi.css, prassi section, and prassi.js
5. All document URLs preserved (no broken links)
6. Redirect pages still function correctly
7. `.env.example` documents PRASSI_DB_ID
8. Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/42.1-fix-prassi-integration/42.1-01-SUMMARY.md`
</output>
