---
phase: 42-build-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - scripts/audit-content.js
  - .planning/AUDIT-content.md
autonomous: true

must_haves:
  truths:
    - "A structured audit report exists listing Notion content issues for downstream phases"
    - "Audit covers both Documenti Questura and Database permessi databases"
    - "Issues are categorized by type (capitalization, synthetic text, unclear wording)"
    - "Each issue links to the Notion page for easy fixing"
  artifacts:
    - path: "scripts/audit-content.js"
      provides: "Content audit script fetching from Notion DBs"
      contains: "auditDatabase"
    - path: ".planning/AUDIT-content.md"
      provides: "Generated audit report with categorized issues"
      contains: "Content Audit Report"
  key_links:
    - from: "scripts/audit-content.js"
      to: "Notion API"
      via: "@notionhq/client"
      pattern: "notion\\.search"
    - from: "scripts/audit-content.js"
      to: ".planning/AUDIT-content.md"
      via: "fs.writeFileSync"
      pattern: "writeFileSync.*AUDIT"
---

<objective>
Create a content audit script that examines both Notion databases (Documenti Questura + Database permessi) for quality issues, and generate a structured report that Phase 43 (Populate Blank Permits) and Phase 45 (Content Validation) can act on.

Purpose: Systematically identify content problems (missing capitalization, overly synthetic text, unclear wording, missing fields) instead of relying on manual review of 60+ pages. The report gives the user a concrete action list for Notion cleanup.

Output: `scripts/audit-content.js` script and `.planning/AUDIT-content.md` generated report.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/42-build-pipeline/42-RESEARCH.md
@.planning/phases/42-build-pipeline/42-CONTEXT.md

# Key source files for understanding Notion property names
@_data/documents.js
@_data/permits.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content audit script</name>
  <files>scripts/audit-content.js</files>
  <action>
Create `scripts/audit-content.js` that fetches from both Notion databases and checks user-facing fields for quality issues.

**Structure:**
```
require('dotenv').config()
const { Client } = require("@notionhq/client")
const fs = require('fs')
const path = require('path')
```

**Database IDs:**
- Documenti Questura: `1ad7355e-7f7f-8088-a065-e814c92e2cfd`
- Database permessi (permits): Need to find the actual ID. Look in the permits data — the notion-client.js uses the SAME database ID `1ad7355e-7f7f-8088-a065-e814c92e2cfd`. Both documents and permits come from the SAME database. Adjust audit logic accordingly — audit once, check both document fields and permit fields.

**Fetching approach:**
Use `notion.search()` with parent filter (same pattern as `_data/documents.js`), paginating with `page_size: 100` and `start_cursor`. Add 350ms delay between pagination requests to stay under 3 req/sec rate limit.

**Quality checks to implement:**

1. **Missing capitalization** — Check `"Nome permesso"` title field. First character should be uppercase.

2. **Overly synthetic/technical text** — Check `"Info extra su doc rilascio"` rich_text field. Flag if 3+ legal reference patterns (`art.`, `comma`, `d.lgs`, `n.`, `del`, `legge`) appear in one field.

3. **Unclear/vague wording** — Check title for generic terms like `generico`, `vario`, `altro`, `ecc`.

4. **Missing document lists** — Check if `"Doc primo rilascio"` or `"Doc rinnovo"` multi_select is empty. Flag permits that have no documents listed (these need content in Phase 43).

5. **Duplicate or near-duplicate names** — Track all permit names, flag any that differ only by case or whitespace.

6. **Overly long document names** — Check multi_select values in `"Doc primo rilascio"` and `"Doc rinnovo"`. Flag individual document names longer than 80 characters (likely too synthetic for display).

7. **Parent/child disambiguation** — Flag permits matching the "X a seguito di Y" pattern to help the user verify the Notion structure mirrors the website's variant grouping.

**Report generation:**
Generate markdown with this structure:
```markdown
# Content Audit Report

**Generated:** YYYY-MM-DD
**Database:** Documenti Questura / Database permessi
**Total pages audited:** N
**Total issues found:** N

## Summary

| Issue Type | Count |
|------------|-------|
| Missing capitalization | N |
| Overly synthetic text | N |
| ... | ... |

## Missing capitalization (N)

| Page | Field | Current | Suggested |
|------|-------|---------|-----------|
| [Name](notion-url) | Title | current text | Suggested fix |

## Overly synthetic text (N)
...

## Missing document lists (N)
...

## Parent/child variants to verify (N)
...
```

Each issue should include a clickable Notion URL: `https://notion.so/{pageId}` (with dashes removed from page ID).

**npm script:** This will be callable via `npm run audit` (script added in plan 42-01).

Write the script to `scripts/audit-content.js`. Make sure it exits cleanly and prints a summary to console.
  </action>
  <verify>
1. `node -c scripts/audit-content.js` — syntax check passes
2. `grep "auditDatabase\|notion.search\|AUDIT-content" scripts/audit-content.js` — contains key functions
3. `grep "dotenv" scripts/audit-content.js` — loads env vars
4. `grep "350" scripts/audit-content.js` — rate limiting delay present
  </verify>
  <done>Content audit script created with checks for capitalization, synthetic text, unclear wording, missing documents, duplicates, long names, and variant disambiguation.</done>
</task>

<task type="auto">
  <name>Task 2: Run audit and generate report</name>
  <files>.planning/AUDIT-content.md</files>
  <action>
Run the audit script:
```bash
node scripts/audit-content.js
```

This should:
1. Connect to Notion API (requires NOTION_API_KEY in .env)
2. Fetch all pages from the database
3. Run all quality checks
4. Write the report to `.planning/AUDIT-content.md`
5. Print summary to console

If the script fails due to API issues, debug and fix. Common issues:
- Rate limiting (429): Increase delay between requests
- Missing properties: Some pages may not have all fields — handle gracefully with optional chaining
- Permission errors: Ensure the Notion integration has access to the database

After the report is generated, read it and verify it looks reasonable:
- Has a summary table
- Issues are categorized
- Notion URLs are clickable
- No empty sections (unless genuinely no issues of that type)

If the report reveals no issues for a category, that section should say "No issues found" rather than being omitted entirely.
  </action>
  <verify>
1. `.planning/AUDIT-content.md` exists and is non-empty
2. `grep "Content Audit Report" .planning/AUDIT-content.md` — report header present
3. `grep "Total pages audited" .planning/AUDIT-content.md` — audit count present
4. `grep "notion.so" .planning/AUDIT-content.md` — Notion links present
5. File size is reasonable (> 500 bytes for a real audit)
  </verify>
  <done>Content audit report generated at .planning/AUDIT-content.md with categorized issues and Notion links. Report is ready for Phase 43 and Phase 45 to act on.</done>
</task>

</tasks>

<verification>
1. `node scripts/audit-content.js` runs without errors
2. `.planning/AUDIT-content.md` contains structured, categorized issues
3. All user-facing Notion fields are checked (title, documents, notes)
4. Each issue has a direct Notion URL for easy fixing
5. Rate limiting is respected (no 429 errors)
</verification>

<success_criteria>
- Audit script covers both document and permit data from Notion
- Report categorizes issues by type with counts
- Each issue links to the specific Notion page
- Report identifies permits with missing document lists (feeds Phase 43)
- Report flags synthetic/unclear text (feeds Phase 45)
- Script is reusable (`npm run audit`) for future validation passes
</success_criteria>

<output>
After completion, create `.planning/phases/42-build-pipeline/42-03-SUMMARY.md`
</output>
