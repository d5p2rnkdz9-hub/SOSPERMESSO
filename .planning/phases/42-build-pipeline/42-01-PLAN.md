---
phase: 42-build-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - _data/permits.js
  - package.json
  - .env.example
  - scripts/build-documents.js
  - scripts/build-permits.js
  - scripts/notion-client.js
  - scripts/manifest.json
  - scripts/slug-map.json
  - scripts/templates/primo.js
  - scripts/templates/rinnovo.js
  - scripts/templates/permesso.js
  - scripts/templates/translation-prompt.txt
  - scripts/fix-all-footers.js
  - scripts/fix-breadcrumbs.js
  - scripts/fix-en-language-switcher.js
  - scripts/fix-en-paths.js
  - scripts/fix-header-structure.js
  - scripts/fix-language-switcher-position.js
  - scripts/add-css-links.js
  - scripts/migrate-pages.js
  - scripts/remove-contact-footer.js
  - scripts/update-document-footers.js
  - scripts/update-emojis.js
  - scripts/update-privacy-label.js
autonomous: true

must_haves:
  truths:
    - "npm run build produces complete site with Notion-sourced pages in a single step"
    - "No obsolete build scripts remain in the codebase"
    - "permits.js is self-contained (no dependency on notion-client.js)"
    - "Build output is identical before and after changes"
  artifacts:
    - path: "_data/permits.js"
      provides: "Self-contained permit data fetching (inlined Notion client)"
      contains: "new Client"
    - path: "package.json"
      provides: "Simplified build command"
      contains: "npx @11ty/eleventy"
    - path: ".env.example"
      provides: "Documented environment variables"
      contains: "NOTION_WEBHOOK_SECRET"
  key_links:
    - from: "_data/permits.js"
      to: "Notion API"
      via: "inline Client instantiation"
      pattern: "new Client.*NOTION_API_KEY"
    - from: "package.json"
      to: "eleventy.config.mjs"
      via: "build script"
      pattern: "npx @11ty/eleventy"
---

<objective>
Unify the build command into a single step, inline the shared Notion client into permits.js so it becomes self-contained (matching documents.js pattern), and remove all obsolete scripts that have been replaced by 11ty data files and templates.

Purpose: Eliminate the two-step build (`build:docs` + `build:11ty`) since 11ty already runs `_data/*.js` files automatically. Remove dead code that creates maintenance confusion.

Output: Single `npm run build` command, self-contained permits.js, and a clean scripts/ directory with only active code.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-build-pipeline/42-RESEARCH.md

# Key source files
@_data/permits.js
@_data/documents.js
@scripts/notion-client.js
@package.json
@eleventy.config.mjs
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inline notion-client.js into permits.js and simplify build command</name>
  <files>_data/permits.js, package.json, .env.example</files>
  <action>
**Step A: Inline notion-client.js functions into _data/permits.js**

permits.js currently imports `fetchPermitData` and `fetchPageBlocks` from `../scripts/notion-client.js`. Inline these two functions directly into permits.js, following the same self-contained pattern that documents.js already uses.

1. Add `require('dotenv').config();` at top of permits.js (CRITICAL: must be before Client instantiation, see MEMORY.md pattern)
2. Add `const { Client } = require("@notionhq/client");`
3. Add `const DATABASE_ID = "1ad7355e-7f7f-8088-a065-e814c92e2cfd";`
4. Copy the `fetchPermitData()` function from notion-client.js (lines 29-77) into permits.js
5. Copy the `fetchPageBlocks()` function from notion-client.js (lines 85-108) into permits.js
6. Remove the `require('../scripts/notion-client.js')` import line
7. Keep the existing `require('../scripts/templates/helpers.js')` import (helpers.js is still active)
8. Create the Notion client instance inside the module.exports function (after the API key check), NOT at module scope. This matches documents.js pattern where the client is created only when needed.

The `testConnection()` function from notion-client.js is NOT needed — it's only used by the old build scripts.

**Step B: Simplify package.json build command**

Update the `scripts` section in package.json:
- Change `"build"` from `"npm run build:docs && npm run build:11ty"` to `"npx @11ty/eleventy"`
- Remove `"build:docs": "node scripts/build-documents.js"` (no longer needed)
- Remove `"build:11ty": "npx @11ty/eleventy"` (redundant — build IS 11ty now)
- Keep `"dev"`, `"build:sitemap"`, `"translate:en"`, `"tm:stats"`, `"test"` unchanged
- Add `"audit": "node scripts/audit-content.js"` (will be created in plan 42-03)

**Step C: Update .env.example**

Update .env.example to document ALL required environment variables:
```
# SOS Permesso - Environment Variables
# Required for Notion content fetching during build
NOTION_API_KEY=your_notion_integration_token_here

# Required for Notion webhook auto-rebuild (notion-webhook.mjs)
NOTION_WEBHOOK_SECRET=your_notion_webhook_secret_here

# Required for webhook-triggered rebuilds (create in Netlify Dashboard > Build hooks)
NETLIFY_BUILD_HOOK_URL=https://api.netlify.com/build_hooks/your_hook_id_here
```
  </action>
  <verify>
1. Run `node -e "const p = require('./_data/permits.js'); console.log(typeof p)"` — should output `function` without errors
2. Run `grep -c "notion-client" _data/permits.js` — should output `0` (no more import)
3. Run `grep "dotenv" _data/permits.js` — should show `require('dotenv').config()`
4. Run `node -e "const pkg = require('./package.json'); console.log(pkg.scripts.build)"` — should output `npx @11ty/eleventy`
5. Run `grep "build:docs" package.json` — should return nothing (removed)
  </verify>
  <done>permits.js is self-contained with inlined Notion client functions. package.json build command is single-step. .env.example documents all env vars.</done>
</task>

<task type="auto">
  <name>Task 2: Remove obsolete scripts and verify build</name>
  <files>scripts/build-documents.js, scripts/build-permits.js, scripts/notion-client.js, scripts/manifest.json, scripts/slug-map.json, scripts/templates/primo.js, scripts/templates/rinnovo.js, scripts/templates/permesso.js, scripts/templates/translation-prompt.txt, scripts/fix-all-footers.js, scripts/fix-breadcrumbs.js, scripts/fix-en-language-switcher.js, scripts/fix-en-paths.js, scripts/fix-header-structure.js, scripts/fix-language-switcher-position.js, scripts/add-css-links.js, scripts/migrate-pages.js, scripts/remove-contact-footer.js, scripts/update-document-footers.js, scripts/update-emojis.js, scripts/update-privacy-label.js</files>
  <action>
**Before deleting anything**, verify no active imports exist by running:
```bash
grep -r "require.*notion-client" _data/*.js eleventy.config.mjs
grep -r "require.*build-documents" _data/*.js eleventy.config.mjs
grep -r "require.*build-permits" _data/*.js eleventy.config.mjs
grep -r "require.*primo\|require.*rinnovo\|require.*permesso" _data/*.js eleventy.config.mjs
```
After Task 1, the only grep match should be ZERO for notion-client (already inlined).

**Delete these files (replaced by 11ty data files + templates):**
- `scripts/build-documents.js` — replaced by `_data/documents.js` + Liquid templates
- `scripts/build-permits.js` — replaced by `_data/permits.js` + Liquid template
- `scripts/notion-client.js` — inlined into `_data/permits.js` in Task 1
- `scripts/manifest.json` — old incremental build manifest, no longer used
- `scripts/slug-map.json` — replaced by `_data/slugMap.js`

**Delete these template files (replaced by Liquid templates in src/pages/):**
- `scripts/templates/primo.js` — replaced by `src/pages/documents-primo.liquid`
- `scripts/templates/rinnovo.js` — replaced by `src/pages/documents-rinnovo.liquid`
- `scripts/templates/permesso.js` — replaced by `src/pages/permits.liquid`
- `scripts/templates/translation-prompt.txt` — one-time translation prompt, no longer needed

**DO NOT delete these (still actively imported):**
- `scripts/templates/helpers.js` — imported by `eleventy.config.mjs` line 5 AND `_data/permits.js` line 11
- `scripts/templates/dizionario-map.json` — imported by `eleventy.config.mjs` line 6 AND `helpers.js`

**Delete these one-time migration/fix scripts (all changes committed, scripts redundant):**
- `scripts/fix-all-footers.js`
- `scripts/fix-breadcrumbs.js`
- `scripts/fix-en-language-switcher.js`
- `scripts/fix-en-paths.js`
- `scripts/fix-header-structure.js`
- `scripts/fix-language-switcher-position.js`
- `scripts/add-css-links.js`
- `scripts/migrate-pages.js`
- `scripts/remove-contact-footer.js`
- `scripts/update-document-footers.js`
- `scripts/update-emojis.js`
- `scripts/update-privacy-label.js`

**After deletion, verify build works:**
```bash
npm run build
```
The build MUST complete successfully. If it fails with "Cannot find module", a script was still needed — restore it from git and investigate.

Also verify the output is correct:
```bash
ls _site/src/pages/documenti-*-primo.html | head -5
ls _site/src/pages/permesso-*.html | head -5
```
Both should show generated pages.
  </action>
  <verify>
1. `npm run build` completes without errors
2. `ls scripts/build-documents.js 2>/dev/null` — file should not exist
3. `ls scripts/build-permits.js 2>/dev/null` — file should not exist
4. `ls scripts/notion-client.js 2>/dev/null` — file should not exist
5. `ls scripts/templates/helpers.js` — file MUST still exist
6. `ls scripts/templates/dizionario-map.json` — file MUST still exist
7. `ls _site/src/pages/permesso-*.html | wc -l` — should be 60+ (permit pages generated)
8. `ls _site/src/pages/documenti-*-primo.html | wc -l` — should be 30+ (document pages generated)
9. Build time under 120 seconds — use `time npm run build` and verify output shows less than 120s (BUILD-03)
  </verify>
  <done>All obsolete scripts removed. Build completes successfully with single `npm run build` command. Only active scripts remain in scripts/ directory.</done>
</task>

</tasks>

<verification>
1. `npm run build` produces complete site in single step
2. No references to removed scripts in any active code
3. _site/ output contains all expected pages (permits + documents)
4. permits.js works without notion-client.js dependency
5. scripts/ directory contains only: build-sitemap.js, translate-batch.js, translation-memory.js, translation-glossary.json, translation-manifest.json, translation-memory/, verify-translation.js, compare-translations.html, templates/helpers.js, templates/dizionario-map.json
</verification>

<success_criteria>
- Single `npm run build` command generates all pages (BUILD-01)
- No `build:docs` step exists in package.json
- notion-client.js removed, permits.js is self-contained
- 20+ obsolete scripts deleted
- Build output unchanged (same pages generated)
- .env.example documents all required variables (BUILD-02 partial)
</success_criteria>

<output>
After completion, create `.planning/phases/42-build-pipeline/42-01-SUMMARY.md`
</output>
