---
phase: 17-content-migration-visual-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/templates/permesso.js
  - scripts/build-permits.js
  - scripts/manifest.json
autonomous: true

must_haves:
  truths:
    - "Permits without Notion content get placeholder pages generated"
    - "Placeholder pages have 'Contenuto in arrivo' message and CTA to Dai una mano"
    - "Build script only regenerates pages when Notion content is newer"
    - "Manifest tracks last build timestamp per permit"
  artifacts:
    - path: "scripts/templates/permesso.js"
      provides: "generatePlaceholderPage function"
      exports: ["generatePermessoPage", "generatePlaceholderPage"]
    - path: "scripts/manifest.json"
      provides: "Build timestamp tracking"
      contains: "lastEdited"
    - path: "scripts/build-permits.js"
      provides: "Placeholder generation and change detection"
      contains: "generatePlaceholderPage"
  key_links:
    - from: "scripts/build-permits.js"
      to: "scripts/manifest.json"
      via: "loadManifest/saveManifest"
      pattern: "manifest\\.json"
    - from: "scripts/build-permits.js"
      to: "generatePlaceholderPage"
      via: "require"
      pattern: "generatePlaceholderPage"
---

<objective>
Extend the build system to generate placeholder pages for permits without Notion content, and add change detection for efficient incremental builds.

Purpose: Complete permit coverage (MIGR-01 partial) - users see all permits exist, even if content isn't ready. Also improves build efficiency by skipping unchanged pages.

Output: Updated build script that generates placeholder pages for empty permits and uses manifest for change detection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-content-migration-visual-polish/17-CONTEXT.md
@.planning/phases/17-content-migration-visual-polish/17-RESEARCH.md
@.planning/phases/16-permit-build-system/16-02-SUMMARY.md
@scripts/build-permits.js
@scripts/templates/permesso.js
@scripts/notion-client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add placeholder page template</name>
  <files>scripts/templates/permesso.js</files>
  <action>
Add a `generatePlaceholderPage` function to scripts/templates/permesso.js.

The placeholder page should:
1. Follow the same structure as generatePermessoPage (same header, footer, breadcrumbs)
2. Show a friendly "Contenuto in arrivo" message (per CONTEXT.md)
3. Include CTA button linking to "Dai una mano" Typeform: https://form.typeform.com/to/USx16QN3
4. Display the permit emoji and name

Add this function AFTER the existing generatePermessoPage function:

```javascript
/**
 * Generate a placeholder page for permits without Notion content
 * @param {Object} permit - Permit data
 * @param {string} permit.tipo - Permit type name
 * @param {string} permit.slug - URL slug
 * @param {string} permit.emoji - Emoji icon (optional)
 * @returns {string} Complete HTML page
 */
function generatePlaceholderPage(permit) {
  const { tipo, slug, emoji } = permit;
  const escapedTipo = escapeHtml(tipo || 'questo permesso');
  const pageEmoji = emoji || 'üìÑ';

  // Use same header/footer structure as main template
  // Content section replaced with placeholder card

  return `<!DOCTYPE html>
<html lang="it">
<head>
  <!-- Same head as generatePermessoPage -->
  ...
</head>
<body>
  <!-- Same header, breadcrumb -->
  ...

  <!-- PLACEHOLDER CONTENT -->
  <section class="section">
    <div class="container" style="max-width: 900px;">
      <div class="card text-center" style="padding: 3rem;">
        <span style="font-size: 4rem;">${pageEmoji}</span>
        <h2 style="margin: 1rem 0;">Contenuto in arrivo</h2>
        <p style="color: var(--gray-medium); max-width: 500px; margin: 0 auto 1.5rem;">
          Stiamo ancora lavorando per completare le informazioni
          su questo permesso di soggiorno.
        </p>
        <a href="https://form.typeform.com/to/USx16QN3"
           class="btn btn-primary"
           target="_blank"
           rel="noopener noreferrer">
          Dai una mano
        </a>
      </div>
    </div>
  </section>

  <!-- Same related/footer -->
  ...
</body>
</html>`;
}
```

IMPORTANT: Reuse the EXACT header, breadcrumb, and footer HTML from generatePermessoPage. Extract these into shared strings or helper functions if needed to avoid duplication.

Export both functions:
```javascript
module.exports = { generatePermessoPage, generatePlaceholderPage };
```
  </action>
  <verify>
1. Run: `node -e "const t = require('./scripts/templates/permesso.js'); console.log(typeof t.generatePlaceholderPage)"`
   Should output: "function"
2. Run the template self-test: `node scripts/templates/permesso.js`
   Add a placeholder test case if helpful
  </verify>
  <done>generatePlaceholderPage function exists and is exported; generates valid HTML with correct structure</done>
</task>

<task type="auto">
  <name>Task 2: Add change detection with manifest</name>
  <files>scripts/build-permits.js</files>
  <action>
Add manifest-based change detection to build-permits.js.

Add these functions near the top of the file (after imports):

```javascript
const MANIFEST_PATH = path.join(__dirname, 'manifest.json');

/**
 * Load build manifest from disk
 * @returns {Object} Manifest data or empty object
 */
async function loadManifest() {
  try {
    const data = await fs.readFile(MANIFEST_PATH, 'utf-8');
    return JSON.parse(data);
  } catch {
    return {};
  }
}

/**
 * Save build manifest to disk
 * @param {Object} manifest - Manifest data
 */
async function saveManifest(manifest) {
  await fs.writeFile(MANIFEST_PATH, JSON.stringify(manifest, null, 2));
}

/**
 * Check if permit needs rebuild based on Notion timestamp
 * @param {Object} permit - Permit with last_edited_time
 * @param {Object} manifest - Current manifest
 * @returns {boolean} True if needs rebuild
 */
function needsRebuild(permit, manifest) {
  const entry = manifest[permit.id];
  if (!entry) return true; // Never built

  const lastBuilt = new Date(entry.lastEdited);
  const lastEdited = new Date(permit.last_edited_time);

  return lastEdited > lastBuilt;
}
```

Update fetchPermitData to include last_edited_time (check notion-client.js - it may already include this from page properties).

In the main build() function, add:
1. Load manifest at start
2. Check needsRebuild before processing each permit
3. Add --force flag option to rebuild all regardless of timestamps
4. Update manifest after successful page generation
5. Save manifest at end
  </action>
  <verify>
1. Run build twice: `node scripts/build-permits.js`
   Second run should show "skipped (unchanged)" for previously built pages
2. Run with force: `node scripts/build-permits.js --force`
   Should rebuild all pages
3. Check manifest exists: `cat scripts/manifest.json | head -20`
  </verify>
  <done>Build script uses manifest for change detection; unchanged pages are skipped; --force flag rebuilds all</done>
</task>

<task type="auto">
  <name>Task 3: Generate placeholder pages for empty permits</name>
  <files>scripts/build-permits.js</files>
  <action>
Update build-permits.js to generate placeholder pages instead of skipping empty permits.

Modify the build() function:

1. Import generatePlaceholderPage:
   ```javascript
   const { generatePermessoPage, generatePlaceholderPage } = require('./templates/permesso.js');
   ```

2. When a permit has no content (no blocks or no Q&A sections), generate a placeholder instead of skipping:
   ```javascript
   if (!blocks || blocks.length === 0 || sections.length === 0) {
     // Generate placeholder page instead of skipping
     const permitData = {
       tipo: permit.tipo,
       slug: permit.slug,
       emoji: getEmojiForPermit(permit.tipo)
     };

     const html = generatePlaceholderPage(permitData);
     const filename = `permesso-${permit.slug}.html`;
     await fs.writeFile(path.join(OUTPUT_DIR, filename), html, 'utf-8');

     console.log(`   ‚ö†Ô∏è ${filename} (placeholder - needs content)`);
     placeholderCount++;

     // Still track for TODO but mark as placeholder
     emptyPermits.push({
       tipo: permit.tipo,
       id: permit.id,
       reason: blocks?.length === 0 ? 'No blocks' : 'No Q&A sections',
       hasPlaceholder: true
     });
     continue;
   }
   ```

3. Update summary to show placeholder count separately

4. Run the build to generate all pages including placeholders
  </action>
  <verify>
1. Run: `node scripts/build-permits.js --force`
2. Check that permits from TODO-permits.md now have placeholder pages:
   `ls -la src/pages/permesso-lavoro-autonomo.html`
3. Open a placeholder page in browser and verify it shows "Contenuto in arrivo"
4. Count total permit pages: `ls src/pages/permesso-*.html | wc -l`
   Should be higher than before (43+)
  </verify>
  <done>All permits have pages (content or placeholder); empty permits have placeholder pages with CTA</done>
</task>

</tasks>

<verification>
1. generatePlaceholderPage function exists and produces valid HTML
2. Manifest-based change detection works (second build skips unchanged)
3. All permits from TODO-permits.md have placeholder pages
4. Total permit page count includes all Notion permits
5. Placeholder pages display correctly with CTA button
</verification>

<success_criteria>
- MIGR-01 PARTIAL: All permits have pages (content or placeholder)
- Build efficiency improved with change detection
- TODO-permits.md updated to reflect placeholder status
- No errors during build
</success_criteria>

<output>
After completion, create `.planning/phases/17-content-migration-visual-polish/17-02-SUMMARY.md`
</output>
