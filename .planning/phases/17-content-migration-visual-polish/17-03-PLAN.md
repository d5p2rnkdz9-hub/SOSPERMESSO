---
phase: 17-content-migration-visual-polish
plan: 03
type: execute
wave: 2
depends_on: ["17-02"]
files_modified:
  - scripts/build-permits.js
  - scripts/templates/permesso.js
autonomous: false

must_haves:
  truths:
    - "User sees proposed variant structure before any pages are generated"
    - "Permit variants have separate pages in subfolders"
    - "Parent pages link to variant child pages without duplicating content"
  artifacts:
    - path: "scripts/build-permits.js"
      provides: "Variant detection and generation"
      contains: "detectVariants"
    - path: "src/pages/*/index.html"
      provides: "Parent pages for permit variants"
  key_links:
    - from: "detectVariants"
      to: "console output"
      via: "proposed variant structure"
      pattern: "PROPOSED VARIANT"
---

<objective>
Add variant detection to identify permits with multiple types (e.g., Lavoro subordinato), present proposed structure for user approval, then generate parent/child pages.

Purpose: Complete MIGR-01 requirement - separate pages for permit variants (e.g., 3 types of Lavoro subordinato). Per CONTEXT.md: "Validate variant list with user before generating."

Output: Variant detection output for user review, then (after approval) parent pages with links + child variant pages in subfolders.

**Dependency note:** This plan depends ONLY on 17-02 (manifest and placeholder logic). Plan 17-01 (CSS styling) is independent and can complete in any order - it does not affect this plan's execution.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-content-migration-visual-polish/17-CONTEXT.md
@.planning/phases/17-content-migration-visual-polish/17-RESEARCH.md
@scripts/build-permits.js
@scripts/templates/permesso.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add variant detection logic</name>
  <files>scripts/build-permits.js</files>
  <action>
Add variant detection function to build-permits.js.

Variants are detected by the phrase "a seguito di" in permit names:
- "Lavoro subordinato a seguito di flussi" -> base: "Lavoro subordinato", variant: "flussi"
- "Lavoro subordinato a seguito di conversione" -> base: "Lavoro subordinato", variant: "conversione"

Add this function:

```javascript
/**
 * Detect permits that are variants of a base permit type
 * Groups by base name when "a seguito di" pattern is found
 * @param {Array} permits - Array of permit objects
 * @returns {Object} { variants: Array, standalone: Array }
 */
function detectVariants(permits) {
  const groups = {};
  const standalone = [];

  for (const permit of permits) {
    if (!permit.tipo) continue;

    // Match "X a seguito di Y" pattern
    const match = permit.tipo.match(/^(.+?)\s+a\s+seguito\s+di\s+(.+)$/i);

    if (match) {
      const baseName = match[1].trim();
      const variantName = match[2].trim();

      if (!groups[baseName]) {
        groups[baseName] = [];
      }
      groups[baseName].push({
        ...permit,
        baseName,
        variantName,
        variantSlug: slugify(variantName)
      });
    } else {
      standalone.push(permit);
    }
  }

  // Only return groups with 2+ variants
  const variantGroups = Object.entries(groups)
    .filter(([_, permits]) => permits.length >= 2)
    .map(([baseName, permits]) => ({
      baseName,
      baseSlug: slugify(baseName),
      variants: permits
    }));

  // Add single-variant items back to standalone
  Object.entries(groups)
    .filter(([_, permits]) => permits.length === 1)
    .forEach(([_, permits]) => standalone.push(permits[0]));

  return { variantGroups, standalone };
}

/**
 * Simple slugify function for variant names
 */
function slugify(text) {
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}
```

Add a --detect-variants flag that runs detection and outputs proposed structure WITHOUT generating pages:

```javascript
if (process.argv.includes('--detect-variants')) {
  await detectAndProposeVariants();
  process.exit(0);
}

async function detectAndProposeVariants() {
  const connected = await testConnection();
  if (!connected) {
    console.log('Cannot connect to Notion');
    process.exit(1);
  }

  const permits = await fetchPermitData();
  const { variantGroups, standalone } = detectVariants(permits);

  console.log('\n===========================================');
  console.log('PROPOSED VARIANT STRUCTURE');
  console.log('===========================================\n');

  if (variantGroups.length === 0) {
    console.log('No variant groups detected.\n');
    return;
  }

  for (const group of variantGroups) {
    console.log(`üìÅ ${group.baseName} (${group.variants.length} variants)`);
    console.log(`   Folder: src/pages/permesso-${group.baseSlug}/`);
    console.log('   Pages:');
    console.log(`   - index.html (parent page with links)`);
    for (const v of group.variants) {
      console.log(`   - ${v.variantSlug}.html ‚Üí "${v.tipo}"`);
    }
    console.log('');
  }

  console.log('-------------------------------------------');
  console.log(`Standalone permits: ${standalone.length}`);
  console.log('-------------------------------------------\n');
  console.log('To generate, confirm this structure is correct and run:');
  console.log('  node scripts/build-permits.js --generate-variants\n');
}
```
  </action>
  <verify>
1. Run: `node scripts/build-permits.js --detect-variants`
2. Should output proposed variant structure without creating files
3. Verify "Lavoro subordinato" appears as a variant group (if data exists)
  </verify>
  <done>Variant detection works; --detect-variants outputs proposed structure; no pages generated yet</done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <name>Task 2: Approve variant structure</name>
  <decision>Approve variant structure before generating pages</decision>
  <context>
Per CONTEXT.md: "Validate variant list with user before generating - don't auto-generate without approval."

The variant detection has output its proposed structure. Before generating parent/child pages with subfolder URLs, we need user confirmation that:
1. The detected variant groups are correct
2. The base names are appropriate
3. No false positives (unrelated permits incorrectly grouped)
  </context>
  <how-to-verify>
Run this command and review the output:
```
node scripts/build-permits.js --detect-variants
```

The output will show:
- Which permits are grouped as variants
- Proposed folder structure (e.g., permesso-lavoro-subordinato/)
- Proposed child page names (e.g., flussi.html, conversione.html)

Review for:
- False positives (permits grouped that shouldn't be)
- Missing variants (permits that should be grouped but aren't)
- Naming issues (base names or variant slugs that don't look right)
  </how-to-verify>
  <options>
    <option id="approve">
      <name>Approve and generate</name>
      <description>The proposed structure is correct. Proceed to generate parent/child pages.</description>
    </option>
    <option id="modify">
      <name>Modify detection</name>
      <description>Some groupings are wrong. Provide specific corrections and re-run detection.</description>
    </option>
    <option id="skip">
      <name>Skip variants for now</name>
      <description>Variant handling is complex. Skip for now and handle in a future phase.</description>
    </option>
  </options>
  <checkpoint-outcomes>
    - "approve" -> Execute Task 3
    - "modify" -> User provides corrections, re-run Task 1 detection, repeat Task 2
    - "skip" -> Skip Task 3, mark plan complete with note "Variant generation deferred"
  </checkpoint-outcomes>
  <resume-signal>Type: approve, modify, or skip. If modify, describe what changes are needed.</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Generate parent pages and variant subfolders</name>
  <files>scripts/build-permits.js, scripts/templates/permesso.js, src/pages/</files>
  <action>
**CONDITIONAL EXECUTION:** Check the outcome of Task 2 checkpoint before proceeding.

- If Task 2 outcome was "approve" -> Execute this task fully
- If Task 2 outcome was "modify" -> Do NOT execute; user needs to re-run detection first
- If Task 2 outcome was "skip" -> Do NOT execute; mark plan complete with note: "Variant generation deferred per user decision. Standalone permit pages remain unchanged."

**If proceeding (approve):**

Add variant page generation to build-permits.js:

1. Add parent page template to permesso.js:
```javascript
function generateVariantParentPage(group) {
  const { baseName, baseSlug, variants } = group;
  // Generate page with:
  // - Brief intro about this permit type
  // - Links to each variant page
  // - No duplicate content (just navigation)
}
```

2. Add --generate-variants flag to build-permits.js:
```javascript
if (process.argv.includes('--generate-variants')) {
  await generateVariantPages();
  process.exit(0);
}

async function generateVariantPages() {
  const permits = await fetchPermitData();
  const { variantGroups } = detectVariants(permits);

  for (const group of variantGroups) {
    // Create subfolder
    const folderPath = path.join(OUTPUT_DIR, `permesso-${group.baseSlug}`);
    await fs.mkdir(folderPath, { recursive: true });

    // Generate parent page
    const parentHtml = generateVariantParentPage(group);
    await fs.writeFile(path.join(folderPath, 'index.html'), parentHtml);

    // Generate variant pages (adjust paths for subfolder)
    for (const variant of group.variants) {
      const blocks = await fetchPageBlocks(variant.id);
      const sections = parseQASections(blocks);

      // Generate page with adjusted relative paths (../ prefix)
      const html = generatePermessoPage({
        ...variant,
        tipo: variant.tipo,
        slug: variant.variantSlug,
        sections,
        isVariant: true,  // Flag for adjusted paths
        parentSlug: group.baseSlug
      });

      await fs.writeFile(
        path.join(folderPath, `${variant.variantSlug}.html`),
        html
      );
    }
  }
}
```

3. Update permesso.js template to handle isVariant flag:
   - Adjust relative paths when isVariant is true
   - CSS/JS paths become ../../styles/, ../../scripts/
   - Logo path becomes ../../../images/
   - Breadcrumb includes parent folder link
  </action>
  <verify>
If Task 2 was "approve":
1. Run: `node scripts/build-permits.js --generate-variants`
2. Check folder exists: `ls -la src/pages/permesso-lavoro-subordinato/`
3. Verify index.html and variant pages exist
4. Open variant page in browser - verify CSS loads, links work

If Task 2 was "skip":
1. Verify no new folders were created: `ls -d src/pages/permesso-*/ 2>/dev/null | wc -l` should be 0 (or unchanged from before)
2. Task is complete with deferred status
  </verify>
  <done>
If approved: Variant pages generated in subfolders; parent pages link to variants; all paths resolve correctly
If skipped: Plan marked complete with deferred variant generation; no folders created
  </done>
</task>

</tasks>

<verification>
1. --detect-variants outputs proposed structure
2. User approved, modified, or skipped variant structure
3. If approved: variant folders and pages exist
4. If approved: parent pages contain links to variant children
5. If approved: variant pages load correctly (CSS, images, navigation all work)
6. If skipped: plan completes without generating variant pages
</verification>

<success_criteria>
If approved:
- MIGR-01 SATISFIED: Separate pages exist for permit variants
- User validated variant structure before generation
- Parent pages provide navigation without duplicating content
- All variant page paths resolve correctly

If skipped:
- Plan completes cleanly with deferred status
- No partial/broken variant pages created
- Future phase can pick up variant work
</success_criteria>

<output>
After completion, create `.planning/phases/17-content-migration-visual-polish/17-03-SUMMARY.md`

Note in summary if variant generation was deferred (Task 2 = skip).
</output>
