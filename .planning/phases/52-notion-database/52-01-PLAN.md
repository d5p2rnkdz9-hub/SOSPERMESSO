---
phase: 52-notion-database
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - _data/permitsFr.js
  - _data/documentsFr.js
autonomous: false

user_setup:
  - service: notion
    why: "Verify FR parent page is correct (currently same ID as EN parent)"
    dashboard_config:
      - task: "Verify NOTION_FR_PARENT_PAGE_ID (30b7355e-7f7f-8184-975d-fb18ca69875c) in Notion is the intended parent for FR database"
        location: "Notion workspace — check where this page lives"

must_haves:
  truths:
    - "A French Notion database exists with translated entries for all IT permits"
    - "The FR database contains translated document names, notes, and application method text"
    - "Running npm run build fetches content from the FR database without errors"
    - "FR data files use hardcoded DB ID (not env var) matching Netlify deployment pattern"
  artifacts:
    - path: "_data/permitsFr.js"
      provides: "FR permit data from Notion for 11ty pagination"
      contains: "FR_DATABASE_ID"
    - path: "_data/documentsFr.js"
      provides: "FR document data from Notion for 11ty pagination"
      contains: "FR_DATABASE_ID"
    - path: ".notion-cache/translation-index-fr.json"
      provides: "FR translation state tracking"
    - path: "scripts/translation-memory/it-fr.json"
      provides: "IT-to-FR cached translations for reuse"
  key_links:
    - from: "_data/permitsFr.js"
      to: "FR Notion database"
      via: "hardcoded FR_DATABASE_ID constant"
      pattern: "FR_DATABASE_ID\\s*=\\s*\""
    - from: "_data/documentsFr.js"
      to: "FR Notion database"
      via: "hardcoded FR_DATABASE_ID constant"
      pattern: "FR_DATABASE_ID\\s*=\\s*\""
    - from: "_data/documentsFr.js"
      to: "extractCost with FR keywords"
      via: "bordereau and timbre fallback keywords"
      pattern: "bordereau|timbre"
---

<objective>
Populate a French Notion database with translated permit and document content, then create 11ty data files that read from it.

Purpose: This gives 11ty the FR content source it needs. Phase 53 will create the Liquid templates and static pages that consume these data files to generate `/fr/` pages.

Output: Two new data files (`_data/permitsFr.js`, `_data/documentsFr.js`) pointing at a populated FR Notion database, verified by a successful `npm run build`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-notion-database/52-RESEARCH.md
@.planning/phases/51-translation-infrastructure/51-01-SUMMARY.md
@_data/permitsEn.js
@_data/documentsEn.js
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <name>Task 1: Confirm FR Notion parent page before translation</name>
  <decision>The NOTION_FR_PARENT_PAGE_ID in .env (30b7355e-7f7f-8184-975d-fb18ca69875c) is the SAME value as NOTION_EN_PARENT_PAGE_ID. The FR database will be created inside this parent page. Is this the correct parent for FR, or should a separate Notion parent page be created first?</decision>
  <context>The translate script auto-creates the FR database under this parent page. Once created, moving the DB in Notion is possible but annoying. Research flagged this as an open question — better to ask now than to move it later.</context>
  <options>
    <option id="same-parent">
      <name>Use same parent page as EN</name>
      <pros>Simple, no extra Notion setup needed. Both translated databases live together.</pros>
      <cons>FR and EN databases are siblings under the same parent — could be confusing in Notion workspace.</cons>
    </option>
    <option id="new-parent">
      <name>Create a dedicated FR parent page in Notion first</name>
      <pros>Cleaner Notion workspace organization.</pros>
      <cons>Requires manual Notion page creation and updating .env before proceeding.</cons>
    </option>
  </options>
  <resume-signal>Select: same-parent or new-parent (if new-parent, provide the new Notion page ID after creating it)</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Run FR translation and create data files</name>
  <files>_data/permitsFr.js, _data/documentsFr.js</files>
  <action>
This task has two sequential parts: run the translation, then create the data files.

**Part A: Run the FR translation script**

1. If user chose "new-parent" in Task 1, update `NOTION_FR_PARENT_PAGE_ID` in `.env` with the provided page ID before proceeding.

2. Run a dry run first to confirm the script sees all IT permits:
   ```bash
   npm run translate:fr:dry
   ```
   Expected output: "Found 41 IT permits" (or similar count). Verify no errors.

3. Run the full translation:
   ```bash
   npm run translate:fr
   ```
   This will:
   - Auto-create the FR Notion database (logs "Created FR database: {UUID}")
   - Append `NOTION_DATABASE_FR_ID={UUID}` to `.env` automatically
   - Translate all IT permits to FR via Claude API with the FR glossary
   - Create `.notion-cache/translation-index-fr.json`
   - Create `scripts/translation-memory/it-fr.json`
   - Migrate `.notion-cache/translation-index.json` to `translation-index-en.json` (one-time, expected)

   This step takes 15-30+ minutes due to API rate limits. Let it complete fully.

4. After completion, extract the FR database ID:
   ```bash
   grep NOTION_DATABASE_FR_ID .env
   ```
   Save this UUID for Part B.

5. Verify translation artifacts exist:
   ```bash
   ls -la .notion-cache/translation-index-fr.json
   ls -la scripts/translation-memory/it-fr.json
   ls -la .notion-cache/translation-index-en.json  # migrated from translation-index.json
   ```

**Part B: Create FR data files**

6. Create `_data/permitsFr.js` by copying `_data/permitsEn.js` with these changes:
   - Replace the `EN_DATABASE_ID` constant name and value with `FR_DATABASE_ID` set to the UUID from step 4 (hardcoded string, NOT an env var)
   - Update ALL console log prefixes from `[permitsEn.js]` to `[permitsFr.js]`
   - Update the module comment at the top from "EN permit pages" to "FR permit pages"
   - Everything else stays identical: same `IT_DATABASE_ID`, same `slugify()`, same `fetchDatabasePages()`, same `buildItSlugMap()`, same `parseQASections()`, same `getEmojiForPermit()`, same cache logic

7. Create `_data/documentsFr.js` by copying `_data/documentsEn.js` with these changes:
   - Replace `EN_DATABASE_ID` constant name and value with `FR_DATABASE_ID` set to the same UUID
   - Update ALL console log prefixes from `[documentsEn.js]` to `[documentsFr.js]`
   - Update the module comment at the top from "EN document pages" to "FR document pages"
   - CRITICAL: Add FR keyword fallbacks to the four `extractCost()` calls. The FR translated Notion document names will contain French words like "bordereau" and "timbre" instead of Italian "bollettino" and "marca da bollo". Update the cost extraction lines to:
     ```javascript
     const costBollettinoPrimo = extractCost(primoDocuments, 'bollettino') || extractCost(primoDocuments, 'bordereau') || extractCost(primoDocuments, 'postal payment');
     const costMarcaBolloPrimo = extractCost(primoDocuments, 'marca da bollo') || extractCost(primoDocuments, 'timbre') || extractCost(primoDocuments, 'revenue stamp');
     const costBollettinoRinnovo = extractCost(rinnovoDocuments, 'bollettino') || extractCost(rinnovoDocuments, 'bordereau') || extractCost(rinnovoDocuments, 'postal payment');
     const costMarcaBolloRinnovo = extractCost(rinnovoDocuments, 'marca da bollo') || extractCost(rinnovoDocuments, 'timbre') || extractCost(rinnovoDocuments, 'revenue stamp');
     ```
   - Everything else stays identical
  </action>
  <verify>
1. `grep NOTION_DATABASE_FR_ID .env` returns a UUID
2. `ls .notion-cache/translation-index-fr.json` exists
3. `ls scripts/translation-memory/it-fr.json` exists
4. `grep FR_DATABASE_ID _data/permitsFr.js` shows the hardcoded UUID (not an env var reference)
5. `grep FR_DATABASE_ID _data/documentsFr.js` shows the same hardcoded UUID
6. `grep "bordereau" _data/documentsFr.js` confirms FR cost keyword fallback is present
7. `grep "timbre" _data/documentsFr.js` confirms FR cost keyword fallback is present
  </verify>
  <done>
- FR Notion database created with translated permits
- Translation index and memory files exist for FR
- `_data/permitsFr.js` reads from FR DB with hardcoded ID
- `_data/documentsFr.js` reads from FR DB with hardcoded ID and FR cost keyword fallbacks
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify build fetches FR data</name>
  <files></files>
  <action>
Run the full build to confirm 11ty can fetch FR permit and document data from Notion without errors:

```bash
npm run build 2>&1 | grep -E '(permitsFr|documentsFr|Error|error)'
```

Expected output:
- `[permitsFr.js] Fetching FR permit data from Notion...` (or similar)
- `[permitsFr.js] Returning NN FR permits` where NN matches the translation count (expect ~41)
- `[documentsFr.js] Fetched NN FR pages from Notion`
- `[documentsFr.js] Prepared NN primo, NN rinnovo entries`
- NO error lines

The build will NOT generate FR pages yet (no Liquid templates exist -- that is Phase 53). It will only confirm the data files successfully fetch and parse FR content from Notion.

If the build shows errors in the FR data files, diagnose:
- "NOTION_API_KEY not set" -- check `.env` has `NOTION_API_KEY`
- "No FR permit data found" -- verify `FR_DATABASE_ID` in the data file matches `NOTION_DATABASE_FR_ID` in `.env`
- Notion API errors -- check the DB was created correctly by the translate script
  </action>
  <verify>
1. `npm run build` completes without errors in permitsFr.js or documentsFr.js
2. Build output shows FR permits fetched (count > 0)
3. Build output shows FR documents fetched (primo count > 0, rinnovo count > 0)
  </verify>
  <done>
- `npm run build` fetches FR content from Notion and reports permit + document counts matching the translation output
- No errors related to FR data files in build output
  </done>
</task>

</tasks>

<verification>
1. FR Notion database exists with translated permit entries (verify via script output count)
2. `.notion-cache/translation-index-fr.json` contains entries for all translated permits
3. `scripts/translation-memory/it-fr.json` exists with cached FR translations
4. `_data/permitsFr.js` has hardcoded `FR_DATABASE_ID` (not env var)
5. `_data/documentsFr.js` has hardcoded `FR_DATABASE_ID` + FR cost keyword fallbacks (`bordereau`, `timbre`)
6. `npm run build` fetches FR data without errors
7. `.notion-cache/translation-index-en.json` exists (migrated from old `translation-index.json`)
</verification>

<success_criteria>
- A French Notion database exists with translated entries for all IT permits (~41)
- The database contains translated document names, notes, and application method text
- Running `npm run build` fetches content from the FR database without errors
- FR data files follow the established pattern: hardcoded DB ID, IT slug resolution, Notion cache integration
</success_criteria>

<output>
After completion, create `.planning/phases/52-notion-database/52-01-SUMMARY.md`
</output>
