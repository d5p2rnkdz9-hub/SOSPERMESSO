---
phase: 15-document-deduplication
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/pages/permesso-asilo-politico.html
  - src/pages/permesso-assistenza-minore.html
  - src/pages/permesso-attesa-occupazione.html
  - src/pages/permesso-calamita-naturale.html
  - src/pages/permesso-coesione-familiare.html
  - src/pages/permesso-conviventi-familiari-italiani.html
  - src/pages/permesso-cure-mediche.html
  - src/pages/permesso-genitore-minore-italiano.html
  - src/pages/permesso-gravi-motivi-salute.html
  - src/pages/permesso-gravidanza.html
  - src/pages/permesso-lavoro-autonomo.html
  - src/pages/permesso-lavoro-subordinato.html
  - src/pages/permesso-minore-eta.html
  - src/pages/permesso-minori-stranieri-affidati.html
  - src/pages/permesso-prosieguo-amministrativo.html
  - src/pages/permesso-protezione-speciale.html
  - src/pages/permesso-protezione-sussidiaria.html
  - src/pages/permesso-richiesta-asilo.html
  - src/pages/permesso-ricongiungimento-familiare.html
  - src/pages/permesso-ue-lungo-periodo.html
autonomous: true

must_haves:
  truths:
    - "All 21 permit pages display two CTA buttons after page header"
    - "All CTA buttons link to correct documenti-[permit]-primo.html and documenti-[permit]-rinnovo.html"
    - "No permit page contains inline document sections"
  artifacts:
    - path: "src/pages/permesso-*.html"
      provides: "21 permit pages with CTA buttons"
      contains: "Documenti per il primo rilascio"
  key_links:
    - from: "src/pages/permesso-[permit].html"
      to: "documenti-[permit]-primo.html"
      via: "CTA button href"
      pattern: 'href="documenti-.*-primo.html"'
    - from: "src/pages/permesso-[permit].html"
      to: "documenti-[permit]-rinnovo.html"
      via: "CTA button href"
      pattern: 'href="documenti-.*-rinnovo.html"'
---

<objective>
Propagate CTA button pattern to remaining 20 permit pages and remove document sections

Purpose: Apply the validated CTA pattern from Plan 01 to all remaining permit pages, achieving 100% coverage
Output: All 21 permit pages have CTA buttons, no inline document sections remain
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-document-deduplication/15-01-SUMMARY.md (CTA pattern from template)
@.planning/phases/15-document-deduplication/15-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python script for bulk CTA addition and document removal</name>
  <files>src/pages/permesso-*.html (20 files, excluding permesso-studio.html which was done in Plan 01)</files>
  <action>
Create and run a Python script to process 20 remaining permit pages. Based on Phase 14 automation pattern.

**Script requirements:**

1. **Target pages:** All permesso-*.html files EXCEPT:
   - permesso-studio.html (already done in Plan 01)
   - permesso-asilo.html (redirect page, skip)

2. **For each page:**
   a. Extract permit name from filename: `permesso-[name].html` -> `[name]`
   b. Insert CTA section after PAGE HEADER section (before `<!-- CONTENT -->`)
   c. Remove document section cards (all variations)

3. **CTA template** (dynamically insert permit name):
```html
  <!-- DOCUMENT CTA -->
  <section class="section" style="padding: 1.5rem 0;">
    <div class="container" style="max-width: 900px;">
      <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
        <a href="documenti-{permit_name}-primo.html" class="btn btn-primary btn-lg">
          Documenti per il primo rilascio
        </a>
        <a href="documenti-{permit_name}-rinnovo.html" class="btn btn-secondary btn-lg">
          Documenti per il rinnovo
        </a>
      </div>
    </div>
  </section>
```

4. **Document section removal patterns** (remove entire `<div class="card">...</div>` containing these headers):
   - `<h2>ðŸ“„ Documenti - Primo Rilascio</h2>`
   - `<h2>ðŸ”„ Documenti - Rinnovo</h2>`
   - `<h2>ðŸ“„ Che documenti servono per la prima richiesta?</h2>`
   - `<h2>ðŸ”„ Che documenti servono per il rinnovo</h2>`
   - `<h2>ðŸ“„ Che documenti porto in questura</h2>`
   - `<h2>ðŸ“‹ Che documenti ti servono?</h2>`
   - `<h2>ðŸ“„ Che documenti ti servono?</h2>`
   - `<h2>ðŸ“„ Che documenti mi servono?</h2>`
   - `<h2>ðŸ“„ Documenti necessari</h2>`

5. **Important:** Some pages (like permesso-richiesta-asilo.html) have NO document section - the script should handle this gracefully (just add CTA, don't fail on missing document section).

6. **Insertion point:** Find `</section>` that ends the PAGE HEADER section (the one with `class="section bg-off-white"`), then insert CTA before `<!-- CONTENT -->`.

Print summary of changes for each file processed.
  </action>
  <verify>
Run the script. Check output shows 20 files processed.

Verify no errors occurred during processing.
  </verify>
  <done>Python script created and executed, 20 permit pages processed</done>
</task>

<task type="auto">
  <name>Task 2: Verify all 21 permit pages have CTA buttons</name>
  <files>src/pages/permesso-*.html</files>
  <action>
Run verification commands:

1. **Count permit pages with CTA buttons:**
```bash
grep -l "Documenti per il primo rilascio" src/pages/permesso-*.html | wc -l
```
Expected: 21 (all permit pages)

2. **List any permit pages MISSING CTA buttons:**
```bash
for f in src/pages/permesso-*.html; do
  # Skip redirect page
  if grep -q "http-equiv=\"refresh\"" "$f" 2>/dev/null; then continue; fi
  if ! grep -q "Documenti per il primo rilascio" "$f"; then
    echo "MISSING CTA: $f"
  fi
done
```
Expected: No output (all pages have CTA)

3. **Verify each CTA links to correct document page:**
```bash
for f in src/pages/permesso-*.html; do
  # Skip redirect page
  if grep -q "http-equiv=\"refresh\"" "$f" 2>/dev/null; then continue; fi

  permit=$(basename "$f" | sed 's/permesso-//;s/.html//')

  if ! grep -q "documenti-${permit}-primo.html" "$f"; then
    echo "WRONG PRIMO LINK: $f"
  fi
  if ! grep -q "documenti-${permit}-rinnovo.html" "$f"; then
    echo "WRONG RINNOVO LINK: $f"
  fi
done
```
Expected: No output (all links correct)
  </action>
  <verify>
All verification commands return expected results.
  </verify>
  <done>All 21 permit pages have correctly linked CTA buttons</done>
</task>

<task type="auto">
  <name>Task 3: Verify no inline document sections remain</name>
  <files>src/pages/permesso-*.html</files>
  <action>
Run verification commands:

1. **Count permit pages with document section headers:**
```bash
grep -l "<h2>.*[Dd]ocumenti" src/pages/permesso-*.html 2>/dev/null | while read f; do
  # Skip if it's just the CTA button text
  if ! grep -q "<h2>.*[Dd]ocumenti" "$f"; then continue; fi

  # Check for actual document section headers (not button text)
  matches=$(grep -E "<h2>.*(Documenti -|Che documenti|Documenti necessari)" "$f" 2>/dev/null | wc -l)
  if [ "$matches" -gt 0 ]; then
    echo "DOCUMENT SECTION REMAINS: $f ($matches matches)"
  fi
done
```
Expected: No output (all document sections removed)

2. **Detailed check - search for all known document header patterns:**
```bash
grep -rn "Documenti - Primo\|Documenti - Rinnovo\|Che documenti\|Documenti necessari" src/pages/permesso-*.html
```
Expected: No output

3. **Verify total card count is reasonable:**
For each file, count `<div class="card"` occurrences. Most pages should have 5-8 cards after removal (Cos'e, Durata, Requisiti, Lavoro/Conversione, Costi, etc.)
  </action>
  <verify>
No permit page contains inline document section headers.
  </verify>
  <done>All inline document sections removed from all 21 permit pages</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Coverage check - all 21 pages have CTA:**
```bash
count=$(grep -l "Documenti per il primo rilascio" src/pages/permesso-*.html | grep -v "permesso-asilo.html" | wc -l | tr -d ' ')
echo "Pages with CTA: $count/21"
```
Expected: 21/21

2. **Deduplication check - no document sections:**
```bash
count=$(grep -rn "Documenti - Primo\|Documenti - Rinnovo\|Che documenti\|Documenti necessari" src/pages/permesso-*.html 2>/dev/null | wc -l | tr -d ' ')
echo "Document section headers remaining: $count"
```
Expected: 0

3. **Link validity check:**
```bash
for f in src/pages/permesso-*.html; do
  if grep -q "http-equiv=\"refresh\"" "$f" 2>/dev/null; then continue; fi
  permit=$(basename "$f" | sed 's/permesso-//;s/.html//')

  # Check primo link exists
  if [ ! -f "src/pages/documenti-${permit}-primo.html" ]; then
    echo "MISSING: documenti-${permit}-primo.html"
  fi
  # Check rinnovo link exists
  if [ ! -f "src/pages/documenti-${permit}-rinnovo.html" ]; then
    echo "MISSING: documenti-${permit}-rinnovo.html"
  fi
done
```
Expected: No missing files

4. **Visual spot check:** Open 3-4 random permit pages in browser, verify CTA buttons appear correctly
</verification>

<success_criteria>
- All 21 permit pages (excluding permesso-asilo.html redirect) have CTA buttons
- "Documenti per il primo rilascio" button links to documenti-[permit]-primo.html
- "Documenti per il rinnovo" button links to documenti-[permit]-rinnovo.html
- No inline document sections remain in any permit page
- Other content sections preserved in all pages
- Pages render correctly in browser
</success_criteria>

<output>
After completion, create `.planning/phases/15-document-deduplication/15-02-SUMMARY.md`

Include:
- Final counts (pages updated, document sections removed)
- Any edge cases encountered
- List of any pages that needed special handling
- Confirmation all requirements met (DEDUP-01, DEDUP-02, CTA-01, CTA-02, CTA-03, CTA-04, COV-01)
</output>
