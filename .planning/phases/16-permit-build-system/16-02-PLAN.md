---
phase: 16-permit-build-system
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - scripts/notion-client.js
  - scripts/build-permits.js
  - .planning/TODO-permits.md
autonomous: true

must_haves:
  truths:
    - "Build script fetches all permits from Notion database"
    - "Script parses Q&A blocks (heading_3, bold paragraphs, inline bold)"
    - "Script generates permesso-*.html pages"
    - "Empty permits are logged to TODO-permits.md"
    - "At least one permit page generates successfully"
  artifacts:
    - path: "scripts/notion-client.js"
      provides: "Extended Notion client with block fetching"
      exports: ["fetchPermitData", "fetchPageBlocks", "testConnection"]
    - path: "scripts/build-permits.js"
      provides: "Permit page build script"
      min_lines: 150
    - path: ".planning/TODO-permits.md"
      provides: "List of empty permits needing content"
  key_links:
    - from: "scripts/build-permits.js"
      to: "scripts/notion-client.js"
      via: "require for fetchPermitData, fetchPageBlocks"
      pattern: "require.*notion-client"
    - from: "scripts/build-permits.js"
      to: "scripts/templates/permesso.js"
      via: "require for generatePermessoPage"
      pattern: "require.*templates/permesso"
---

<objective>
Create the build script that fetches permit content from Notion and generates HTML pages using the template from Plan 01.

Purpose: This is the core build infrastructure that reads Notion Q&A content, parses the three different question formats, and outputs static HTML pages. It enables the "build from source of truth" workflow for permit content.

Output:
- Extended `notion-client.js` with block fetching
- New `build-permits.js` that generates permit pages
- `.planning/TODO-permits.md` listing permits without content
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-permit-build-system/16-RESEARCH.md
@.planning/phases/16-permit-build-system/16-01-SUMMARY.md

# Reference patterns
@scripts/build-documents.js
@scripts/notion-client.js
@scripts/templates/helpers.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend notion-client.js with block fetching</name>
  <files>scripts/notion-client.js</files>
  <action>
Add block fetching functions to the existing `notion-client.js`:

**1. Add fetchPageBlocks function:**
```javascript
/**
 * Fetch all blocks (content) from a Notion page
 * Handles pagination and nested children
 * @param {string} pageId - Notion page ID
 * @returns {Promise<Array>} Array of block objects
 */
async function fetchPageBlocks(pageId) {
  const blocks = [];
  let cursor = undefined;

  do {
    const response = await notion.blocks.children.list({
      block_id: pageId,
      start_cursor: cursor,
      page_size: 100
    });

    blocks.push(...response.results);
    cursor = response.has_more ? response.next_cursor : undefined;
  } while (cursor);

  // Recursively fetch children for blocks that have them
  for (const block of blocks) {
    if (block.has_children) {
      block.children = await fetchPageBlocks(block.id);
    }
  }

  return blocks;
}
```

**2. Update module.exports:**
Add `fetchPageBlocks` to the exports:
```javascript
module.exports = { fetchPermitData, fetchPageBlocks, testConnection, DATABASE_ID };
```

**Note:** Keep all existing functions unchanged. This is an additive change only.
  </action>
  <verify>
Run: `node -e "const {fetchPageBlocks} = require('./scripts/notion-client.js'); console.log(typeof fetchPageBlocks);"` returns "function"
  </verify>
  <done>
- fetchPageBlocks function added to notion-client.js
- Function handles pagination (cursor loop)
- Function handles nested children recursively
- Existing functions unchanged
- Module exports updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create build-permits.js with Q&A parsing</name>
  <files>scripts/build-permits.js</files>
  <action>
Create `scripts/build-permits.js` following `build-documents.js` pattern:

**Structure:**
```javascript
const fs = require('fs/promises');
const path = require('path');
const { fetchPermitData, fetchPageBlocks, testConnection } = require('./notion-client.js');
const { generatePermessoPage } = require('./templates/permesso.js');
const { escapeHtml } = require('./templates/helpers.js');

const OUTPUT_DIR = path.join(__dirname, '../src/pages');
```

**Q&A Parsing Functions:**

1. `isQuestionBlock(block)` - Detect question patterns:
   - Style 1: `block.type === 'heading_3'` -> question is heading text
   - Style 2 & 3: `block.type === 'paragraph'` with first rich_text segment bold and ending in `?`
   - Return `{ question: string }` or `null`

2. `richTextToHtml(richTextArray)` - Convert Notion rich_text to HTML:
   - Handle annotations: bold -> `<strong>`, italic -> `<em>`, underline -> `<u>`, strikethrough -> `<s>`, code -> `<code>`
   - Handle links: `href` -> `<a href="...">`
   - Escape plain_text with escapeHtml()

3. `blockToHtml(block)` - Convert single block to HTML:
   - `paragraph` -> `<p>richTextToHtml()</p>`
   - `heading_3` -> `<h3>richTextToHtml()</h3>` (for non-question h3)
   - `bulleted_list_item` -> `<li>richTextToHtml()</li>` (will be wrapped later)
   - `numbered_list_item` -> `<li>richTextToHtml()</li>` (will be wrapped later)
   - `divider` -> `<hr>`
   - Handle children recursively

4. `groupAndRenderBlocks(blocks)` - Group list items and render:
   - Consecutive `bulleted_list_item` -> wrap in `<ul>...</ul>`
   - Consecutive `numbered_list_item` -> wrap in `<ol>...</ol>`
   - Other blocks render individually

5. `parseQASections(blocks)` - Main parser:
   - Iterate blocks, detect questions
   - Collect content blocks until next question
   - Return array of `{ question: string, content: string }` (content is rendered HTML)

**Main build() function:**
```javascript
async function build() {
  // Test connection
  // Fetch all permits via fetchPermitData()
  // For each permit with content:
  //   1. fetchPageBlocks(permit.id)
  //   2. parseQASections(blocks)
  //   3. Build permit object for template
  //   4. generatePermessoPage(permit)
  //   5. Write to OUTPUT_DIR/permesso-{slug}.html
  // Track empty permits (no blocks or no Q&A sections)
  // Write TODO-permits.md with empty permit list
  // Print summary
}
```

**Emoji extraction:**
- Check if page properties have an emoji field
- Default emoji based on permit type keywords:
  - "studio" -> "ðŸ“–"
  - "lavoro" -> "ðŸ’¼"
  - "protezione/asilo/rifugiato" -> "ðŸ›¡ï¸"
  - "famiglia/familiare" -> "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦"
  - "medic/salute/gravidanza" -> "ðŸ¥"
  - default -> "ðŸ“„"

**Subtitle extraction:**
- Use first paragraph of content as subtitle if it's short (< 100 chars)
- Otherwise use generic "Informazioni sul permesso di soggiorno"

**Error handling:**
- Wrap API calls in try/catch
- Log errors per permit, continue to next
- Track failed permits in summary

**Rate limiting:**
- Add 350ms delay between page block fetches (under 3 req/s limit)
  </action>
  <verify>
Run: `node scripts/build-permits.js` - should connect to Notion and attempt to build
Check output for permits found count and any generated files
  </verify>
  <done>
- build-permits.js exists with proper structure
- Q&A parsing handles all 3 formats (heading_3, bold paragraph, inline bold)
- List items grouped into ul/ol correctly
- Rich text formatting preserved (bold, italic, links)
- At least one permit page generated (if Notion has content)
- Empty permits logged appropriately
  </done>
</task>

<task type="auto">
  <name>Task 3: Run build and create TODO-permits.md</name>
  <files>.planning/TODO-permits.md</files>
  <action>
Run the build script and capture results:

```bash
node scripts/build-permits.js
```

**Expected output:**
- Connection to Notion
- List of permits processed
- Generated page filenames
- List of empty/skipped permits

**Create .planning/TODO-permits.md:**
```markdown
# Permits Needing Notion Content

**Generated:** [date]
**Source:** build-permits.js run

## Empty Permits

These permits have no Q&A content in Notion and need to be filled in:

| Permit | Notion Page ID | Reason |
|--------|----------------|--------|
| [tipo] | [id] | No blocks / No Q&A sections |
...

## Notes

- Edit permits in Notion database
- Re-run `node scripts/build-permits.js` after adding content
- See REQUIREMENTS.md for standard Q&A sections
```

If the build script already generates this file automatically, verify it exists and has content.

**Proof of concept check:**
- At least one `permesso-*.html` file should exist in `src/pages/`
- Open it in browser to verify it renders correctly
  </action>
  <verify>
1. Check for generated files: `ls src/pages/permesso-*.html | head -5`
2. Verify TODO-permits.md exists: `cat .planning/TODO-permits.md`
3. Open one generated permit page in browser to verify rendering
  </verify>
  <done>
- Build script runs successfully
- At least one permesso-*.html generated
- TODO-permits.md exists with empty permit list
- Generated pages render correctly in browser
  </done>
</task>

</tasks>

<verification>
1. notion-client.js has fetchPageBlocks export
2. build-permits.js runs without errors: `node scripts/build-permits.js`
3. Generated permit pages exist: `ls src/pages/permesso-*.html`
4. TODO-permits.md exists with permit tracking
5. Open generated page in browser - verify layout, styling, navigation
</verification>

<success_criteria>
- Build script fetches all permits from Notion (BUILD-01)
- Script parses Q&A format correctly (TMPL-03)
- At least one permit page generated as proof of concept (BUILD-02)
- Empty permits logged to TODO-permits.md (BUILD-03)
- Generated pages use standard section order (TMPL-01)
- Additional Q&A content preserved (TMPL-02)
</success_criteria>

<output>
After completion, create `.planning/phases/16-permit-build-system/16-02-SUMMARY.md`
</output>
