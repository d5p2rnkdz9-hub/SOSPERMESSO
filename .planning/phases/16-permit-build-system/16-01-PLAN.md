---
phase: 16-permit-build-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/templates/permesso.js
autonomous: true

must_haves:
  truths:
    - "Template generates valid HTML with all 7 standard sections"
    - "Template renders Q&A content with proper escaping"
    - "Template follows existing primo.js/rinnovo.js patterns"
    - "Generated HTML matches site styling (header, footer, cards)"
  artifacts:
    - path: "scripts/templates/permesso.js"
      provides: "Permit page template generator"
      exports: ["generatePermessoPage"]
      min_lines: 150
  key_links:
    - from: "scripts/templates/permesso.js"
      to: "scripts/templates/helpers.js"
      via: "require for escapeHtml, linkToDizionario"
      pattern: "require.*helpers"
---

<objective>
Create the permit page HTML template that generates `permesso-*.html` pages from structured Notion content.

Purpose: The template transforms parsed Q&A data into properly styled HTML pages matching the existing site design (header, navigation, footer, card styling). This is the output layer that Plan 02's build script will use.

Output: `scripts/templates/permesso.js` module exporting `generatePermessoPage(permit)` function.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-permit-build-system/16-RESEARCH.md

# Reference patterns
@scripts/templates/primo.js
@scripts/templates/helpers.js
@src/pages/permesso-studio.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create permesso.js template module</name>
  <files>scripts/templates/permesso.js</files>
  <action>
Create `scripts/templates/permesso.js` following the existing `primo.js` template pattern.

**Structure:**
1. Import helpers: `const { escapeHtml, linkToDizionario } = require('./helpers.js');`

2. Create section rendering helper:
```javascript
function renderSection(section) {
  // section = { question: string, content: string (HTML) }
  // Return card div with h2 for question, content inside
}
```

3. Create main function:
```javascript
function generatePermessoPage(permit) {
  // permit = {
  //   tipo: string,          // "Studio"
  //   slug: string,          // "studio"
  //   emoji: string,         // from Notion or default
  //   subtitle: string,      // brief description
  //   sections: [{question, content}, ...]  // Q&A pairs as HTML
  // }
}
```

**Template sections (in order):**
- DOCTYPE, html, head (meta, title, fonts, styles - copy from primo.js)
- Header with full navigation (copy from permesso-studio.html, NOT primo.js simplified header)
- Breadcrumb with error report button
- Page header with emoji icon, title, subtitle
- Document CTA buttons section (primo + rinnovo links)
- Content sections: Iterate over permit.sections, each in a card
- Related links section (database.html link)
- Footer (use current footer pattern from permesso-studio.html)
- Scripts (app.js, mobile.js)

**Key differences from primo.js:**
- Full nav with dropdowns (Database, Guide, Test, Collabora)
- Language switcher placeholder
- CTA buttons for documents
- Dynamic sections from parsed Q&A (not hardcoded content)

**Card styling by section type:**
- Use border-left colors based on section index or question keywords
- Blue for "Cos'√®", Yellow for "Requisiti/Chi pu√≤", Red for "Lavoro/Diritti", Teal for "Conversione"

**Escaping:**
- All user content through escapeHtml()
- URLs through encodeURIComponent() where needed
- Template literal interpolation is safe for already-escaped HTML content in sections
  </action>
  <verify>
Run: `node -e "const {generatePermessoPage} = require('./scripts/templates/permesso.js'); console.log(typeof generatePermessoPage);"` returns "function"
  </verify>
  <done>
- permesso.js exists with generatePermessoPage export
- Function accepts permit object with tipo, slug, emoji, subtitle, sections
- Generated HTML has valid structure (DOCTYPE, head, body, header, content, footer)
- Template includes full navigation dropdowns
- Template includes CTA buttons for document pages
  </done>
</task>

<task type="auto">
  <name>Task 2: Test template with mock data</name>
  <files>scripts/templates/permesso.js</files>
  <action>
Add a self-test block at the bottom of permesso.js (inside `if (require.main === module)` block) that:

1. Creates mock permit data:
```javascript
const mockPermit = {
  tipo: 'Studio',
  slug: 'studio',
  emoji: 'üìñ',
  subtitle: 'Per frequentare corsi universitari in Italia',
  sections: [
    {
      question: "Cos'√® questo permesso?",
      content: '<p>Il permesso di soggiorno per studio permette di frequentare corsi universitari.</p>'
    },
    {
      question: 'Chi pu√≤ chiederlo?',
      content: '<ul><li>Studenti con visto per studio</li><li>Iscritti a universit√† italiana</li></ul>'
    },
    {
      question: 'Posso lavorare?',
      content: '<p><strong>S√¨, con limiti:</strong> massimo 20 ore settimanali.</p>'
    }
  ]
};
```

2. Generates HTML and writes to `test-permesso-output.html` in project root

3. Logs success message with file path

Run the test: `node scripts/templates/permesso.js`

Verify output:
- File creates successfully
- HTML is valid (open in browser to check)
- Structure matches expected design
- Delete test file after verification
  </action>
  <verify>
Run: `node scripts/templates/permesso.js` - should output "Test page generated: test-permesso-output.html" (or similar)
Open `test-permesso-output.html` in browser - page renders with header, sections, footer
Delete test file: `rm test-permesso-output.html`
  </verify>
  <done>
- Self-test runs without errors
- Generated HTML opens correctly in browser
- All sections render in cards
- Navigation dropdowns visible
- CTA buttons present and linked correctly
  </done>
</task>

</tasks>

<verification>
1. Module exports work: `node -e "require('./scripts/templates/permesso.js')"`
2. Self-test passes: `node scripts/templates/permesso.js`
3. Output HTML is valid: Open test file in browser, check for rendering errors
4. No console errors in browser developer tools
</verification>

<success_criteria>
- scripts/templates/permesso.js exists and exports generatePermessoPage
- Template generates valid HTML matching site design
- Self-test produces working HTML page
- Template ready for build script integration in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/16-permit-build-system/16-01-SUMMARY.md`
</output>
