---
phase: 03-complete-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/slug-map.json
  - scripts/build-documents.js
  - src/pages/documenti-*-primo.html (19 redirect pages)
  - src/pages/documenti-*-rinnovo.html (19 redirect pages)
autonomous: false

must_haves:
  truths:
    - "User clicks any [Primo] badge on documenti-questura and lands on a working document page"
    - "User clicks any [Rinnovo] badge on documenti-questura and lands on a working document page"
    - "All 23 permits from database.html are represented with working links"
  artifacts:
    - path: "scripts/slug-map.json"
      provides: "Mapping of 19 display slugs to canonical slugs"
      contains: "studio"
    - path: "scripts/build-documents.js"
      provides: "Redirect page generation function"
      contains: "generateRedirectPage"
    - path: "src/pages/documenti-studio-primo.html"
      provides: "Redirect page example"
      contains: "meta http-equiv"
  key_links:
    - from: "documenti-questura.html badge hrefs"
      to: "redirect pages (documenti-{display-slug}-*.html)"
      via: "user clicks badge, browser loads redirect page"
      pattern: "documenti-studio-primo.html"
    - from: "redirect pages"
      to: "canonical pages (documenti-{canonical-slug}-*.html)"
      via: "meta refresh redirect"
      pattern: "refresh.*documenti-studio-art-39-primo.html"
---

<objective>
Create slug mapping and redirect pages so all 46 badge links on documenti-questura.html work without 404s.

Purpose: Phase 2 generated 63 document pages from Notion with descriptive slugs (e.g., "studio-art-39"). The documenti-questura.html navigation uses simplified slugs (e.g., "studio"). This creates 404s for 19 of 23 permit types. This plan bridges the gap with redirect pages.

Output: 38 HTML redirect pages (19 primo + 19 rinnovo), slug-map.json configuration, updated build script.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-complete-coverage/03-RESEARCH.md
@.planning/phases/02-document-templates/02-02-SUMMARY.md
@scripts/build-documents.js
@src/pages/documenti-questura.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create slug mapping configuration</name>
  <files>scripts/slug-map.json</files>
  <action>
Create scripts/slug-map.json with mappings from display slugs (used in documenti-questura.html) to canonical slugs (used in Notion-generated files).

The mapping must cover these 19 slugs that currently result in 404s:
- studio -> studio-art-39
- lavoro-subordinato -> lavoro-subordinato-a-seguito-di-ingresso-per-flussi
- ue-lungo-periodo -> carta-di-soggiorno-psuelp-art-9
- attesa-occupazione -> attesa-occupazione-art-22
- asilo-politico -> asilo-status-rifugiato
- protezione-speciale -> protezione-speciale-art-32-d-lgs-25-2008
- calamita-naturale -> calamita-naturale-art-20-bis
- prosieguo-amministrativo -> prosieguo-amministravo (note: typo in Notion)
- gravidanza -> donna-in-stato-di-gravidanza-e-padre-del-bambino
- cure-mediche -> cure-mediche-art-36-d-lgs-286-1998
- gravi-motivi-salute -> cure-mediche-ex-art-19-comma-2-lett-d-bis (OR persona-gravemente-malata-che-si-trova-gia-in-italia)
- ricongiungimento-familiare -> famiglia-motivi-famigliari-art-30-dopo-ingresso-con-nullaosta
- coesione-familiare -> famiglia-motivi-familiari-art-30-senza-nullaosta-coesione
- genitore-minore-italiano -> genitore-di-cittadino-italiano
- conviventi-familiari-italiani -> famiglia-motivi-famigliari-art-19
- assistenza-minore -> assistenza-minore-art-31
- minori-stranieri-affidati -> affidamento-a-familiari-entro-il-quarto-grado
- carta-soggiorno-familiare-ue -> familiari-di-cittadini-ue-carta-ue
- carta-soggiorno-familiare-italiano -> familiari-di-italiani-dinamici-carta-ue

JSON structure:
```json
{
  "displaySlug": "canonicalSlug",
  ...
}
```

Cross-check each mapping by verifying the canonical slug file exists in src/pages/.
  </action>
  <verify>
1. File exists: scripts/slug-map.json
2. JSON is valid: node -e "require('./scripts/slug-map.json')"
3. Contains 19 entries (one for each missing slug)
4. Each canonical slug maps to existing files in src/pages/
  </verify>
  <done>
slug-map.json exists with 19 display-to-canonical slug mappings, all validated against existing files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add redirect page generation to build script</name>
  <files>scripts/build-documents.js</files>
  <action>
Extend scripts/build-documents.js with redirect page generation capability.

1. Add function generateRedirectPage(displaySlug, canonicalSlug, type):
```javascript
function generateRedirectPage(displaySlug, canonicalSlug, type) {
  const targetFile = `documenti-${canonicalSlug}-${type}.html`;
  return `<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="0;url=${targetFile}">
  <link rel="canonical" href="${targetFile}">
  <title>Redirecting...</title>
</head>
<body>
  <p>Reindirizzamento in corso...</p>
  <script>window.location.replace("${targetFile}");</script>
</body>
</html>`;
}
```

2. Add function generateAliasPages():
- Load slug-map.json
- For each entry, generate primo and rinnovo redirect pages
- Write to src/pages/documenti-{displaySlug}-{type}.html
- Log each redirect page created

3. Call generateAliasPages() in main() function AFTER document page generation (so canonical pages exist first).

4. Add summary log: "Generated X redirect pages for URL aliasing"

Important: Do NOT modify existing page generation logic. Only ADD redirect generation.
  </action>
  <verify>
1. Run: node scripts/build-documents.js
2. Check output shows redirect page generation logs
3. Count redirect files: ls src/pages/documenti-*-primo.html | wc -l (should increase by 19)
4. Spot check one redirect: cat src/pages/documenti-studio-primo.html (should contain meta refresh)
  </verify>
  <done>
Build script extended with generateRedirectPage() and generateAliasPages() functions. Running build generates 38 redirect pages (19 primo + 19 rinnovo) in addition to existing Notion-generated pages.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Slug mapping configuration and redirect pages for all 23 permit types, eliminating 404s when clicking badges on documenti-questura.html.
  </what-built>
  <how-to-verify>
1. Open documenti-questura.html in browser
2. Click on [Primo] badge for "Permesso per studio" - should redirect to documenti-studio-art-39-primo.html (not 404)
3. Click on [Rinnovo] badge for "Permesso di soggiorno per lavoro subordinato" - should redirect to actual document page
4. Randomly test 3-4 more badges from different categories (protezione, cure mediche, familiari)
5. Verify redirect is instant (0-second delay)
6. Verify destination page shows correct document checklist

Expected: All 46 badge links work, no 404 errors.
  </how-to-verify>
  <resume-signal>Type "approved" if all badge links work, or describe which badges still show 404</resume-signal>
</task>

</tasks>

<verification>
- [ ] All 23 permits have working [Primo] badge links (no 404s)
- [ ] All 23 permits have working [Rinnovo] badge links (no 404s)
- [ ] Redirect pages use meta refresh (SEO-friendly, works without JS)
- [ ] Redirect pages have canonical link to target page
- [ ] Build script runs without errors
- [ ] Slug mapping is version-controlled in scripts/slug-map.json
</verification>

<success_criteria>
1. User clicks any [Primo] badge on documenti-questura page and lands on a working document page (no 404s)
2. User clicks any [Rinnovo] badge on documenti-questura page and lands on a working document page (no 404s)
3. All 23 permits from database.html present in documenti-questura with working links
4. Build script can regenerate all redirect pages from slug-map.json
</success_criteria>

<output>
After completion, create `.planning/phases/03-complete-coverage/03-01-SUMMARY.md`
</output>
