---
phase: 03-complete-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/slug-map.json
  - scripts/build-documents.js
  - src/pages/documenti-*-primo.html (redirect pages)
  - src/pages/documenti-*-rinnovo.html (redirect pages)
autonomous: false

must_haves:
  truths:
    - "User clicks any [Primo] badge on documenti-questura and lands on a working document page"
    - "User clicks any [Rinnovo] badge on documenti-questura and lands on a working document page"
    - "All 23 permits from database.html are represented with working links"
  artifacts:
    - path: "scripts/slug-map.json"
      provides: "Mapping of display slugs to canonical slugs"
      contains: "studio"
    - path: "scripts/build-documents.js"
      provides: "Redirect page generation function"
      contains: "generateRedirectPage"
    - path: "src/pages/documenti-studio-primo.html"
      provides: "Redirect page example"
      contains: "meta http-equiv"
  key_links:
    - from: "documenti-questura.html badge hrefs"
      to: "redirect pages (documenti-{display-slug}-*.html)"
      via: "user clicks badge, browser loads redirect page"
      pattern: "documenti-studio-primo.html"
    - from: "redirect pages"
      to: "canonical pages (documenti-{canonical-slug}-*.html)"
      via: "meta refresh redirect"
      pattern: "refresh.*documenti-studio-art-39-primo.html"
---

<objective>
Create slug mapping and redirect pages so all 46 badge links on documenti-questura.html work without 404s.

Purpose: Phase 2 generated 63 document pages from Notion with descriptive slugs (e.g., "studio-art-39"). The documenti-questura.html navigation uses simplified slugs (e.g., "studio"). This creates 404s for permits where display slug != canonical slug. This plan bridges the gap with redirect pages.

Output: Redirect pages for all display slugs that differ from canonical slugs, slug-map.json configuration, updated build script.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-complete-coverage/03-RESEARCH.md
@.planning/phases/02-document-templates/02-02-SUMMARY.md
@scripts/build-documents.js
@src/pages/documenti-questura.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Discover and create slug mapping configuration</name>
  <files>scripts/slug-map.json</files>
  <action>
SYSTEMATIC DISCOVERY APPROACH:

**Step 1: Extract display slugs from documenti-questura.html**
Run: grep -o 'href="documenti-[^"]*"' src/pages/documenti-questura.html | sort -u
This gives all 46 badge hrefs (23 primo + 23 rinnovo).

**Step 2: Extract canonical slugs from existing files**
Run: ls src/pages/documenti-*-primo.html src/pages/documenti-*-rinnovo.html | sort
This gives all 63 Notion-generated canonical files.

**Step 3: Identify mismatches**
For each display slug from Step 1:
- Check if a file with that exact slug exists in Step 2
- If YES: no redirect needed (direct match)
- If NO: find the matching canonical slug and record the mapping

**Step 4: Handle one-to-many mappings**
When a display slug could map to multiple canonical slugs, apply these PRIORITY RULES:

| Display Slug | Candidates | CHOSEN | Rationale |
|--------------|------------|--------|-----------|
| lavoro-subordinato | flussi, conversione | flussi | Most common entry path for subordinate work |
| gravi-motivi-salute | cure-mediche-ex-art-19, persona-gravemente-malata | cure-mediche-ex-art-19 | More specific legal reference |

**Step 5: Create scripts/slug-map.json**
JSON structure:
```json
{
  "mappings": {
    "displaySlug": "canonicalSlug",
    ...
  },
  "notes": {
    "prosieguo-amministravo": "INTENTIONAL TYPO: Matches Notion source exactly. The typo 'amministravo' (missing 'ti') is preserved from original Notion database.",
    "lavoro-subordinato": "Maps to 'flussi' variant. For 'conversione' variant, use full slug."
  }
}
```

**Expected mappings (to be verified programmatically):**
- studio -> studio-art-39
- lavoro-subordinato -> lavoro-subordinato-a-seguito-di-ingresso-per-flussi (NOT conversione)
- ue-lungo-periodo -> carta-di-soggiorno-psuelp-art-9
- attesa-occupazione -> attesa-occupazione-art-22
- asilo-politico -> asilo-status-rifugiato
- protezione-speciale -> protezione-speciale-art-32-d-lgs-25-2008
- calamita-naturale -> calamita-naturale-art-20-bis
- prosieguo-amministrativo -> prosieguo-amministravo (NOTE: typo in Notion source is INTENTIONAL)
- gravidanza -> donna-in-stato-di-gravidanza-e-padre-del-bambino
- cure-mediche -> cure-mediche-art-36-d-lgs-286-1998
- gravi-motivi-salute -> cure-mediche-ex-art-19-comma-2-lett-d-bis (NOT persona-gravemente-malata)
- ricongiungimento-familiare -> famiglia-motivi-famigliari-art-30-dopo-ingresso-con-nullaosta
- coesione-familiare -> famiglia-motivi-familiari-art-30-senza-nullaosta-coesione
- genitore-minore-italiano -> genitore-di-cittadino-italiano
- conviventi-familiari-italiani -> famiglia-motivi-famigliari-art-19
- assistenza-minore -> assistenza-minore-art-31
- minori-stranieri-affidati -> affidamento-a-familiari-entro-il-quarto-grado
- carta-soggiorno-familiare-ue -> familiari-di-cittadini-ue-carta-ue
- carta-soggiorno-familiare-italiano -> familiari-di-italiani-dinamici-carta-ue

VALIDATION: After creating the mapping, verify EACH entry:
- For each displaySlug in the mapping:
  1. Confirm documenti-{displaySlug}-primo.html does NOT exist (otherwise no redirect needed)
  2. Confirm documenti-{canonicalSlug}-primo.html DOES exist
  3. Confirm documenti-{canonicalSlug}-rinnovo.html DOES exist (if rinnovo badge exists)
  </action>
  <verify>
1. File exists: scripts/slug-map.json
2. JSON is valid: node -e "require('./scripts/slug-map.json')"
3. Programmatic validation script (run inline):
```bash
node -e "
const fs = require('fs');
const map = require('./scripts/slug-map.json');
let errors = 0;
for (const [display, canonical] of Object.entries(map.mappings)) {
  const directFile = 'src/pages/documenti-' + display + '-primo.html';
  const canonicalFile = 'src/pages/documenti-' + canonical + '-primo.html';
  if (fs.existsSync(directFile)) {
    console.log('WARNING: ' + display + ' has direct file, no redirect needed');
  }
  if (!fs.existsSync(canonicalFile)) {
    console.log('ERROR: Canonical file not found: ' + canonicalFile);
    errors++;
  }
}
console.log('Validation complete. Errors: ' + errors);
process.exit(errors);
"
```
4. Notes section includes explanation for prosieguo-amministravo typo
5. Notes section includes explanation for lavoro-subordinato choice
  </verify>
  <done>
slug-map.json exists with validated display-to-canonical slug mappings. Each mapping verified to point to existing canonical files. Typos from Notion source documented in notes section.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add redirect page generation to build script</name>
  <files>scripts/build-documents.js</files>
  <action>
Extend scripts/build-documents.js with redirect page generation capability.

1. Add function generateRedirectPage(displaySlug, canonicalSlug, type):
```javascript
function generateRedirectPage(displaySlug, canonicalSlug, type) {
  const targetFile = `documenti-${canonicalSlug}-${type}.html`;
  return `<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="0;url=${targetFile}">
  <link rel="canonical" href="${targetFile}">
  <title>Redirecting...</title>
</head>
<body>
  <p>Reindirizzamento in corso...</p>
  <script>window.location.replace("${targetFile}");</script>
</body>
</html>`;
}
```

2. Add function generateAliasPages():
- Load slug-map.json
- For each entry in mappings:
  - Generate primo redirect page: documenti-{displaySlug}-primo.html -> documenti-{canonicalSlug}-primo.html
  - Check if rinnovo exists for canonical before generating rinnovo redirect
  - Write to src/pages/documenti-{displaySlug}-{type}.html
  - Log each redirect page created
- Skip if redirect page already exists (avoid overwriting canonical pages)

3. Call generateAliasPages() in main() function AFTER document page generation (so canonical pages exist first).

4. Add summary log: "Generated X redirect pages for URL aliasing"

Important: Do NOT modify existing page generation logic. Only ADD redirect generation.
Important: Check if displaySlug file already exists before writing (don't overwrite canonical pages like lavoro-autonomo).
  </action>
  <verify>
1. Run: node scripts/build-documents.js
2. Check output shows redirect page generation logs
3. Spot check redirect file exists: ls src/pages/documenti-studio-primo.html
4. Spot check redirect content: cat src/pages/documenti-studio-primo.html (should contain meta refresh to studio-art-39)
5. Verify canonical pages NOT overwritten: cat src/pages/documenti-lavoro-autonomo-primo.html (should be full document, not redirect)
6. Count total pages: ls src/pages/documenti-*.html | wc -l
  </verify>
  <done>
Build script extended with generateRedirectPage() and generateAliasPages() functions. Running build generates redirect pages for all display slugs that differ from canonical slugs. Canonical pages are never overwritten.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Slug mapping configuration and redirect pages for all permit types, eliminating 404s when clicking badges on documenti-questura.html.
  </what-built>
  <how-to-verify>
1. Open documenti-questura.html in browser
2. Click on [Primo] badge for "Permesso per studio" - should redirect to documenti-studio-art-39-primo.html (not 404)
3. Click on [Rinnovo] badge for "Permesso di soggiorno per lavoro subordinato" - should redirect to flussi variant
4. Click on [Primo] for "Prosieguo amministrativo" - should redirect (the typo 'amministravo' is intentional)
5. Randomly test 3-4 more badges from different categories (protezione, cure mediche, familiari)
6. Verify redirect is instant (0-second delay)
7. Verify destination page shows correct document checklist

Expected: All 46 badge links work, no 404 errors.
  </how-to-verify>
  <resume-signal>Type "approved" if all badge links work, or describe which badges still show 404</resume-signal>
</task>

</tasks>

<verification>
- [ ] All 23 permits have working [Primo] badge links (no 404s)
- [ ] All 23 permits have working [Rinnovo] badge links (no 404s)
- [ ] Redirect pages use meta refresh (SEO-friendly, works without JS)
- [ ] Redirect pages have canonical link to target page
- [ ] Build script runs without errors
- [ ] Slug mapping validated programmatically (all canonical files exist)
- [ ] One-to-many mappings documented with rationale (lavoro-subordinato -> flussi)
- [ ] Notion typos documented (prosieguo-amministravo note)
- [ ] Canonical pages not overwritten by redirects
</verification>

<success_criteria>
1. User clicks any [Primo] badge on documenti-questura page and lands on a working document page (no 404s)
2. User clicks any [Rinnovo] badge on documenti-questura page and lands on a working document page (no 404s)
3. All 23 permits from database.html present in documenti-questura with working links
4. Build script can regenerate all redirect pages from slug-map.json
5. Slug mappings validated against actual files (no orphan mappings)
</success_criteria>

<output>
After completion, create `.planning/phases/03-complete-coverage/03-01-SUMMARY.md`
</output>
