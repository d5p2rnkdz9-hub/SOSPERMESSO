---
phase: 51-translation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/translate-notion.js
  - scripts/translation-glossary.json
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running `npm run translate:fr -- --dry-run` lists all IT permits without errors (script parses --lang fr correctly)"
    - "Running `npm run translate -- --dry-run` still lists IT permits exactly as before (EN default backward-compatible)"
    - "The FR glossary contains all ~32 immigration/legal terms mapped to standard French equivalents"
    - "Translation index files are language-specific (translation-index-en.json, translation-index-fr.json) preventing cross-language corruption"
    - "The system prompt says 'French' when --lang fr is used and 'English' when --lang en or no --lang is used"
  artifacts:
    - path: "scripts/translate-notion.js"
      provides: "Multi-language translation script with --lang parameter"
      contains: "getLangConfig"
    - path: "scripts/translation-glossary.json"
      provides: "FR glossary terms alongside existing EN terms"
      contains: "termsFr"
    - path: "package.json"
      provides: "translate:fr and translate:fr:dry npm scripts"
      contains: "translate:fr"
  key_links:
    - from: "scripts/translate-notion.js"
      to: "scripts/translation-glossary.json"
      via: "glossary[termsKey] where termsKey is 'termsFr' or 'terms' based on lang"
      pattern: "termsFr|terms"
    - from: "scripts/translate-notion.js"
      to: ".notion-cache/translation-index-{lang}.json"
      via: "getLangConfig(lang).translationIndexPath"
      pattern: "translation-index-.*\\.json"
    - from: "scripts/translate-notion.js"
      to: "scripts/translation-memory.js"
      via: "loadTranslationMemory('it', lang) for it-fr.json or it-en.json"
      pattern: "loadTranslationMemory.*lang"
---

<objective>
Make the existing translation script (`translate-notion.js`) support French as a target language via `--lang fr`, with a dedicated FR glossary and language-specific translation index files.

Purpose: This is the infrastructure foundation for Phase 52 (which will actually RUN the translation to populate the FR Notion database). Without this refactor, the script can only produce EN output.

Output: A parameterized translation script, FR glossary in translation-glossary.json, and npm convenience scripts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-translation-infrastructure/51-RESEARCH.md

@scripts/translate-notion.js
@scripts/translation-glossary.json
@scripts/translation-memory.js
@scripts/notion-cache.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Parameterize translate-notion.js for multi-language support</name>
  <files>scripts/translate-notion.js</files>
  <action>
Refactor `translate-notion.js` to support `--lang <code>` (defaulting to `en` for backward compatibility). The changes are:

1. **parseArgs()** (line 50-73): Add `lang: 'en'` to default opts. Add case `'--lang': opts.lang = args[++i]; break;` to the switch.

2. **showHelp()** (line 75-88): Update usage text to include `--lang <code>` option with description "Target language (en, fr). Default: en".

3. **Add `getLangConfig(lang)` function** after parseArgs. Returns an object with language-specific config:
   ```js
   function getLangConfig(lang) {
     const configs = {
       en: {
         dbEnvVar: 'NOTION_DATABASE_EN_ID',
         parentEnvVar: 'NOTION_EN_PARENT_PAGE_ID',
         translationIndexPath: path.join(cache.CACHE_DIR, 'translation-index-en.json'),
         dbTitle: 'EN - Permits Database',
         langName: 'English',
         langCode: 'en',
         glossaryKey: 'terms',  // backward compat: EN uses existing 'terms' key
       },
       fr: {
         dbEnvVar: 'NOTION_DATABASE_FR_ID',
         parentEnvVar: 'NOTION_FR_PARENT_PAGE_ID',
         translationIndexPath: path.join(cache.CACHE_DIR, 'translation-index-fr.json'),
         dbTitle: 'FR - Permits Database',
         langName: 'French',
         langCode: 'fr',
         glossaryKey: 'termsFr',
       },
     };
     const config = configs[lang];
     if (!config) {
       console.error(`Unsupported language: "${lang}". Supported: ${Object.keys(configs).join(', ')}`);
       process.exit(1);
     }
     return config;
   }
   ```

4. **Add `migrateTranslationIndex()` function** near loadTranslationIndex:
   ```js
   async function migrateTranslationIndex() {
     const oldPath = path.join(cache.CACHE_DIR, 'translation-index.json');
     const newEnPath = path.join(cache.CACHE_DIR, 'translation-index-en.json');
     try {
       await fs.access(oldPath);
       try { await fs.access(newEnPath); } catch {
         await fs.rename(oldPath, newEnPath);
         console.log('[translate] Migrated translation-index.json -> translation-index-en.json');
       }
     } catch { /* old file doesn't exist, nothing to migrate */ }
   }
   ```

5. **Remove the top-level `TRANSLATION_INDEX_PATH` constant** (line 28). Replace it with a variable set in main() from getLangConfig. Update `loadTranslationIndex()` and `saveTranslationIndex()` to accept `indexPath` as a parameter instead of using the module-level constant.

6. **Rename `ensureEnDatabase()` to `ensureTargetDatabase(notion, langConfig)`** (line 399-455). Replace:
   - `process.env.NOTION_DATABASE_EN_ID` -> `process.env[langConfig.dbEnvVar]`
   - `process.env.NOTION_EN_PARENT_PAGE_ID` -> `process.env[langConfig.parentEnvVar]`
   - `'EN - Permits Database'` -> `langConfig.dbTitle`
   - All console log messages: `'EN'` -> `langConfig.langCode.toUpperCase()`
   - `.env` append line: `NOTION_DATABASE_EN_ID=` -> `${langConfig.dbEnvVar}=`
   - Return keys: rename `enDbId`/`enDataSourceId` to `targetDbId`/`targetDataSourceId` (update all callers)

7. **Update `buildTranslationPrompt()`** (line 462-491) to accept `lang` and `glossary` params:
   - Use `glossary[langConfig.glossaryKey]` (falling back to `glossary.terms` if key missing)
   - Change `"Translate Italian text to English"` -> `"Translate Italian text to ${langConfig.langName}"`
   - The rest of the prompt (rules, format) stays identical

8. **Update `batchTranslateSegments()`** (line 533-589): Change the hardcoded prompt at line 555 from `"Translate these ${texts.length} lines from Italian to English"` to `"Translate these ${texts.length} lines from Italian to ${langConfig.langName}"`. Pass `langConfig` as an additional parameter.

9. **Update `main()`** (line 1080+):
   - After parseArgs, call `const langConfig = getLangConfig(opts.lang);`
   - Call `await migrateTranslationIndex();` before loading the index
   - Change `loadTranslationIndex()` to `loadTranslationIndex(langConfig.translationIndexPath)`
   - Change `saveTranslationIndex(index)` to `saveTranslationIndex(index, langConfig.translationIndexPath)`
   - Change `ensureEnDatabase(notion)` to `ensureTargetDatabase(notion, langConfig)`
   - Change `tm.loadTranslationMemory('it', 'en')` to `tm.loadTranslationMemory('it', opts.lang)`
   - Change `tm.saveTranslationMemory('it', 'en', memory)` to `tm.saveTranslationMemory('it', opts.lang, memory)`
   - Change `buildTranslationPrompt()` to `buildTranslationPrompt(langConfig)`
   - Pass `langConfig` through to `batchTranslateSegments` calls (this flows through `translateSectionBlocks` which calls it)
   - Update all console log messages that say "EN" to use `langConfig.langCode.toUpperCase()`
   - Update the index page key from `enPageId` to `targetPageId` (or keep `enPageId` as-is and document that it means "target page ID" generically -- RESEARCH recommends keeping simple, so use a generic key name like `targetPageId`)

10. **Update `writeEnPage()`** to `writeTargetPage()`**: Rename and update the function signature. Change `enPageId` references to `targetPageId`. Update console logs from "EN" to use the lang code.

11. **Update `findEnPage()`** to `findTargetPage()`**: Rename. Same logic, just rename for clarity.

12. **Update `handleDeletedPermits()`**: Update log messages from "EN" to use lang code.

13. **Update `verifyEnPage()`** to `verifyTargetPage()`**: Rename. Update the title check -- EN DB uses 'Name' as the title property, FR DB will too (same ensureTargetDatabase creates it). Keep checking 'Name'.

14. **Update file header comment** (lines 1-14): Change "Translate IT Notion permit content to EN" to "Translate IT Notion permit content to target language (EN/FR) via Claude API". Update usage examples to show `--lang fr`.

CRITICAL BACKWARD COMPATIBILITY: After all changes, running `node scripts/translate-notion.js` (no --lang flag) MUST behave identically to the current script. The `lang` defaults to `'en'`, which uses `glossary.terms` (not `termsEn`), reads `NOTION_DATABASE_EN_ID`, and writes to `translation-index-en.json` (after migration).

IMPORTANT: The `translateSectionBlocks()` function (line 595) calls `batchTranslateSegments()`. Pass `langConfig` through the call chain: main -> translateSectionBlocks -> batchTranslateSegments. Add `langConfig` parameter to `translateSectionBlocks()`.

AVOID: Do NOT create a separate `translate-notion-fr.js` file. The whole point is one parameterized script.
AVOID: Do NOT change the translation-memory.js module -- it already supports any language pair.
AVOID: Do NOT rename the `terms` key in translation-glossary.json to `termsEn`. Keep `terms` as-is for backward compat. FR uses `termsFr`.
  </action>
  <verify>
Run these checks:
1. `node scripts/translate-notion.js --help` shows --lang option in help text
2. `node scripts/translate-notion.js --dry-run` lists IT permits (backward compat, defaults to EN)
3. `node scripts/translate-notion.js --lang fr --dry-run` lists IT permits with FR-specific messaging
4. `node scripts/translate-notion.js --lang xx 2>&1` shows "Unsupported language" error
5. Verify no syntax errors: `node -c scripts/translate-notion.js`
6. Verify the file no longer contains any hardcoded `'translation-index.json'` (without lang suffix)
7. Verify `ensureEnDatabase` function name no longer exists (replaced by `ensureTargetDatabase`)
  </verify>
  <done>
The translate-notion.js script accepts `--lang fr` and `--lang en` (or no flag = en default). All language-specific values (DB env vars, index path, glossary key, system prompt language name, database title) are derived from `getLangConfig()`. Auto-migration renames the old translation-index.json to translation-index-en.json. Running with no --lang flag produces identical behavior to the pre-refactor script.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FR glossary and add npm scripts</name>
  <files>scripts/translation-glossary.json, package.json</files>
  <action>
**1. Update `scripts/translation-glossary.json`:**

Add a `termsFr` key alongside the existing `terms` key. The `terms` key stays unchanged (EN backward compat). Add these ~32 FR immigration/legal term mappings:

```json
"termsFr": {
  "permesso di soggiorno": "titre de séjour",
  "permesso": "titre de séjour",
  "Questura": "Questure (commissariat principal)",
  "Prefettura": "Préfecture",
  "soggiornante di lungo periodo": "résident de longue durée",
  "decreto flussi": "décret annuel sur les quotas d'immigration",
  "kit postale": "kit postal",
  "primo rilascio": "première délivrance",
  "rinnovo": "renouvellement",
  "richiesta asilo": "demande d'asile",
  "protezione internazionale": "protection internationale",
  "protezione sussidiaria": "protection subsidiaire",
  "protezione speciale": "protection spéciale",
  "status di rifugiato": "statut de réfugié",
  "ricongiungimento familiare": "regroupement familial",
  "coesione familiare": "cohésion familiale",
  "motivi familiari": "motifs familiaux",
  "lavoro subordinato": "travail salarié",
  "lavoro autonomo": "travail indépendant",
  "attesa occupazione": "recherche d'emploi",
  "ricerca lavoro": "recherche d'emploi",
  "Commissione Territoriale": "Commission territoriale",
  "Servizio Sanitario Nazionale": "Service national de santé (SSN)",
  "SSN": "SSN (Sécurité sociale italienne)",
  "marca da bollo": "timbre fiscal",
  "bollettino postale": "bordereau de paiement postal",
  "codice fiscale": "code fiscal",
  "carta d'identità": "carte d'identité",
  "dichiarazione ospitalità": "déclaration d'hébergement",
  "contratto di affitto": "contrat de location",
  "cittadino UE": "citoyen UE",
  "cittadino italiano": "citoyen italien",
  "extracomunitario": "ressortissant non-UE",
  "minore": "mineur",
  "maggiorenne": "majeur",
  "visto di ingresso": "visa d'entrée",
  "permesso giallo": "récépissé (permesso giallo)",
  "carta di soggiorno": "carte de séjour"
}
```

Also update `meta.version` to `"1.1"` and `meta.description` to `"Translation glossary for IT→EN and IT→FR. Terms must be translated consistently across all pages."` and `meta.lastUpdated` to `"2026-02-18"`.

The `doNotTranslate` and `uiStrings` sections remain unchanged. (FR UI strings will be handled in Phase 53.)

**2. Update `package.json`:**

Add two new scripts after the existing `translate:dry` entry:
```json
"translate:fr": "node scripts/translate-notion.js --lang fr",
"translate:fr:dry": "node scripts/translate-notion.js --lang fr --dry-run"
```

Keep all existing scripts unchanged.
  </action>
  <verify>
1. `node -e "const g = require('./scripts/translation-glossary.json'); console.log(Object.keys(g.termsFr).length)"` outputs a number >= 32
2. `node -e "const g = require('./scripts/translation-glossary.json'); console.log(g.terms['permesso di soggiorno'])"` outputs "residence permit" (EN unchanged)
3. `node -e "const g = require('./scripts/translation-glossary.json'); console.log(g.termsFr['permesso di soggiorno'])"` outputs "titre de séjour"
4. `npm run translate:fr:dry` lists IT permits with FR messaging (no errors)
5. `npm run translate:dry` still works identically to before (EN default)
6. `node -e "const p = require('./package.json'); console.log(p.scripts['translate:fr'])"` outputs the correct command
  </verify>
  <done>
translation-glossary.json contains `termsFr` with all FR immigration terms. package.json has `translate:fr` and `translate:fr:dry` convenience scripts. Both EN scripts (`translate`, `translate:dry`) are unchanged and backward-compatible.
  </done>
</task>

</tasks>

<verification>
1. **Backward compatibility:** `npm run translate -- --dry-run` produces identical output to the pre-refactor script
2. **FR dry run:** `npm run translate:fr:dry` lists all IT permits without errors
3. **Unsupported language:** `npm run translate -- --lang xx` exits with clear "Unsupported language" error
4. **Index migration:** If `.notion-cache/translation-index.json` exists, running the script renames it to `translation-index-en.json` and logs the migration
5. **Glossary integrity:** Both `terms` (EN) and `termsFr` (FR) exist in translation-glossary.json with correct values
6. **No syntax errors:** `node -c scripts/translate-notion.js` exits 0
</verification>

<success_criteria>
- `npm run translate:fr:dry` completes successfully listing all IT permits
- `npm run translate:dry` still works identically (backward compat)
- FR glossary has all ~32 standard immigration terms
- Translation index path is language-specific (no cross-language corruption risk)
- Script help text documents the --lang option
</success_criteria>

<output>
After completion, create `.planning/phases/51-translation-infrastructure/51-01-SUMMARY.md`
</output>
