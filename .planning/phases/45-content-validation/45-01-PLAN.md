---
phase: 45-content-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/validate-permits.js
  - .planning/phases/45-content-validation/validation-findings.json
autonomous: true

must_haves:
  truths:
    - "Every permit's DB columns are compared against its page Q&A content"
    - "Phase 43 rule violations are detected across ALL permits"
    - "Gaps (DB has data, page missing section) are identified"
    - "Conflicts (DB says X, page says Y) are flagged"
    - "Document pages are validated for correct document lists, notes, and Phase 43 rules"
    - "Findings are machine-readable for Plan 02 to process"
  artifacts:
    - path: "scripts/validate-permits.js"
      provides: "Automated cross-reference of DB columns vs. page content for permits AND documents"
      min_lines: 200
    - path: ".planning/phases/45-content-validation/validation-findings.json"
      provides: "Structured findings for all permits and document pages"
      contains: "documents"
  key_links:
    - from: "scripts/validate-permits.js"
      to: "Notion API"
      via: "@notionhq/client"
      pattern: "notion\\.pages\\.retrieve|notion\\.blocks\\.children\\.list"
    - from: "scripts/validate-permits.js"
      to: "_site/documenti-*"
      via: "HTML file reading for document page validation"
      pattern: "readFileSync.*documenti-"
---

<objective>
Build and run automated content validation that cross-references every permit's Notion database columns against its page Q&A content AND validates document pages for correctness. Detect Phase 43 rule violations, missing sections, and conflicts.

Purpose: Automated pre-screening finds all issues so Plan 02 can fix them efficiently without manually reviewing 67 permits and ~130 document pages.
Output: `scripts/validate-permits.js` script + `validation-findings.json` with categorized issues per permit and per document page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-content-validation/45-CONTEXT.md
@.planning/phases/45-content-validation/45-RESEARCH.md

# Key source files
@_data/permits.js
@_data/documents.js
@scripts/audit-permits.js
@scripts/audit-content.js
@src/pages/documents-primo.liquid
@src/pages/documents-rinnovo.liquid
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validate-permits.js script</name>
  <files>scripts/validate-permits.js</files>
  <action>
Create `scripts/validate-permits.js` that performs a comprehensive validation of all permit pages AND document pages. Follow existing patterns from `scripts/audit-permits.js` and `scripts/audit-content.js`.

The script must:

**1. Fetch all permit data (DB columns + page blocks)**
For each permit in the database (using the same search+filter pattern as `_data/permits.js`):
- Fetch page properties via `notion.pages.retrieve()` to get: Nome permesso, Posso lavorare?, Quanto dura?, Doc primo rilascio, Doc rinnovo, Info extra su doc rilascio, Info extra su doc rinnovo, Mod primo rilascio, Mod rinnovo, posso convertire?, NOTES, Macrocategoria
- Fetch page blocks via `notion.blocks.children.list()` (with pagination, same as `_data/permits.js`)
- Rate limit: 350ms between API calls

**2. Parse page blocks into Q&A sections**
Reuse the same Q&A detection logic as `_data/permits.js` (heading_3 or bold paragraph ending in ?). For each section, extract:
- Section question text (plain text)
- Section content (plain text, for keyword matching)

**3. Cross-reference DB columns against Q&A sections**
For each permit, check these mappings:
- `Posso lavorare?` column (select: SI/NO/Limitato) -> Look for "diritti" or "lavorare" section. If DB=SI, content must mention work rights. If DB=NO, content must mention restriction. If DB=Limitato, content should mention limitations.
- `Quanto dura?` column (rich_text) -> Look for "dura" section. If DB has a value, check content mentions duration.
- `Doc primo rilascio` / `Doc rinnovo` columns -> Check that page does NOT contain document checklists (Phase 43 rule: link to doc pages instead). Check that if docs exist, there's a link to `documenti-{slug}-primo.html` or `documenti-{slug}-rinnovo.html`.
- `Mod primo rilascio` / `Mod rinnovo` columns -> Look for "come" or "dove" section. If DB has method, check it's mentioned.
- `posso convertire?` column (rich_text) -> Look for "convertir" section. If DB has value, check it's addressed.

**4. Check Phase 43 content rules on permit pages**
For ALL permits (not just newly populated), scan page blocks for:
- **NO_DOC_LISTS**: Bulleted list items that look like document names (marca da bollo, bollettino postale, copia del passaporto, foto tessera, codice fiscale, etc.)
- **BOLLETTINO_INCLUDES_40**: Text mentioning both "bollettino" and separate "40" + "elettronico" nearby
- **FULL_URLS**: Any links in rich_text that are relative paths instead of full https:// URLs. Only check links pointing to sospermesso.it pages.
- **TU_TONE**: Presence of formal Italian constructions: "Lei" (as pronoun, not name), "Suo/Sua" (possessive), "Si prega", "Si consiglia di" (impersonal). Be careful: "lei" lowercase at start of sentence is fine; look for mid-sentence capitalized "Lei" or formal "Ella".

**5. Detect placeholder pages**
Pages with zero blocks or only a single "Contenuto in arrivo" paragraph.

**6. Validate document pages (primo + rinnovo)**
After the permit validation, validate document pages by reading built HTML from `_site/`. For each permit slug that has documents in the DB:

- **Build first:** The script should check that `_site/` exists. If not, warn and skip document validation (Plan executor should run `npm run build` first).
- **Read built HTML:** Read `_site/src/pages/documenti-{slug}-primo.html` and `_site/src/pages/documenti-{slug}-rinnovo.html` if they exist.
- **DOCUMENT_LIST_MATCH:** Compare the document items in the DB columns (`Doc primo rilascio` / `Doc rinnovo` multi_select) against the checklist items rendered in the HTML. Parse `<span class="doc-label">` elements from the HTML. Flag if DB has documents but HTML is missing them, or vice versa. Allow for normalization differences (the `normalizeDocumentName` filter may alter names slightly -- match on substring/keyword).
- **NOTES_PRESENT:** If the permit has `Info extra su doc rilascio` or `Info extra su doc rinnovo` in the DB, verify the HTML contains the "Informazioni aggiuntive" section (look for the `<h2>` with that text).
- **COST_SECTION:** If DB has cost data (bollettino or marca da bollo extracted from document lists), verify the HTML contains the costi section (`id="quanto-costa"`). This was Phase 44 -- just confirm it renders.
- **Phase 43 rules on document notes:** The `Info extra su doc rilascio` field populates the notes section on document pages. Check the DB field (rich_text) for the same Phase 43 violations: BOLLETTINO_INCLUDES_40, FULL_URLS, TU_TONE. (NO_DOC_LISTS doesn't apply here since document pages ARE the document list.)
- **EMPTY_DOCUMENT_PAGE:** Flag permits where DB has no documents at all (empty `Doc primo rilascio` or `Doc rinnovo`) -- the generated page would show an empty checklist.

**7. Output structured JSON**
Write findings to `.planning/phases/45-content-validation/validation-findings.json`:

```json
{
  "generated": "2026-02-16",
  "total_permits": 67,
  "summary": {
    "valid": 40,
    "gaps": 15,
    "conflicts": 3,
    "rule_violations": 8,
    "placeholders": 5
  },
  "permits": [
    {
      "id": "page-id",
      "tipo": "Permit name",
      "slug": "permit-slug",
      "macrocategoria": "Category",
      "status": "valid|gaps|conflicts|violations|placeholder",
      "db_columns": {
        "possoLavorare": "SI",
        "quantoDura": "2 anni",
        "docPrimo": ["doc1", "doc2"],
        "docRinnovo": ["doc1"],
        "modPrimo": "kit postale",
        "modRinnovo": "kit postale",
        "possoConvertire": "Si, in...",
        "notes": "..."
      },
      "sections_found": ["Cos'e questo permesso?", "Che diritti mi da?"],
      "gaps": [
        {
          "type": "missing_section",
          "column": "Quanto dura?",
          "db_value": "2 anni",
          "expected_section": "Quanto dura"
        }
      ],
      "conflicts": [
        {
          "column": "Posso lavorare?",
          "db_value": "NO",
          "page_says": "puoi lavorare",
          "section": "Che diritti mi da?"
        }
      ],
      "rule_violations": [
        {
          "rule": "NO_DOC_LISTS",
          "detail": "Found bulleted list with document names",
          "block_ids": ["block-id-1"]
        }
      ]
    }
  ],
  "documents": {
    "total_primo": 60,
    "total_rinnovo": 60,
    "summary": {
      "valid": 50,
      "doc_list_mismatch": 3,
      "missing_notes": 2,
      "missing_costs": 1,
      "empty_checklist": 4,
      "note_rule_violations": 1
    },
    "pages": [
      {
        "slug": "permit-slug",
        "type": "primo",
        "file": "documenti-permit-slug-primo.html",
        "issues": [
          {
            "rule": "DOCUMENT_LIST_MISMATCH",
            "detail": "DB has 5 docs, HTML renders 4. Missing: foto tessera",
            "db_docs": ["doc1", "doc2", "doc3", "doc4", "foto tessera"],
            "html_docs": ["doc1", "doc2", "doc3", "doc4"]
          }
        ]
      }
    ]
  }
}
```

**Technical notes:**
- Use `require('dotenv').config()` at top
- Use same DATABASE_ID as `_data/permits.js`: `1ad7355e-7f7f-8088-a065-e814c92e2cfd`
- Skip permits with no `tipo` (no name)
- Skip permits whose name starts with "[DUPLICATE]" (archived in Phase 43)
- For section matching, use case-insensitive substring matching (e.g., section question containing "dura" matches "Quanto dura")
- For document page HTML parsing, use simple regex or string matching (no need for a full HTML parser -- the structure is consistent from Liquid templates). Parse `doc-label` spans for document names.
- Log progress to stderr, output JSON to file
- Handle API errors gracefully (log and continue to next permit)
  </action>
  <verify>
Run `node scripts/validate-permits.js` and confirm:
1. Script completes without errors
2. `validation-findings.json` is created in the phase directory
3. JSON is valid and contains entries for all permits
4. JSON contains a `documents` section with primo/rinnovo page results
5. Summary counts are plausible (not all zeros, not all gaps)
  </verify>
  <done>
`validation-findings.json` exists with structured findings for every permit in the database AND every document page. Summary shows counts for valid, gaps, conflicts, rule_violations, placeholders (permits) and doc_list_mismatch, missing_notes, empty_checklist, note_rule_violations (documents).
  </done>
</task>

<task type="auto">
  <name>Task 2: Build site and run validation</name>
  <files>.planning/phases/45-content-validation/validation-findings.json</files>
  <action>
First, build the site so document page HTML exists for validation:
```bash
npm run build
```

Then run the validation script:
```bash
node scripts/validate-permits.js
```

After it completes, review the findings:
1. Read `validation-findings.json` and examine the summary
2. Log a quick breakdown to the console:
   - How many permits are fully valid
   - How many have gaps (missing sections)
   - How many have conflicts
   - How many have rule violations
   - How many are placeholders
   - How many document pages have issues (mismatched docs, missing notes, empty checklists)
3. List the top permits by issue count (most issues first) -- these will be suggested for spot-checking later

If the script fails or produces unexpected results, debug and fix `validate-permits.js` before proceeding.

No Notion writes happen in this plan. This is read-only discovery.
  </action>
  <verify>
1. `validation-findings.json` exists and is valid JSON
2. Summary numbers are reasonable
3. At least some permits show "valid" status (not everything flagged)
4. Placeholder count matches expected (~3-5 remaining from Phase 43 skips)
5. `documents` section is populated with primo/rinnovo page results
  </verify>
  <done>
Validation findings are complete and reviewed. The JSON file contains actionable findings for both permits and document pages that Plan 02 will process.
  </done>
</task>

</tasks>

<verification>
1. `scripts/validate-permits.js` exists and runs without errors
2. `.planning/phases/45-content-validation/validation-findings.json` exists with valid JSON
3. All permits in the database are represented in findings
4. Document pages are validated (document list match, notes presence, cost section, Phase 43 rules on notes)
5. Findings categorize each permit as valid, gaps, conflicts, violations, or placeholder
</verification>

<success_criteria>
- Validation script runs against Notion DB and produces structured findings
- Every permit's DB columns are cross-referenced against page Q&A content
- Phase 43 rules checked across all permits (not just new ones)
- Document pages validated: checklist matches DB, notes present when expected, costs render, Phase 43 rules on doc notes
- Findings JSON is machine-readable for Plan 02 to consume
- No Notion writes occurred (read-only)
</success_criteria>

<output>
After completion, create `.planning/phases/45-content-validation/45-01-SUMMARY.md`
</output>
