---
phase: 45-content-validation
plan: 03
type: execute
wave: 3
depends_on: ["45-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Site rebuilds successfully with updated Notion content"
    - "User reviews VALIDATION-REPORT.md and decides on each conflict"
    - "User's conflict decisions are implemented in Notion (pages or DB columns updated)"
    - "Site rebuilds again after conflict resolution to reflect final state"
    - "User spot-checks suggested permits in browser"
    - "User explicitly approves Phase 45 completion"
  artifacts: []
  key_links:
    - from: "npm run build"
      to: "_site/"
      via: "11ty build regenerates HTML from updated Notion data"
      pattern: "npm run build"
    - from: "User conflict decisions"
      to: "Notion API"
      via: "notion.pages.update or notion.blocks.children.append"
      pattern: "notion\\.(pages\\.update|blocks\\.children\\.append)"
---

<objective>
Rebuild the site to reflect all Notion edits, user reviews the validation report and makes conflict decisions, then Claude implements those decisions in Notion and rebuilds again for final verification.

Purpose: Verify that Notion edits appear correctly in generated HTML. User makes final decisions on conflicts. Conflicts are actually resolved (not left hanging). User approves phase completion.
Output: Rebuilt site with all conflicts resolved + user approval.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/45-content-validation/45-02-SUMMARY.md
@.planning/phases/45-content-validation/VALIDATION-REPORT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild site with updated Notion content</name>
  <files>No source files modified -- build output in _site/</files>
  <action>
Run the full site build to regenerate all pages from updated Notion content:

```bash
npm run build
```

After build completes:
1. Verify build succeeded (no errors, expected file count)
2. For 2-3 permits that were modified in Plan 02, check their generated HTML:
   - Open `_site/permesso-{slug}.html` and verify new/fixed content appears
   - Confirm no broken HTML or missing sections
3. Check document page output for any pages that were modified
4. Report build time and file count

If build fails, debug the issue. Common causes:
- Notion API rate limiting during build (retry after delay)
- Template errors from unexpected content format
  </action>
  <verify>
1. `npm run build` completes without errors
2. `_site/` contains expected number of files (~400+)
3. Spot-check 2-3 modified permit HTML files for correct content
  </verify>
  <done>
Site rebuilt successfully. Generated HTML reflects all Notion edits from Plan 02.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete content validation pass across all permit and document pages:
- Automated cross-reference of every permit's DB columns vs. page Q&A content (Plan 01)
- Phase 43 rule violations fixed directly in Notion (Plan 02)
- Missing sections added from database column data (Plan 02)
- Document page validation (Plan 01) -- checklist accuracy, notes, costs
- Conflicts logged for your review (Plan 02)
- Site rebuilt with all changes (this plan)
  </what-built>
  <how-to-verify>
1. **Read the validation report:**
   Open `.planning/phases/45-content-validation/VALIDATION-REPORT.md`
   - Review "Changes Made" section -- do the additions and fixes look correct?
   - Review "Conflicts Requiring User Review" -- decide for each: update DB or update page?
   - Review "Document Page Validation" -- any issues to address?
   - Review "Placeholder Pages" -- any that should be populated now?

2. **Spot-check in browser:**
   Start local server if needed: `npx @11ty/eleventy --serve`
   Visit the permits suggested for spot-check in the report:
   - Do new sections read naturally?
   - Is the tone consistent ("tu" not "Lei")?
   - Are document links correct (point to real doc pages)?
   - No broken formatting or missing content?

3. **Resolve conflicts (if any):**
   For each conflict in the report, tell me one of:
   - "DB is correct, update page for [permit name]" -- I will fix the Notion page content to match DB
   - "Page is correct, update DB for [permit name]" -- I will fix the Notion DB column to match page
   - "Defer [permit name]" -- skip for now

4. **Approve or request changes:**
   - If everything looks good AND you have given conflict decisions: type "approved"
   - If issues found: describe what needs fixing
  </how-to-verify>
  <resume-signal>Provide conflict decisions (if any) and type "approved" to proceed, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Implement conflict resolutions and final rebuild</name>
  <files>No local source files -- Notion pages/DB updated via API</files>
  <action>
Process the user's conflict decisions from the checkpoint. For each conflict:

**If "DB is correct, update page":**
- Find the relevant section in the Notion page blocks (using block IDs from validation-findings.json if available, or by searching for the conflicting content)
- Update the block content to match the DB column value using `notion.blocks.update()`
- For example: if DB says `Posso lavorare? = NO` but page says "puoi lavorare", rewrite the relevant paragraph to state the correct restriction
- Log the change

**If "Page is correct, update DB":**
- Update the Notion database column to match the page content using `notion.pages.update()`
- For example: if page says "2 anni rinnovabile" but DB says "1 anno", update the DB `Quanto dura?` rich_text
- Use the correct property type for updates:
  - `select` properties (e.g., Posso lavorare?): `{ "Posso lavorare?": { "select": { "name": "value" } } }`
  - `rich_text` properties (e.g., Quanto dura?): `{ "Quanto dura?": { "rich_text": [{ "text": { "content": "value" } }] } }`
  - `multi_select` properties (e.g., Doc primo rilascio): `{ "Doc primo rilascio": { "multi_select": [{ "name": "value" }] } }`
- Log the change

**If "Defer":**
- Log as deferred, no action taken

**Rate limiting:** 350ms between all Notion API calls.

**After all conflict resolutions are applied:**
1. Rebuild the site: `npm run build`
2. Verify the build succeeds
3. For each resolved conflict, check the generated HTML to confirm the fix is reflected
4. Update VALIDATION-REPORT.md: add a "## Conflict Resolution" section at the end documenting what was decided and what was changed

**If user had zero conflicts (all permits were clean):** Skip Notion updates, just confirm no action needed and log it.
  </action>
  <verify>
1. All non-deferred conflicts have been updated in Notion (page or DB)
2. `npm run build` succeeds after updates
3. Spot-check 1-2 resolved conflicts in generated HTML
4. VALIDATION-REPORT.md updated with conflict resolution log
  </verify>
  <done>
All user conflict decisions are implemented. Site rebuilt with final state. VALIDATION-REPORT.md updated with resolution log. Phase 45 content validation is complete.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with updated Notion content (initial rebuild)
2. User reviews VALIDATION-REPORT.md
3. User spot-checks permits in browser
4. User provides conflict decisions
5. Conflict decisions implemented in Notion (pages or DB columns)
6. Final rebuild succeeds with all resolutions applied
7. User explicitly approves Phase 45
</verification>

<success_criteria>
- Site rebuilt with all Notion edits reflected in HTML output
- User has reviewed the validation report
- All conflicts resolved or explicitly deferred by user
- Conflict resolutions implemented in Notion via API (not left as open items)
- Final rebuild confirms all changes are reflected in HTML
- VALIDATION-REPORT.md updated with conflict resolution log
- User approval received for Phase 45 completion
</success_criteria>

<output>
After completion, create `.planning/phases/45-content-validation/45-03-SUMMARY.md`
</output>
