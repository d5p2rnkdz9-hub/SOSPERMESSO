---
phase: 45-content-validation
plan: 02
type: execute
wave: 2
depends_on: ["45-01"]
files_modified:
  - .planning/phases/45-content-validation/VALIDATION-REPORT.md
autonomous: true

must_haves:
  truths:
    - "Phase 43 rule violations are fixed directly in Notion pages"
    - "Missing sections are added to Notion pages with correct tone and format"
    - "Conflicts are logged in report for user review (never auto-fixed)"
    - "Placeholder pages are flagged in report"
    - "Every change is documented in VALIDATION-REPORT.md"
  artifacts:
    - path: ".planning/phases/45-content-validation/VALIDATION-REPORT.md"
      provides: "Complete validation report with all changes, conflicts, and recommendations"
      min_lines: 50
      contains: "## Changes Made"
  key_links:
    - from: ".planning/phases/45-content-validation/VALIDATION-REPORT.md"
      to: ".planning/phases/45-content-validation/validation-findings.json"
      via: "Findings drive all fixes and report content"
      pattern: "validation-findings"
---

<objective>
Process all validation findings from Plan 01: fix Phase 43 rule violations directly in Notion, add missing content from DB columns, log conflicts for user review, and generate the final VALIDATION-REPORT.md.

Purpose: All fixable issues are resolved in Notion. User gets a clear report of what changed and what conflicts need their decision.
Output: Updated Notion pages + comprehensive VALIDATION-REPORT.md.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/45-content-validation/45-CONTEXT.md
@.planning/phases/45-content-validation/45-RESEARCH.md
@.planning/phases/45-content-validation/45-01-SUMMARY.md
@.planning/phases/45-content-validation/validation-findings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix rule violations and add missing content in Notion</name>
  <files>No local files modified -- Notion pages updated via API</files>
  <action>
Read `validation-findings.json` from Plan 01. Process each permit that has issues, in this order of priority:

**Priority 1: Fix Phase 43 rule violations (clear-cut, fix directly)**

For each permit with `rule_violations`:

- **NO_DOC_LISTS**: If page contains bulleted lists of documents (marca da bollo, bollettino, passaporto, foto, codice fiscale, etc.), these blocks should be replaced with a paragraph linking to the document page. Use `notion.blocks.delete()` to remove the doc list blocks, then `notion.blocks.children.append()` to add a paragraph like:
  "Per l'elenco completo dei documenti necessari, consulta la pagina [Che documenti porto per il primo rilascio](https://www.sospermesso.it/documenti-{slug}-primo.html) o [per il rinnovo](https://www.sospermesso.it/documenti-{slug}-rinnovo.html)."
  Use bold text annotation for the link anchor text.

  IMPORTANT: Before deleting doc list blocks, verify they are actually document lists (not other bulleted content). Only delete blocks that match document-name patterns.

- **BOLLETTINO_INCLUDES_40**: If page mentions "40 euro" or "40€" as a separate cost for "rilascio del permesso elettronico" alongside a bollettino amount, remove the separate 40€ line. The bollettino amount already includes it.

- **FULL_URLS**: If any Notion links use relative paths (e.g., `/documenti-...` or `documenti-...`), update them to full URLs (`https://www.sospermesso.it/documenti-...`). Use `notion.blocks.update()` to fix the rich_text href.

- **TU_TONE**: If formal "Lei/Suo/Sua" constructions found, rewrite the affected paragraphs using informal "tu" (puoi, tuo, devi). Use `notion.blocks.update()` to replace block content.

**Priority 2: Add missing sections (gaps where DB has data but page is missing section)**

For each permit with `gaps`:
- Read the `db_value` for the missing column
- Compose content following existing page tone (conversational "tu", concise, linking to doc pages for documents)
- Append the section using `notion.blocks.children.append()` with a bold question paragraph + answer paragraph(s)

Section templates by column:

- **Quanto dura?** missing: Add bold "Quanto dura questo permesso?" + paragraph with duration from DB + standard renewal note
- **Posso lavorare?** missing (in "Che diritti" section): Add bold "Che diritti mi da questo permesso?" + paragraph stating work rights (SI -> "puoi lavorare", NO -> "NON puoi lavorare", Limitato -> mention limitations)
- **Mod primo/rinnovo** missing (in "Come/dove" section): Add bold "Come/dove si chiede?" + paragraph with method from DB
- **posso convertire?** missing: Add bold "Posso convertirlo in un altro permesso?" + paragraph with conversion info from DB
- **Doc links** missing: If permit has documents in DB but no link to doc pages in Q&A, add a paragraph linking to the relevant doc pages

**Priority 3: Log conflicts (DB vs page disagree -- DO NOT auto-fix)**

For each permit with `conflicts`:
- Record both the DB value and the page content value
- Do not modify the Notion page
- These go into the report for user review

**Rate limiting:** 350ms between all Notion API calls. If processing many permits, this will take time -- that's expected.

**CRITICAL RULES:**
- NEVER delete any existing Q&A section or info. Only add missing content or fix rule violations.
- For rule violations, only modify the specific blocks that violate rules.
- When adding content, append at the END of the page (after existing content).
- Use the existing page's tone and format as guide for new content.
- Track every change made (permit name, what was changed, why) for the report.
  </action>
  <verify>
For a sample of 3-5 permits that had issues:
1. Fetch their page blocks after fixes
2. Verify rule violations are resolved
3. Verify added sections exist with correct content
4. Verify no content was accidentally deleted (block count >= previous count)
  </verify>
  <done>
All fixable issues from validation-findings.json are processed. Rule violations fixed, missing sections added, conflicts logged. No content deleted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate VALIDATION-REPORT.md</name>
  <files>.planning/phases/45-content-validation/VALIDATION-REPORT.md</files>
  <action>
Create `.planning/phases/45-content-validation/VALIDATION-REPORT.md` with a comprehensive report of all validation activity. Structure:

```markdown
# Phase 45: Content Validation Report

**Generated:** {date}
**Total permits validated:** {N}

## Summary

| Status | Count |
|--------|-------|
| Valid (no changes needed) | {N} |
| Fixed (content added or rule violation fixed) | {N} |
| Conflicts (user review needed) | {N} |
| Placeholders (no content) | {N} |

## Changes Made

For each permit that was modified, list:
### {Permit Name}
- **Added:** {section name} -- {brief description of what was added and source (DB column value)}
- **Fixed:** {rule ID} -- {what was changed}

## Conflicts Requiring User Review

For each conflict:
### {Permit Name}
**Column:** {column name}
**Database says:** {DB value}
**Page content says:** {page content excerpt}
**Action needed:** User decides which is correct

## Placeholder Pages

List permits that still have "Contenuto in arrivo" or no content:
- {Permit name} ({Notion URL})
- ...

(These were skipped by user in Phase 43 or have no DB data to generate from.)

## Document Page Validation

Summary of document page checks:
- Total document pages: {N primo + N rinnovo}
- Rule violations found: {N}
- Changes made: {list if any}

## Suggested Spot-Check Permits

Based on volume of changes, suggest 5-7 permits for user to visually verify in browser after rebuild:
1. {Permit name} -- {reason: most changes / complex fixes / etc.}
2. ...

## Next Steps

1. Review conflicts above and decide: update DB or update page content
2. Run `npm run build` to regenerate HTML from updated Notion content
3. Spot-check suggested permits in browser
4. Approve Phase 45 completion
```

Populate ALL sections with actual data from the fixes performed in Task 1. The report must be complete and honest -- don't minimize issues or skip any permits.
  </action>
  <verify>
1. `VALIDATION-REPORT.md` exists in phase directory
2. Summary counts match the actual work done
3. Every permit that was modified appears in "Changes Made"
4. Every conflict appears in "Conflicts Requiring User Review"
5. Spot-check suggestions include permits with most changes
  </verify>
  <done>
VALIDATION-REPORT.md is complete with all changes, conflicts, placeholders, and recommendations documented. User can review it to understand everything that was validated and changed.
  </done>
</task>

</tasks>

<verification>
1. All Phase 43 rule violations found in Plan 01 are fixed in Notion
2. All missing sections (gaps) are added to Notion pages
3. No content was deleted from any Notion page
4. Conflicts are documented (not auto-fixed)
5. VALIDATION-REPORT.md exists with accurate, complete information
</verification>

<success_criteria>
- Rule violations fixed directly in Notion (NO_DOC_LISTS, BOLLETTINO_INCLUDES_40, FULL_URLS, TU_TONE)
- Missing sections added from DB column data
- Conflicts logged for user review (never auto-resolved)
- VALIDATION-REPORT.md at `.planning/phases/45-content-validation/VALIDATION-REPORT.md`
- Report includes suggested spot-check permits
</success_criteria>

<output>
After completion, create `.planning/phases/45-content-validation/45-02-SUMMARY.md`
</output>
