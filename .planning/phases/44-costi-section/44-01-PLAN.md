---
phase: 44-costi-section
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - _data/documents.js
  - src/pages/documents-primo.liquid
  - src/pages/documents-rinnovo.liquid
  - src/styles/document-page.css
autonomous: true

must_haves:
  truths:
    - "Document pages with cost data show an itemized cost breakdown between notes and prassi locali"
    - "Document pages without cost data in Notion show no costi section at all"
    - "Kit permits show an additional 30 EUR kit postale line item"
    - "The bold total at the bottom sums all cost items correctly"
    - "A Quanto costa anchor link appears in the page header alongside the existing Prassi locali link"
  artifacts:
    - path: "_data/documents.js"
      provides: "Cost fields extracted from Notion properties for primo and rinnovo"
      contains: "costBollettino"
    - path: "src/pages/documents-primo.liquid"
      provides: "Costi section between notes and prassi locali"
      contains: "Quanto costa"
    - path: "src/pages/documents-rinnovo.liquid"
      provides: "Costi section between notes and prassi locali"
      contains: "Quanto costa"
    - path: "src/styles/document-page.css"
      provides: "Cost list and total styling"
      contains: "costi-"
  key_links:
    - from: "_data/documents.js"
      to: "Notion API"
      via: "page.properties cost columns"
      pattern: "properties.*[Cc]ost"
    - from: "src/pages/documents-primo.liquid"
      to: "_data/documents.js"
      via: "doc.costBollettino and doc.costMarcaBollo"
      pattern: "doc\\.cost"
    - from: "src/pages/documents-rinnovo.liquid"
      to: "_data/documents.js"
      via: "doc.costBollettino and doc.costMarcaBollo"
      pattern: "doc\\.cost"
---

<objective>
Add cost information section to all document pages (primo rilascio and rinnovo).

Purpose: Users need to know how much their permit application costs. Cost data already exists in Notion columns but is not rendered on document pages. This adds an itemized cost breakdown section.

Output: Updated data file with cost fields, updated Liquid templates with costi section, updated CSS with cost list styles.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-costi-section/44-CONTEXT.md

@_data/documents.js
@src/pages/documents-primo.liquid
@src/pages/documents-rinnovo.liquid
@src/styles/document-page.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Discover Notion cost column names and add cost fields to documents.js</name>
  <files>_data/documents.js</files>
  <action>
  **Step 1 â€” Discover column names:**
  Query the Notion API to list all properties of the document database (ID: `1ad7355e-7f7f-8088-a065-e814c92e2cfd`). Use a one-off Node.js script:

  ```js
  require('dotenv').config();
  const { Client } = require("@notionhq/client");
  const notion = new Client({ auth: process.env.NOTION_API_KEY });
  // Use search to find a page from this DB, then inspect its properties
  const response = await notion.search({ filter: { property: 'object', value: 'page' }, page_size: 1 });
  const page = response.results.find(p => p.parent?.database_id === '1ad7355e-7f7f-8088-a065-e814c92e2cfd' || p.parent?.data_source_id === '1ad7355e-7f7f-8088-a065-e814c92e2cfd');
  console.log(JSON.stringify(Object.keys(page.properties), null, 2));
  // Then for each cost-related property, log name + type + sample value
  ```

  Look for properties containing words like "costi", "bollettino", "marca", "bollo" â€” they may be under the primo or rinnovo column groups. Record the exact property names.

  **Step 2 â€” Add cost extraction to documents.js:**
  In the `for (const page of allPages)` loop, after the existing method extraction, add cost field extraction. Based on the discovered column names, extract:

  - `costBollettinoPrimo` â€” bollettino amount for primo rilascio (likely a number or text property)
  - `costMarcaBolloPrimo` â€” marca da bollo amount for primo (likely boolean or number; if boolean/checkbox, hardcode 16â‚¬ when true)
  - `costBollettinoRinnovo` â€” bollettino amount for rinnovo
  - `costMarcaBolloRinnovo` â€” marca da bollo amount for rinnovo

  Use the same safe-access pattern as existing fields (e.g., `page.properties["Column Name"]?.number || null`). If the columns are `select` or `rich_text` type rather than `number`, parse accordingly.

  **Step 3 â€” Push cost fields into primo/rinnovo arrays:**
  Add to the `primo.push({...})` call:
  ```js
  costBollettino: costBollettinoPrimo,
  costMarcaBollo: costMarcaBolloPrimo
  ```

  Add to the `rinnovo.push({...})` call:
  ```js
  costBollettino: costBollettinoRinnovo,
  costMarcaBollo: costMarcaBolloRinnovo
  ```

  **Important:** The 40 EUR electronic permit fee is ALREADY INCLUDED in the bollettino amount. Do NOT extract or display it separately. The kit postale 30 EUR is a fixed cost added in the template (not from Notion), based on the existing `method` field.

  **Naming convention note:** Use field names like `costBollettino` and `costMarcaBollo` (camelCase, matching existing patterns like `docNotes`, `primoMethod`). If you discover additional cost columns (e.g., separate "kit postale" column), extract those too.
  </action>
  <verify>
  Run `npm run build` and check console output confirms primo/rinnovo entries are still generated. Then inspect a built page to verify the data file runs without errors. Also run a quick Node.js snippet to log one entry and confirm cost fields are present:

  ```bash
  node -e "require('dotenv').config(); require('./_data/documents.js')().then(d => { console.log('Sample primo:', JSON.stringify(d.primo[0], null, 2)); console.log('Sample rinnovo:', JSON.stringify(d.rinnovo[0], null, 2)); })"
  ```

  Verify cost fields appear (may be null for some permits â€” that is correct).
  </verify>
  <done>documents.js extracts cost fields from Notion and includes them in primo and rinnovo arrays. Build completes without errors. Sample entries show costBollettino and costMarcaBollo fields.</done>
</task>

<task type="auto">
  <name>Task 2: Add costi section to both Liquid templates and CSS styling</name>
  <files>src/pages/documents-primo.liquid, src/pages/documents-rinnovo.liquid, src/styles/document-page.css</files>
  <action>
  **Part A â€” Add anchor link in page header (both templates):**

  In both `documents-primo.liquid` and `documents-rinnovo.liquid`, find the page header section containing the "Prassi locali della tua Questura" anchor link. Add a "Quanto costa" anchor link BEFORE the prassi one, using a similar pattern. Only show it when cost data exists:

  ```liquid
  {%- if doc.costBollettino or doc.costMarcaBollo -%}
  <a href="#quanto-costa" class="costi-anchor-link">
    Quanto costa
  </a>
  {%- endif -%}
  <a href="#prassi-locali" class="prassi-anchor-link">
    Prassi locali della tua Questura
  </a>
  ```

  **Part B â€” Add costi section HTML (both templates):**

  Insert between the document notes `endif` and the `<!-- PRASSI LOCALI -->` comment. The section should only render when at least one cost field is present:

  ```liquid
  {%- if doc.costBollettino or doc.costMarcaBollo -%}
  <!-- COSTI -->
  <section class="section bg-off-white" id="quanto-costa">
    <div class="container" style="max-width: 700px;">
      <h2 style="text-align: center; margin-bottom: 1.5rem;">ðŸ’° Quanto costa?</h2>
      <div class="card">
        <ul class="costi-list">
          {%- if doc.costBollettino -%}
          <li class="costi-item">
            <span class="costi-label">Bollettino postale <span class="costi-note">da pagare alle Poste</span></span>
            <span class="costi-amount">â‚¬ {{ doc.costBollettino }}</span>
          </li>
          {%- endif -%}
          {%- if doc.costMarcaBollo -%}
          <li class="costi-item">
            <span class="costi-label">Marca da bollo <span class="costi-note">da comprare in tabaccheria</span></span>
            <span class="costi-amount">â‚¬ {{ doc.costMarcaBollo }}</span>
          </li>
          {%- endif -%}
          {%- assign methodLowerCosti = doc.method | downcase -%}
          {%- if methodLowerCosti contains 'kit' -%}
          <li class="costi-item">
            <span class="costi-label">Kit postale <span class="costi-note">da comprare alle Poste</span></span>
            <span class="costi-amount">â‚¬ 30,00</span>
          </li>
          {%- endif -%}
        </ul>
        <div class="costi-total">
          <span class="costi-total-label">Totale</span>
          <span class="costi-total-amount">â‚¬
            {%- assign total = 0 -%}
            {%- if doc.costBollettino -%}{%- assign total = total | plus: doc.costBollettino -%}{%- endif -%}
            {%- if doc.costMarcaBollo -%}{%- assign total = total | plus: doc.costMarcaBollo -%}{%- endif -%}
            {%- assign methodLowerTotal = doc.method | downcase -%}
            {%- if methodLowerTotal contains 'kit' -%}{%- assign total = total | plus: 30 -%}{%- endif -%}
            {{ total }}
          </span>
        </div>
      </div>
    </div>
  </section>
  {%- endif -%}
  ```

  **Note on amounts:** The Notion data may store amounts as numbers (e.g., `70.1`) or as formatted strings (e.g., `"70,10"`). If they come as numbers, Liquid will render them as-is (e.g., `70.1`). For display, this is acceptable â€” the CSS will handle alignment. If you want comma formatting (Italian style), you may need a custom Liquid filter, but keep it simple for now: just render the raw value. The total calculation uses `plus:` filter which works with numbers.

  **Part C â€” Add CSS styling to document-page.css:**

  Append the following styles at the end of document-page.css, before the mobile responsive section (before `@media (max-width: 768px)`):

  ```css
  /* -----------------------------------------------
     COSTI SECTION
     ----------------------------------------------- */

  .costi-anchor-link {
    display: inline-block;
    margin-top: var(--spacing-sm);
    margin-right: var(--spacing-xs);
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--accent-orange);
    background: rgba(255, 152, 0, 0.1);
    border-radius: var(--radius-full);
    transition: all var(--transition-fast);
    text-decoration: none;
  }

  .costi-anchor-link:hover {
    background: var(--accent-orange-bright);
    color: var(--white);
    transform: translateX(4px);
  }

  .costi-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .costi-item {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--gray-light);
  }

  .costi-item:last-child {
    border-bottom: none;
  }

  .costi-label {
    font-size: var(--font-size-base);
    color: var(--gray-dark);
    flex: 1;
  }

  .costi-note {
    display: block;
    font-size: var(--font-size-xs);
    color: var(--gray-medium);
    font-style: italic;
    margin-top: 2px;
  }

  .costi-amount {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--gray-dark);
    white-space: nowrap;
    margin-left: var(--spacing-md);
  }

  .costi-total {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding-top: var(--spacing-md);
    margin-top: var(--spacing-sm);
    border-top: 2px solid var(--gray-dark);
  }

  .costi-total-label {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--gray-dark);
  }

  .costi-total-amount {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--gray-dark);
  }
  ```

  Also add to the existing `@media (max-width: 768px)` block:

  ```css
  .costi-anchor-link {
    display: block;
    text-align: center;
  }
  ```

  And add to the existing `@media print` block:

  ```css
  .costi-total {
    border-top: 2px solid #333 !important;
  }
  ```
  </action>
  <verify>
  Run `npm run build` and verify:

  1. Build completes without errors
  2. Check a built document page that has cost data:
     ```bash
     grep -l "Quanto costa" _site/src/pages/documenti-*-primo.html | head -3
     ```
  3. Verify the section appears between notes and prassi:
     ```bash
     # Pick one page with costs and check section order
     grep -n "Quanto costa\|Prassi locali\|Informazioni aggiuntive" _site/src/pages/documenti-lavoro-subordinato-primo.html
     ```
  4. Verify pages WITHOUT cost data do NOT show the section:
     ```bash
     # Find a page that should have no costs (if any) and confirm no "Quanto costa"
     ```
  5. Verify anchor link appears in header:
     ```bash
     grep "quanto-costa" _site/src/pages/documenti-lavoro-subordinato-primo.html
     ```
  </verify>
  <done>Both primo and rinnovo templates render a cost breakdown section with itemized costs, bold total, and kit postale conditional line. Anchor link appears in page header. CSS styles the list with right-aligned amounts and prominent total. Pages without cost data show no costi section.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Cost information section on document pages â€” itemized breakdown with bollettino, marca da bollo, conditional kit postale, and bold total. Anchor link in page header.</what-built>
  <how-to-verify>
  1. Run `npm run build` if not already done
  2. Open a primo page that uses Kit method (e.g., `_site/src/pages/documenti-lavoro-subordinato-primo.html`) â€” verify:
     - "Quanto costa" anchor link in header area
     - Cost section appears after notes, before prassi locali
     - Shows bollettino, marca da bollo, AND kit postale (30 EUR)
     - Bold total sums all three correctly
  3. Open a primo page that uses Questura method (e.g., a protezione permit) â€” verify:
     - Cost section shows bollettino and marca da bollo only (NO kit postale)
     - Total sums only those two
  4. Open a rinnovo page â€” verify same structure works
  5. Check on mobile viewport (responsive) â€” amounts should stay readable
  6. If any permit has no cost data at all, confirm no costi section appears
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Document pages with cost data show the costi section
3. Document pages without cost data show no costi section
4. Kit permits show 3 line items (bollettino + marca da bollo + kit postale)
5. Non-kit permits show 2 line items (bollettino + marca da bollo)
6. Total is correct for both cases
7. "Quanto costa" anchor link appears in page header for pages with costs
8. Section placement: after notes, before prassi locali
</verification>

<success_criteria>
- COSTI-01 satisfied: Cost data sourced from Notion database properties
- COSTI-02 satisfied: Costi section rendered on both primo and rinnovo document pages
- All ~40 document page pairs (primo + rinnovo) build correctly
- Visual verification confirms readability and correct placement
</success_criteria>

<output>
After completion, create `.planning/phases/44-costi-section/44-01-SUMMARY.md`
</output>
