---
phase: 10-error-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/styles/components.css
  - scripts/templates/primo.js
  - scripts/templates/rinnovo.js
  - scripts/build-documents.js
  - src/pages/permesso-studio.html
  - src/pages/permesso-lavoro-subordinato.html
  - src/pages/permesso-lavoro-autonomo.html
  - src/pages/permesso-asilo.html
  - src/pages/permesso-ue-lungo-periodo.html
  - src/pages/permesso-ricongiungimento-familiare.html
  - src/pages/permesso-protezione-sussidiaria.html
  - src/pages/carta-soggiorno.html
  - src/pages/carta-soggiorno-familiare.html
autonomous: true

must_haves:
  truths:
    - "User sees 'Segnala errore' button in top-right of content pages"
    - "Button redirects to Typeform with current page URL as parameter"
    - "Button is visible but non-intrusive (does not block breadcrumbs or content)"
    - "Button adapts to mobile layout (absolute â†’ static positioning)"
    - "Button appears on all 128 content pages (permesso-*, documenti-*, carta-*)"
  artifacts:
    - path: "src/styles/components.css"
      provides: "Error button CSS component"
      contains: ".error-report-btn"
      min_lines: 40
    - path: "scripts/templates/primo.js"
      provides: "Button HTML in primo template"
      contains: "error-report-btn"
    - path: "scripts/templates/rinnovo.js"
      provides: "Button HTML in rinnovo template"
      contains: "error-report-btn"
    - path: "src/pages/permesso-studio.html"
      provides: "Button on static permit pages"
      contains: "error-report-btn"
    - path: "src/pages/documenti-studio-primo.html"
      provides: "Button on generated document pages"
      contains: "error-report-btn"
  key_links:
    - from: "src/styles/components.css"
      to: "HTML pages"
      via: "class='error-report-btn'"
      pattern: "\\.error-report-btn"
    - from: "HTML button"
      to: "Typeform"
      via: "href with page_url parameter"
      pattern: "form\\.typeform\\.com.*#page_url="
    - from: "scripts/templates/primo.js"
      to: "documenti-*-primo.html"
      via: "build script generation"
      pattern: "generatePrimoPage"
    - from: "breadcrumb .container"
      to: "button positioning"
      via: "position: relative parent"
      pattern: "position: relative"

user_setup:
  - service: typeform
    why: "Error reporting form"
    action_required:
      - task: "Create Typeform with hidden field named 'page_url'"
        location: "Typeform Dashboard"
        note: "Field name must exactly match URL parameter"
      - task: "Add dropdown field with error type options (5 categories)"
        location: "Typeform form builder"
        note: "User defines categories based on content needs"
      - task: "Add text area field for error description"
        location: "Typeform form builder"
      - task: "Copy form ID from form URL"
        location: "Typeform Dashboard â†’ Share"
        note: "Form ID looks like: https://form.typeform.com/to/ABC123XYZ"
      - task: "Replace TYPEFORM_ID placeholder in generated code"
        location: "After button implementation"
        note: "Search for TYPEFORM_ID and replace with actual form ID"
---

<objective>
Implement error reporting functionality by adding a "Segnala errore" button to all content pages that redirects to Typeform with pre-filled page context.

Purpose: Enable users to report content errors (outdated info, typos) or technical issues (broken links, layout problems) from any page, providing structured feedback channel with automatic page context.

Output: Fully functional error reporting button on 128 content pages (permit pages, document pages, carta pages) with CSS styling, template integration, and Typeform redirection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/10-error-reporting/10-RESEARCH.md

# Sample page for understanding structure
@src/pages/permesso-studio.html

# Existing CSS system
@src/styles/components.css

# Template scripts for document pages
@scripts/templates/primo.js
@scripts/templates/rinnovo.js

# Prior phase establishing design system
@.planning/phases/04-color-palette/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Error Button CSS Component</name>
  <files>src/styles/components.css</files>
  <action>
Add `.error-report-btn` component to components.css following the established design system.

**Location:** Add after existing button styles (around line 50, after `.btn-secondary`)

**CSS to add:**

```css
/* ===============================================
   ERROR REPORT BUTTON
   =============================================== */

.error-report-btn {
  /* Positioning - absolute within breadcrumb container */
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 10;

  /* Visual style - subtle teal outline */
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 1rem;

  /* Colors - matching header nav links teal (#1A6B5F) */
  color: #1A6B5F;
  background: transparent;
  border: 1px solid #26A69A;
  border-radius: var(--radius-full);

  /* Typography */
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  line-height: 1;
  white-space: nowrap;

  /* Transitions */
  transition: all var(--transition-base);
}

.error-report-btn:hover {
  color: #1A6B5F;
  background: rgba(38, 166, 154, 0.1);
  border-color: #1A6B5F;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(26, 107, 95, 0.15);
}

.error-report-btn:active {
  transform: translateY(0);
}

/* Mobile responsive - shift to normal flow */
@media (max-width: 768px) {
  .error-report-btn {
    position: static;
    display: block;
    width: fit-content;
    margin: 0.75rem auto 0;
    text-align: center;
  }
}

/* Landscape mobile - keep absolute but smaller */
@media (max-width: 768px) and (orientation: landscape) {
  .error-report-btn {
    position: absolute;
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
  }
}
```

**Design rationale:**
- Teal colors (#1A6B5F, #26A69A) match header nav links for consistency
- Outline style is subtle and non-intrusive
- Absolute positioning keeps it top-right without blocking breadcrumbs
- Mobile shifts to static positioning to avoid layout issues
- Uses existing CSS variables (--radius-full, --transition-base)
  </action>
  <verify>
1. Run: `grep -A 20 "ERROR REPORT BUTTON" src/styles/components.css`
2. Verify output contains `.error-report-btn` class with positioning, colors, hover states
3. Check mobile media queries present (@media max-width: 768px)
4. Confirm no syntax errors: Open any HTML page in browser, no console CSS errors
  </verify>
  <done>
CSS component exists in components.css with:
- `.error-report-btn` class defined
- Absolute positioning (desktop), static positioning (mobile)
- Teal color scheme (#1A6B5F, #26A69A)
- Hover and active states
- Mobile responsive breakpoints
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Templates and Regenerate Document Pages</name>
  <files>scripts/templates/primo.js, scripts/templates/rinnovo.js, scripts/build-documents.js</files>
  <action>
Modify template files to include error button HTML, then regenerate all document pages.

**Step 1: Update primo.js template**

Location: After breadcrumb div (around line 100, after `</div>` closing breadcrumb)

Find the breadcrumb section that looks like:
```javascript
  <!-- BREADCRUMB -->
  <section class="section" style="padding: 1rem 0;">
    <div class="container">
      <div style="font-size: 0.875rem; color: var(--gray-medium);">
        <a href="../../index.html" style="color: var(--taxi-yellow-dark);">Home</a> â†’
        <a href="database.html" style="color: var(--taxi-yellow-dark);">Database</a> â†’
        <span>Documenti ${escapedTipo} - Primo Rilascio</span>
      </div>
    </div>
  </section>
```

**Modify to:**
1. Add `style="position: relative;"` to the `.container` div
2. Add button HTML after breadcrumb div, before closing `</div>` of container

```javascript
  <!-- BREADCRUMB -->
  <section class="section" style="padding: 1rem 0;">
    <div class="container" style="position: relative;">
      <div style="font-size: 0.875rem; color: var(--gray-medium);">
        <a href="../../index.html" style="color: var(--taxi-yellow-dark);">Home</a> â†’
        <a href="database.html" style="color: var(--taxi-yellow-dark);">Database</a> â†’
        <span>Documenti ${escapedTipo} - Primo Rilascio</span>
      </div>

      <!-- ERROR BUTTON -->
      <a href="https://form.typeform.com/to/TYPEFORM_ID#page_url=${encodeURIComponent('https://sospermesso.it/src/pages/documenti-' + slug + '-primo.html')}"
         class="error-report-btn"
         target="_blank"
         rel="noopener noreferrer"
         aria-label="Segnala un errore in questa pagina">
        ðŸš¨ Segnala errore
      </a>
    </div>
  </section>
```

**Step 2: Update rinnovo.js template**

Apply same changes to rinnovo.js, but adjust the page URL:
```javascript
href="https://form.typeform.com/to/TYPEFORM_ID#page_url=${encodeURIComponent('https://sospermesso.it/src/pages/documenti-' + slug + '-rinnovo.html')}"
```

**Step 3: Regenerate document pages**

Run the build script to regenerate all documenti-* pages with new button:
```bash
cd /Users/albertopasquero/Desktop/TECH/SOSpermesso/Sito_Nuovo
node scripts/build-documents.js
```

**Note:** TYPEFORM_ID is a placeholder. User will replace it after creating the Typeform (see user_setup in frontmatter).
  </action>
  <verify>
1. Check primo.js: `grep -A 10 "ERROR BUTTON" scripts/templates/primo.js`
2. Check rinnovo.js: `grep -A 10 "ERROR BUTTON" scripts/templates/rinnovo.js`
3. Run build script: `node scripts/build-documents.js` (should complete without errors)
4. Verify generated page: `grep "error-report-btn" src/pages/documenti-studio-primo.html`
5. Check URL encoding: `grep "page_url=" src/pages/documenti-studio-primo.html | grep "%2F"` (slashes should be encoded)
6. Count updated pages: `grep -l "error-report-btn" src/pages/documenti-*.html | wc -l` (should be ~110-120 pages)
  </verify>
  <done>
Template files updated with button HTML:
- primo.js contains error-report-btn with documenti-{slug}-primo.html URL
- rinnovo.js contains error-report-btn with documenti-{slug}-rinnovo.html URL
- Build script executed successfully
- All documenti-* pages contain error-report-btn
- URLs are properly encoded (slashes as %2F)
- TYPEFORM_ID placeholder present for user to replace
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Button to Static Content Pages</name>
  <files>
    src/pages/permesso-studio.html,
    src/pages/permesso-lavoro-subordinato.html,
    src/pages/permesso-lavoro-autonomo.html,
    src/pages/permesso-asilo.html,
    src/pages/permesso-ue-lungo-periodo.html,
    src/pages/permesso-ricongiungimento-familiare.html,
    src/pages/permesso-protezione-sussidiaria.html,
    src/pages/carta-soggiorno.html,
    src/pages/carta-soggiorno-familiare.html
  </files>
  <action>
Add error button to static content pages (permesso-*, carta-*) using a bash script with sed.

**Create and run this bash script:**

```bash
#!/bin/bash
# add-error-buttons.sh
# Adds error report button to static content pages

cd /Users/albertopasquero/Desktop/TECH/SOSpermesso/Sito_Nuovo

# Process permesso-* pages
for file in src/pages/permesso-*.html; do
  if [ -f "$file" ]; then
    filename=$(basename "$file")
    encoded_url=$(echo "https://sospermesso.it/src/pages/$filename" | sed 's/:/%3A/g; s/\//%2F/g; s/\./%2E/g')

    # Add position: relative to breadcrumb container and insert button
    sed -i.bak '
      # Add position: relative to breadcrumb container
      s/<div class="container">/<div class="container" style="position: relative;">/

      # Find breadcrumb closing </div> and add button after it
      /<div style="font-size: 0\.875rem; color: var(--gray-medium);">/,/<\/div>/ {
        /<\/div>/ a\
\
      <!-- ERROR BUTTON -->\
      <a href="https://form.typeform.com/to/TYPEFORM_ID#page_url='"$encoded_url"'"\
         class="error-report-btn"\
         target="_blank"\
         rel="noopener noreferrer"\
         aria-label="Segnala un errore in questa pagina">\
        ðŸš¨ Segnala errore\
      </a>
      }
    ' "$file"

    echo "âœ“ Added button to $filename"
  fi
done

# Process carta-* pages
for file in src/pages/carta-*.html; do
  if [ -f "$file" ]; then
    filename=$(basename "$file")
    encoded_url=$(echo "https://sospermesso.it/src/pages/$filename" | sed 's/:/%3A/g; s/\//%2F/g; s/\./%2E/g')

    # Same sed commands as above
    sed -i.bak '
      s/<div class="container">/<div class="container" style="position: relative;">/
      /<div style="font-size: 0\.875rem; color: var(--gray-medium);">/,/<\/div>/ {
        /<\/div>/ a\
\
      <!-- ERROR BUTTON -->\
      <a href="https://form.typeform.com/to/TYPEFORM_ID#page_url='"$encoded_url"'"\
         class="error-report-btn"\
         target="_blank"\
         rel="noopener noreferrer"\
         aria-label="Segnala un errore in questa pagina">\
        ðŸš¨ Segnala errore\
      </a>
      }
    ' "$file"

    echo "âœ“ Added button to $filename"
  fi
done

echo ""
echo "Done! Backup files created with .bak extension"
echo "Test the changes, then remove backups with: find src/pages -name '*.bak' -delete"
```

**Execute the script:**
```bash
chmod +x add-error-buttons.sh
./add-error-buttons.sh
```

**Important notes:**
- Script creates .bak backup files (safety measure)
- TYPEFORM_ID is placeholder for user to replace
- URLs are encoded (slashes â†’ %2F, colons â†’ %3A, dots â†’ %2E)
- Only processes permesso-* and carta-* files (not database.html, chi-siamo.html)
  </action>
  <verify>
1. Check script created backups: `ls src/pages/*.bak | wc -l` (should match number of files modified)
2. Verify button in permesso-studio.html: `grep "error-report-btn" src/pages/permesso-studio.html`
3. Check position: relative added: `grep 'style="position: relative;"' src/pages/permesso-studio.html`
4. Verify URL encoding: `grep "page_url=" src/pages/permesso-studio.html | grep "%2F"`
5. Count total content pages with button: `grep -l "error-report-btn" src/pages/*.html | wc -l` (should be 128)
6. Open permesso-studio.html in browser: Button visible top-right of breadcrumb
7. Test mobile: Resize browser to 400px width, button shifts below breadcrumb
8. Test link: Click button, opens new tab with Typeform URL (may 404 until user creates form)
  </verify>
  <done>
Button added to all static content pages:
- permesso-* pages (7 files) have error-report-btn
- carta-* pages (2 files) have error-report-btn
- Breadcrumb containers have position: relative
- URLs are properly encoded
- Backup .bak files exist
- Button visible in browser (top-right desktop, below breadcrumb mobile)
- Link opens in new tab with correct Typeform URL structure
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Visual check** - Open 3 sample pages in browser:
   - `src/pages/permesso-studio.html` (static page)
   - `src/pages/documenti-studio-primo.html` (generated page)
   - `src/pages/carta-soggiorno.html` (static page)

2. **Desktop verification:**
   - Button appears top-right of breadcrumb section
   - Button has teal outline style (not intrusive)
   - Hover shows background tint and slight lift
   - Breadcrumbs are not obscured

3. **Mobile verification:**
   - Resize browser to 400px width
   - Button shifts to center position below breadcrumb
   - No horizontal overflow
   - Button remains clickable

4. **Link verification:**
   - Click button on any page
   - New tab opens with URL: `https://form.typeform.com/to/TYPEFORM_ID#page_url=...`
   - page_url parameter contains encoded page URL (with %2F for slashes)

5. **Coverage verification:**
   - Run: `grep -l "error-report-btn" src/pages/*.html | wc -l`
   - Should return: 128 (all content pages)
   - Run: `grep -L "error-report-btn" src/pages/database.html src/pages/chi-siamo.html`
   - Should confirm: No button on non-content pages

6. **CSS verification:**
   - No console errors in browser
   - Button styling matches design (teal colors, rounded corners, hover effects)
   - Mobile media query works (button repositions on narrow screens)
</verification>

<success_criteria>
Phase 10 is complete when:

1. **CSS Component Exists:**
   - `.error-report-btn` class in components.css
   - Includes desktop (absolute) and mobile (static) positioning
   - Teal color scheme matches header nav links
   - Hover and active states defined

2. **Templates Updated:**
   - primo.js and rinnovo.js contain button HTML
   - Button positioned after breadcrumb with position: relative parent
   - URLs use proper encoding (encodeURIComponent)
   - TYPEFORM_ID placeholder ready for user replacement

3. **All Content Pages Have Button:**
   - 128 content pages contain error-report-btn
   - 7 permesso-* pages (static)
   - ~110-120 documenti-* pages (generated)
   - 2 carta-* pages (static)

4. **Button Works Correctly:**
   - Desktop: Top-right absolute positioning, no content blocking
   - Mobile: Static positioning below breadcrumb, centered
   - Click opens Typeform in new tab with page_url parameter
   - URL parameter is properly encoded

5. **User Setup Ready:**
   - TYPEFORM_ID placeholder present in all button hrefs
   - User knows to create Typeform with 'page_url' hidden field
   - User knows to replace TYPEFORM_ID after form creation

6. **Non-Content Pages Unaffected:**
   - database.html, chi-siamo.html, index.html do NOT have button
   - Navigation and landing pages remain unchanged

**User action required:** Create Typeform (5 min) and replace TYPEFORM_ID placeholder (~2 min with find/replace).
</success_criteria>

<output>
After completion, create `.planning/phases/10-error-reporting/10-01-SUMMARY.md` with:

- Overview of implementation approach (CSS + templates + bulk edit)
- Number of pages modified (128 content pages)
- Design decisions (teal colors, positioning strategy, mobile responsive)
- TYPEFORM_ID placeholder locations (user setup instructions)
- Files modified list
- Next steps: User creates Typeform and replaces placeholder
</output>
