---
phase: 38-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - netlify.toml
autonomous: false

user_setup:
  - service: netlify
    why: "Production deployment platform"
    env_vars:
      - name: NOTION_API_KEY
        source: "Notion Dashboard -> Settings & members -> Connections -> Develop or manage integrations"
      - name: NOTION_DATABASE_ID
        source: "Notion URL of Database permessi page (32-character ID from URL)"
      - name: OPENROUTER_API_KEY
        source: "OpenRouter Dashboard -> API Keys"
    dashboard_config:
      - task: "Verify environment variables are set with Builds scope"
        location: "Netlify Dashboard -> Site settings -> Environment variables"

must_haves:
  truths:
    - "Netlify build command runs both Notion generation and 11ty build"
    - "Build output goes to _site directory"
    - "Build completes successfully on Netlify"
    - "All ~412 pages accessible on production domain"
    - "Build time under 60 seconds"
  artifacts:
    - path: "package.json"
      provides: "Combined build script chaining Notion + 11ty"
      contains: "npm run build:docs && npm run build:11ty"
    - path: "netlify.toml"
      provides: "Netlify build configuration for 11ty"
      contains: "publish = \"_site\""
  key_links:
    - from: "netlify.toml"
      to: "package.json"
      via: "build command"
      pattern: "command = \"npm run build\""
    - from: "package.json build script"
      to: "Notion scripts + 11ty"
      via: "chained npm scripts"
      pattern: "build:docs.*build:11ty"
---

<objective>
Configure Netlify for 11ty deployment with combined Notion + 11ty build pipeline.

Purpose: Complete v3.0 migration by deploying the 11ty-powered site to production, replacing the old HTML-only deployment.

Output: Updated netlify.toml and package.json enabling automated Netlify builds that generate Notion content and compile 11ty site.
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-deployment/38-RESEARCH.md
@package.json
@netlify.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update build scripts and netlify.toml</name>
  <files>package.json, netlify.toml</files>
  <action>
1. Update package.json scripts section to add combined build:
   - Keep existing: "build:docs", "build:sitemap", "dev"
   - Rename current "build" to "build:11ty": "npx @11ty/eleventy"
   - Add new "build": "npm run build:docs && npm run build:11ty"
   - This chains Notion content generation BEFORE 11ty compilation

2. Update netlify.toml completely:
   ```toml
   # Netlify build configuration for SOS Permesso (11ty)

   [build]
     command = "npm run build"
     publish = "_site"

   [build.environment]
     NODE_VERSION = "22"
     NODE_ENV = "production"

   # Security headers
   [[headers]]
     for = "/*"
     [headers.values]
       X-Frame-Options = "DENY"
       X-Content-Type-Options = "nosniff"
       X-XSS-Protection = "1; mode=block"
       Referrer-Policy = "strict-origin-when-cross-origin"
   ```

Key changes from current netlify.toml:
- command: "npm run build:docs" -> "npm run build" (runs both Notion + 11ty)
- publish: "." -> "_site" (11ty output directory)
- NODE_VERSION: "18" -> "22" (latest LTS, supported until Apr 2027)
- Add X-Content-Type-Options and Referrer-Policy headers
- REMOVE the old [[redirects]] section (11ty handles URLs directly)

Note: Do NOT add netlify-plugin-cache - the site builds in 1.38s locally, caching adds complexity without benefit. Keep it simple.
  </action>
  <verify>
    1. Run `cat package.json | grep -A 10 '"scripts"'` - verify build:11ty and combined build exist
    2. Run `cat netlify.toml` - verify publish = "_site" and NODE_VERSION = "22"
    3. Run `npm run build` locally - should complete successfully in under 10 seconds
  </verify>
  <done>
    - package.json has "build": "npm run build:docs && npm run build:11ty"
    - netlify.toml has publish = "_site" and command = "npm run build"
    - Local build completes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify local build produces correct output</name>
  <files>_site/ (output verification only)</files>
  <action>
1. Run full build command: `npm run build`
   - Should run build:docs first (Notion content)
   - Should run build:11ty second (Eleventy compilation)

2. Verify _site directory structure:
   - `ls _site/index.html` - root index exists
   - `ls _site/en/index.html` - EN index exists
   - `ls _site/*.html | wc -l` - should be ~207 IT pages
   - `ls _site/en/*.html | wc -l` - should be ~205 EN pages

3. Spot check a page:
   - `head -20 _site/permesso-studio.html` - should have doctype, html, head, body
   - Check it includes header/footer (not raw content)

4. Measure build time:
   - `time npm run build` - should complete in under 10 seconds locally
   - Netlify builds typically 2-3x slower, so under 30 seconds expected
  </action>
  <verify>
    - `ls _site/index.html` returns file (not error)
    - `ls _site/en/index.html` returns file (not error)
    - `npm run build` exits with code 0
    - Build time under 10 seconds locally
  </verify>
  <done>
    - _site/ contains ~412 HTML files (IT root + EN subdirectory)
    - Build completes without errors
    - Build time well under 60 seconds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify production deployment on Netlify</name>
  <what-built>
    Updated netlify.toml and package.json for 11ty deployment.
    Local build verified working with correct output structure.
  </what-built>
  <how-to-verify>
    1. Push changes to git: `git push origin main`
    2. Go to Netlify Dashboard for sospermesso.it
    3. Watch build log - should show:
       - "npm run build" starting
       - Notion content generation output
       - "11ty" build output with page count
       - Build time (should be under 60 seconds)
    4. Once deployed, verify pages work:
       - Visit https://sospermesso.it - homepage loads
       - Visit https://sospermesso.it/permesso-studio.html - permit page loads
       - Visit https://sospermesso.it/en/index.html - English pages load
       - Check header/footer appear correctly
    5. If build fails, check:
       - Environment variables set in Netlify (NOTION_API_KEY, NOTION_DATABASE_ID)
       - Build log for specific error message

    IMPORTANT: If environment variables are not set in Netlify:
    - Go to Site settings -> Environment variables
    - Add NOTION_API_KEY (from Notion integrations)
    - Add NOTION_DATABASE_ID (from Notion database URL)
    - Add OPENROUTER_API_KEY (if used by build scripts)
    - Ensure all have "Builds" scope enabled
  </how-to-verify>
  <resume-signal>
    Type "approved" if:
    - Netlify build succeeds
    - Build time under 60 seconds
    - All pages accessible on production

    Or describe any issues encountered.
  </resume-signal>
</task>

</tasks>

<verification>
## Phase 38 Verification

Run these checks after production deployment:

```bash
# Local verification (before push)
npm run build && echo "Build passed"
ls _site/index.html _site/en/index.html && echo "Key files exist"
ls _site/*.html | wc -l  # Should be ~207
ls _site/en/*.html | wc -l  # Should be ~205

# Production verification (after Netlify deploy)
curl -I https://sospermesso.it  # Should return 200
curl -I https://sospermesso.it/permesso-studio.html  # Should return 200
curl -I https://sospermesso.it/en/index.html  # Should return 200
```

## Requirements Coverage

| Requirement | Verification | Status |
|-------------|--------------|--------|
| DEPLOY-01 | netlify.toml has publish="_site", command="npm run build" | Task 1 |
| DEPLOY-02 | Netlify build succeeds, pages accessible | Task 3 |
| DEPLOY-03 | Build time under 60 seconds | Task 3 |
</verification>

<success_criteria>
1. netlify.toml configured with:
   - command = "npm run build"
   - publish = "_site"
   - NODE_VERSION = "22"

2. package.json has combined build script:
   - "build": "npm run build:docs && npm run build:11ty"

3. Netlify production deploy:
   - Build completes successfully
   - Build time under 60 seconds
   - All ~412 pages accessible
   - Header/footer render correctly

4. No broken integrations:
   - Notion content generation still works
   - Existing URLs preserved
</success_criteria>

<output>
After completion, create `.planning/phases/38-deployment/38-01-SUMMARY.md`
</output>
