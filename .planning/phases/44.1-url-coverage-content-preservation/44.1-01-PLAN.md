---
phase: 44.1-url-coverage-content-preservation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/audit-permit-content.js
autonomous: true

must_haves:
  truths:
    - "No unique content from old static files is lost when they are later replaced"
    - "Duplicate permit entries in Notion are identified and cleaned up"
    - "An audit report documents exactly which static files have unique content vs. which are safe to redirect"
  artifacts:
    - path: "scripts/audit-permit-content.js"
      provides: "Content comparison script"
    - path: ".planning/phases/44.1-url-coverage-content-preservation/CONTENT-AUDIT.md"
      provides: "Audit report: static file vs Notion content comparison"
  key_links:
    - from: "scripts/audit-permit-content.js"
      to: "Notion API"
      via: "notion.blocks.children.list + notion.search"
      pattern: "notion\\.(blocks|search)"
---

<objective>
Audit all 34 static permit files against their Notion-generated counterparts, identify any unique content that would be lost if the static file were replaced with a redirect, migrate unique content to Notion, and clean up the 3 duplicate-* entries in Notion DB.

Purpose: Content preservation is a hard requirement (URL-03). Before any static file can be replaced with a redirect, we must confirm its content exists in Notion. This plan creates the safety net for Plans 02 and 03.

Output: An audit report (CONTENT-AUDIT.md) documenting each static file's status (safe-to-redirect vs. needs-migration), and any Notion API writes needed to migrate content.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44.1-url-coverage-content-preservation/44.1-CONTEXT.md
@_data/permits.js
@eleventy.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Content audit -- compare static files vs Notion pages</name>
  <files>scripts/audit-permit-content.js, .planning/phases/44.1-url-coverage-content-preservation/CONTENT-AUDIT.md</files>
  <action>
Create `scripts/audit-permit-content.js` that:

1. Reads all 34 static permit HTML files listed in CONTEXT.md from `src/pages/permesso-*.html`
2. For each file, extracts text content from Q&A sections (strip HTML tags, normalize whitespace)
3. Fetches the corresponding Notion page content (using the canonical target slug from the CONTEXT.md mapping table)
4. Compares extracted text: does the static file have substantive content not present in Notion?
5. Categorizes each file as:
   - **placeholder**: Static file is just a "Contenuto in arrivo" placeholder -- safe to redirect
   - **equivalent**: Static file content matches Notion content -- safe to redirect
   - **unique-content**: Static file has Q&A sections with info not in Notion -- needs migration
   - **redirect-only**: Static file is already just a redirect (like permesso-asilo.html)

For matching: Do NOT require exact text match. Extract Q&A question headings from static file, check if Notion page covers the same topics. Flag as "unique" only if the static file discusses topics the Notion page does not cover at all.

Also identify the 3 duplicate-* entries in Notion (duplicate-attivita-sportiva, duplicate-motivi-religiosi, duplicate-residenza-elettiva) and confirm they can be archived (their title starts with "[DUPLICATE]" from Phase 43).

Output the results as `CONTENT-AUDIT.md` in the phase directory with a table:

| Static File | Category | Canonical Target | Notes |
|-------------|----------|------------------|-------|

At the end, summarize: how many are safe-to-redirect, how many need migration.

Run the script: `node scripts/audit-permit-content.js`

IMPORTANT: The static files are already ignored by 11ty (eleventy.config.mjs adds them to ignores). They are NOT served in _site/. This audit reads them directly from `src/pages/` as source files.
  </action>
  <verify>
- `node scripts/audit-permit-content.js` completes without errors
- `.planning/phases/44.1-url-coverage-content-preservation/CONTENT-AUDIT.md` exists
- Audit report covers all 34 static files from the CONTEXT.md mapping table
- Each file has a clear category assignment
  </verify>
  <done>Audit report exists documenting every static permit file's content status relative to Notion. Any files with unique content are clearly flagged for migration in Task 2.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate unique content to Notion + archive duplicates</name>
  <files>.planning/phases/44.1-url-coverage-content-preservation/CONTENT-AUDIT.md</files>
  <action>
Based on the CONTENT-AUDIT.md from Task 1:

**For any files flagged as "unique-content":**
- Read the unique Q&A sections from the static file
- Use Notion API (`notion.blocks.children.append()`) to add missing content to the corresponding canonical Notion page
- Format: Use heading_3 for questions, paragraph blocks for answers, bulleted_list_item for lists
- Follow Phase 43 content rules: conversational "tu" tone, no document lists (link to doc pages instead), full URLs for links
- After migration, update the audit report to mark the file as "migrated"

**For the 3 duplicate-* entries in Notion:**
- Verify they are already archived/prefixed with [DUPLICATE] (from Phase 43)
- If they still generate pages in the build (they do -- `permesso-duplicate-*.html` appear in _site/), the real fix is in Plan 02 where permits.js will filter them out
- Note in the audit report that duplicates need filtering in permits.js

**If no files are flagged as "unique-content":**
- Simply confirm in the audit report that all content is already in Notion and no migration was needed
- Still note the duplicate-* situation

Update CONTENT-AUDIT.md with a "Migration Complete" section at the bottom.
  </action>
  <verify>
- CONTENT-AUDIT.md has a "Migration Complete" section
- Any unique content identified in Task 1 has been added to the corresponding Notion page
- No content will be lost when static files are later replaced with redirects
  </verify>
  <done>All unique content from static files is confirmed present in Notion. CONTENT-AUDIT.md documents the full audit trail. Ready for Plans 02 and 03 to proceed with redirect creation and static file deletion.</done>
</task>

</tasks>

<verification>
- CONTENT-AUDIT.md exists and covers all 34 files
- Every file categorized as placeholder, equivalent, unique-content (migrated), or redirect-only
- No "unique-content" entries remain un-migrated
- Duplicate entries documented
</verification>

<success_criteria>
URL-03 satisfied: Unique content from old static files is confirmed preserved in Notion before any files are replaced with redirects.
</success_criteria>

<output>
After completion, create `.planning/phases/44.1-url-coverage-content-preservation/44.1-01-SUMMARY.md`
</output>
