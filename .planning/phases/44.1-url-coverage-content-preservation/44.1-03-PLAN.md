---
phase: 44.1-url-coverage-content-preservation
plan: 03
type: execute
wave: 3
depends_on: ["44.1-01", "44.1-02"]
files_modified:
  - src/pages/permesso-*.html
autonomous: false

must_haves:
  truths:
    - "No old static permesso-*.html files remain in src/pages/ (except any that are also Notion-generated slugs)"
    - "Build produces the expected number of permit pages (generated + redirects + parents)"
    - "No broken internal links on permit pages"
    - "All 3 parent pages show variant cards linking to children"
  artifacts:
    - path: "_site/permesso-studio.html"
      provides: "Parent page with variant cards"
      contains: "Quale situazione ti interessa"
    - path: "_site/permesso-gravidanza.html"
      provides: "Redirect to cure-mediche-art-19 parent"
      contains: "meta http-equiv"
  key_links:
    - from: "_site/permesso-studio.html"
      to: "_site/permesso-studio-dopo-ingresso-con-visto.html"
      via: "variant card link"
      pattern: "permesso-studio-dopo-ingresso-con-visto"
    - from: "_site/permesso-lavoro-autonomo.html"
      to: "_site/permesso-lavoro-autonomo-dopo-ingresso-per-flussi.html"
      via: "variant card link"
      pattern: "permesso-lavoro-autonomo-dopo-ingresso-per-flussi"
---

<objective>
Delete all old static permit files from src/pages/, run a clean build, and verify that every expected URL works correctly -- redirects land on the right page, parent pages show variant cards, and no internal links are broken.

Purpose: This is the cleanup and verification step that completes URL-01, URL-02, and URL-03. After Plans 01 and 02 have ensured content is preserved and redirect infrastructure is in place, the old files can be safely removed.

Output: Clean src/pages/ directory (no stale static permit files), verified build output.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44.1-url-coverage-content-preservation/44.1-CONTEXT.md
@.planning/phases/44.1-url-coverage-content-preservation/44.1-01-SUMMARY.md
@.planning/phases/44.1-url-coverage-content-preservation/44.1-02-SUMMARY.md
@.planning/phases/44.1-url-coverage-content-preservation/CONTENT-AUDIT.md
@eleventy.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete old static files + clean build + automated verification</name>
  <files>src/pages/permesso-*.html, eleventy.config.mjs</files>
  <action>
**A) Delete all old static `permesso-*.html` files from `src/pages/`:**

Delete every file matching `src/pages/permesso-*.html`. These are ALL old static files. The permit pages are now generated by:
- `src/pages/permits.liquid` (standard + parent + child pages from Notion data)
- `src/pages/permits-redirects.liquid` (redirect pages from permitSlugMap)

There should be approximately 63 files to delete (the count from `ls` earlier). Git history preserves them.

**B) Simplify `eleventy.config.mjs`:**

The dynamic ignore block that scans `src/pages/` for `permesso-*.html` files is no longer needed since those files are being deleted. Remove or comment out the block that does:

```js
const permitFiles = files.filter(f => f.startsWith('permesso-') && f.endsWith('.html'));
for (const file of permitFiles) {
  eleventyConfig.ignores.add(`src/pages/${file}`);
}
```

Keep the similar block for `documenti-*.html` if any static document files still exist (check first).

**C) Run a clean build:**

```bash
rm -rf _site && npm run build
```

**D) Automated verification checks:**

Run the following verification commands and confirm results:

1. **Page count check:**
   ```bash
   ls _site/permesso-*.html | wc -l
   ```
   Expected: should be approximately 45+ pages (Notion-generated + parent pages + redirects). Count should be HIGHER than the previous 47 because redirects are now added.

2. **Parent page existence:**
   ```bash
   grep -l "Quale situazione ti interessa" _site/permesso-studio.html _site/permesso-lavoro-autonomo.html _site/permesso-cure-mediche-art-19*.html
   ```
   All three should match (they are parent pages with variant cards).

3. **Redirect spot-checks:**
   ```bash
   grep "meta http-equiv" _site/permesso-gravidanza.html
   grep "meta http-equiv" _site/permesso-asilo-politico.html
   grep "meta http-equiv" _site/permesso-prosieguo-amministrativo.html
   grep "meta http-equiv" _site/permesso-ricongiungimento-familiare.html
   ```
   All should contain redirect meta tags.

4. **No duplicate pages:**
   ```bash
   ls _site/permesso-duplicate-*.html 2>/dev/null
   ```
   Should return nothing.

5. **Redirect target check** -- verify redirects point to pages that actually exist:
   ```bash
   # Extract all redirect targets from permit redirect pages
   grep -h "url=" _site/permesso-*.html | grep "meta http-equiv" | sed 's/.*url=//;s/".*//' | sort -u | while read target; do
     if [ ! -f "_site/$target" ]; then
       echo "BROKEN REDIRECT TARGET: $target"
     fi
   done
   ```
   Should produce no output (all targets exist).

6. **Parent page variant links check:**
   ```bash
   # Check studio parent links to its children
   grep -o 'href="permesso-studio-[^"]*"' _site/permesso-studio.html
   # Check lavoro-autonomo parent links to its children
   grep -o 'href="permesso-lavoro-autonomo-[^"]*"' _site/permesso-lavoro-autonomo.html
   ```
   Each should show 2 child links.

7. **No stale static files:**
   ```bash
   ls src/pages/permesso-*.html 2>/dev/null | wc -l
   ```
   Should be 0.

**E) Clean up the audit script:**

Delete `scripts/audit-permit-content.js` (one-time script, no longer needed).
  </action>
  <verify>
- `ls src/pages/permesso-*.html 2>/dev/null | wc -l` returns 0
- `npm run build` succeeds (clean build)
- All 7 verification checks from step D pass
- No "BROKEN REDIRECT TARGET" messages
- Parent pages show variant cards
- Redirect pages contain meta-refresh
  </verify>
  <done>All old static permit files deleted. Build produces all expected pages. Redirects verified working. Parent pages verified with variant cards.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete URL coverage and content preservation system:
1. Three new parent pages (Studio, Lavoro Autonomo, Cure Mediche art.19) with variant navigation cards
2. ~28 redirect pages for old URLs pointing to canonical Notion-generated pages
3. All old static permit files removed
4. slugMap.js typo fixed
5. Duplicate-* entries filtered from build output
  </what-built>
  <how-to-verify>
1. Run `npm run build` and start a local server: `npx serve _site`
2. Visit these parent pages and confirm they show variant cards:
   - http://localhost:3000/permesso-studio.html (should show 2 children: "dopo ingresso con visto" + "conversione da altro permesso")
   - http://localhost:3000/permesso-lavoro-autonomo.html (should show 2 children: "dopo ingresso per flussi" + "conversione da altro permesso")
   - Check the Cure Mediche art.19 parent page (URL depends on generated slug)
3. Test these redirects (should auto-redirect to canonical page):
   - http://localhost:3000/permesso-gravidanza.html
   - http://localhost:3000/permesso-asilo-politico.html
   - http://localhost:3000/permesso-prosieguo-amministrativo.html
   - http://localhost:3000/permesso-ricongiungimento-familiare.html
4. Verify lavoro-subordinato parent still works: http://localhost:3000/permesso-lavoro-subordinato.html
5. Confirm no "duplicate-*" pages exist
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with parent pages, redirects, or missing content.</resume-signal>
</task>

</tasks>

<verification>
- Zero static permesso-*.html files in src/pages/
- All permit URLs resolve (either direct Notion page, parent page, or redirect)
- Parent pages show navigable variant cards
- Redirects land on correct canonical pages
- No duplicate-* pages in build output
- Build completes without errors
</verification>

<success_criteria>
- URL-01: Every Notion DB permit generates an HTML page (no 404s)
- URL-02: All old permit URLs redirect to correct canonical pages
- URL-03: No content lost (verified by Plan 01 audit)
- Clean codebase: no stale static files, no unnecessary ignores in config
</success_criteria>

<output>
After completion, create `.planning/phases/44.1-url-coverage-content-preservation/44.1-03-SUMMARY.md`
</output>
