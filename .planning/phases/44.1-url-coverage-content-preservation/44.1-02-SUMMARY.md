---
phase: 44.1-url-coverage-content-preservation
plan: 02
subsystem: content-management
tags: [notion, redirects, variant-detection, url-mapping]

# Dependency graph
requires:
  - phase: 44.1-01-content-audit
    provides: Content audit identifying 4 files needing parent pages, 8 safe for redirect
  - phase: 40-permit-pages
    provides: permits.js data file, permit page generation from Notion
provides:
  - Permit redirect system (31 old URLs → canonical pages)
  - 3 new parent pages (Studio, Lavoro Autonomo, Cure Mediche art.19)
  - Duplicate-* permit filtering in permits.js
  - Fixed slugMap.js typo (prosieguo-amministrativo target)
affects: [44.1-03-static-cleanup, 45-content-validation]

# Tech tracking
tech-stack:
  added: []
  patterns: ["Manual variant group configuration", "Multi-pattern variant name extraction", "Permit redirect pagination template"]

key-files:
  created:
    - _data/permitSlugMap.js
    - _data/permitRedirects.js
    - src/pages/permits-redirects.liquid
  modified:
    - _data/permits.js
    - _data/slugMap.js

key-decisions:
  - "Manual variant groups for naming patterns not caught by 'a seguito di' detection"
  - "Extract variant names via parentheses, 'a seguito di', or colon patterns"
  - "Filter duplicate-* entries early (before content processing)"
  - "Process manual groups before auto-detection to avoid conflicts"

patterns-established:
  - "Manual variant group config when naming patterns vary"
  - "Multi-pattern variant name extraction (parentheses, 'a seguito di', colon)"
  - "Permit redirect system mirrors document redirect pattern"

# Metrics
duration: 8min
completed: 2026-02-16
---

# Phase 44.1 Plan 02: Permit Redirect System & Variant Detection Summary

**Created permit redirect system (31 old URLs), extended variant detection for 3 parent pages, filtered duplicate entries, fixed slugMap.js typo**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-16T21:50:46Z
- **Completed:** 2026-02-16T22:58:00Z
- **Tasks:** 2
- **Files modified:** 5
- **Files created:** 3

## Accomplishments

- Extended variant detection in permits.js to handle 3 naming patterns (parentheses, "a seguito di", colon)
- Created 3 new parent pages: Studio (2 children), Lavoro Autonomo (2 children), Cure Mediche art.19 (2 children)
- Filtered duplicate-* entries early in permits.js (removed 5 duplicate permits from generation)
- Created permit redirect system: permitSlugMap.js + permitRedirects.js + permits-redirects.liquid
- Generated 31 redirect pages for old permit URLs → canonical pages
- Fixed slugMap.js typo: prosieguo-amministrativo now correctly points to integrazione-prosieguo-amministrativo
- Preserved existing Lavoro Subordinato parent page (3 children, "a seguito di" pattern)

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend variant detection + filter duplicates in permits.js** - `4ce515b` (feat)
2. **Task 2: Create permit redirect system + fix slugMap.js** - `f57fab3` (feat)

## Files Created/Modified

### Created
- `_data/permitSlugMap.js` - Mapping of 31 old permit slugs to canonical slugs (short slugs, typo corrections, old spellings, renamed permits, gravidanza variants)
- `_data/permitRedirects.js` - Data file generating redirect objects from permitSlugMap for pagination
- `src/pages/permits-redirects.liquid` - Liquid template rendering permit redirect pages with meta-refresh

### Modified
- `_data/permits.js` - Added manualVariantGroups config, extractVariantName() helper, duplicate filtering, manual group processing before auto-detection
- `_data/slugMap.js` - Fixed prosieguo-amministrativo target from "prosieguo-amministravo" (typo) to "integrazione-prosieguo-amministrativo"

## Decisions Made

**Decision 44.1-02-A: Manual variant group configuration**
- **Choice:** Define manualVariantGroups object with explicit childSlugs arrays for 3 naming patterns
- **Rationale:** Studio, Lavoro Autonomo, and Cure Mediche art.19 use parentheses, not "a seguito di" pattern. Auto-detection would miss them.
- **Impact:** 3 new parent pages generated. System now handles multiple naming conventions for variant groups.

**Decision 44.1-02-B: Multi-pattern variant name extraction**
- **Choice:** Created extractVariantName() helper with 3 fallback patterns: parentheses → "a seguito di" → colon → full tipo
- **Rationale:** Different permits use different naming patterns to indicate variants. Need unified extraction.
- **Impact:** Variant cards on parent pages show clean variant names ("dopo ingresso con visto" not full tipo)

**Decision 44.1-02-C: Early duplicate filtering**
- **Choice:** Filter duplicate-* entries immediately after Notion fetch, before content processing
- **Rationale:** No point in fetching/parsing content for entries that won't generate pages
- **Impact:** Build time savings (5 fewer Notion API calls), cleaner console output, no duplicate permit pages in _site/

**Decision 44.1-02-D: Manual groups before auto-detection**
- **Choice:** Process manualVariantGroups first, remove matched slugs from array, then run detectVariants() on remainder
- **Rationale:** Prevents edge case where a permit might match both manual config and auto-detection pattern
- **Impact:** Clear separation of manual vs auto-detected groups, no duplicate parent pages

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**Issue: Duplicate document pages still generated**
- Observation: documenti-duplicate-*.html files still appear in _site/ even though permit pages were filtered
- Root cause: documents.js data file generates document pages for ALL permits in Notion, including duplicates
- Resolution: Expected behavior. Permit page filtering (permits.js) is separate from document page filtering (documents.js)
- Action: No fix needed for this plan. Document duplicate filtering would be a separate task if needed.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Plan 03 (Static file cleanup):**
- ✓ 3 parent pages generated (Studio, Lavoro Autonomo, Cure Mediche art.19)
- ✓ 31 redirect pages generated (old URLs → canonical pages)
- ✓ No duplicate permalink errors
- ✓ slugMap.js typo fixed
- ✓ Existing Lavoro Subordinato parent page preserved

**URL-01 satisfied:** Every Notion DB permit has a working HTML page (including 3 new parent pages)
**URL-02 satisfied:** 31 old permit URLs redirect to correct canonical pages
**URL-03 satisfied:** Content preservation rules from Plan 01 respected (only 8 verified-safe files touched)

**Blockers for Plan 03:**
- None. Static file cleanup can proceed for the 8 files verified safe in Plan 01 audit.

**Post-plan verification:**
- ✓ Build succeeds without errors
- ✓ permesso-studio.html, permesso-lavoro-autonomo.html, permesso-cure-mediche-art-19.html exist as parent pages
- ✓ permesso-gravidanza.html redirects to permesso-cure-mediche-art-19-donna-in-stato-di-gravidanza.html
- ✓ permesso-asilo-politico.html redirects to permesso-asilo-status-rifugiato.html
- ✓ permesso-prosieguo-amministrativo.html redirects to permesso-integrazione-prosieguo-amministrativo.html
- ✓ No permesso-duplicate-*.html files in _site/
- ✓ documenti-prosieguo-amministrativo-primo.html redirects to documenti-integrazione-prosieguo-amministrativo-primo.html

---
*Phase: 44.1-url-coverage-content-preservation*
*Completed: 2026-02-16*
