---
phase: 44.1-url-coverage-content-preservation
plan: 02
type: execute
wave: 2
depends_on: ["44.1-01"]
files_modified:
  - _data/permits.js
  - _data/permitSlugMap.js
  - _data/permitRedirects.js
  - _data/slugMap.js
  - src/pages/permits-redirects.liquid
autonomous: true

must_haves:
  truths:
    - "permesso-studio.html is a parent page listing 2 variant children"
    - "permesso-lavoro-autonomo.html is a parent page listing 2 variant children"
    - "permesso-cure-mediche-art-19.html is a parent page listing 2 variant children (donna + padre)"
    - "Old URLs like permesso-gravidanza.html redirect to correct canonical pages"
    - "Old URLs like permesso-prosieguo-amministrativo.html redirect to permesso-integrazione-prosieguo-amministrativo.html"
    - "duplicate-* permits do not generate pages"
    - "slugMap.js prosieguo-amministrativo target is fixed"
  artifacts:
    - path: "_data/permits.js"
      provides: "Extended variant detection for parenthetical naming patterns"
      contains: "manualVariantGroups"
    - path: "_data/permitSlugMap.js"
      provides: "Permit URL redirect mappings (old slug -> canonical slug)"
      exports: ["mappings"]
    - path: "_data/permitRedirects.js"
      provides: "Generates redirect page objects from permitSlugMap"
      exports: ["module.exports"]
    - path: "src/pages/permits-redirects.liquid"
      provides: "Liquid template rendering permit redirect pages"
      contains: "meta http-equiv"
    - path: "_data/slugMap.js"
      provides: "Fixed document redirect mappings"
      contains: "integrazione-prosieguo-amministrativo"
  key_links:
    - from: "_data/permitRedirects.js"
      to: "_data/permitSlugMap.js"
      via: "require('./permitSlugMap.js')"
      pattern: "require.*permitSlugMap"
    - from: "src/pages/permits-redirects.liquid"
      to: "_data/permitRedirects.js"
      via: "pagination data: permitRedirects"
      pattern: "data: permitRedirects"
    - from: "_data/permits.js"
      to: "Notion API"
      via: "manualVariantGroups config"
      pattern: "manualVariantGroups"
---

<objective>
Create the permit redirect system (mirroring the existing document redirect pattern), extend variant detection in permits.js to generate parent pages for Studio/Lavoro Autonomo/Cure Mediche art.19, filter out duplicate-* entries, and fix the slugMap.js typo.

Purpose: This delivers URL-01 (every Notion permit has a working page, including parent pages) and URL-02 (old URLs redirect to canonical pages). Without this, ~28 old URLs would 404 and 3 variant groups would lack navigable parent pages.

Output: Working redirect system + parent pages generated by 11ty build.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44.1-url-coverage-content-preservation/44.1-CONTEXT.md
@.planning/phases/44.1-url-coverage-content-preservation/44.1-01-SUMMARY.md
@_data/permits.js
@_data/slugMap.js
@_data/documentRedirects.js
@src/pages/documents-redirects.liquid
@src/pages/permits.liquid
@eleventy.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend variant detection + filter duplicates in permits.js</name>
  <files>_data/permits.js</files>
  <action>
Modify `_data/permits.js` to:

**A) Add manual variant group definitions** (because these 3 groups do NOT follow the "a seguito di" naming pattern that `detectVariants()` catches):

Add a `manualVariantGroups` config object BEFORE the `detectVariants()` function (i.e., above line 428 `function detectVariants(permits) {`):

```js
const manualVariantGroups = {
  "Studio": {
    childSlugs: [
      "studio-dopo-ingresso-con-visto",
      "studio-conversione-da-altro-permesso"
    ]
  },
  "Lavoro autonomo": {
    childSlugs: [
      "lavoro-autonomo-dopo-ingresso-per-flussi",
      "lavoro-autonomo-a-seguito-di-conversione-da-altro-permesso"
    ]
  },
  "Cure mediche (art. 19)": {
    childSlugs: [
      "cure-mediche-art-19-donna-in-stato-di-gravidanza",
      "cure-mediche-art-19-padre"
    ]
  }
};
```

**B) Modify the result-building section** to also process `manualVariantGroups`:

The key section is inside `module.exports` around lines 580-615 where `detectVariants()` is called and the `result` array is built. The simplest approach: process manual groups FIRST on the raw `processedPermits` array (line 522), pull matched children out, then run `detectVariants()` on the remainder. Specifically:

Insert new logic **after line 578** (`console.log(...Processed ${processedPermits.length}...)`) and **before line 580** (`const { variantGroups, standalone } = detectVariants(processedPermits)`). This new block should:
- Iterate `manualVariantGroups`, find matching permits in `processedPermits` by slug
- Remove matched children from the array that gets passed to `detectVariants()`
- Store the manual groups for later addition to the result array

Then after the existing variant group loop (lines 591-615), add the manual groups to `result` using the same parent/child structure.

Add logic to:
1. For each manual group, find matching permits in `standalone` (or the full `processedPermits` array) by slug
2. Remove matched children from standalone
3. Create a synthetic parent entry (same format as existing variant parents: `isVariantParent: true`, `baseName`, `variants` array)
4. Add parent + children (with `isVariantChild: true`, `parentSlug`) to the result array
5. For variant children, set `variantName` to a human-friendly label extracted from the Notion `tipo` field. E.g., for "Studio (dopo ingresso con visto)", the `variantName` should be "dopo ingresso con visto". For "Lavoro autonomo a seguito di conversione da altro permesso", `variantName` should be "conversione da altro permesso".

Logic for extracting variantName from tipo:
- If tipo contains parentheses: extract content inside parens, e.g., "Studio (dopo ingresso con visto)" -> "dopo ingresso con visto"
- If tipo contains "a seguito di": extract text after "a seguito di", e.g., "Lavoro autonomo a seguito di conversione da altro permesso" -> "conversione da altro permesso"
- If tipo contains ": " (colon-space) for the art.19 pattern: extract after colon, e.g., "Cure mediche (art. 19: donna in stato di gravidanza)" -> "donna in stato di gravidanza"
- Fallback: use the full tipo as variantName

**C) Filter out duplicate-* entries** early in the pipeline:

After fetching permits from Notion and before processing, filter out any permit whose `tipo` starts with "[DUPLICATE]" or whose slug starts with "duplicate-":

```js
// Filter out archived duplicates
const activePermits = processedPermits.filter(p => {
  if (p.slug && p.slug.startsWith('duplicate-')) {
    console.log(`[permits.js] Skipping duplicate entry: ${p.tipo}`);
    return false;
  }
  if (p.tipo && p.tipo.startsWith('[DUPLICATE]')) {
    console.log(`[permits.js] Skipping archived entry: ${p.tipo}`);
    return false;
  }
  return true;
});
```

Insert this filter **after line 578** (after all permits are processed and before `detectVariants()` is called on line 580). Apply it to the `processedPermits` array so duplicate entries never reach variant detection or the result array.

**D) Ensure the "a seguito di" detection still works** for Lavoro subordinato (3 variants) and for the one Lavoro autonomo variant that uses that pattern. The manual group for Lavoro autonomo should catch both children (one found by "a seguito di" regex, one as standalone). Handle the edge case: if a child is already captured by `detectVariants()`, the manual group processing should grab it from the existing variant group instead of standalone.

Simplest approach: Process manual groups FIRST on the raw processedPermits array, pull matched children out, then run `detectVariants()` on the remainder.

**IMPORTANT:** Do NOT break the existing lavoro-subordinato parent page. It should continue working exactly as before (3 children via "a seguito di" pattern).
  </action>
  <verify>
- `npm run build` completes without errors
- Build output includes `permesso-studio.html` (parent page with variant cards)
- Build output includes `permesso-lavoro-autonomo.html` (parent page with variant cards)
- Build output includes a parent page for Cure Mediche art.19 (check slug generated)
- Build output does NOT include `permesso-duplicate-*.html`
- `permesso-lavoro-subordinato.html` still works as parent with 3 children
- Console output shows "Skipping duplicate entry" messages
  </verify>
  <done>Three new parent pages generated (Studio, Lavoro Autonomo, Cure Mediche art.19), duplicate entries filtered out, existing Lavoro Subordinato parent still works.</done>
</task>

<task type="auto">
  <name>Task 2: Create permit redirect system + fix slugMap.js</name>
  <files>_data/permitSlugMap.js, _data/permitRedirects.js, src/pages/permits-redirects.liquid, _data/slugMap.js</files>
  <action>
**A) Create `_data/permitSlugMap.js`** -- mapping old permit slugs to canonical slugs.

Follow the exact pattern of `_data/slugMap.js` (for documents). Export an object with a `mappings` property.

The mappings come from the CONTEXT.md table. Build the complete map of old-slug -> canonical-slug:

```js
module.exports = {
  mappings: {
    // Short slug -> canonical slug
    "assistenza-minore": "assistenza-minore-art-31",
    "attesa-occupazione": "attesa-occupazione-art-22",
    "calamita-naturale": "calamita-naturale-art-20-bis",
    "protezione-speciale": "protezione-speciale-dopo-decisione-positiva-della-commissione-o-del-tribunale-art-32-d-lgs-25-2008",
    "prosieguo-amministrativo": "integrazione-prosieguo-amministrativo",
    "minori-stranieri-affidati": "affidamento-a-familiari-entro-il-quarto-grado",
    "genitore-minore-italiano": "famiglia-per-genitore-di-cittadino-italiano-art-30",
    "genitore-di-cittadino-italiano": "famiglia-per-genitore-di-cittadino-italiano-art-30",
    "ricongiungimento-familiare": "famiglia-motivi-familiari-dopo-ingresso-con-nullaosta-per-ricongiungimento-familiare",
    "conviventi-familiari-italiani": "famiglia-motivi-familiari-convivente-con-parente-cittadino-italiano-art-19",
    "coesione-familiare": "famiglia-o-motivi-familiari-senza-nullaosta-per-ricongiungimento-coesione",
    "gravi-motivi-salute": "cure-mediche-per-persona-gravemente-malata-che-si-trova-gia-in-italia",
    "persona-gravemente-malata-che-si-trova-gia-in-italia": "cure-mediche-per-persona-gravemente-malata-che-si-trova-gia-in-italia",

    // Typo corrections
    "prosieguo-amministravo": "integrazione-prosieguo-amministrativo",
    "famiglia-motivi-familiari-convivente-con-parente-cittaadino-italiano-art-19": "famiglia-motivi-familiari-convivente-con-parente-cittadino-italiano-art-19",
    "famit-per-familiari-di-cittidini-statici": "famit-per-familiari-di-cittadini-italiani-statici",

    // Old spelling (famigliari -> familiari)
    "famiglia-motivi-famigliari-art-19": "famiglia-motivi-familiari-convivente-con-parente-cittadino-italiano-art-19",
    "famiglia-motivi-famigliari-art-30-dopo-ingresso-con-nullaosta": "famiglia-motivi-familiari-dopo-ingresso-con-nullaosta-per-ricongiungimento-familiare",

    // Old article-number slugs
    "famiglia-motivi-familiari-art-30-dopo-ingresso-con-nullaosta": "famiglia-motivi-familiari-dopo-ingresso-con-nullaosta-per-ricongiungimento-familiare",
    "famiglia-motivi-familiari-art-30-senza-nullaosta-coesione": "famiglia-o-motivi-familiari-senza-nullaosta-per-ricongiungimento-coesione",
    "protezione-speciale-art-32-d-lgs-25-2008": "protezione-speciale-dopo-decisione-positiva-della-commissione-o-del-tribunale-art-32-d-lgs-25-2008",

    // Renamed permits
    "asilo-politico": "asilo-status-rifugiato",
    "cure-mediche": "cure-mediche-dopo-ingresso-con-visto-art-36",
    "cure-mediche-art-36-d-lgs-286-1998": "cure-mediche-dopo-ingresso-con-visto-art-36",
    "cure-mediche-ex-art-19-comma-2-lett-d-bis": "cure-mediche-per-persona-gravemente-malata-che-si-trova-gia-in-italia",

    // Old card names -> canonical
    "familiari-di-cittadini-ue-carta-ue": "carta-di-soggiorno-per-familiari-di-cittadini-ue-d-lgs-30-07",
    "familiari-di-italiani-dinamici-carta-ue": "carta-di-soggiorno-per-familiari-di-italiani-dinamici-d-lgs-30-07",
    "famit-familiari-italiani-statici": "famit-per-familiari-di-cittadini-italiani-statici",

    // Gravidanza variants -> parent or specific child
    "gravidanza": "cure-mediche-art-19-donna-in-stato-di-gravidanza",
    "donna-in-stato-di-gravidanza-e-padre-del-bambino": "cure-mediche-art-19",
    "cure-mediche-per-donna-in-stato-di-gravidanza-e-padre-del-bambino-art-19": "cure-mediche-art-19"
  }
};
```

IMPORTANT: Cross-reference each mapping against the CONTEXT.md table and the actual Notion slugs from permits.js output. The canonical target MUST match either:
- A slug that Notion generates (from the ALL SLUGS list), OR
- A parent page slug created by the variant detection (e.g., "studio", "lavoro-autonomo", "cure-mediche-art-19")

For the Gravidanza/Cure art.19 parent entries: the two old URLs for the combined "donna + padre" page should redirect to the parent page slug. The parent slugs are deterministic from `slugify()` â€” no need to wait for Task 1's runtime output:
- `slugify("Studio")` = `"studio"`
- `slugify("Lavoro autonomo")` = `"lavoro-autonomo"`
- `slugify("Cure mediche (art. 19)")` = `"cure-mediche-art-19"`

Use these known slugs directly as redirect targets in the permitSlugMap.

**B) Create `_data/permitRedirects.js`** -- mirrors `_data/documentRedirects.js` pattern:

```js
const permitSlugMap = require('./permitSlugMap.js');

module.exports = function() {
  const redirects = [];
  for (const [oldSlug, canonicalSlug] of Object.entries(permitSlugMap.mappings)) {
    redirects.push({
      oldSlug,
      canonicalSlug,
      targetFile: `permesso-${canonicalSlug}.html`
    });
  }
  console.log(`[permitRedirects.js] Generated ${redirects.length} permit redirect entries`);
  return redirects;
};
```

**C) Create `src/pages/permits-redirects.liquid`** -- mirrors `src/pages/documents-redirects.liquid`:

```liquid
---
pagination:
  data: permitRedirects
  size: 1
  alias: redirect
permalink: "permesso-{{ redirect.oldSlug }}.html"
layout: false
eleventyExcludeFromCollections: true
---
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="0;url={{ redirect.targetFile }}">
  <link rel="canonical" href="{{ redirect.targetFile }}">
  <title>Redirecting...</title>
</head>
<body>
  <p>Reindirizzamento in corso a <a href="{{ redirect.targetFile }}">{{ redirect.targetFile }}</a>...</p>
  <script>window.location.replace("{{ redirect.targetFile }}");</script>
</body>
</html>
```

**D) Fix `_data/slugMap.js`** -- change the prosieguo-amministrativo target:

Change line:
```
"prosieguo-amministrativo": "prosieguo-amministravo",
```
To:
```
"prosieguo-amministrativo": "integrazione-prosieguo-amministrativo",
```

Wait -- this is the DOCUMENT slugMap, not permits. The document redirect for prosieguo-amministrativo currently points to a typo slug that generates broken document pages. Verify:
- Check if `documenti-prosieguo-amministravo-primo.html` exists in _site/ (it might, from old static files)
- The correct document redirect target should use the slug that matches the Notion document entry
- If the Notion documents use a different slug, check `_data/documents.js` output

Actually, the slugMap.js is for DOCUMENT page redirects, not permits. The typo "prosieguo-amministravo" in slugMap means `documenti-prosieguo-amministrativo-primo.html` redirects to `documenti-prosieguo-amministravo-primo.html` which may or may not exist. The CONTEXT.md says the target should be "integrazione-prosieguo-amministrativo". Fix it:

```js
"prosieguo-amministrativo": "integrazione-prosieguo-amministrativo",
```

Also verify all other slugMap targets still point to valid generated document pages.

**E) Handle potential permalink collision:** If a Notion-generated permit page has the SAME slug as an old redirect slug (e.g., `permesso-famiglia-o-motivi-familiari-senza-nullaosta-per-ricongiungimento-coesione.html` exists both as a generated page AND appears in the redirect template output), 11ty will error with a duplicate permalink. Review the mapping: every `oldSlug` in permitSlugMap must NOT be the same as any slug in the Notion DB. Cross-check the CONTEXT.md table -- some entries like `permesso-famiglia-o-motivi-familiari-senza-nullaosta-per-ricongiungimento-coesione.html` exist as BOTH a static file AND a Notion-generated page. For those, the static file is already ignored and the Notion page takes over -- they do NOT need a redirect entry. Remove any mapping where oldSlug matches a Notion-generated slug.
  </action>
  <verify>
- `npm run build` completes without errors (no duplicate permalink errors)
- `_site/permesso-gravidanza.html` exists and contains meta-refresh redirect
- `_site/permesso-asilo-politico.html` exists and redirects to permesso-asilo-status-rifugiato.html
- `_site/permesso-prosieguo-amministrativo.html` redirects to permesso-integrazione-prosieguo-amministrativo.html
- `_site/permesso-ricongiungimento-familiare.html` redirects to the family canonical page
- `_site/documenti-prosieguo-amministrativo-primo.html` redirects correctly (slugMap fix)
- Console shows "[permitRedirects.js] Generated N permit redirect entries"
- Total permit pages in _site/ increases (parents + redirects added)
  </verify>
  <done>Permit redirect system operational. ~28 old URLs redirect to canonical pages. Three new parent pages generated. slugMap.js typo fixed. No duplicate permalink errors. No duplicate-* pages in output.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `ls _site/permesso-studio.html` shows parent page (not redirect, not old static)
- `ls _site/permesso-lavoro-autonomo.html` shows parent page
- `grep "meta http-equiv" _site/permesso-gravidanza.html` confirms redirect
- `grep "meta http-equiv" _site/permesso-asilo-politico.html` confirms redirect
- `ls _site/permesso-duplicate-*.html` returns nothing (filtered out)
</verification>

<success_criteria>
- URL-01: All Notion DB permits generate HTML pages including 3 new parent pages
- URL-02: All ~28 old permit URLs redirect to correct canonical pages
- No duplicate permalink build errors
- Existing lavoro-subordinato parent page still works
- slugMap.js prosieguo-amministrativo typo fixed
</success_criteria>

<output>
After completion, create `.planning/phases/44.1-url-coverage-content-preservation/44.1-02-SUMMARY.md`
</output>
