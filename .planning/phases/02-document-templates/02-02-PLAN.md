---
phase: 02-document-templates
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - scripts/templates/primo.js
  - scripts/templates/rinnovo.js
  - scripts/build-documents.js
  - src/styles/document-page.css
autonomous: false

must_haves:
  truths:
    - "User clicks [Primo] badge and lands on document page with checklist"
    - "User clicks [Rinnovo] badge and lands on document page with renewal-specific content"
    - "User checks a document checkbox and it persists after page reload"
    - "User prints document page and sees clean printable checklist"
    - "User on mobile sees responsive layout matching existing site pages"
    - "User navigates breadcrumb and returns to documenti-questura.html"
  artifacts:
    - path: "scripts/templates/primo.js"
      provides: "Primo rilascio HTML template function"
      exports: ["generatePrimoPage"]
    - path: "scripts/templates/rinnovo.js"
      provides: "Rinnovo HTML template function"
      exports: ["generateRinnovoPage"]
    - path: "scripts/build-documents.js"
      provides: "Full build script generating 46 document pages"
      min_lines: 50
    - path: "src/styles/document-page.css"
      provides: "Document page styles including print CSS"
      contains: "@media print"
    - path: "src/pages/documenti-studio-primo.html"
      provides: "Example generated primo page (first permit type)"
    - path: "src/pages/documenti-studio-rinnovo.html"
      provides: "Example generated rinnovo page (first permit type)"
  key_links:
    - from: "scripts/build-documents.js"
      to: "scripts/templates/primo.js"
      via: "require and generatePrimoPage()"
      pattern: "generatePrimoPage"
    - from: "scripts/build-documents.js"
      to: "scripts/notion-client.js"
      via: "require and fetchPermitData()"
      pattern: "fetchPermitData"
    - from: "src/pages/documenti-*-primo.html"
      to: "localStorage"
      via: "checkbox change handler"
      pattern: "localStorage\\.setItem"
---

<objective>
Create primo rilascio and rinnovo document page templates with checklist interactivity.

Purpose: Enable 46 document pages to be generated from Notion data, each with:
- Interactive checkboxes that persist across sessions (localStorage)
- Print-friendly layout for paper checklists
- Submission method callout (KIT vs Questura)
- Quick switch between Primo/Rinnovo versions
- Mobile-responsive design matching existing site

Output:
- Two template modules (primo.js, rinnovo.js)
- Complete build script with generation logic
- Document page CSS with print styles
- At least 2 generated example pages (documenti-studio-primo.html, documenti-studio-rinnovo.html)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-document-templates/02-CONTEXT.md
@.planning/phases/02-document-templates/02-RESEARCH.md
@.planning/phases/02-document-templates/02-01-SUMMARY.md
@src/pages/permesso-studio.html (for header/footer/breadcrumb structure)
@src/pages/documenti-questura.html (for badge styling reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create document page CSS with print styles</name>
  <files>
    - src/styles/document-page.css
  </files>
  <action>
Create src/styles/document-page.css with:

1. **Document checklist styles:**
   - .doc-checklist container
   - .doc-item for each document row (checkbox + label)
   - .doc-checkbox styled checkbox input
   - .doc-label with hover state
   - .doc-checked class for completed items (strikethrough optional, green check)

2. **Submission method callout:**
   - .submission-callout prominent box
   - .callout-kit (blue accent) for postal kit submission
   - .callout-questura (orange accent) for in-person submission
   - Include negative clarification text styling

3. **Quick switch link:**
   - .quick-switch-link positioned near title
   - Styled as subtle but visible link

4. **Color accents:**
   - .page-primo for blue accent theme (border, highlight)
   - .page-rinnovo for orange accent theme

5. **Print styles (@media print):**
   - Hide header, footer, nav elements
   - Hide checkboxes, show static checkbox character
   - Show checked state with CSS ::before pseudo-element (‚úì or ‚ñ°)
   - Optimize font sizes and margins for A4/Letter paper
   - Keep checklist items together (page-break-inside: avoid)
   - Add print-only title with page URL

6. **Mobile responsive:**
   - Touch-friendly checkbox targets (44x44px)
   - Proper spacing on small screens
   - Stack elements appropriately

Reference existing styles in src/styles/main.css for color variables and spacing system.
  </action>
  <verify>
- File exists at src/styles/document-page.css
- Contains @media print section
- Contains .doc-checklist, .doc-item, .doc-checkbox classes
- Contains .submission-callout class
- Contains .page-primo and .page-rinnovo accent classes
  </verify>
  <done>
- Document page CSS created with checklist, callout, print, and responsive styles
- Print styles hide interactive elements and show checkbox state
- Color accent classes for primo (blue) and rinnovo (orange)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create primo and rinnovo template modules</name>
  <files>
    - scripts/templates/primo.js
    - scripts/templates/rinnovo.js
  </files>
  <action>
1. Create scripts/templates/ directory

2. Create scripts/templates/primo.js:

```javascript
/**
 * Template for primo rilascio (first release) document pages
 * Generates static HTML with interactive checklist
 */

function generatePrimoPage(permit) {
  const { tipo, slug, primoDocuments, primoMethod } = permit;

  // Determine submission callout
  const isKit = primoMethod && primoMethod.toLowerCase().includes('kit');
  const calloutClass = isKit ? 'callout-kit' : 'callout-questura';
  const calloutIcon = isKit ? 'üìÆ' : 'üèõÔ∏è';
  const calloutText = isKit
    ? 'Invia tramite KIT alle Poste (non devi andare in Questura)'
    : 'Porta i documenti in Questura (non puoi usare il KIT postale)';

  // Generate checklist items
  const checklistHtml = primoDocuments.map((doc, index) => `
    <div class="doc-item">
      <input type="checkbox"
             class="doc-checkbox"
             id="doc-${slug}-primo-${index}"
             data-doc="${doc}">
      <label class="doc-label" for="doc-${slug}-primo-${index}">${doc}</label>
    </div>
  `).join('');

  return `<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Documenti necessari per il primo rilascio del permesso per ${tipo}">
  <title>Documenti ${tipo} - Primo Rilascio - SOS Permesso</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="../../images/Favicon.svg">
  <link rel="shortcut icon" type="image/svg+xml" href="../../images/Favicon.svg">
  <link rel="apple-touch-icon" href="../../images/Favicon.svg">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="../styles/main.css">
  <link rel="stylesheet" href="../styles/components.css">
  <link rel="stylesheet" href="../styles/animations.css">
  <link rel="stylesheet" href="../styles/mobile.css">
  <link rel="stylesheet" href="../styles/mobile-fix.css">
  <link rel="stylesheet" href="../styles/document-page.css">
</head>
<body class="page-primo">

  <!-- HEADER -->
  <header class="header">
    <div class="container">
      <nav class="navbar">
        <a href="../../index.html" class="logo">
          <img src="../../images/Logo.png" alt="SOS Permesso" class="logo-image">
        </a>
        <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
        <ul class="nav-menu" id="nav-menu">
          <li><a href="../../index.html" class="nav-link">Home</a></li>
          <li><a href="database.html" class="nav-link">Database</a></li>
          <li><a href="chi-siamo.html" class="nav-link">Chi siamo</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- BREADCRUMB -->
  <section class="section" style="padding: 1rem 0;">
    <div class="container">
      <div style="font-size: 0.875rem; color: var(--gray-medium);">
        <a href="../../index.html" style="color: var(--taxi-yellow-dark);">Home</a> ‚Üí
        <a href="documenti-questura.html" style="color: var(--taxi-yellow-dark);">Documenti Questura</a> ‚Üí
        <span>${tipo} - Primo Rilascio</span>
      </div>
    </div>
  </section>

  <!-- PAGE HEADER -->
  <section class="section bg-off-white">
    <div class="container">
      <div class="page-header text-center">
        <span class="page-icon" style="font-size: 3rem;">üìÑ</span>
        <h1 class="page-title">${tipo}</h1>
        <p class="section-subtitle">Documenti per il <strong>Primo Rilascio</strong></p>
        <a href="documenti-${slug}-rinnovo.html" class="quick-switch-link">
          Vedi anche: Rinnovo ‚Üí
        </a>
      </div>
    </div>
  </section>

  <!-- SUBMISSION METHOD CALLOUT -->
  <section class="section">
    <div class="container" style="max-width: 700px;">
      <div class="submission-callout ${calloutClass}">
        <span class="callout-icon">${calloutIcon}</span>
        <div class="callout-text">${calloutText}</div>
      </div>
    </div>
  </section>

  <!-- DOCUMENT CHECKLIST -->
  <section class="section">
    <div class="container" style="max-width: 700px;">
      <div class="card">
        <h2>üìã Documenti necessari</h2>
        <p class="checklist-intro">Spunta i documenti che hai gi√† preparato. I tuoi progressi vengono salvati automaticamente.</p>

        <div class="doc-checklist" data-permit="${slug}-primo">
          ${checklistHtml}
        </div>

        <div class="checklist-progress">
          <span class="progress-text">Completati: <span id="progress-count">0</span>/${primoDocuments.length}</span>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="alert alert-warning" style="margin-top: 1.5rem;">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <div>
          <strong>Nota:</strong> I documenti richiesti possono variare da Questura a Questura. Contatta sempre la tua Questura per confermare la lista esatta.
        </div>
      </div>

      <!-- Related permit info link -->
      <div class="card" style="margin-top: 1.5rem; text-align: center;">
        <p>Vuoi sapere di pi√π su questo permesso?</p>
        <a href="permesso-${slug}.html" class="btn btn-primary">Informazioni sul permesso</a>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container">
      <div class="footer-links">
        <a href="chi-siamo.html" class="footer-link">Chi siamo</a>
        <a href="../../index.html" class="footer-link">Home</a>
        <a href="https://sospermesso.typeform.com/contatti" class="footer-link">Contatti</a>
      </div>
      <p class="footer-copyright">¬© 2025 SOS Permesso. Tutti i diritti riservati.</p>
    </div>
  </footer>

  <script src="../scripts/app.js"></script>
  <script>
    // Checklist persistence with localStorage
    (function() {
      const permitKey = '${slug}-primo';
      const checkboxes = document.querySelectorAll('.doc-checkbox');
      const progressCount = document.getElementById('progress-count');
      const progressFill = document.getElementById('progress-fill');

      // Load saved state
      function loadState() {
        const saved = localStorage.getItem('checklist-' + permitKey);
        if (saved) {
          try {
            const state = JSON.parse(saved);
            state.forEach(item => {
              const checkbox = document.getElementById(item.id);
              if (checkbox) checkbox.checked = item.checked;
            });
          } catch (e) {
            console.warn('Failed to load checklist state:', e);
          }
        }
        updateProgress();
      }

      // Save state
      function saveState() {
        const state = Array.from(checkboxes).map(cb => ({
          id: cb.id,
          checked: cb.checked
        }));
        localStorage.setItem('checklist-' + permitKey, JSON.stringify(state));
        updateProgress();
      }

      // Update progress bar
      function updateProgress() {
        const total = checkboxes.length;
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        progressCount.textContent = checked;
        progressFill.style.width = (total > 0 ? (checked / total) * 100 : 0) + '%';
      }

      // Attach event listeners
      checkboxes.forEach(cb => cb.addEventListener('change', saveState));

      // Initialize
      document.addEventListener('DOMContentLoaded', loadState);
    })();
  </script>
</body>
</html>`;
}

module.exports = { generatePrimoPage };
```

3. Create scripts/templates/rinnovo.js with identical structure but:
   - Export generateRinnovoPage function
   - Use rinnovoDocuments and rinnovoMethod from permit
   - Change accent class to page-rinnovo
   - Change title to "Rinnovo" instead of "Primo Rilascio"
   - Change quick-switch link to point to primo version
   - Change localStorage key to use {slug}-rinnovo
  </action>
  <verify>
- File scripts/templates/primo.js exists and exports generatePrimoPage
- File scripts/templates/rinnovo.js exists and exports generateRinnovoPage
- Run `node -e "const { generatePrimoPage } = require('./scripts/templates/primo.js'); console.log(typeof generatePrimoPage)"` - outputs "function"
- Run `node -e "const { generateRinnovoPage } = require('./scripts/templates/rinnovo.js'); console.log(typeof generateRinnovoPage)"` - outputs "function"
  </verify>
  <done>
- primo.js template generates complete HTML with header, breadcrumb, callout, checklist, localStorage script
- rinnovo.js template mirrors primo.js with renewal-specific content and orange accent
- Templates include all features: checkboxes, progress bar, submission callout, quick switch link
  </done>
</task>

<task type="auto">
  <name>Task 3: Complete build script with page generation</name>
  <files>
    - scripts/build-documents.js
  </files>
  <action>
Update scripts/build-documents.js (replacing the stub from Plan 01) with full implementation:

1. Import required modules:
   - fs/promises for file writing
   - path for path manipulation
   - notion-client for data fetching
   - primo.js and rinnovo.js templates

2. Implement generatePages() function:
   - Fetch all permit data from Notion
   - For each permit with valid slug:
     - If primoDocuments.length > 0: generate primo page
     - If rinnovoDocuments.length > 0: generate rinnovo page
   - Write files to src/pages/documenti-{slug}-{type}.html

3. Add error handling:
   - Graceful exit if NOTION_API_KEY not set
   - Log progress for each generated file
   - Report total pages generated

4. Add summary output:
   - List all generated files
   - Show any permits skipped (no slug or empty documents)

Example structure:
```javascript
const fs = require('fs/promises');
const path = require('path');
const { fetchPermitData, testConnection } = require('./notion-client.js');
const { generatePrimoPage } = require('./templates/primo.js');
const { generateRinnovoPage } = require('./templates/rinnovo.js');

const OUTPUT_DIR = path.join(__dirname, '../src/pages');

async function build() {
  console.log('üìÑ SOS Permesso - Document Page Builder');
  console.log('========================================\n');

  // Test connection
  const connected = await testConnection();
  if (!connected) {
    console.log('\n‚ö†Ô∏è  Skipping build - Notion not configured');
    console.log('   Set NOTION_API_KEY in environment variables');
    process.exit(0);
  }

  // Fetch data
  console.log('\nüì• Fetching permit data from Notion...');
  const permits = await fetchPermitData();
  console.log(`   Found ${permits.length} permit types\n`);

  let primoCount = 0;
  let rinnovoCount = 0;
  const skipped = [];

  for (const permit of permits) {
    if (!permit.slug) {
      skipped.push({ tipo: permit.tipo, reason: 'No slug' });
      continue;
    }

    // Generate primo page
    if (permit.primoDocuments.length > 0) {
      const html = generatePrimoPage(permit);
      const filename = `documenti-${permit.slug}-primo.html`;
      await fs.writeFile(path.join(OUTPUT_DIR, filename), html, 'utf-8');
      console.log(`   ‚úì ${filename}`);
      primoCount++;
    } else {
      skipped.push({ tipo: permit.tipo, reason: 'No primo documents' });
    }

    // Generate rinnovo page
    if (permit.rinnovoDocuments.length > 0) {
      const html = generateRinnovoPage(permit);
      const filename = `documenti-${permit.slug}-rinnovo.html`;
      await fs.writeFile(path.join(OUTPUT_DIR, filename), html, 'utf-8');
      console.log(`   ‚úì ${filename}`);
      rinnovoCount++;
    } else {
      skipped.push({ tipo: permit.tipo, reason: 'No rinnovo documents' });
    }
  }

  // Summary
  console.log('\n========================================');
  console.log(`‚úÖ Generated ${primoCount + rinnovoCount} document pages`);
  console.log(`   - ${primoCount} primo rilascio pages`);
  console.log(`   - ${rinnovoCount} rinnovo pages`);

  if (skipped.length > 0) {
    console.log(`\n‚ö†Ô∏è  Skipped ${skipped.length} items:`);
    skipped.forEach(s => console.log(`   - ${s.tipo}: ${s.reason}`));
  }
}

build().catch(err => {
  console.error('\n‚ùå Build failed:', err);
  process.exit(1);
});
```
  </action>
  <verify>
- Run `npm run build:docs` with valid NOTION_API_KEY - generates pages
- Check src/pages/ for generated documenti-*-primo.html and documenti-*-rinnovo.html files
- Open a generated file in browser and verify structure
  </verify>
  <done>
- Build script fetches from Notion and generates static HTML pages
- Progress logged for each file generated
- Graceful handling of missing API key or empty document lists
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete document page generation system:
    - Document page CSS with checklist, callout, and print styles
    - Primo rilascio template with interactive checklist
    - Rinnovo template with renewal-specific content
    - Build script that generates pages from Notion data
  </what-built>
  <how-to-verify>
    1. **Set up Notion API key:**
       - Go to https://www.notion.so/my-integrations
       - Create a new integration (name: "SOS Permesso Build")
       - Copy the Internal Integration Secret
       - Create .env file with: NOTION_API_KEY=secret_xxx
       - Share the database with your integration:
         - Open the Notion database page
         - Click ... ‚Üí Connections ‚Üí Add connection ‚Üí Select your integration

    2. **Run build:**
       - `npm run build:docs`
       - Should see "Found X permit types" and list of generated files

    3. **Verify generated pages:**
       - Open src/pages/documenti-studio-primo.html in browser
       - Check: Header, breadcrumb, title, submission callout visible
       - Check: Document checklist with checkboxes
       - Check: Progress bar shows "Completati: 0/X"
       - Check a few checkboxes, refresh page - should persist
       - Check: "Vedi anche: Rinnovo ‚Üí" link works

    4. **Verify rinnovo page:**
       - Navigate to documenti-studio-rinnovo.html
       - Check: Orange accent instead of blue
       - Check: "Vedi anche: Primo ‚Üí" link works

    5. **Verify print:**
       - Press Ctrl+P (or Cmd+P)
       - Check: Header/footer hidden
       - Check: Checkboxes show checkbox character
       - Check: Layout optimized for paper

    6. **Verify mobile:**
       - Resize browser to mobile width
       - Check: Checkboxes have adequate touch targets
       - Check: Layout stacks appropriately
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Run `npm run build:docs` - generates document pages from Notion
2. Open documenti-studio-primo.html in browser - shows checklist with all required elements
3. Check checkbox, refresh page - state persists via localStorage
4. Print page (Ctrl/Cmd + P) - shows clean printable layout
5. View on mobile - responsive layout with touch-friendly checkboxes
6. Click "Vedi anche: Rinnovo ‚Üí" - navigates to rinnovo version
7. Navigate breadcrumb - returns to documenti-questura.html correctly
</verification>

<success_criteria>
1. At least 2 document pages generated (documenti-studio-primo.html, documenti-studio-rinnovo.html)
2. Checkbox state persists across page refresh (localStorage)
3. Print styles hide navigation and show clean checklist
4. Submission method callout shows correct icon and text
5. Quick switch link navigates between primo/rinnovo versions
6. Mobile layout has 44x44px touch targets for checkboxes
7. Breadcrumb navigation works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-document-templates/02-02-SUMMARY.md`
</output>
