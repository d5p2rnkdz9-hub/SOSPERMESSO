---
phase: 02-document-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .env.example
  - .gitignore
  - netlify.toml
  - scripts/notion-client.js
autonomous: true
user_setup:
  - service: notion
    why: "Fetch document lists from Notion database at build time"
    env_vars:
      - name: NOTION_API_KEY
        source: "Notion Settings > Integrations > Create integration > Copy Internal Integration Secret"
    dashboard_config:
      - task: "Create Notion integration"
        location: "https://www.notion.so/my-integrations â†’ New integration"
      - task: "Share database with integration"
        location: "Open database â†’ ... menu â†’ Connections â†’ Add [your integration name]"

must_haves:
  truths:
    - "npm install runs without error"
    - "Build script successfully fetches permit data from Notion"
    - "Build script can query Notion database and retrieve permit data"
  artifacts:
    - path: "package.json"
      provides: "Node.js project with @notionhq/client and dotenv dependencies"
      contains: "@notionhq/client"
    - path: "scripts/notion-client.js"
      provides: "Notion API wrapper with database query function"
      exports: ["fetchPermitData"]
    - path: "netlify.toml"
      provides: "Netlify build configuration"
      contains: "node scripts/build-documents.js"
    - path: ".env.example"
      provides: "Environment variable template"
      contains: "NOTION_API_KEY"
  key_links:
    - from: "scripts/notion-client.js"
      to: "Notion API"
      via: "@notionhq/client SDK"
      pattern: "Client.*auth.*NOTION_API_KEY"
---

<objective>
Set up Node.js build infrastructure for Notion-powered document page generation.

Purpose: Establish the foundation for fetching document lists from Notion database at build time. This enables Phase 3 to generate 46 static HTML pages from a single source of truth.

Output:
- package.json with dependencies
- Notion client module for database queries
- Netlify build configuration
- Environment variable template
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-document-templates/02-CONTEXT.md
@.planning/phases/02-document-templates/02-RESEARCH.md
@.planning/phases/01-page-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Node.js project with dependencies</name>
  <files>
    - package.json
    - .gitignore
    - .env.example
  </files>
  <action>
1. Run `npm init -y` to create package.json in project root
2. Run `npm install @notionhq/client dotenv` to add dependencies
3. Update package.json scripts section to add:
   - "build:docs": "node scripts/build-documents.js"
4. Update .gitignore to add:
   - node_modules/
   - .env
   - (keep existing entries)
5. Create .env.example with:
   - NOTION_API_KEY=your_notion_integration_token_here
   - Include comment: "# Get from https://www.notion.so/my-integrations"
  </action>
  <verify>
- Run `npm install` - should complete without errors
- Run `cat package.json | grep notionhq` - should show dependency
- Run `cat .gitignore | grep node_modules` - should find entry
- Run `cat .env.example` - should show NOTION_API_KEY template
  </verify>
  <done>
- package.json exists with @notionhq/client and dotenv in dependencies
- .gitignore includes node_modules/ and .env
- .env.example documents required environment variable
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Notion client module with database query</name>
  <files>
    - scripts/notion-client.js
  </files>
  <action>
1. Create scripts/ directory if it doesn't exist
2. Create scripts/notion-client.js with:

```javascript
/**
 * Notion API client for fetching permit document data
 * Database ID: 1ad7355e-7f7f-80bc-b445-000b881c6c80
 */
const { Client } = require("@notionhq/client");
require('dotenv').config();

const notion = new Client({ auth: process.env.NOTION_API_KEY });
const DATABASE_ID = "1ad7355e7f7f80bcb445000b881c6c80";

/**
 * Fetch all permit data from Notion database
 * @returns {Promise<Array>} Array of permit objects with document lists
 */
async function fetchPermitData() {
  const response = await notion.databases.query({
    database_id: DATABASE_ID
  });

  return response.results.map(page => ({
    id: page.id,
    tipo: page.properties.Tipo?.select?.name || null,
    slug: page.properties.Slug?.rich_text?.[0]?.plain_text || null,
    primoDocuments: page.properties["Doc primo rilascio"]?.multi_select?.map(d => d.name) || [],
    rinnovoDocuments: page.properties["Doc rinnovo"]?.multi_select?.map(d => d.name) || [],
    primoMethod: page.properties["Mod primo rilascio"]?.select?.name || null,
    rinnovoMethod: page.properties["Mod rinnovo"]?.select?.name || null,
  }));
}

/**
 * Test connection to Notion API
 * @returns {Promise<boolean>} True if connection successful
 */
async function testConnection() {
  try {
    const response = await notion.databases.retrieve({
      database_id: DATABASE_ID
    });
    console.log(`âœ“ Connected to Notion database: ${response.title[0]?.plain_text || 'Untitled'}`);
    return true;
  } catch (error) {
    console.error(`âœ— Notion connection failed: ${error.message}`);
    return false;
  }
}

module.exports = { fetchPermitData, testConnection, DATABASE_ID };
```

Note on DATABASE_ID: Remove hyphens from the UUID (1ad7355e-7f7f-80bc-b445-000b881c6c80 â†’ 1ad7355e7f7f80bcb445000b881c6c80) as Notion API requires 32-character hex string without dashes.
  </action>
  <verify>
- Run `node -e "require('./scripts/notion-client.js')"` - should not throw syntax errors
- Verify file exports fetchPermitData and testConnection functions
  </verify>
  <done>
- scripts/notion-client.js exists with fetchPermitData() and testConnection() exports
- Database ID correctly formatted for Notion API
- Error handling for connection failures
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Netlify build configuration</name>
  <files>
    - netlify.toml
  </files>
  <action>
1. Create netlify.toml in project root with:

```toml
# Netlify build configuration for SOS Permesso
# Generates document pages from Notion at build time

[build]
  command = "npm run build:docs"
  publish = "."

[build.environment]
  NODE_VERSION = "18"

# Headers for static assets
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"

# Redirect for clean URLs (optional)
[[redirects]]
  from = "/documenti/*"
  to = "/src/pages/documenti-:splat.html"
  status = 200
```

2. Also create a stub build-documents.js to prevent build failures:

Create scripts/build-documents.js with:
```javascript
/**
 * Build script for generating document pages from Notion
 * Full implementation in 02-02-PLAN.md
 */
const { fetchPermitData, testConnection } = require('./notion-client.js');

async function build() {
  console.log('ðŸ“„ SOS Permesso - Document Page Builder');
  console.log('----------------------------------------');

  // Test connection first
  const connected = await testConnection();
  if (!connected) {
    console.log('âš ï¸  Skipping build - Notion not configured');
    console.log('   Set NOTION_API_KEY in environment variables');
    process.exit(0); // Exit gracefully to not fail build
  }

  // Fetch data (template generation comes in Plan 02)
  const permits = await fetchPermitData();
  console.log(`âœ“ Found ${permits.length} permit types`);

  // Placeholder for template generation
  console.log('â³ Template generation will be added in next plan...');
}

build().catch(err => {
  console.error('Build failed:', err);
  process.exit(1);
});
```
  </action>
  <verify>
- Run `cat netlify.toml` - should show build command
- Run `npm run build:docs` - should run without error (shows "Notion not configured" message if no API key)
  </verify>
  <done>
- netlify.toml exists with build command pointing to npm run build:docs
- Node.js 18 specified as build environment
- Stub build script allows CI to pass while Notion is being configured
  </done>
</task>

</tasks>

<verification>
1. Run `npm install` - installs dependencies without error
2. Run `node -e "const { fetchPermitData } = require('./scripts/notion-client.js'); console.log('OK')"` - module loads correctly
3. Run `npm run build:docs` - executes build script (with warning if NOTION_API_KEY not set)
4. Verify file structure:
   - package.json (with dependencies)
   - .gitignore (with node_modules/, .env)
   - .env.example (with NOTION_API_KEY template)
   - netlify.toml (with build config)
   - scripts/notion-client.js (with fetchPermitData export)
   - scripts/build-documents.js (stub for Plan 02)
</verification>

<success_criteria>
1. `npm install` runs without errors
2. `npm run build:docs` executes (with graceful exit if no API key)
3. Notion client module exports fetchPermitData function
4. Environment variable template documented in .env.example
5. Netlify configured to run build script on deploy
</success_criteria>

<output>
After completion, create `.planning/phases/02-document-templates/02-01-SUMMARY.md`
</output>
