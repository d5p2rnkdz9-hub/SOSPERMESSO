---
phase: 53-fr-page-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - _data/nav.js
  - _data/footer.js
  - _includes/components/header.liquid
  - _includes/components/language-switcher.liquid
  - src/scripts/app.js
  - _includes/layouts/base.liquid
autonomous: true

must_haves:
  truths:
    - "Language switcher shows FR as current language on FR pages"
    - "Clicking FR in the language switcher navigates to the /fr/ version of the current page"
    - "FR pages show French navigation labels in header and footer"
    - "Logo on FR pages links to /fr/ homepage"
    - "hreflang tags on all pages include FR alternate"
  artifacts:
    - path: "_data/nav.js"
      provides: "FR navigation dropdown labels"
      contains: "fr:"
    - path: "_data/footer.js"
      provides: "FR footer link labels"
      contains: "fr:"
    - path: "_includes/components/header.liquid"
      provides: "FR-aware logo link"
      contains: "lang == 'fr'"
    - path: "_includes/components/language-switcher.liquid"
      provides: "FR current language display"
      contains: "FR"
    - path: "src/scripts/app.js"
      provides: "FR language switching logic"
      contains: "isCurrentlyFrench"
    - path: "_includes/layouts/base.liquid"
      provides: "FR hreflang alternate tags"
      contains: "hreflang=\"fr\""
  key_links:
    - from: "_includes/components/header.liquid"
      to: "_data/nav.js"
      via: "11ty data cascade"
      pattern: "lang == 'fr'"
    - from: "src/scripts/app.js"
      to: "/fr/ pages"
      via: "window.location.href path manipulation"
      pattern: "selectedLang === 'fr'"
    - from: "_includes/layouts/base.liquid"
      to: "/fr/ pages"
      via: "hreflang link tags"
      pattern: "hreflang.*fr"
---

<objective>
Wire the language switching infrastructure to support French as a third language alongside Italian and English.

Purpose: Without this wiring, FR pages would exist but be unreachable from the language switcher, have wrong navigation, and miss SEO hreflang tags.
Output: 6 modified infrastructure files enabling FR navigation, language switching, and hreflang across the entire site.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-fr-page-generation/53-RESEARCH.md

Key source files to modify:
@_data/nav.js
@_data/footer.js
@_includes/components/header.liquid
@_includes/components/language-switcher.liquid
@src/scripts/app.js
@_includes/layouts/base.liquid
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FR entries to nav.js and footer.js data files</name>
  <files>
    _data/nav.js
    _data/footer.js
  </files>
  <action>
**1. Add `fr` key to `_data/nav.js`:**

After the existing `en: { ... }` block (after line 83), add the `fr` entry. The structure mirrors the `en` block with French labels and `/fr/` paths:

```javascript
fr: {
  dropdowns: [
    {
      label: "Base de donnees",
      href: "/fr/database.html",
      items: [
        { label: "Tous les permis", href: "/fr/database.html" },
        { label: "Documents pour la Questura", href: "/fr/documenti-questura.html" }
      ]
    },
    {
      label: "Guides",
      href: "/fr/dizionario.html",
      items: [
        { label: "Protection internationale", href: "/fr/protezione-internazionale.html" },
        { label: "Regroupement familial", href: "/fr/permesso-ricongiungimento-familiare.html" },
        { label: "Dictionnaire", href: "/fr/dizionario.html" }
      ]
    },
    {
      label: "Test",
      href: "https://form.typeform.com/to/kt7P9Ejk",
      external: true,
      items: [
        { label: "Puis-je OBTENIR un permis ?", href: "https://form.typeform.com/to/kt7P9Ejk", external: true },
        { label: "Puis-je CONVERTIR ?", href: "https://form.typeform.com/to/oc9jhdkJ", external: true },
        { label: "Puis-je RENOUVELER ?", href: "https://form.typeform.com/to/R7HY8nBp", external: true }
      ]
    },
    {
      label: "Collaborer",
      href: "https://form.typeform.com/to/USx16QN3",
      external: true,
      items: [
        { label: "Aider", href: "https://form.typeform.com/to/USx16QN3", external: true },
        { label: "Signaler une erreur", href: "https://form.typeform.com/to/FsqvzdXI", external: true },
        { label: "Donner un retour", href: "https://form.typeform.com/to/USx16QN3", external: true }
      ]
    }
  ]
}
```

Note: The Guides links to `dizionario.html` and `protezione-internazionale.html` are static pages that may not exist in FR yet -- they will be 404s until created, but `permesso-ricongiungimento-familiare.html` WILL exist (generated from Notion). This is acceptable for now.

**2. Add `fr` key to `_data/footer.js`:**

After the existing `en: { ... }` block (after line 15), add:

```javascript
fr: {
  links: [
    { label: "Le Projet", href: "/fr/il-progetto.html" },
    { label: "Qui sommes-nous", href: "/fr/chi-siamo.html" },
    { label: "Confidentialite", href: "/fr/privacy-policy.html" }
  ]
}
```

Note: `il-progetto.html` and `privacy-policy.html` will be 404s until those static pages are created. `chi-siamo.html` will exist after Plan 03.
  </action>
  <verify>
1. `node -e "const n = require('./_data/nav.js'); console.log(Object.keys(n));"` outputs `['it', 'en', 'fr']`
2. `node -e "const f = require('./_data/footer.js'); console.log(Object.keys(f));"` outputs `['it', 'en', 'fr']`
3. Verify FR nav has 4 dropdowns and FR footer has 3 links
  </verify>
  <done>
nav.js has fr entry with 4 dropdown sections (Base de donnees, Guides, Test, Collaborer). footer.js has fr entry with 3 links.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update header, language switcher, app.js, and base.liquid for FR support</name>
  <files>
    _includes/components/header.liquid
    _includes/components/language-switcher.liquid
    src/scripts/app.js
    _includes/layouts/base.liquid
  </files>
  <action>
**1. Update `_includes/components/header.liquid` -- add FR logo link condition:**

Replace line 6 (the logo `<a>` tag):
```liquid
<a href="{% if lang == 'en' %}{{ '/en/' | url }}{% else %}{{ '/' | url }}{% endif %}" class="logo">
```

With a three-way conditional:
```liquid
<a href="{% if lang == 'fr' %}{{ '/fr/' | url }}{% elsif lang == 'en' %}{{ '/en/' | url }}{% else %}{{ '/' | url }}{% endif %}" class="logo">
```

FR must come FIRST in the if/elsif chain (before en) so it doesn't fall through to the else.

**2. Update `_includes/components/language-switcher.liquid` -- show FR as current:**

Replace lines 3-8 (the current language display block):
```liquid
{% if lang == 'en' %}
<span id="current-language">EN</span>
{% else %}
<span id="current-language">IT</span>
{% endif %}
```

With a three-way conditional:
```liquid
{% if lang == 'fr' %}
<span id="current-language">FR</span>
{% elsif lang == 'en' %}
<span id="current-language">EN</span>
{% else %}
<span id="current-language">IT</span>
{% endif %}
```

Note: The existing template includes flag emojis in the span. Keep whatever format the existing template uses (check if it says "EN" or "EN [flag]"). Looking at the actual file, it uses `EN [gb_flag]` and `IT [it_flag]`. So use `FR [fr_flag]` for consistency. The exact existing format is `EN ðŸ‡¬ðŸ‡§` and `IT ðŸ‡®ðŸ‡¹`, so use `FR ðŸ‡«ðŸ‡·`.

**3. Update `src/scripts/app.js` -- enable FR language switching:**

Three changes in the language switcher section:

**(a)** In `detectLanguage()` function (around line 193), uncomment the FR path detection. Replace the comment:
```javascript
// if (path.startsWith('/fr/') || path === '/fr') return 'fr';
```
With:
```javascript
if (path.startsWith('/fr/') || path === '/fr') return 'fr';
```

**(b)** Replace the "only IT and EN" guard (lines 226-229):
```javascript
if (selectedLang !== 'it' && selectedLang !== 'en') {
  alert('This language is coming soon! / Questa lingua arrivera presto!');
  return;
}
```
With:
```javascript
if (selectedLang !== 'it' && selectedLang !== 'en' && selectedLang !== 'fr') {
  alert('This language is coming soon! / Questa lingua arrivera presto!');
  return;
}
```

**(c)** Replace the entire language switching logic block (lines 236-264) with a three-language version. The current logic handles only IT<->EN. Replace it with:

```javascript
// Get current path
const currentPath = window.location.pathname;
let newPath;

// Determine current language from path
const isCurrentlyEnglish = currentPath.startsWith('/en/') || currentPath === '/en';
const isCurrentlyFrench = currentPath.startsWith('/fr/') || currentPath === '/fr';

if (selectedLang === 'fr') {
  // Switching TO French
  if (isCurrentlyFrench) return;
  if (currentPath === '/' || currentPath === '/index.html') {
    newPath = '/fr/';
  } else if (isCurrentlyEnglish) {
    newPath = '/fr' + currentPath.replace(/^\/en/, '');
  } else {
    newPath = '/fr' + currentPath;
  }
} else if (selectedLang === 'en') {
  // Switching TO English
  if (isCurrentlyEnglish) return;
  if (currentPath === '/' || currentPath === '/index.html') {
    newPath = '/en/';
  } else if (isCurrentlyFrench) {
    newPath = '/en' + currentPath.replace(/^\/fr/, '');
  } else {
    newPath = '/en' + currentPath;
  }
} else if (selectedLang === 'it') {
  // Switching TO Italian
  if (!isCurrentlyEnglish && !isCurrentlyFrench) return;
  if (isCurrentlyEnglish) {
    newPath = (currentPath === '/en/' || currentPath === '/en' || currentPath === '/en/index.html')
      ? '/' : currentPath.replace(/^\/en/, '');
  } else if (isCurrentlyFrench) {
    newPath = (currentPath === '/fr/' || currentPath === '/fr' || currentPath === '/fr/index.html')
      ? '/' : currentPath.replace(/^\/fr/, '');
  }
}

// Navigate to the new path
window.location.href = newPath;
```

IMPORTANT: The `// Save to localStorage` line and the `localStorage.setItem` call must remain BEFORE this path-switching block (they are already at line 233). Keep them. Only replace the path calculation + navigation block.

**4. Update `_includes/layouts/base.liquid` -- add FR hreflang:**

Replace the existing hreflang block (lines 31-41):

```liquid
{%- assign isEnglish = page.url | slice: 0, 4 -%}
{%- if isEnglish == "/en/" -%}
  {%- assign itUrl = page.url | replace_first: "/en/", "/" -%}
  {%- assign enUrl = page.url -%}
{%- else -%}
  {%- assign itUrl = page.url -%}
  {%- assign enUrl = "/en" | append: page.url -%}
{%- endif -%}
<link rel="alternate" hreflang="it" href="{{ site.url }}{{ itUrl }}">
<link rel="alternate" hreflang="en" href="{{ site.url }}{{ enUrl }}">
<link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ itUrl }}">
```

With a three-language version:

```liquid
{%- assign urlPrefix = page.url | slice: 0, 4 -%}
{%- if urlPrefix == "/en/" -%}
  {%- assign itUrl = page.url | replace_first: "/en/", "/" -%}
  {%- assign enUrl = page.url -%}
  {%- assign frUrl = "/fr" | append: itUrl -%}
{%- elsif urlPrefix == "/fr/" -%}
  {%- assign itUrl = page.url | replace_first: "/fr/", "/" -%}
  {%- assign enUrl = "/en" | append: itUrl -%}
  {%- assign frUrl = page.url -%}
{%- else -%}
  {%- assign itUrl = page.url -%}
  {%- assign enUrl = "/en" | append: page.url -%}
  {%- assign frUrl = "/fr" | append: page.url -%}
{%- endif -%}
<link rel="alternate" hreflang="it" href="{{ site.url }}{{ itUrl }}">
<link rel="alternate" hreflang="en" href="{{ site.url }}{{ enUrl }}">
<link rel="alternate" hreflang="fr" href="{{ site.url }}{{ frUrl }}">
<link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ itUrl }}">
```

Note: This handles all three cases:
- IT page -> EN = /en + url, FR = /fr + url
- EN page -> IT = strip /en/, FR = /fr + IT url
- FR page -> IT = strip /fr/, EN = /en + IT url
  </action>
  <verify>
1. Verify header.liquid has `lang == 'fr'` condition for logo link
2. Verify language-switcher.liquid displays `FR` with French flag when `lang == 'fr'`
3. Verify app.js has uncommented FR path detection and `isCurrentlyFrench` variable in switching logic
4. Verify app.js guard allows 'fr' through (not just 'it' and 'en')
5. Verify base.liquid has 4 hreflang tags (it, en, fr, x-default) with correct URL computation for all three prefixes
  </verify>
  <done>
Header logo links to /fr/ on FR pages. Language switcher shows "FR" on FR pages. app.js enables FR detection and three-way path switching (IT/EN/FR). base.liquid emits hreflang tags for all three languages with correct URL derivation.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. nav.js and footer.js have `fr` keys with French labels
2. header.liquid logo link handles `fr` language
3. language-switcher.liquid shows FR current state
4. app.js FR path detection uncommented and switching logic supports FR
5. base.liquid hreflang includes `fr` alternate for all page types (IT, EN, FR)
6. No hardcoded `en` references in FR-specific paths
</verification>

<success_criteria>
- Navigation and footer show French labels on FR pages
- Language switcher displays "FR" on FR pages and navigates correctly between IT/EN/FR
- Logo links to /fr/ homepage on FR pages
- All pages (IT, EN, FR) include hreflang tags for all three languages
- FR language option no longer shows "coming soon" alert
</success_criteria>

<output>
After completion, create `.planning/phases/53-fr-page-generation/53-02-SUMMARY.md`
</output>
