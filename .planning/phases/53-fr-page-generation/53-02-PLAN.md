---
phase: 53-fr-page-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - _data/nav.js
  - _data/footer.js
  - _includes/components/header.liquid
  - _includes/components/language-switcher.liquid
  - src/scripts/app.js
  - _includes/layouts/base.liquid
  - en/src/pages/documents-primo-en.liquid
  - en/src/pages/documents-rinnovo-en.liquid
autonomous: true

must_haves:
  truths:
    - "FR nav dropdown has 4 sections with French labels and /fr/ paths"
    - "FR footer has 3 links with French labels and /fr/ paths"
    - "Header logo links to /fr/ when lang is fr"
    - "Language switcher displays FR flag when lang is fr"
    - "Clicking FR in language switcher navigates to /fr/ equivalent of current page (no alert)"
    - "base.liquid emits hreflang for it, en, and fr on all pages"
    - "EN document templates include FR hreflang alternate"
  artifacts:
    - path: "_data/nav.js"
      provides: "FR navigation structure"
      contains: "fr:"
    - path: "_data/footer.js"
      provides: "FR footer links"
      contains: "fr:"
    - path: "_includes/components/header.liquid"
      provides: "FR logo link condition"
      contains: "lang == 'fr'"
    - path: "_includes/components/language-switcher.liquid"
      provides: "FR current language display"
      contains: "FR"
    - path: "src/scripts/app.js"
      provides: "FR path detection and navigation"
      contains: "isCurrentlyFrench"
    - path: "_includes/layouts/base.liquid"
      provides: "3-language hreflang tags"
      contains: "hreflang=\"fr\""
  key_links:
    - from: "src/scripts/app.js"
      to: "language-switcher.liquid"
      via: "data-lang attribute on .language-option elements"
      pattern: "selectedLang === 'fr'"
    - from: "_includes/layouts/base.liquid"
      to: "FR pages"
      via: "hreflang alternate link"
      pattern: "hreflang=\"fr\""
---

<objective>
Wire FR language support into all shared infrastructure files: navigation, footer, header, language switcher, client-side JS, hreflang tags.

Purpose: Without this wiring, FR pages would render with broken nav, wrong logo link, missing language switcher display, and an alert when clicking FR. This plan makes FR a first-class language alongside IT and EN.
Output: 8 modified infrastructure files
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/53-fr-page-generation/53-RESEARCH.md
@_data/nav.js
@_data/footer.js
@_includes/components/header.liquid
@_includes/components/language-switcher.liquid
@src/scripts/app.js
@_includes/layouts/base.liquid
@en/src/pages/documents-primo-en.liquid
@en/src/pages/documents-rinnovo-en.liquid
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FR entries to nav.js and footer.js data files</name>
  <files>_data/nav.js, _data/footer.js</files>
  <action>
**`_data/nav.js`** â€” Add a `fr` key after the existing `en` key (before the closing `};`). The structure is identical to `en` with French labels and `/fr/` paths:

```javascript
  fr: {
    dropdowns: [
      {
        label: "Base de donnÃ©es",
        href: "/fr/database.html",
        items: [
          { label: "Tous les permis", href: "/fr/database.html" },
          { label: "Documents pour la Questura", href: "/fr/documenti-questura.html" }
        ]
      },
      {
        label: "Guides",
        href: "/fr/dizionario.html",
        items: [
          { label: "Protection internationale", href: "/fr/protezione-internazionale.html" },
          { label: "Regroupement familial", href: "/fr/permesso-ricongiungimento-familiare.html" },
          { label: "Dictionnaire", href: "/fr/dizionario.html" }
        ]
      },
      {
        label: "Test",
        href: "https://form.typeform.com/to/kt7P9Ejk",
        external: true,
        items: [
          { label: "Puis-je OBTENIR un permis ?", href: "https://form.typeform.com/to/kt7P9Ejk", external: true },
          { label: "Puis-je CONVERTIR ?", href: "https://form.typeform.com/to/oc9jhdkJ", external: true },
          { label: "Puis-je RENOUVELER ?", href: "https://form.typeform.com/to/R7HY8nBp", external: true }
        ]
      },
      {
        label: "Collaborer",
        href: "https://form.typeform.com/to/USx16QN3",
        external: true,
        items: [
          { label: "Aider", href: "https://form.typeform.com/to/USx16QN3", external: true },
          { label: "Signaler une erreur", href: "https://form.typeform.com/to/FsqvzdXI", external: true },
          { label: "Donner un retour", href: "https://form.typeform.com/to/USx16QN3", external: true }
        ]
      }
    ]
  }
```

**`_data/footer.js`** â€” Add a `fr` key after the existing `en` key:

```javascript
  fr: {
    links: [
      { label: "Le Projet", href: "/fr/il-progetto.html" },
      { label: "Qui sommes-nous", href: "/fr/chi-siamo.html" },
      { label: "ConfidentialitÃ©", href: "/fr/privacy-policy.html" }
    ]
  }
```
  </action>
  <verify>
1. `grep "fr:" _data/nav.js` returns a match
2. `grep "fr:" _data/footer.js` returns a match
3. `grep "Tous les permis" _data/nav.js` returns a match
4. `grep "Qui sommes-nous" _data/footer.js` returns a match
5. `node -e "const n = require('./_data/nav.js'); console.log(n.fr.dropdowns.length)"` outputs `4`
6. `node -e "const f = require('./_data/footer.js'); console.log(f.fr.links.length)"` outputs `3`
  </verify>
  <done>nav.js has `fr` entry with 4 dropdowns (Base de donnÃ©es, Guides, Test, Collaborer) and footer.js has `fr` entry with 3 links (Le Projet, Qui sommes-nous, ConfidentialitÃ©), all with /fr/ prefixed paths</done>
</task>

<task type="auto">
  <name>Task 2: Update header, language switcher, app.js, base.liquid hreflang, and EN doc templates</name>
  <files>_includes/components/header.liquid, _includes/components/language-switcher.liquid, src/scripts/app.js, _includes/layouts/base.liquid, en/src/pages/documents-primo-en.liquid, en/src/pages/documents-rinnovo-en.liquid</files>
  <action>
**`_includes/components/header.liquid`** â€” Replace the logo `<a>` tag href logic. Currently it's:
```liquid
<a href="{% if lang == 'en' %}{{ '/en/' | url }}{% else %}{{ '/' | url }}{% endif %}" class="logo">
```
Change to:
```liquid
<a href="{% if lang == 'fr' %}{{ '/fr/' | url }}{% elsif lang == 'en' %}{{ '/en/' | url }}{% else %}{{ '/' | url }}{% endif %}" class="logo">
```
FR must come FIRST in the if-chain (otherwise it falls through to the else clause).

**`_includes/components/language-switcher.liquid`** â€” Replace the `{% if lang == 'en' %}` block. Currently it's:
```liquid
    {% if lang == 'en' %}
    <span id="current-language">EN ðŸ‡¬ðŸ‡§</span>
    {% else %}
    <span id="current-language">IT ðŸ‡®ðŸ‡¹</span>
    {% endif %}
```
Change to:
```liquid
    {% if lang == 'fr' %}
    <span id="current-language">FR ðŸ‡«ðŸ‡·</span>
    {% elsif lang == 'en' %}
    <span id="current-language">EN ðŸ‡¬ðŸ‡§</span>
    {% else %}
    <span id="current-language">IT ðŸ‡®ðŸ‡¹</span>
    {% endif %}
```

**`src/scripts/app.js`** â€” Three changes in the LANGUAGE SWITCHER section:

1. In `detectLanguage()`, uncomment the FR path detection. Find:
```javascript
  // Add more languages here when available:
  // if (path.startsWith('/fr/') || path === '/fr') return 'fr';
  // if (path.startsWith('/es/') || path === '/es') return 'es';
  // if (path.startsWith('/zh/') || path === '/zh') return 'zh';
```
Change to:
```javascript
  // Add more languages here when available:
  if (path.startsWith('/fr/') || path === '/fr') return 'fr';
  // if (path.startsWith('/es/') || path === '/es') return 'es';
  // if (path.startsWith('/zh/') || path === '/zh') return 'zh';
```

2. Remove the "only IT and EN" guard. Find:
```javascript
      // Only IT and EN are available for now
      if (selectedLang !== 'it' && selectedLang !== 'en') {
        alert('This language is coming soon! / Questa lingua arriverÃ  presto!');
        return;
      }
```
Change to:
```javascript
      // Only IT, EN, and FR are available for now
      if (selectedLang !== 'it' && selectedLang !== 'en' && selectedLang !== 'fr') {
        alert('This language is coming soon! / Questa lingua arriverÃ  presto!');
        return;
      }
```

3. Replace the entire path-switching block. Find the block starting with `// Determine current language from path` through `newPath = currentPath.replace(/^\/en/, '');` and the closing brace. Replace the ENTIRE switching logic (from `// Determine current language from path` to just before `// Navigate to the new path`) with:

```javascript
      // Determine current language from path
      const isCurrentlyEnglish = currentPath.startsWith('/en/') || currentPath === '/en';
      const isCurrentlyFrench = currentPath.startsWith('/fr/') || currentPath === '/fr';

      if (selectedLang === 'fr') {
        // Switching TO French
        if (isCurrentlyFrench) return;
        if (currentPath === '/' || currentPath === '/index.html') {
          newPath = '/fr/';
        } else if (isCurrentlyEnglish) {
          newPath = '/fr' + currentPath.replace(/^\/en/, '');
        } else {
          newPath = '/fr' + currentPath;
        }
      } else if (selectedLang === 'en') {
        // Switching TO English
        if (isCurrentlyEnglish) return;
        if (currentPath === '/' || currentPath === '/index.html') {
          newPath = '/en/';
        } else if (isCurrentlyFrench) {
          newPath = '/en' + currentPath.replace(/^\/fr/, '');
        } else {
          newPath = '/en' + currentPath;
        }
      } else if (selectedLang === 'it') {
        // Switching TO Italian
        if (!isCurrentlyEnglish && !isCurrentlyFrench) return;
        if (isCurrentlyEnglish) {
          newPath = (currentPath === '/en/' || currentPath === '/en' || currentPath === '/en/index.html')
            ? '/' : currentPath.replace(/^\/en/, '');
        } else if (isCurrentlyFrench) {
          newPath = (currentPath === '/fr/' || currentPath === '/fr' || currentPath === '/fr/index.html')
            ? '/' : currentPath.replace(/^\/fr/, '');
        }
      }
```

**`_includes/layouts/base.liquid`** â€” Replace the hreflang block. Find:
```liquid
  <!-- hreflang for multilingual SEO -->
  {%- assign isEnglish = page.url | slice: 0, 4 -%}
  {%- if isEnglish == "/en/" -%}
    {%- assign itUrl = page.url | replace_first: "/en/", "/" -%}
    {%- assign enUrl = page.url -%}
  {%- else -%}
    {%- assign itUrl = page.url -%}
    {%- assign enUrl = "/en" | append: page.url -%}
  {%- endif -%}
  <link rel="alternate" hreflang="it" href="{{ site.url }}{{ itUrl }}">
  <link rel="alternate" hreflang="en" href="{{ site.url }}{{ enUrl }}">
  <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ itUrl }}">
```
Replace with:
```liquid
  <!-- hreflang for multilingual SEO -->
  {%- assign urlPrefix = page.url | slice: 0, 4 -%}
  {%- if urlPrefix == "/en/" -%}
    {%- assign itUrl = page.url | replace_first: "/en/", "/" -%}
    {%- assign enUrl = page.url -%}
    {%- assign frUrl = "/fr" | append: itUrl -%}
  {%- elsif urlPrefix == "/fr/" -%}
    {%- assign itUrl = page.url | replace_first: "/fr/", "/" -%}
    {%- assign enUrl = "/en" | append: itUrl -%}
    {%- assign frUrl = page.url -%}
  {%- else -%}
    {%- assign itUrl = page.url -%}
    {%- assign enUrl = "/en" | append: page.url -%}
    {%- assign frUrl = "/fr" | append: page.url -%}
  {%- endif -%}
  <link rel="alternate" hreflang="it" href="{{ site.url }}{{ itUrl }}">
  <link rel="alternate" hreflang="en" href="{{ site.url }}{{ enUrl }}">
  <link rel="alternate" hreflang="fr" href="{{ site.url }}{{ frUrl }}">
  <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ itUrl }}">
```

**`en/src/pages/documents-primo-en.liquid`** â€” Add FR hreflang line. Find the hreflang block:
```html
  <link rel="alternate" hreflang="en" href="https://www.sospermesso.it/en/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="x-default" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-primo.html">
```
Insert a new line between them:
```html
  <link rel="alternate" hreflang="en" href="https://www.sospermesso.it/en/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="fr" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="x-default" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-primo.html">
```

**`en/src/pages/documents-rinnovo-en.liquid`** â€” Same pattern. Find:
```html
  <link rel="alternate" hreflang="en" href="https://www.sospermesso.it/en/documenti-{{ doc.slug }}-rinnovo.html">
  <link rel="alternate" hreflang="x-default" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-rinnovo.html">
```
Insert FR line:
```html
  <link rel="alternate" hreflang="en" href="https://www.sospermesso.it/en/documenti-{{ doc.slug }}-rinnovo.html">
  <link rel="alternate" hreflang="fr" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-rinnovo.html">
  <link rel="alternate" hreflang="x-default" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-rinnovo.html">
```
  </action>
  <verify>
1. `grep "lang == 'fr'" _includes/components/header.liquid` returns a match
2. `grep "FR" _includes/components/language-switcher.liquid` returns a match showing FR flag display
3. `grep "isCurrentlyFrench" src/scripts/app.js` returns matches
4. `grep "selectedLang === 'fr'" src/scripts/app.js` returns a match
5. `grep "hreflang=\"fr\"" _includes/layouts/base.liquid` returns a match
6. `grep "hreflang=\"fr\"" en/src/pages/documents-primo-en.liquid` returns a match
7. `grep "hreflang=\"fr\"" en/src/pages/documents-rinnovo-en.liquid` returns a match
8. `grep -c "alert" src/scripts/app.js` â€” verify the alert guard now includes `'fr'` in the exclusion
  </verify>
  <done>All 6 infrastructure files updated: header links to /fr/ for FR, switcher shows FR flag, app.js handles FR path detection + navigation without alert, base.liquid emits 3-language hreflang, EN document templates include FR hreflang alternate</done>
</task>

</tasks>

<verification>
1. `grep "fr:" _data/nav.js _data/footer.js` shows both files have FR entries
2. `grep "lang == 'fr'" _includes/components/header.liquid` shows FR condition
3. `grep "FR" _includes/components/language-switcher.liquid` shows FR display
4. `grep "isCurrentlyFrench" src/scripts/app.js` shows FR path detection
5. `grep "hreflang=\"fr\"" _includes/layouts/base.liquid` shows FR hreflang
6. `grep "hreflang=\"fr\"" en/src/pages/documents-primo-en.liquid en/src/pages/documents-rinnovo-en.liquid` shows FR hreflang in both EN doc templates
7. No references to "only IT and EN" remain in app.js guard
</verification>

<success_criteria>
- nav.js has `fr` key with 4 dropdown sections using French labels and `/fr/` paths
- footer.js has `fr` key with 3 links using French labels and `/fr/` paths
- header.liquid logo links to `/fr/` when `lang == 'fr'`
- language-switcher.liquid displays `FR` flag when `lang == 'fr'`
- app.js detects FR path, allows FR selection without alert, navigates correctly between IT/EN/FR
- base.liquid emits `hreflang="fr"` alongside `hreflang="it"` and `hreflang="en"`
- EN document templates (primo and rinnovo) include `hreflang="fr"` alternate
</success_criteria>

<output>
After completion, create `.planning/phases/53-fr-page-generation/53-02-SUMMARY.md`
</output>
