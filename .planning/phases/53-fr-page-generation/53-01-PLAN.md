---
phase: 53-fr-page-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eleventy.config.mjs
  - fr/src/pages/pages.11tydata.js
  - fr/src/pages/permits-fr.liquid
  - fr/src/pages/documents-primo-fr.liquid
  - fr/src/pages/documents-rinnovo-fr.liquid
autonomous: true

must_haves:
  truths:
    - "11ty build does not fail with DuplicatePermalinkOutputError for EN permesso-* files"
    - "FR permit pagination template exists and references permitsFr data"
    - "FR document primo pagination template exists and references documentsFr.primo data"
    - "FR document rinnovo pagination template exists and references documentsFr.rinnovo data"
    - "FR pages.11tydata.js redirects static pages to fr/ prefix and passes through pagination permalinks"
  artifacts:
    - path: "fr/src/pages/permits-fr.liquid"
      provides: "FR permit pagination template"
      contains: "data: permitsFr"
    - path: "fr/src/pages/documents-primo-fr.liquid"
      provides: "FR document primo pagination template"
      contains: "data: documentsFr.primo"
    - path: "fr/src/pages/documents-rinnovo-fr.liquid"
      provides: "FR document rinnovo pagination template"
      contains: "data: documentsFr.rinnovo"
    - path: "fr/src/pages/pages.11tydata.js"
      provides: "FR permalink override for static pages"
      contains: "fr/${data.page.fileSlug}.html"
    - path: "eleventy.config.mjs"
      provides: "Safety nets for EN permesso-* and FR documenti-* static files"
      contains: "permesso-"
  key_links:
    - from: "fr/src/pages/permits-fr.liquid"
      to: "_data/permitsFr.js"
      via: "11ty pagination data reference"
      pattern: "data: permitsFr"
    - from: "fr/src/pages/documents-primo-fr.liquid"
      to: "_data/documentsFr.js"
      via: "11ty pagination data reference"
      pattern: "data: documentsFr.primo"
---

<objective>
Create the FR pagination pipeline by copying EN templates and making targeted en->fr edits, plus fix the EN permesso-* DuplicatePermalinkOutputError blocker.

Purpose: This enables 11ty to generate all FR permit and document pages from the FR Notion database. The blocker fix is prerequisite for reliable builds.
Output: 5 new files in `fr/src/pages/`, 1 modified `eleventy.config.mjs`
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/53-fr-page-generation/53-RESEARCH.md
@en/src/pages/permits-en.liquid
@en/src/pages/documents-primo-en.liquid
@en/src/pages/documents-rinnovo-en.liquid
@en/src/pages/pages.11tydata.js
@eleventy.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix EN permesso-* blocker + add FR safety nets in eleventy.config.mjs</name>
  <files>eleventy.config.mjs</files>
  <action>
In `eleventy.config.mjs`, find the existing EN document safety net block (the `try` block starting around line 46 that reads `enPagesDir` and filters `enDocFiles`). INSIDE the same `try` block, AFTER the `enDocFiles` ignore loop (but before the `catch`), add a second filter+ignore block for EN permit files:

```javascript
    // Safety net for EN static permit pages (fixes DuplicatePermalinkOutputError)
    const enPermitFiles = enFiles.filter(f =>
      f.startsWith('permesso-') && f.endsWith('.html')
    );
    for (const file of enPermitFiles) {
      eleventyConfig.ignores.add(`en/src/pages/${file}`);
    }
    if (enPermitFiles.length > 0) {
      console.log(`[eleventy] Ignoring ${enPermitFiles.length} static EN permit files (replaced by Liquid templates)`);
    }
```

Then, AFTER the EN safety net `try/catch` block, add a NEW `try/catch` block for FR:

```javascript
  // Safety net for FR document and permit pages
  const frPagesDir = path.join(process.cwd(), 'fr', 'src', 'pages');
  try {
    const frFiles = fs.readdirSync(frPagesDir);
    const frDocFiles = frFiles.filter(f =>
      f.startsWith('documenti-') && f.endsWith('.html') && f !== 'documenti-questura.html'
    );
    for (const file of frDocFiles) {
      eleventyConfig.ignores.add(`fr/src/pages/${file}`);
    }
    if (frDocFiles.length > 0) {
      console.log(`[eleventy] Ignoring ${frDocFiles.length} static FR document files (replaced by Liquid templates)`);
    }
    const frPermitFiles = frFiles.filter(f =>
      f.startsWith('permesso-') && f.endsWith('.html')
    );
    for (const file of frPermitFiles) {
      eleventyConfig.ignores.add(`fr/src/pages/${file}`);
    }
    if (frPermitFiles.length > 0) {
      console.log(`[eleventy] Ignoring ${frPermitFiles.length} static FR permit files (replaced by Liquid templates)`);
    }
  } catch (e) {
    // Directory might not exist yet
  }
```

Do NOT change any other part of the file.
  </action>
  <verify>
Run `grep -n "permesso-" eleventy.config.mjs` to confirm the new safety net blocks exist. Confirm the EN block references `en/src/pages/` and the FR block references `fr/src/pages/`.
  </verify>
  <done>eleventy.config.mjs has three safety net blocks: IT documenti-*, EN documenti-* + permesso-*, FR documenti-* + permesso-*</done>
</task>

<task type="auto">
  <name>Task 2: Create FR pagination templates and pages.11tydata.js by copying EN and editing</name>
  <files>fr/src/pages/pages.11tydata.js, fr/src/pages/permits-fr.liquid, fr/src/pages/documents-primo-fr.liquid, fr/src/pages/documents-rinnovo-fr.liquid</files>
  <action>
**APPROACH: Copy EN files, then make targeted edits. Every FR file must be structurally identical to its EN counterpart.**

First, create the directory: `mkdir -p fr/src/pages`

**File 1: `fr/src/pages/pages.11tydata.js`**
Copy from `en/src/pages/pages.11tydata.js`. Single edit: change `en/` to `fr/` in the permalink return.
Result:
```javascript
module.exports = {
  eleventyComputed: {
    permalink: (data) => {
      // Don't override permalink for pagination templates
      if (data.pagination) return data.permalink;
      return `fr/${data.page.fileSlug}.html`;
    }
  }
};
```

**File 2: `fr/src/pages/permits-fr.liquid`**
Copy from `en/src/pages/permits-en.liquid`. Make these EXACT substitutions (no structural changes):
- Front matter `data: permitsEn` -> `data: permitsFr`
- Front matter `permalink: "en/permesso-` -> `permalink: "fr/permesso-`
- Front matter `title: "Permit for` -> `title: "Permis pour`
- Front matter `lang: en` -> `lang: fr`
- Front matter `description:` line -> `description: "Permis de séjour {{ permit.tipo }} - informations, conditions, documents et démarches"`
- Breadcrumb `href="/en/index.html"` -> `href="/fr/index.html"`
- Breadcrumb `>Home<` -> `>Accueil<`
- Breadcrumb `href="/en/database.html"` -> `href="/fr/database.html"`
- Breadcrumb `>Database<` -> `>Base de données<`
- Breadcrumb `>Permit for` -> `>Permis pour`
- Page title `>Permit for` -> `>Permis pour`
- Placeholder `>Content coming soon<` -> `>Contenu à venir<`
- Placeholder `We are still working on completing the information` -> `Nous travaillons encore à compléter les informations`
- Placeholder `about this residence permit.` -> `sur ce permis de séjour.`
- Placeholder button `Help out` -> `Aider`
- Document CTA `href="/en/documenti-` (2 occurrences) -> `href="/fr/documenti-`
- Document CTA `Documents for first issue` -> `Documents pour premier titre`
- Document CTA `Documents for renewal` -> `Documents pour renouvellement`
- CTA `Do you have more questions about the permit for` -> `Vous avez d'autres questions sur le permis pour`
- CTA button `Contact us` -> `Contactez-nous`
- Related section `>You might also be interested in<` -> `>Vous pourriez aussi être intéressé par<`
- Related `href="/en/database.html"` -> `href="/fr/database.html"`
- Related `>All permits<` -> `>Tous les permis<`
- Related `href="/en/documenti-questura.html"` -> `href="/fr/documenti-questura.html"`
- Related `>Police Documents<` -> `>Documents pour la Questura<`
- Related `href="/en/dizionario.html"` -> `href="/fr/dizionario.html"`
- Related `>Dictionary<` -> `>Dictionnaire<`

**File 3: `fr/src/pages/documents-primo-fr.liquid`**
Copy from `en/src/pages/documents-primo-en.liquid`. Make these EXACT substitutions:
- Front matter `data: documentsEn.primo` -> `data: documentsFr.primo`
- Front matter `permalink: "en/documenti-` -> `permalink: "fr/documenti-`
- Front matter `lang: en` -> `lang: fr`
- `<html lang="en">` -> `<html lang="fr">`
- `<meta name="description" content="Documents required for the first issue` -> `<meta name="description" content="Documents requis pour le premier titre du permis pour`
- `<title>Documents` -> `<title>Documents` (keep same, just change suffix) -> actually: `<title>Documents {{ doc.tipo }} - First Issue` -> `<title>Documents {{ doc.tipo }} - Premier titre`
- Canonical URL: `href="https://www.sospermesso.it/en/documenti-` -> `href="https://www.sospermesso.it/fr/documenti-`
- hreflang: Keep the existing IT and EN lines. Change the canonical self-reference to FR. Add FR alternate line:
  ```
  <link rel="canonical" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="it" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="en" href="https://www.sospermesso.it/en/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="fr" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="x-default" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-primo.html">
  ```
- Breadcrumb `href="/en/index.html"` -> `href="/fr/index.html"`
- Breadcrumb `>Home<` -> `>Accueil<`
- Breadcrumb `href="/en/documenti-questura.html"` -> `href="/fr/documenti-questura.html"`
- Breadcrumb `>Police Documents<` -> `>Documents pour la Questura<`
- Breadcrumb `- First Issue` -> `- Premier titre`
- Page subtitle `Documents for <strong>First Issue</strong>` -> `Documents pour <strong>Premier titre</strong>`
- Quick switch `href="/en/documenti-{{ doc.slug }}-rinnovo.html"` -> `href="/fr/documenti-{{ doc.slug }}-rinnovo.html"`
- Quick switch `See also: Renewal` -> `Voir aussi : Renouvellement`
- View permit `href="/en/permesso-{{ doc.slug }}.html"` -> `href="/fr/permesso-{{ doc.slug }}.html"`
- View permit `View the permit` -> `Voir le permis`
- Callout kit: `Submit via postal KIT (no Police visit needed)` -> `Déposer via kit postal (pas besoin d'aller à la Questura)`
- Callout questura: `Bring documents to the Police Headquarters (you cannot use the postal KIT)` -> `Apporter les documents à la Questura (le kit postal n'est pas utilisable)`
- Checklist heading `Required documents` -> `Documents requis`
- Checklist intro `Check off the documents you've already prepared. Your progress is saved automatically.` -> `Cochez les documents que vous avez déjà préparés. Votre progrès est sauvegardé automatiquement.`
- `data-permit="{{ doc.slug }}-primo-en"` -> `data-permit="{{ doc.slug }}-primo-fr"`
- `id="doc-{{ doc.slug }}-primo-en-{{ forloop.index0 }}"` -> `id="doc-{{ doc.slug }}-primo-fr-{{ forloop.index0 }}"`
- `(may vary by Police office)` -> `(peut varier selon la Questura)`
- `Completed:` -> `Complété :`
- Warning note `Required documents may vary from one Police office to another.` -> `Les documents requis peuvent varier d'une Questura à l'autre.`
- Doc notes heading `Additional document information` -> `Informations supplémentaires sur les documents`
- Cost heading `How much does it cost?` -> `Combien ça coûte ?`
- Cost labels: `Postal payment slip` -> `Bon de paiement postal`, `to pay at the Post Office` -> `à payer à la Poste`, `Revenue stamp` -> `Timbre fiscal`, `to buy at a tobacco shop` -> `à acheter chez un buraliste`, `Postal kit` -> `Kit postal`, `to buy at the Post Office` -> `à acheter à la Poste`
- Cost total: `Total` stays `Total`
- localStorage key: `var permitKey = '{{ doc.slug }}-primo-en'` -> `var permitKey = '{{ doc.slug }}-primo-fr'`

**File 4: `fr/src/pages/documents-rinnovo-fr.liquid`**
Copy from `en/src/pages/documents-rinnovo-en.liquid`. Apply ALL the same substitutions as primo above, plus these rinnovo-specific ones:
- Front matter `data: documentsEn.rinnovo` -> `data: documentsFr.rinnovo`
- `permalink: "en/documenti-{{ doc.slug }}-rinnovo.html"` -> `permalink: "fr/documenti-{{ doc.slug }}-rinnovo.html"`
- Title: `- Renewal -` -> `- Renouvellement -`
- Description: adjust for renewal
- Canonical and hreflang: all `-rinnovo.html` versions, same pattern as primo (IT/EN/FR/x-default)
- Breadcrumb: `- Renewal` -> `- Renouvellement`
- Subtitle: `Documents for <strong>Renewal</strong>` -> `Documents pour <strong>Renouvellement</strong>`
- Quick switch to primo: `href="/en/documenti-{{ doc.slug }}-primo.html"` -> `href="/fr/documenti-{{ doc.slug }}-primo.html"`
- Quick switch text: `See also: First Issue` -> `Voir aussi : Premier titre`
- `data-permit="{{ doc.slug }}-rinnovo-en"` -> `data-permit="{{ doc.slug }}-rinnovo-fr"`
- `id="doc-{{ doc.slug }}-rinnovo-en-0"` -> `id="doc-{{ doc.slug }}-rinnovo-fr-0"`
- `id="doc-{{ doc.slug }}-rinnovo-en-{{ idx }}"` -> `id="doc-{{ doc.slug }}-rinnovo-fr-{{ idx }}"`
- Common doc `Copy of previous permit (or loss report)` -> `Copie du permis précédent (ou déclaration de perte)`
- Also in the `unless` filter: keep `"copy of previous permit"` and `"copia permesso precedente"` (these check the normalized doc names which come from Notion data -- keep them to avoid breaking the duplicate check)
- Disputed renewal warning: `Renewal of the job-seeking permit is controversial. Some Police offices deny it. We recommend consulting a lawyer or legal aid office before proceeding.` -> `Le renouvellement du permis d'attente d'emploi est controversé. Certaines Questura le refusent. Nous recommandons de consulter un avocat ou un bureau d'aide juridique avant de procéder.`
- Legal help link: `href="/en/aiuto-legale.html"` -> `href="/fr/aiuto-legale.html"`, text: `Find legal help in your area` -> `Trouver une aide juridique près de chez vous`
- Renewal reminder: `The renewal application should preferably be submitted <strong>before the expiry date</strong> or in any case <strong>within 60 days</strong> of expiry.` -> `La demande de renouvellement doit de préférence être soumise <strong>avant la date d'expiration</strong> ou en tout cas <strong>dans les 60 jours</strong> suivant l'expiration.`
- `Remember:` -> `Rappel :`
- `Warning:` -> `Attention :`
- localStorage key: `var permitKey = '{{ doc.slug }}-rinnovo-en'` -> `var permitKey = '{{ doc.slug }}-rinnovo-fr'`

CRITICAL: The `unless` block in the rinnovo template that checks `lowerDoc contains "copy of previous permit"` must ALSO check for the French version. Add: `or lowerDoc contains "copie du permis"` to the `unless` condition to avoid duplicate display if the FR common doc name appears in the Notion data.
  </action>
  <verify>
1. `ls fr/src/pages/` confirms all 4 files exist: `pages.11tydata.js`, `permits-fr.liquid`, `documents-primo-fr.liquid`, `documents-rinnovo-fr.liquid`
2. `grep "permitsFr" fr/src/pages/permits-fr.liquid` returns a match
3. `grep "documentsFr.primo" fr/src/pages/documents-primo-fr.liquid` returns a match
4. `grep "documentsFr.rinnovo" fr/src/pages/documents-rinnovo-fr.liquid` returns a match
5. `grep "lang: fr" fr/src/pages/permits-fr.liquid` returns a match
6. `grep "primo-fr" fr/src/pages/documents-primo-fr.liquid` returns matches (data-permit, id attributes, localStorage key)
7. `grep -c "/en/" fr/src/pages/permits-fr.liquid` returns 0 (no leftover EN paths)
8. `grep -c "/en/" fr/src/pages/documents-primo-fr.liquid` returns exactly 1 (the EN hreflang alternate line only)
9. `grep -c "/en/" fr/src/pages/documents-rinnovo-fr.liquid` returns exactly 1 (the EN hreflang alternate line only)
  </verify>
  <done>All 4 FR files exist in `fr/src/pages/`, reference FR data sources, use `lang: fr`, have `/fr/` paths, FR UI strings, and FR-suffixed localStorage/checkbox IDs. No leftover EN paths except in hreflang alternates.</done>
</task>

</tasks>

<verification>
1. `ls fr/src/pages/` shows 4 files
2. `grep "permesso-" eleventy.config.mjs` shows safety net for EN AND FR permit files
3. All FR templates reference `permitsFr` or `documentsFr` (not `permitsEn` or `documentsEn`)
4. All FR templates have `lang: fr` in front matter
5. No `/en/` paths remain in FR templates except hreflang alternate lines
6. FR document templates have 4 hreflang lines (it, en, fr, x-default)
</verification>

<success_criteria>
- `fr/src/pages/permits-fr.liquid` exists with `data: permitsFr`, `lang: fr`, all `/fr/` paths, all FR UI strings
- `fr/src/pages/documents-primo-fr.liquid` exists with `data: documentsFr.primo`, `lang: fr`, FR strings, FR-suffixed IDs
- `fr/src/pages/documents-rinnovo-fr.liquid` exists with `data: documentsFr.rinnovo`, `lang: fr`, FR strings, FR-suffixed IDs
- `fr/src/pages/pages.11tydata.js` exists with `fr/` permalink prefix
- `eleventy.config.mjs` ignores EN `permesso-*.html` and FR `documenti-*.html` + `permesso-*.html` static files
</success_criteria>

<output>
After completion, create `.planning/phases/53-fr-page-generation/53-01-SUMMARY.md`
</output>
