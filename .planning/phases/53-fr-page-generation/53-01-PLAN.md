---
phase: 53-fr-page-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eleventy.config.mjs
  - fr/src/pages/pages.11tydata.js
  - fr/src/pages/permits-fr.liquid
  - fr/src/pages/documents-primo-fr.liquid
  - fr/src/pages/documents-rinnovo-fr.liquid
  - en/src/pages/documents-primo-en.liquid
  - en/src/pages/documents-rinnovo-en.liquid
  - src/pages/documents-primo.liquid
  - src/pages/documents-rinnovo.liquid
autonomous: true

must_haves:
  truths:
    - "11ty build succeeds without DuplicatePermalinkOutputError"
    - "Build produces /fr/permesso-*.html for all 43 permits"
    - "Build produces /fr/documenti-*-primo.html and /fr/documenti-*-rinnovo.html for all document types"
    - "FR permit pages display translated Q&A content from Notion"
    - "FR document pages display checklist with localStorage persistence"
    - "IT document pages include hreflang alternate for FR counterparts"
  artifacts:
    - path: "fr/src/pages/pages.11tydata.js"
      provides: "Permalink override for FR static pages"
      contains: "fr/${data.page.fileSlug}.html"
    - path: "fr/src/pages/permits-fr.liquid"
      provides: "FR permit pagination template"
      contains: "data: permitsFr"
    - path: "fr/src/pages/documents-primo-fr.liquid"
      provides: "FR document primo pagination template"
      contains: "data: documentsFr.primo"
    - path: "fr/src/pages/documents-rinnovo-fr.liquid"
      provides: "FR document rinnovo pagination template"
      contains: "data: documentsFr.rinnovo"
  key_links:
    - from: "fr/src/pages/permits-fr.liquid"
      to: "_data/permitsFr.js"
      via: "11ty pagination data binding"
      pattern: "data: permitsFr"
    - from: "fr/src/pages/documents-primo-fr.liquid"
      to: "_data/documentsFr.js"
      via: "11ty pagination data binding"
      pattern: "data: documentsFr.primo"
    - from: "eleventy.config.mjs"
      to: "en/src/pages/permesso-*.html"
      via: "dynamic ignore safety net"
      pattern: "enPermitFiles"
    - from: "src/pages/documents-primo.liquid"
      to: "fr/documenti-*-primo.html"
      via: "hreflang alternate link"
      pattern: "hreflang=\"fr\""
    - from: "src/pages/documents-rinnovo.liquid"
      to: "fr/documenti-*-rinnovo.html"
      via: "hreflang alternate link"
      pattern: "hreflang=\"fr\""
---

<objective>
Fix the EN DuplicatePermalinkOutputError blocker and create all FR pagination templates so 11ty generates French permit and document pages from Notion data. Also add FR hreflang to IT and EN document templates for full hreflang symmetry.

Purpose: This is the core generation pipeline -- without it, no FR pages exist. The blocker fix is prerequisite for any build to succeed. The hreflang additions ensure all three languages cross-reference each other for SEO.
Output: 5 new files (FR pages.11tydata.js + 3 FR liquid templates) + 5 modified files (eleventy.config.mjs + 2 EN document templates + 2 IT document templates with FR hreflang)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-fr-page-generation/53-RESEARCH.md

Key source files to reference (copy patterns from these):
@en/src/pages/permits-en.liquid
@en/src/pages/documents-primo-en.liquid
@en/src/pages/documents-rinnovo-en.liquid
@en/src/pages/pages.11tydata.js
@eleventy.config.mjs
@src/pages/documents-primo.liquid
@src/pages/documents-rinnovo.liquid
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix EN blocker + add FR safety nets in eleventy.config.mjs + create FR pages.11tydata.js</name>
  <files>
    eleventy.config.mjs
    fr/src/pages/pages.11tydata.js
  </files>
  <action>
**1. Fix DuplicatePermalinkOutputError blocker in `eleventy.config.mjs`:**

Inside the existing `enPagesDir` try block (after line 58 where enDocFiles are handled), add a SECOND filter for EN permit files. Reuse the already-read `enFiles` variable:

```javascript
// Safety net for EN static permit pages (causes DuplicatePermalinkOutputError)
const enPermitFiles = enFiles.filter(f =>
  f.startsWith('permesso-') && f.endsWith('.html')
);
for (const file of enPermitFiles) {
  eleventyConfig.ignores.add(`en/src/pages/${file}`);
}
if (enPermitFiles.length > 0) {
  console.log(`[eleventy] Ignoring ${enPermitFiles.length} static EN permit files (replaced by Liquid templates)`);
}
```

This goes INSIDE the existing try/catch block at lines 46-60 that already reads `enPagesDir`. Do NOT create a separate try/catch -- just add the filter and loop after the `enDocFiles` block.

**2. Add FR safety net in `eleventy.config.mjs`:**

After the EN safety net block (after line 60), add a NEW try/catch block for FR:

```javascript
// Safety net for FR document and permit pages
const frPagesDir = path.join(process.cwd(), 'fr', 'src', 'pages');
try {
  const frFiles = fs.readdirSync(frPagesDir);
  const frDocFiles = frFiles.filter(f =>
    f.startsWith('documenti-') && f.endsWith('.html') && f !== 'documenti-questura.html'
  );
  for (const file of frDocFiles) {
    eleventyConfig.ignores.add(`fr/src/pages/${file}`);
  }
  if (frDocFiles.length > 0) {
    console.log(`[eleventy] Ignoring ${frDocFiles.length} static FR document files (replaced by Liquid templates)`);
  }
  const frPermitFiles = frFiles.filter(f =>
    f.startsWith('permesso-') && f.endsWith('.html')
  );
  for (const file of frPermitFiles) {
    eleventyConfig.ignores.add(`fr/src/pages/${file}`);
  }
  if (frPermitFiles.length > 0) {
    console.log(`[eleventy] Ignoring ${frPermitFiles.length} static FR permit files (replaced by Liquid templates)`);
  }
} catch (e) {
  // Directory might not exist yet
}
```

**3. Create `fr/src/pages/pages.11tydata.js`:**

Create directories `fr/src/pages/` if they don't exist. Write the file as an exact copy of `en/src/pages/pages.11tydata.js` but with `fr/` prefix:

```javascript
module.exports = {
  eleventyComputed: {
    permalink: (data) => {
      // Don't override permalink for pagination templates
      if (data.pagination) return data.permalink;
      return `fr/${data.page.fileSlug}.html`;
    }
  }
};
```
  </action>
  <verify>
1. Verify `eleventy.config.mjs` has three safety net blocks: IT documenti, EN documenti+permesso, FR documenti+permesso
2. Verify `fr/src/pages/pages.11tydata.js` exists with correct content
3. Run a quick syntax check: `node -c eleventy.config.mjs` (should output "eleventy.config.mjs is ok" or similar -- note: ESM modules may not support -c, so alternatively just check the file was written correctly)
  </verify>
  <done>
eleventy.config.mjs has EN permesso-* ignore block (blocker fix) and FR safety net block. fr/src/pages/pages.11tydata.js exists with correct permalink override.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FR pagination templates (permits + documents primo + documents rinnovo) + update IT and EN document hreflang</name>
  <files>
    fr/src/pages/permits-fr.liquid
    fr/src/pages/documents-primo-fr.liquid
    fr/src/pages/documents-rinnovo-fr.liquid
    en/src/pages/documents-primo-en.liquid
    en/src/pages/documents-rinnovo-en.liquid
    src/pages/documents-primo.liquid
    src/pages/documents-rinnovo.liquid
  </files>
  <action>
**1. Create `fr/src/pages/permits-fr.liquid`:**

Copy `en/src/pages/permits-en.liquid` and make these substitutions:
- Front matter: `data: permitsEn` -> `data: permitsFr`
- Front matter: `permalink: "en/permesso-..."` -> `permalink: "fr/permesso-{{ permit.slug }}.html"`
- Front matter: `title: "Permit for..."` -> `title: "Permis pour {{ permit.tipo }}"`
- Front matter: `lang: en` -> `lang: fr`
- Front matter: `description:` -> `"Permis de sejour {{ permit.tipo }} - informations, conditions, documents et demarches"`
- Breadcrumb: `Home` -> `Accueil`, links to `/fr/index.html` and `/fr/database.html`
- Breadcrumb trail text: `Permit for` -> `Permis pour`
- Page header h1: `Permit for` -> `Permis pour`
- Placeholder text: `Content coming soon` -> `Contenu en cours de preparation`
- Placeholder description: translate to French: `Nous travaillons encore a completer les informations sur ce titre de sejour.`
- Placeholder button: `Help out` -> `Aider`
- Document CTA buttons: `/en/documenti-...` -> `/fr/documenti-...`
- Button text: `Documents for first issue` -> `Documents pour premier titre`
- Button text: `Documents for renewal` -> `Documents pour renouvellement`
- CTA alert text: `Do you have more questions about the permit for` -> `Avez-vous d'autres questions sur le permis pour`
- CTA button: `Contact us` -> `Contactez-nous`
- Related section heading: `You might also be interested in` -> `Cela pourrait aussi vous interesser`
- Related cards: all `/en/` links -> `/fr/` links
- Card titles: `All permits` -> `Tous les permis`, `Police Documents` -> `Documents pour la Questura`, `Dictionary` -> `Dictionnaire`
- Contact form fetch path stays `/src/components/contact-form.html` (same for all languages)

**2. Create `fr/src/pages/documents-primo-fr.liquid`:**

Copy `en/src/pages/documents-primo-en.liquid` and make these substitutions:
- Front matter: `data: documentsEn.primo` -> `data: documentsFr.primo`
- Front matter: `permalink: "en/documenti-..."` -> `permalink: "fr/documenti-{{ doc.slug }}-primo.html"`
- Front matter: `lang: en` -> `lang: fr`
- `<html lang="en">` -> `<html lang="fr">`
- `<meta name="description"` -> French: `"Documents requis pour le premier titre de sejour pour {{ doc.tipo }}"`
- `<title>` -> `Documents {{ doc.tipo }} - Premier titre - SOS Permesso`
- hreflang section: update canonical to `/fr/...`, keep IT and EN alternates, add FR alternate:
  ```
  <link rel="canonical" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="it" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="en" href="https://www.sospermesso.it/en/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="fr" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="x-default" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-primo.html">
  ```
- Breadcrumb: `Home` -> `Accueil` (link to `/fr/index.html`), `Police Documents` -> `Documents pour la Questura` (link to `/fr/documenti-questura.html`)
- Breadcrumb trail: `First Issue` -> `Premier titre`
- Page header subtitle: `Documents for <strong>First Issue</strong>` -> `Documents pour <strong>premier titre</strong>`
- Quick switch link: `See also: Renewal` -> `Voir aussi : Renouvellement` (link to `/fr/documenti-...rinnovo.html`)
- Permit link: `View the permit` -> `Voir le permis` (link to `/fr/permesso-...`)
- Submission callout: `Submit via postal KIT...` -> `Deposer via kit postal (pas besoin d'aller a la Questura)`, `Bring documents to the Police Headquarters...` -> `Apporter les documents a la Questura (le kit postal ne peut pas etre utilise)`
- Checklist heading: `Required documents` -> `Documents requis`
- Checklist intro: `Check off the documents...` -> `Cochez les documents que vous avez deja prepares. Votre progression est sauvegardee automatiquement.`
- `data-permit` attribute: `{{ doc.slug }}-primo-en` -> `{{ doc.slug }}-primo-fr`
- Checkbox IDs: `doc-{{ doc.slug }}-primo-en-` -> `doc-{{ doc.slug }}-primo-fr-`
- Disputed note: `(may vary by Police office)` -> `(peut varier selon la Questura)`
- Progress text: `Completed:` -> `Complete :`
- Warning note: `Required documents may vary...` -> `Les documents requis peuvent varier d'une Questura a l'autre.`
- Doc notes heading: `Additional document information` -> `Informations supplementaires sur les documents`
- Costs heading: `How much does it cost?` -> `Combien ca coute ?`
- Cost labels: `Postal payment slip` -> `Bon de paiement postal`, `to pay at the Post Office` -> `a payer a la Poste`, `Revenue stamp` -> `Timbre fiscal`, `to buy at a tobacco shop` -> `a acheter chez un buraliste`, `Postal kit` -> `Kit postal`, `to buy at the Post Office` -> `a acheter a la Poste`
- `Total` -> `Total`
- localStorage key in script: `{{ doc.slug }}-primo-en` -> `{{ doc.slug }}-primo-fr`

**3. Create `fr/src/pages/documents-rinnovo-fr.liquid`:**

Same as above but for rinnovo. Copy `en/src/pages/documents-rinnovo-en.liquid` and apply same substitutions with rinnovo-specific changes:
- `data: documentsEn.rinnovo` -> `data: documentsFr.rinnovo`
- Permalink: `fr/documenti-{{ doc.slug }}-rinnovo.html`
- Title: `Documents {{ doc.tipo }} - Renouvellement - SOS Permesso`
- Breadcrumb: `Renewal` -> `Renouvellement`
- Page header subtitle: `Documents for <strong>Renewal</strong>` -> `Documents pour <strong>renouvellement</strong>`
- Quick switch: `See also: First Issue` -> `Voir aussi : Premier titre` (link to `/fr/documenti-...-primo.html`)
- Disputed renewal warning (attesa-occupazione): `Warning: Renewal of the job-seeking permit is controversial...` -> `Attention : Le renouvellement du permis d'attente d'emploi est controverse. Certaines Questure le refusent. Nous recommandons de consulter un avocat ou un bureau d'aide juridique avant de proceder.`
- Legal help link text: `Find legal help in your area` -> `Trouver une aide juridique pres de chez vous` (link to `/fr/aiuto-legale.html`)
- Common doc for rinnovo: `Copy of previous permit (or loss report)` -> `Copie du permis precedent (ou declaration de perte)` -- IMPORTANT: keep the EN text in the `commonDocName` variable assignment since this is matched against Notion data (which is in IT/EN). Actually, this variable is hardcoded EN text used as display label. For FR, change display text to French but keep the `lowerDoc contains` check using the same English/Italian strings since that's what filters duplicates from the Notion data.
- `data-permit` and checkbox IDs: use `-fr` suffix
- localStorage key: `{{ doc.slug }}-rinnovo-fr`
- Renewal reminder alert: `Remember: The renewal application should preferably be submitted before the expiry date or in any case within 60 days of expiry.` -> `Rappel : La demande de renouvellement doit de preference etre deposee avant la date d'expiration ou en tout cas dans les 60 jours suivant l'expiration.`
- hreflang: same pattern as primo (canonical FR, alternates for IT/EN/FR/x-default)

**4. Update EN document templates with FR hreflang:**

In `en/src/pages/documents-primo-en.liquid`, add a FR hreflang line after the existing EN hreflang (line 27):
```
<link rel="alternate" hreflang="fr" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-primo.html">
```

In `en/src/pages/documents-rinnovo-en.liquid`, add a FR hreflang line after the existing EN hreflang (line 27):
```
<link rel="alternate" hreflang="fr" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-rinnovo.html">
```

**5. Add hreflang to IT document templates (hreflang symmetry):**

The IT document templates (`src/pages/documents-primo.liquid` and `src/pages/documents-rinnovo.liquid`) currently have NO hreflang tags at all. Add a hreflang block after the `<link>` stylesheet tags (after line 35) and before `</head>` in each:

In `src/pages/documents-primo.liquid`, add after the stylesheet links:
```html
  <!-- hreflang -->
  <link rel="canonical" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="it" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="en" href="https://www.sospermesso.it/en/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="fr" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-primo.html">
  <link rel="alternate" hreflang="x-default" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-primo.html">
```

In `src/pages/documents-rinnovo.liquid`, add after the stylesheet links:
```html
  <!-- hreflang -->
  <link rel="canonical" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-rinnovo.html">
  <link rel="alternate" hreflang="it" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-rinnovo.html">
  <link rel="alternate" hreflang="en" href="https://www.sospermesso.it/en/documenti-{{ doc.slug }}-rinnovo.html">
  <link rel="alternate" hreflang="fr" href="https://www.sospermesso.it/fr/documenti-{{ doc.slug }}-rinnovo.html">
  <link rel="alternate" hreflang="x-default" href="https://www.sospermesso.it/documenti-{{ doc.slug }}-rinnovo.html">
```
  </action>
  <verify>
1. Verify all 3 FR liquid templates exist with correct front matter (check `data:`, `permalink:`, `lang: fr`)
2. Verify FR templates reference `/fr/` paths (not `/en/`)
3. Verify localStorage keys use `-fr` suffix (not `-en`)
4. Verify EN document templates now have 4 hreflang links (IT, EN, FR, x-default)
5. Check that `data-permit` attributes use `-fr` suffix in FR document templates
6. Verify `_data/documentsFr.js` exports `{ primo, rinnovo }` shape: `node -e "const d = require('./_data/documentsFr.js'); d().then(r => console.log(Object.keys(r)));"`  -- must output `['primo', 'rinnovo']`
7. Verify IT document templates (`src/pages/documents-primo.liquid`, `src/pages/documents-rinnovo.liquid`) now have 5 hreflang links (canonical, IT, EN, FR, x-default)
  </verify>
  <done>
Three FR pagination templates exist and follow EN patterns with French UI strings. EN document templates updated with FR hreflang. IT document templates updated with full hreflang block (IT, EN, FR, x-default). All internal links point to /fr/ prefix. Checklist localStorage keys use -fr suffix. documentsFr.js confirmed to export { primo, rinnovo } shape.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. All 5 new FR files exist in `fr/src/pages/`
2. `eleventy.config.mjs` has EN permesso-* safety net (blocker fix)
3. `eleventy.config.mjs` has FR safety net block
4. EN document templates have FR hreflang links
5. IT document templates have full hreflang block (IT, EN, FR, x-default)
6. No `/en/` paths remain in FR templates (search for `/en/` in all FR files)
7. `_data/documentsFr.js` exports `{ primo, rinnovo }` (not flat array)
</verification>

<success_criteria>
- DuplicatePermalinkOutputError blocker is fixed (EN permesso-* files ignored)
- FR pagination templates exist for permits, documents-primo, documents-rinnovo
- FR pages.11tydata.js provides correct permalink override
- EN document templates include FR hreflang alternate
- IT document templates include full hreflang block (IT, EN, FR, x-default) for symmetry
- All FR templates use `lang: fr`, `/fr/` paths, and French UI strings
- documentsFr.js export shape verified as { primo, rinnovo }
</success_criteria>

<output>
After completion, create `.planning/phases/53-fr-page-generation/53-01-SUMMARY.md`
</output>
